<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Fullscreen / PWA polish -->
  <meta name="theme-color" content="#0b0f14" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>Î—Î¼ÎµÏÎ®ÏƒÎ¹Î¿ Î¤Î±Î¼ÎµÎ¯Î¿</title>
  <link rel="manifest" href="./manifest.webmanifest" />
  <style>
    :root{
      --bg0:#070a0f;
      --bg1:#0b0f14;
      --card:#111824;
      --line:rgba(255,255,255,.10);
      --text:#eaf1ff;
      --muted:rgba(234,241,255,.72);
      --muted2:rgba(234,241,255,.55);
      --accent:#4aa3ff;
      --good:#2fe39f;
      --bad:#ff5566;

      --r:18px;
      --tap:46px;

      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
      --safeLeft: env(safe-area-inset-left, 0px);
      --safeRight: env(safe-area-inset-right, 0px);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 70% -10%, rgba(74,163,255,.18), transparent 55%),
        radial-gradient(900px 700px at -10% 30%, rgba(47,227,159,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      padding: calc(var(--safeTop) + 10px) calc(var(--safeRight) + 10px) calc(var(--safeBottom) + 10px) calc(var(--safeLeft) + 10px);
      gap:10px;
    }

    /* TOPBAR (thin) */
    .topbar{
      display:flex;
      align-items:center;
      gap:10px;
      background: rgba(17,24,36,.55);
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 8px 10px;
      backdrop-filter: blur(10px);
    }
    .topbar .left{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .topbar .date{
      font-weight:900;
      font-size:14px;
      line-height:1.1;
    }
    .topbar .userline{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    select, button, input{ font: inherit; color:var(--text); }

    select{
      border:1px solid var(--line);
      background: rgba(17,24,36,.70);
      backdrop-filter: blur(8px);
      border-radius:999px;
      height: 38px;
      padding: 0 36px 0 12px;
      appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, var(--muted) 50%),
        linear-gradient(135deg, var(--muted) 50%, transparent 50%);
      background-position:
        calc(100% - 18px) 50%,
        calc(100% - 12px) 50%;
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      min-width: 140px;
      max-width: 220px;
    }
    .iconbtn{
      border:1px solid var(--line);
      background: rgba(17,24,36,.70);
      backdrop-filter: blur(8px);
      border-radius:999px;
      height: 38px;
      width: 38px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .content{
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
    }

    .view{
      flex:1;
      min-height:0;
      overflow:auto;
      padding-bottom: calc(76px + var(--safeBottom));
    }
    .view::-webkit-scrollbar{ width:0; height:0; }

    /* cards */
    .card{
      background: rgba(17,24,36,.55);
      border:1px solid var(--line);
      border-radius: var(--r);
      padding: 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      margin-bottom:10px;
    }
    .h{
      font-weight:900;
      margin:0 0 8px 0;
      font-size:16px;
    }
    .muted{ color:var(--muted); }
    .muted2{ color:var(--muted2); }
    .row{ display:flex; align-items:center; gap:10px; }
    .row.space{ justify-content:space-between; }

    /* tables grid */
    .tables{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (min-width: 520px){
      .tables{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }

    /* --- PRESS FEEDBACK (visual) --- */
    .pressable{
      position:relative;
      overflow:hidden;
      transition: transform .06s ease, filter .06s ease, box-shadow .10s ease;
      touch-action: manipulation;
      user-select:none;
    }
    .pressable:active{
      transform: scale(.985);
      filter: brightness(1.08);
    }
    .pressable::after{
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(circle at var(--rx,50%) var(--ry,50%), rgba(255,255,255,.16), transparent 45%);
      opacity:0;
      transition: opacity .20s ease;
      pointer-events:none;
    }
    .pressable.pulse::after{ opacity:1; }

    .tbtn{
      text-align:left;
      padding: 14px 14px;
      border-radius: var(--r);
      border:1px solid var(--line);
      background: rgba(17,24,36,.45);
      min-height: 74px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:4px;
    }
    .tbtn .title{ font-weight:1000; font-size:18px; letter-spacing:.2px; }
    .tbtn .sub{ color:var(--muted); font-size:13px; }
    .badge{
      position:absolute;
      right:10px;
      top:10px;
      min-width: 28px;
      height: 22px;
      padding:0 8px;
      border-radius: 999px;
      border:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      background: rgba(74,163,255,.12);
    }
    .tbtn.open{
      outline:2px solid rgba(74,163,255,.35);
    }
    .tbtn.open .badge{
      background: rgba(47,227,159,.10);
    }

    /* chips categories */
    .chips{
      display:flex;
      gap:8px;
      overflow:auto;
      padding: 2px 2px 8px 2px;
      scroll-snap-type:x proximity;
    }
    .chips::-webkit-scrollbar{ height:0; }
    .chip{
      flex:0 0 auto;
      scroll-snap-align:start;
      border:1px solid var(--line);
      background: rgba(17,24,36,.45);
      border-radius:999px;
      height: 38px;
      padding: 0 12px;
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:800;
      color: var(--muted);
      white-space:nowrap;
    }
    .chip.active{
      color: var(--text);
      border-color: rgba(74,163,255,.35);
      box-shadow: 0 0 0 3px rgba(74,163,255,.08) inset;
    }

    /* list (notebook-ish) */
    .list{
      display:flex;
      flex-direction:column;
      gap:0;
      border:1px solid var(--line);
      border-radius: var(--r);
      overflow:hidden;
      background: rgba(17,24,36,.35);
    }
    .li{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 12px;
      border-top:1px solid rgba(255,255,255,.07);
      gap:12px;
      background: rgba(0,0,0,.00);
    }
    .li:first-child{ border-top:none; }
    .li .left{ min-width:0; flex:1; }
    .li .name{ font-weight:900; line-height:1.15; margin:0; font-size:15px; }
    .li .meta{ font-size:12px; color:var(--muted2); margin-top:3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .price{ font-weight:1000; font-size:15px; white-space:nowrap; }

    .qty{
      display:flex;
      align-items:center;
      gap:6px;
      flex:0 0 auto;
    }
    .qbtn{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(17,24,36,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
    }
    .qnum{ min-width: 22px; text-align:center; font-weight:1000; }

    /* bottom bar */
    .bottom{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding: 10px calc(var(--safeRight) + 10px) calc(var(--safeBottom) + 10px) calc(var(--safeLeft) + 10px);
      background: linear-gradient(180deg, transparent, rgba(7,10,15,.72) 30%, rgba(7,10,15,.92));
      backdrop-filter: blur(10px);
      pointer-events:none;
    }
    .bottom .bar{
      pointer-events:auto;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (min-width:520px){
      .bottom .bar{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(17,24,36,.62);
      border-radius: 16px;
      height: 48px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.good{ border-color: rgba(47,227,159,.35); box-shadow:0 0 0 3px rgba(47,227,159,.06) inset; }
    .btn.bad{ border-color: rgba(255,85,102,.35); box-shadow:0 0 0 3px rgba(255,85,102,.06) inset; }
    .btn.accent{ border-color: rgba(74,163,255,.35); box-shadow:0 0 0 3px rgba(74,163,255,.06) inset; }

    /* modal */
    .modalBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 10px;
      padding-bottom: calc(10px + var(--safeBottom));
      z-index:999;
    }
    .modal{
      width:min(560px, 100%);
      border-radius: 22px;
      border:1px solid var(--line);
      background: rgba(17,24,36,.86);
      backdrop-filter: blur(14px);
      box-shadow: 0 30px 80px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .modal .head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 14px 14px 10px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modal .head .ttl{ font-weight:1000; font-size:16px; }
    .modal .body{ padding: 14px; display:flex; flex-direction:column; gap:10px; }
    .modal .foot{
      padding: 12px 14px 14px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    .small{ font-size:12px; color:var(--muted2); line-height:1.35; }
    .dangerText{ color: rgba(255,85,102,.95); font-weight:900; }
    .okText{ color: rgba(47,227,159,.95); font-weight:900; }

    /* screensaver */
    .saver{
      position:fixed;
      inset:0;
      z-index: 2000;
      display:none;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(1000px 700px at 50% 20%, rgba(74,163,255,.14), transparent 60%),
        linear-gradient(180deg, #05070b, #070a0f);
      padding: 24px;
      text-align:center;
      user-select:none;
    }
    .saver .logo{ font-weight:1000; font-size: 34px; letter-spacing:.3px; margin-bottom:10px; }
    .saver .line{ color: var(--muted); font-weight:900; font-size: 16px; }
    .saver .hint{ margin-top:16px; color: var(--muted2); font-size:13px; }

    .pill{
      border:1px solid var(--line);
      background: rgba(17,24,36,.55);
      border-radius: 999px;
      padding: 8px 12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    /* make everything "pressable" feel consistent */
    button, .li, .chip, .tbtn { cursor:pointer; }
  </style>
</head>

<body>
  <div class="app" id="app">

    <div class="topbar">
      <div class="left">
        <div class="date" id="topDate">â€”</div>
        <div class="userline" id="topUser">Î•Î½ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±: â€”</div>
      </div>
      <select id="userSelect" title="Î§ÏÎ®ÏƒÏ„Î·Ï‚"></select>
      <button class="iconbtn pressable" id="btnSettings" title="Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚">âš™ï¸</button>
    </div>

    <div class="content">
      <div class="view" id="view"></div>
    </div>
  </div>

  <div class="bottom" id="bottom">
    <div class="bar" id="bottomBar"></div>
  </div>

  <div class="modalBack" id="modalBack">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="head">
        <div class="ttl" id="modalTitle">â€”</div>
        <button class="iconbtn pressable" id="modalClose">âœ•</button>
      </div>
      <div class="body" id="modalBody"></div>
      <div class="foot" id="modalFoot"></div>
    </div>
  </div>

  <div class="saver" id="saver">
    <div>
      <div class="logo" id="saverLogo">ÎšÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î±</div>
      <div class="line" id="saverLine">Î•Î½ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±: â€”</div>
      <div class="hint">Î†Î³Î³Î¹Î¾Îµ Ï„Î·Î½ Î¿Î¸ÏŒÎ½Î· Î³Î¹Î± ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î±</div>
    </div>
  </div>

  <script>
    /***********************
     *  DAILY CASHIER v2.1
     *  Polish:
     *  - stronger press feedback + ripple + haptic
     *  - mandatory PIN for users
     *  - add/manage staff users via owner PIN
     *  - fullscreen meta/manifest + safe-areas
     ***********************/

    const LS_KEY = "daily_cashier_db_v2";
    const TODAY = new Date().toISOString().slice(0,10);

    // inactivity
    const IDLE_TO_HOME_MS = 40_000;
    const IDLE_TO_SAVER_AFTER_HOME_MS = 12_000;
    let idleTimer = null;
    let saverTimer = null;

    const el = (id) => document.getElementById(id);
    const view = el("view");
    const bottom = el("bottom");
    const bottomBar = el("bottomBar");

    // modal
    const modalBack = el("modalBack");
    const modalTitle = el("modalTitle");
    const modalBody = el("modalBody");
    const modalFoot = el("modalFoot");

    const saver = el("saver");

    /** HAPTIC + ripple */
    function haptic(ms=12){
      try{
        if(navigator.vibrate) navigator.vibrate(ms);
      }catch{}
    }
    function pressPulse(elem, clientX, clientY){
      if(!elem) return;
      const r = elem.getBoundingClientRect();
      const x = ((clientX ?? (r.left + r.width/2)) - r.left) / r.width * 100;
      const y = ((clientY ?? (r.top + r.height/2)) - r.top) / r.height * 100;
      elem.style.setProperty("--rx", x.toFixed(1) + "%");
      elem.style.setProperty("--ry", y.toFixed(1) + "%");
      elem.classList.add("pulse");
      setTimeout(()=> elem.classList.remove("pulse"), 180);
    }
    function makePressable(elem, vib=10){
      if(!elem) return;
      elem.classList.add("pressable");
      const handler = (ev)=>{
        const t = ev.touches?.[0];
        pressPulse(elem, t?.clientX ?? ev.clientX, t?.clientY ?? ev.clientY);
        haptic(vib);
      };
      elem.addEventListener("pointerdown", handler, {passive:true});
      elem.addEventListener("touchstart", handler, {passive:true});
    }

    function euro(x){
      const n = Number(x || 0);
      return n.toLocaleString("el-GR",{minimumFractionDigits:2, maximumFractionDigits:2}) + " â‚¬";
    }
    function uid(){
      return Math.random().toString(36).slice(2) + Date.now().toString(36);
    }

    function loadDB(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(raw) return JSON.parse(raw);
      }catch(e){}
      return null;
    }

    function defaultDB(){
      return {
        shopName: "Î—Î¼ÎµÏÎ®ÏƒÎ¹Î¿ Î¤Î±Î¼ÎµÎ¯Î¿",
        ownerPin: "1234",
        users: [
          { id:"u1", name:"Î¥Ï€Î¬Î»Î»Î·Î»Î¿Ï‚ 1", pin:"1111" }
        ],
        currentUserId: "u1",
        tables: [
          { id:"T1",  label:"T1" },
          { id:"T2",  label:"T2" },
          { id:"T3",  label:"T3" },
          { id:"T4",  label:"T4" },
          { id:"T5",  label:"T5" },
          { id:"T6",  label:"T6" },
          { id:"BAR", label:"BAR" },
          { id:"OUT", label:"Î•ÎÎ©" }
        ],
        menu: (function(){
          const categories = [
            { id:"coffee_hot",  name:"ÎšÎ±Ï†Î­Î´ÎµÏ‚ â€“ Î–ÎµÏƒÏ„Î¿Î¯", emoji:"â˜•" },
            { id:"coffee_cold", name:"ÎšÎ±Ï†Î­Î´ÎµÏ‚ â€“ ÎšÏÏÎ¿Î¹",  emoji:"ğŸ§Š" },
            { id:"tea",         name:"Î¤ÏƒÎ¬Î¹ â€“ Î–ÎµÏƒÏ„Î¬",     emoji:"ğŸ«–" },
            { id:"choco",       name:"Î£Î¿ÎºÎ¿Î»Î¬Ï„ÎµÏ‚ / Î“Î±Î»Î±ÎºÏ„ÎµÏÎ¬", emoji:"ğŸ«" },
            { id:"soft",        name:"Î‘Î½Î±ÏˆÏ…ÎºÏ„Î¹ÎºÎ¬ â€“ ÎÎµÏÎ¬", emoji:"ğŸ¥¤" },
            { id:"juice",       name:"Î§Ï…Î¼Î¿Î¯ â€“ Smoothies", emoji:"ğŸŠ" },
            { id:"snack",       name:"Î£Î½Î±Îº â€“ Î“Î»Ï…ÎºÎ¬",      emoji:"ğŸ¥" },
            { id:"beer",        name:"ÎœÏ€ÏÏÎµÏ‚",            emoji:"ğŸº" },
            { id:"wine",        name:"ÎšÏÎ±ÏƒÎ¹Î¬",            emoji:"ğŸ·" },
            { id:"spirit",      name:"Î Î¿Ï„Î¬",              emoji:"ğŸ¥ƒ" },
            { id:"cocktail",    name:"ÎšÎ¿ÎºÏ„Î­Î¹Î»",           emoji:"ğŸ¸" },
            { id:"extras",      name:"Extras",            emoji:"â•" }
          ];

          const products = [
            { id:"p_espresso_single", cat:"coffee_hot", name:"Espresso Î¼Î¿Î½ÏŒÏ‚", price:2.60 },
            { id:"p_espresso_double", cat:"coffee_hot", name:"Espresso Î´Î¹Ï€Î»ÏŒÏ‚", price:3.20 },
            { id:"p_espresso_macchiato", cat:"coffee_hot", name:"Espresso macchiato", price:2.90 },
            { id:"p_americano", cat:"coffee_hot", name:"Americano", price:3.20 },
            { id:"p_cappuccino", cat:"coffee_hot", name:"Cappuccino", price:3.60 },
            { id:"p_cappuccino_double", cat:"coffee_hot", name:"Cappuccino Î´Î¹Ï€Î»ÏŒÏ‚", price:4.20 },
            { id:"p_latte_macchiato", cat:"coffee_hot", name:"Latte macchiato", price:4.20 },
            { id:"p_flat_white", cat:"coffee_hot", name:"Flat white", price:4.40 },
            { id:"p_mocha", cat:"coffee_hot", name:"Mocha", price:4.50 },
            { id:"p_filter", cat:"coffee_hot", name:"ÎšÎ±Ï†Î­Ï‚ Ï†Î¯Î»Ï„ÏÎ¿Ï…", price:3.00 },

            { id:"p_freddo_espresso", cat:"coffee_cold", name:"Freddo espresso", price:3.80 },
            { id:"p_freddo_cappuccino", cat:"coffee_cold", name:"Freddo cappuccino", price:4.20 },
            { id:"p_iced_latte", cat:"coffee_cold", name:"Iced latte", price:4.50 },
            { id:"p_cold_brew", cat:"coffee_cold", name:"Cold brew", price:4.80 },
            { id:"p_frappe", cat:"coffee_cold", name:"Frappe", price:3.50 },

            { id:"p_tea_basic", cat:"tea", name:"Î¤ÏƒÎ¬Î¹ (Î¼Î±ÏÏÎ¿/Ï€ÏÎ¬ÏƒÎ¹Î½Î¿/Î²ÏŒÏ„Î±Î½Î±)", price:3.20 },
            { id:"p_tea_fruit", cat:"tea", name:"Î¤ÏƒÎ¬Î¹ Ï†ÏÎ¿ÏÏ„Ï‰Î½", price:3.50 },
            { id:"p_chai_latte", cat:"tea", name:"Chai latte", price:4.30 },

            { id:"p_hot_chocolate", cat:"choco", name:"Î–ÎµÏƒÏ„Î® ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:4.20 },
            { id:"p_cold_chocolate", cat:"choco", name:"ÎšÏÏÎ± ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:4.50 },
            { id:"p_white_chocolate", cat:"choco", name:"Î›ÎµÏ…ÎºÎ® ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:4.50 },
            { id:"p_cocoa", cat:"choco", name:"ÎšÎ±ÎºÎ¬Î¿", price:4.00 },

            { id:"p_cola", cat:"soft", name:"Coca-Cola / Zero / Fanta (0,33l)", price:3.40 },
            { id:"p_ice_tea", cat:"soft", name:"Ice Tea", price:3.60 },
            { id:"p_soda_tonic", cat:"soft", name:"Î£ÏŒÎ´Î± / Î¤ÏŒÎ½Î¹Îº", price:3.20 },
            { id:"p_water_033", cat:"soft", name:"ÎœÎµÏ„Î±Î»Î»Î¹ÎºÏŒ Î½ÎµÏÏŒ (0,33l)", price:2.80 },
            { id:"p_water_075", cat:"soft", name:"ÎœÎµÏ„Î±Î»Î»Î¹ÎºÏŒ Î½ÎµÏÏŒ (0,75l)", price:5.50 },

            { id:"p_orange_juice", cat:"juice", name:"Î¦Ï…ÏƒÎ¹ÎºÏŒÏ‚ Ï‡Ï…Î¼ÏŒÏ‚ Ï€Î¿ÏÏ„Î¿ÎºÎ¬Î»Î¹", price:4.50 },
            { id:"p_mix_juice", cat:"juice", name:"Î§Ï…Î¼ÏŒÏ‚ Î±Î½Î¬Î¼ÎµÎ¹ÎºÏ„Î¿Ï‚", price:4.80 },
            { id:"p_fruit_smoothie", cat:"juice", name:"Smoothie Ï†ÏÎ¿ÏÏ„Ï‰Î½", price:5.80 },
            { id:"p_milkshake", cat:"juice", name:"Milkshake", price:5.50 },

            { id:"p_croissant_plain", cat:"snack", name:"ÎšÏÎ¿Ï…Î±ÏƒÎ¬Î½ ÏƒÎºÎ­Ï„Î¿", price:2.80 },
            { id:"p_croissant_choco", cat:"snack", name:"ÎšÏÎ¿Ï…Î±ÏƒÎ¬Î½ ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:3.20 },
            { id:"p_muffin", cat:"snack", name:"ÎœÎ¬Ï†Î¹Î½", price:3.50 },
            { id:"p_cake_piece", cat:"snack", name:"ÎšÎ­Î¹Îº (ÎºÎ¿Î¼Î¼Î¬Ï„Î¹)", price:4.20 },
            { id:"p_cheesecake", cat:"snack", name:"Cheesecake", price:4.80 },
            { id:"p_cookies", cat:"snack", name:"ÎœÏ€Î¹ÏƒÎºÏŒÏ„Î±", price:2.50 },
            { id:"p_toast_ham", cat:"snack", name:"Î¤Î¿ÏƒÏ„ Î¶Î±Î¼Ï€ÏŒÎ½-Ï„Ï…ÏÎ¯", price:4.50 },
            { id:"p_toast_veg", cat:"snack", name:"Î¤Î¿ÏƒÏ„ vegetarian", price:4.80 },

            { id:"p_beer_draft", cat:"beer", name:"ÎœÏ€ÏÏÎ± Î²Î±ÏÎµÎ»Î¯ÏƒÎ¹Î± (0,5l)", price:5.20 },
            { id:"p_beer_bottle", cat:"beer", name:"ÎœÏ€ÏÏÎ± ÎµÎ¼Ï†Î¹Î±Î»Ï‰Î¼Î­Î½Î· (0,33l)", price:4.20 },
            { id:"p_weissbier", cat:"beer", name:"Weissbier (0,5l)", price:5.50 },
            { id:"p_beer_zero", cat:"beer", name:"ÎœÏ€ÏÏÎ± Ï‡Ï‰ÏÎ¯Ï‚ Î±Î»ÎºÎ¿ÏŒÎ»", price:4.20 },

            { id:"p_wine_glass", cat:"wine", name:"ÎšÏÎ±ÏƒÎ¯ Ï€Î¿Ï„Î®ÏÎ¹", price:5.50 },
            { id:"p_wine_carafe", cat:"wine", name:"ÎšÏÎ±ÏƒÎ¯ ÎºÎ±ÏÎ¬Ï†Î± (0,5l)", price:12.00 },
            { id:"p_wine_bottle_22", cat:"wine", name:"Î¦Î¹Î¬Î»Î· ÎºÏÎ±ÏƒÎ¯ (22â‚¬)", price:22.00 },
            { id:"p_wine_bottle_28", cat:"wine", name:"Î¦Î¹Î¬Î»Î· ÎºÏÎ±ÏƒÎ¯ (28â‚¬)", price:28.00 },
            { id:"p_prosecco_glass", cat:"wine", name:"Prosecco Ï€Î¿Ï„Î®ÏÎ¹", price:6.50 },

            { id:"p_whisky_std", cat:"spirit", name:"ÎŸÏ…Î¯ÏƒÎºÎ¹ standard (4cl)", price:8.50 },
            { id:"p_whisky_premium", cat:"spirit", name:"Premium Î¿Ï…Î¯ÏƒÎºÎ¹ (4cl)", price:10.50 },
            { id:"p_vodka", cat:"spirit", name:"Î’ÏŒÏ„ÎºÎ± (4cl)", price:8.00 },
            { id:"p_rum", cat:"spirit", name:"Î¡Î¿ÏÎ¼Î¹ (4cl)", price:8.50 },
            { id:"p_gin", cat:"spirit", name:"Î¤Î¶Î¹Î½ (4cl)", price:8.50 },
            { id:"p_ouzo_tsipouro", cat:"spirit", name:"ÎŸÏÎ¶Î¿ / Î¤ÏƒÎ¯Ï€Î¿Ï…ÏÎ¿ (4cl)", price:7.50 },
            { id:"p_liqueur", cat:"spirit", name:"Î›Î¹ÎºÎ­Ï (4cl)", price:7.50 },

            { id:"p_mojito", cat:"cocktail", name:"Mojito", price:9.50 },
            { id:"p_caipirinha", cat:"cocktail", name:"Caipirinha", price:9.50 },
            { id:"p_margarita", cat:"cocktail", name:"Margarita", price:10.00 },
            { id:"p_aperol", cat:"cocktail", name:"Aperol Spritz", price:8.50 },
            { id:"p_gin_tonic", cat:"cocktail", name:"Gin Tonic", price:9.00 },
            { id:"p_negroni", cat:"cocktail", name:"Negroni", price:10.50 },

            { id:"p_extra_decaf", cat:"extras", name:"Decaf (+)", price:0.30 },
            { id:"p_extra_plant_milk", cat:"extras", name:"Î¦Ï…Ï„Î¹ÎºÏŒ Î³Î¬Î»Î± (+)", price:0.50 }
          ];
          return { categories, products };
        })(),
        days: {}
      };
    }

    let db = loadDB() || defaultDB();

    function saveDB(){ localStorage.setItem("daily_cashier_db_v2", JSON.stringify(db)); }

    function ensureDay(){
      if(!db.days[TODAY]) db.days[TODAY] = { tables:{}, payments:[] };
      for(const t of db.tables){
        if(!db.days[TODAY].tables[t.id]) db.days[TODAY].tables[t.id] = { items:[] };
      }
    }
    ensureDay();
    saveDB();

    function getUser(){
      return db.users.find(u=>u.id===db.currentUserId) || db.users[0];
    }

    function setTop(){
      el("topDate").textContent = TODAY;
      const u = getUser();
      el("topUser").textContent = `Î•Î½ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±: ${u?.name || "â€”"} â€¢ ${db.shopName}`;
      el("saverLogo").textContent = db.shopName;
      el("saverLine").textContent = `Î•Î½ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±: ${u?.name || "â€”"}`;
      document.title = db.shopName;
    }

    function fillUsers(){
      const sel = el("userSelect");
      sel.innerHTML = "";
      for(const u of db.users){
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = u.name;
        if(u.id===db.currentUserId) opt.selected = true;
        sel.appendChild(opt);
      }
    }

    /* state */
    let state = { screen:"home", tableId:null, categoryId:null };

    function gotoHome(){ state.screen="home"; state.tableId=null; state.categoryId=null; render(); }
    function gotoTable(tid){ state.screen="table"; state.tableId=tid; render(); }
    function gotoAdd(tid){ state.screen="add"; state.tableId=tid; state.categoryId = state.categoryId || db.menu.categories[0]?.id || null; render(); }
    function gotoPay(tid){ state.screen="pay"; state.tableId=tid; render(); }
    function gotoSummary(){ state.screen="summary"; state.tableId=null; render(); }

    /* helpers */
    function dayTable(tid){ ensureDay(); return db.days[TODAY].tables[tid]; }
    function allItems(tid){ return dayTable(tid).items; }
    function unpaidItems(tid){ return allItems(tid).filter(it => !it.paid && !it.voided); }
    function tableTotal(tid){ return unpaidItems(tid).reduce((s,it)=>s+it.price,0); }

    function groupUnpaid(tid){
      const map = new Map();
      for(const it of unpaidItems(tid)){
        const k = it.prodId + "|" + it.price;
        if(!map.has(k)) map.set(k, { prodId: it.prodId, name: it.name, price: it.price, qty:0 });
        map.get(k).qty += 1;
      }
      return [...map.values()];
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function addProductToTable(prodId){
      const tid = state.tableId;
      if(!tid) return;
      const p = db.menu.products.find(x=>x.id===prodId);
      if(!p) return;
      const it = {
        id: uid(),
        prodId: p.id,
        name: p.name,
        cat: p.cat,
        price: Number(p.price),
        ts: Date.now(),
        by: getUser()?.name || "",
        paid: null,
        voided: false
      };
      dayTable(tid).items.push(it);
      saveDB();
      render();
    }

    function removeOneUnit(tid, prodId){
      const items = dayTable(tid).items;
      const idx = items.findIndex(it => it.prodId===prodId && !it.paid && !it.voided);
      if(idx>=0){
        items.splice(idx,1);
        saveDB();
        render();
      }
    }

    function findOneUnpaidUnit(tid, prodId){
      return dayTable(tid).items.find(it => it.prodId===prodId && !it.paid && !it.voided) || null;
    }

    function methodLabel(m){
      if(m==="cash") return "ÎœÎµÏ„ÏÎ·Ï„Î¬";
      if(m==="card") return "ÎšÎ¬ÏÏ„Î±";
      if(m==="treat") return "ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î¿";
      return m;
    }

    /* modal */
    function openModal({title, bodyHtml, buttons}){
      modalTitle.textContent = title || "";
      modalBody.innerHTML = bodyHtml || "";
      modalFoot.innerHTML = "";
      for(const b of (buttons||[])){
        const btn = document.createElement("button");
        btn.className = "btn pressable " + (b.cls || "");
        btn.textContent = b.text || "ÎŸÎš";
        btn.addEventListener("click", (ev)=>{ pressPulse(btn, ev.clientX, ev.clientY); haptic(8); (b.onClick||closeModal)(); });
        modalFoot.appendChild(btn);
        makePressable(btn, 8);
      }
      modalBack.style.display = "flex";
    }
    function closeModal(){
      modalBack.style.display = "none";
      modalTitle.textContent = "";
      modalBody.innerHTML = "";
      modalFoot.innerHTML = "";
    }
    el("modalClose").addEventListener("click", closeModal);
    makePressable(el("modalClose"), 8);
    modalBack.addEventListener("click", (e)=>{ if(e.target===modalBack) closeModal(); });

    function confirmModal({title, bodyHtml, okText="ÎŸÎš", cancelText="Î†ÎºÏ…ÏÎ¿", danger=false}){
      return new Promise(resolve=>{
        openModal({
          title,
          bodyHtml,
          buttons: [
            { text: cancelText, cls:"", onClick: ()=>{ closeModal(); resolve(false); } },
            { text: okText, cls: (danger? "bad":"good"), onClick: ()=>{ closeModal(); resolve(true); } }
          ].filter(b => b.text !== "")
        });
      });
    }

    function askPin({title, hint, maxLen=6, allowEmpty=false}){
      return new Promise(resolve=>{
        const idInput = "pinInput";
        openModal({
          title,
          bodyHtml: `
            <div class="small">${hint || ""}</div>
            <input id="${idInput}" inputmode="numeric" pattern="[0-9]*" autocomplete="one-time-code"
              style="width:100%; height:46px; border-radius:14px; border:1px solid var(--line);
                     padding:0 12px; background:rgba(0,0,0,.18);" placeholder="PIN" />
            <div class="small">${allowEmpty ? "Î†Î´ÎµÎ¹Î¿ = Î±ÎºÏÏÏ‰ÏƒÎ· / Ï‡Ï‰ÏÎ¯Ï‚ Î±Î»Î»Î±Î³Î®." : ""}</div>
          `,
          buttons: [
            { text:"Î†ÎºÏ…ÏÎ¿", cls:"", onClick: ()=>{ closeModal(); resolve(null); } },
            { text:"ÎŸÎš", cls:"good", onClick: ()=>{
                const v = (document.getElementById(idInput)?.value || "").trim();
                closeModal();
                if(!allowEmpty && v.length===0) return resolve("");
                resolve(v.slice(0,maxLen));
            } }
          ]
        });
        setTimeout(()=> document.getElementById(idInput)?.focus(), 60);
      });
    }

    function askText(title, hint){
      return new Promise(resolve=>{
        const idInput = "txtInput";
        openModal({
          title,
          bodyHtml: `
            <div class="small">${hint||""}</div>
            <input id="${idInput}"
              style="width:100%; height:46px; border-radius:14px; border:1px solid var(--line);
                     padding:0 12px; background:rgba(0,0,0,.18);" placeholder="ÎšÎµÎ¯Î¼ÎµÎ½Î¿" />
          `,
          buttons: [
            { text:"Î†ÎºÏ…ÏÎ¿", cls:"", onClick: ()=>{ closeModal(); resolve(null); } },
            { text:"ÎŸÎš", cls:"good", onClick: ()=>{
                const v = (document.getElementById(idInput)?.value || "").trim();
                closeModal();
                resolve(v);
            } }
          ]
        });
        setTimeout(()=> document.getElementById(idInput)?.focus(), 60);
      });
    }

    /* screensaver + idle */
    function resetIdle(){
      if(idleTimer) clearTimeout(idleTimer);
      if(saverTimer) clearTimeout(saverTimer);
      saver.style.display = "none";

      idleTimer = setTimeout(()=>{
        gotoHome();
        saverTimer = setTimeout(()=>{ saver.style.display = "flex"; }, IDLE_TO_SAVER_AFTER_HOME_MS);
      }, IDLE_TO_HOME_MS);
    }
    ["click","touchstart","keydown","pointerdown","scroll"].forEach(ev=>{
      window.addEventListener(ev, resetIdle, {passive:true});
    });
    saver.addEventListener("click", ()=>{ saver.style.display="none"; resetIdle(); haptic(12); });
    saver.addEventListener("touchstart", ()=>{ saver.style.display="none"; resetIdle(); haptic(12); }, {passive:true});

    /* bottom buttons */
    function setBottomButtons(btns){
      bottomBar.innerHTML = "";
      if(!btns || btns.length===0){
        bottom.style.display = "none";
        return;
      }
      bottom.style.display = "block";
      for(const b of btns){
        const btn = document.createElement("button");
        btn.className = "btn pressable " + (b.kind || "");
        btn.textContent = b.text;
        btn.addEventListener("click", (ev)=>{
          pressPulse(btn, ev.clientX, ev.clientY);
          haptic(10);
          b.onClick();
        });
        bottomBar.appendChild(btn);
        makePressable(btn, 10);
      }
    }

    /* HOME = ONLY TABLES */
    function renderHome(){
      view.innerHTML = `
        <div class="tables">
          ${db.tables.map(t=>{
            const total = tableTotal(t.id);
            const count = unpaidItems(t.id).length;
            const isOpen = total>0;
            return `
              <button class="tbtn pressable ${isOpen?"open":""}" data-tid="${t.id}">
                <div class="title">${t.label}</div>
                <div class="sub">${isOpen ? ("Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: " + euro(total)) : "â€”"}</div>
                <div class="badge">${count}</div>
              </button>
            `;
          }).join("")}
        </div>
      `;

      view.querySelectorAll("[data-tid]").forEach(b=>{
        makePressable(b, 12);
        b.addEventListener("click", ()=> gotoTable(b.getAttribute("data-tid")));
      });

      setBottomButtons([
        { text:"Î£ÏÎ½Î¿ÏˆÎ·", kind:"accent", onClick: ()=> gotoSummary() },
        { text:"CSV", kind:"", onClick: ()=> exportCSV() },
        { text:"Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚", kind:"", onClick: ()=> openSettings() },
      ]);
    }

    /* TABLE screen */
    function renderTable(){
      const tid = state.tableId;
      const t = db.tables.find(x=>x.id===tid);
      const groups = groupUnpaid(tid);
      const total = tableTotal(tid);

      view.innerHTML = `
        <div class="card">
          <div class="row space">
            <div>
              <div class="h">Î¤ÏÎ±Ï€Î­Î¶Î¹: ${escapeHtml(t?.label || tid)}</div>
              <div class="muted">Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: <b>${euro(total)}</b></div>
            </div>
          </div>
          <div class="small">Î“ÏÎ®Î³Î¿ÏÎ±: Î Î¯ÏƒÏ‰ / + Î ÏÎ¿ÏŠÏŒÎ½ / Î Î»Î·ÏÏ‰Î¼Î®</div>
        </div>

        <div class="card">
          <div class="h">Î‘Î½Î¿Î¹Ï‡Ï„Î¬ items</div>
          ${groups.length===0 ? `<div class="okText">ÎšÎ±Î¸Î±ÏÏŒ âœ…</div>` : `
            <div class="list">
              ${groups.map(g=>`
                <div class="li">
                  <div class="left">
                    <div class="name">${escapeHtml(g.name)}</div>
                    <div class="meta">${euro(g.price)} â€¢ ${g.qty} Ï„ÎµÎ¼.</div>
                  </div>
                  <div class="qty">
                    <button class="qbtn pressable" data-minus="${g.prodId}">âˆ’</button>
                    <div class="qnum">${g.qty}</div>
                    <button class="qbtn pressable" data-plus="${g.prodId}">+</button>
                  </div>
                </div>
              `).join("")}
            </div>
          `}
        </div>
      `;

      view.querySelectorAll("[data-minus]").forEach(b=>{
        makePressable(b, 8);
        b.addEventListener("click", ()=> removeOneUnit(tid, b.getAttribute("data-minus")));
      });
      view.querySelectorAll("[data-plus]").forEach(b=>{
        makePressable(b, 8);
        b.addEventListener("click", ()=> addProductToTable(b.getAttribute("data-plus")));
      });

      setBottomButtons([
        { text:"â† Î Î¯ÏƒÏ‰", kind:"", onClick: ()=> gotoHome() },
        { text:"+ Î ÏÎ¿ÏŠÏŒÎ½", kind:"accent", onClick: ()=> gotoAdd(tid) },
        { text:"Î Î»Î·ÏÏ‰Î¼Î®", kind:"good", onClick: ()=> gotoPay(tid) }
      ]);
    }

    /* ADD screen */
    function renderAdd(){
      const tid = state.tableId;
      const t = db.tables.find(x=>x.id===tid);
      const cats = db.menu.categories;
      const activeCat = state.categoryId || cats[0]?.id || null;
      const products = db.menu.products.filter(p=>p.cat===activeCat);

      view.innerHTML = `
        <div class="card">
          <div class="row space">
            <div>
              <div class="h">+ Î ÏÎ¿ÏŠÏŒÎ½ â€¢ ${escapeHtml(t?.label || tid)}</div>
              <div class="muted">Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ Ï„ÏÏÎ±: <b>${euro(tableTotal(tid))}</b></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="h">ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚</div>
          <div class="chips" id="catChips">
            ${cats.map(c=>`
              <button class="chip pressable ${c.id===activeCat?"active":""}" data-cat="${c.id}">
                ${c.emoji} ${escapeHtml(c.name)}
              </button>
            `).join("")}
          </div>
          <div class="small">Swipe Î¿ÏÎ¹Î¶ÏŒÎ½Ï„Î¹Î± ÏƒÏ„Î¹Ï‚ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚.</div>
        </div>

        <div class="card">
          <div class="h">Î ÏÎ¿ÏŠÏŒÎ½Ï„Î±</div>
          <div class="list">
            ${products.map(p=>`
              <div class="li pressable" data-add="${p.id}">
                <div class="left">
                  <div class="name">${escapeHtml(p.name)}</div>
                  <div class="meta">${escapeHtml(catTitle(p.cat))}</div>
                </div>
                <div class="price">${euro(p.price)}</div>
              </div>
            `).join("")}
          </div>
          <div class="small">Î Î¬Ï„Î± Î³ÏÎ±Î¼Î¼Î® Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î¿Ï‚ â†’ Ï€ÏÎ¿ÏƒÏ„Î¯Î¸ÎµÏ„Î±Î¹.</div>
        </div>
      `;

      view.querySelectorAll("[data-cat]").forEach(b=>{
        makePressable(b, 8);
        b.addEventListener("click", ()=>{
          state.categoryId = b.getAttribute("data-cat");
          render();
        });
      });

      view.querySelectorAll("[data-add]").forEach(li=>{
        makePressable(li, 8);
        li.addEventListener("click", ()=> addProductToTable(li.getAttribute("data-add")));
      });

      setBottomButtons([
        { text:"â† Î Î¯ÏƒÏ‰", kind:"", onClick: ()=> gotoTable(tid) },
        { text:"Î Î»Î·ÏÏ‰Î¼Î®", kind:"good", onClick: ()=> gotoPay(tid) }
      ]);
    }

    function catTitle(catId){
      const c = db.menu.categories.find(x=>x.id===catId);
      return c ? `${c.emoji} ${c.name}` : "";
    }

    /* PAY screen */
    async function treatOne(tid, prodId){
      const it = findOneUnpaidUnit(tid, prodId);
      if(!it) return;

      const ok = await confirmModal({
        title:"ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î¿",
        bodyHtml:`<div class="small">ÎÎ± Î³Î¯Î½ÎµÎ¹ ÎºÎµÏÎ±ÏƒÎ¼Î­Î½Î¿ <b>1 Ï„ÎµÎ¼.</b> â€œ${escapeHtml(it.name)}â€;</div>`,
        okText:"ÎÎ±Î¹",
        cancelText:"Î†ÎºÏ…ÏÎ¿"
      });
      if(!ok) return;

      it.paid = { method:"treat", ts: Date.now(), by: getUser()?.name || "" };
      db.days[TODAY].payments.push({
        id: uid(),
        tableId: tid,
        prodId: it.prodId,
        name: it.name,
        price: it.price,
        method: "treat",
        ts: it.paid.ts,
        by: it.paid.by
      });

      saveDB();
      render();
    }

    async function payAll(tid, method){
      const items = unpaidItems(tid);
      if(items.length===0){
        await confirmModal({ title:"Î Î»Î·ÏÏ‰Î¼Î®", bodyHtml:`<div class="small">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿.</div>`, okText:"ÎŸÎš", cancelText:"" });
        gotoHome();
        return;
      }

      const ok = await confirmModal({
        title:"Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·",
        bodyHtml:`<div class="small">ÎÎ± Ï€Î»Î·ÏÏ‰Î¸ÎµÎ¯ <b>ÏŒÎ»Î¿</b> Ï„Î¿ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ (${euro(tableTotal(tid))}) Î¼Îµ <b>${methodLabel(method)}</b>;</div>`,
        okText:"ÎÎ±Î¹",
        cancelText:"Î†ÎºÏ…ÏÎ¿"
      });
      if(!ok) return;

      const u = getUser()?.name || "";
      const ts = Date.now();

      for(const it of items){
        it.paid = { method, ts, by: u };
        db.days[TODAY].payments.push({
          id: uid(),
          tableId: tid,
          prodId: it.prodId,
          name: it.name,
          price: it.price,
          method,
          ts,
          by: u
        });
      }

      saveDB();
      gotoHome();
    }

    function renderPay(){
      const tid = state.tableId;
      const t = db.tables.find(x=>x.id===tid);
      const groups = groupUnpaid(tid);
      const total = tableTotal(tid);

      view.innerHTML = `
        <div class="card">
          <div class="h">Î Î»Î·ÏÏ‰Î¼Î® â€¢ ${escapeHtml(t?.label || tid)}</div>
          <div class="muted">Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: <b>${euro(total)}</b></div>
          <div class="row" style="gap:10px; margin-top:10px;">
            <button class="btn pressable good" style="flex:1;" id="payCash">Î Î›Î—Î¡Î©ÎœÎ— ÎœÎ•Î¤Î¡Î—Î¤Î‘</button>
            <button class="btn pressable accent" style="flex:1;" id="payCard">Î Î›Î—Î¡Î©ÎœÎ— ÎšÎ‘Î¡Î¤Î‘</button>
          </div>
          <div class="small">Î¤Î¿ â€œÎºÎµÏÎ±ÏƒÎ¼Î­Î½Î¿â€ Î±Ï†Î±Î¹ÏÎµÎ¯ 1 Ï„ÎµÎ¼. Î±Ï€ÏŒ Ï„Î¿ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿.</div>
        </div>

        <div class="card">
          <div class="h">Î‘Î½Î¿Î¹Ï‡Ï„Î¬ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±</div>
          ${groups.length===0 ? `<div class="okText">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ âœ…</div>` : `
            <div class="list">
              ${groups.map(g=>`
                <div class="li">
                  <div class="left">
                    <div class="name">${escapeHtml(g.name)}</div>
                    <div class="meta">${euro(g.price)} â€¢ ${g.qty} Ï„ÎµÎ¼.</div>
                  </div>
                  <div class="qty">
                    <button class="qbtn pressable" title="ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î¿ 1 Ï„ÎµÎ¼." data-treat="${g.prodId}">ğŸ</button>
                  </div>
                </div>
              `).join("")}
            </div>
          `}
        </div>
      `;

      makePressable(el("payCash"), 14);
      makePressable(el("payCard"), 14);

      el("payCash").addEventListener("click", ()=> payAll(tid, "cash"));
      el("payCard").addEventListener("click", ()=> payAll(tid, "card"));

      view.querySelectorAll("[data-treat]").forEach(b=>{
        makePressable(b, 8);
        b.addEventListener("click", ()=> treatOne(tid, b.getAttribute("data-treat")));
      });

      setBottomButtons([
        { text:"â† Î Î¯ÏƒÏ‰", kind:"", onClick: ()=> gotoTable(tid) },
        { text:"+ Î ÏÎ¿ÏŠÏŒÎ½", kind:"accent", onClick: ()=> gotoAdd(tid) }
      ]);
    }

    /* SUMMARY */
    function renderSummary(){
      const pay = db.days[TODAY].payments || [];
      const totals = { cash:0, card:0, treat:0, all:0 };
      const byUser = new Map();

      for(const p of pay){
        totals.all += p.price;
        if(p.method==="cash") totals.cash += p.price;
        if(p.method==="card") totals.card += p.price;
        if(p.method==="treat") totals.treat += p.price;

        const k = p.by || "â€”";
        if(!byUser.has(k)) byUser.set(k, { cash:0, card:0, treat:0, all:0, count:0 });
        const o = byUser.get(k);
        o.all += p.price; o.count += 1;
        if(p.method==="cash") o.cash += p.price;
        if(p.method==="card") o.card += p.price;
        if(p.method==="treat") o.treat += p.price;
      }

      const usersArr = [...byUser.entries()].sort((a,b)=>b[1].all-a[1].all);

      view.innerHTML = `
        <div class="card">
          <div class="h">Î£ÏÎ½Î¿ÏˆÎ· â€¢ ${TODAY}</div>
          <div class="row" style="flex-wrap:wrap;">
            <div class="pill">Î£ÏÎ½Î¿Î»Î¿: <b>${euro(totals.all)}</b></div>
            <div class="pill">ÎœÎµÏ„ÏÎ·Ï„Î¬: <b>${euro(totals.cash)}</b></div>
            <div class="pill">ÎšÎ¬ÏÏ„Î±: <b>${euro(totals.card)}</b></div>
            <div class="pill">ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±: <b>${euro(totals.treat)}</b></div>
          </div>
          <div class="small">Î Î¬Ï„Î± Ï‡ÏÎ®ÏƒÏ„Î· Î³Î¹Î± Î±Î½Î¬Î»Ï…ÏƒÎ·.</div>
        </div>

        <div class="card">
          <div class="h">Î‘Î½Î¬ Ï‡ÏÎ®ÏƒÏ„Î·</div>
          ${usersArr.length===0 ? `<div class="muted2">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚ Î±ÎºÏŒÎ¼Î±.</div>` : `
            <div class="list">
              ${usersArr.map(([uname,o])=>`
                <div class="li pressable" data-user="${escapeHtml(uname)}">
                  <div class="left">
                    <div class="name">${escapeHtml(uname)}</div>
                    <div class="meta">${o.count} ÎºÎ¹Î½Î®ÏƒÎµÎ¹Ï‚ â€¢ ÎœÎµÏ„ÏÎ·Ï„Î¬ ${euro(o.cash)} â€¢ ÎšÎ¬ÏÏ„Î± ${euro(o.card)} â€¢ ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î± ${euro(o.treat)}</div>
                  </div>
                  <div class="price">${euro(o.all)}</div>
                </div>
              `).join("")}
            </div>
          `}
        </div>
      `;

      view.querySelectorAll("[data-user]").forEach(li=>{
        makePressable(li, 8);
        li.addEventListener("click", ()=>{
          const uname = li.getAttribute("data-user");
          userBreakdown(uname);
        });
      });

      setBottomButtons([
        { text:"â† Home", kind:"", onClick: ()=> gotoHome() },
        { text:"CSV", kind:"", onClick: ()=> exportCSV() },
        { text:"Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚", kind:"", onClick: ()=> openSettings() },
      ]);
    }

    function userBreakdown(uname){
      const pay = (db.days[TODAY].payments || []).filter(p => (p.by||"â€”")===uname);
      let html = `<div class="small">ÎšÎ¹Î½Î®ÏƒÎµÎ¹Ï‚: <b>${pay.length}</b></div>`;
      html += `<div class="list">` + pay.slice().reverse().map(p=>`
        <div class="li">
          <div class="left">
            <div class="name">${escapeHtml(p.name)}</div>
            <div class="meta">${methodLabel(p.method)} â€¢ ${escapeHtml(p.tableId)} â€¢ ${new Date(p.ts).toLocaleTimeString("el-GR",{hour:"2-digit",minute:"2-digit"})}</div>
          </div>
          <div class="price">${euro(p.price)}</div>
        </div>
      `).join("") + `</div>`;

      openModal({
        title:`Î‘Î½Î¬Î»Ï…ÏƒÎ·: ${uname}`,
        bodyHtml: html,
        buttons:[ { text:"ÎŸÎš", cls:"good", onClick: closeModal } ]
      });
    }

    /* CSV */
    function exportCSV(){
      haptic(12);
      const pay = db.days[TODAY].payments || [];
      const rows = [["date","time","table","product","price","method","user"].join(",")];
      for(const p of pay){
        const d = new Date(p.ts);
        rows.push([
          TODAY,
          d.toLocaleTimeString("el-GR",{hour:"2-digit",minute:"2-digit"}),
          p.tableId,
          `"${String(p.name).replaceAll('"','""')}"`,
          Number(p.price).toFixed(2),
          p.method,
          `"${String(p.by||"").replaceAll('"','""')}"`
        ].join(","));
      }
      const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `daily_cashier_${TODAY}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /* SETTINGS (Owner PIN required for user admin) */
    async function openSettings(){
      openModal({
        title:"Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚",
        bodyHtml: `
          <div class="card" style="margin:0; padding:12px;">
            <div class="h">ÎŒÎ½Î¿Î¼Î± Î¼Î±Î³Î±Î¶Î¹Î¿Ï (Î¼ÏŒÎ½Î¿ Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·Ï‚)</div>
            <div class="small">Î“Î¹Î± Î±Î»Î»Î±Î³Î® Î¶Î·Ï„Î¬ÎµÎ¹ PIN Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·.</div>
            <div class="row space">
              <div class="pill" style="flex:1; min-width:0;">Î¤ÏÎ­Ï‡Î¿Î½: <b>${escapeHtml(db.shopName)}</b></div>
              <button class="btn pressable accent" style="flex:0 0 auto; height:38px; border-radius:999px;" id="btnChangeShop">Î‘Î»Î»Î±Î³Î®</button>
            </div>
          </div>

          <div class="card" style="margin:0; padding:12px;">
            <div class="h">PIN Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·</div>
            <div class="small">Î†Î»Î»Î±Î¾Î­ Ï„Î¿ ÏƒÎµ ÎºÎ¬Ï„Î¹ Ï€Î¿Ï… Î¾Î­ÏÎµÎ¹Ï‚ Î¼ÏŒÎ½Î¿ ÎµÏƒÏ.</div>
            <button class="btn pressable" style="height:38px; border-radius:999px;" id="btnChangeOwnerPin">Î‘Î»Î»Î±Î³Î® PIN</button>
          </div>

          <div class="card" style="margin:0; padding:12px;">
            <div class="h">Î¥Ï€Î¬Î»Î»Î·Î»Î¿Î¹ (Î¿Î½ÏŒÎ¼Î±Ï„Î± + PIN)</div>
            <div class="small">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·/ÎœÎµÏ„Î¿Î½Î¿Î¼Î±ÏƒÎ¯Î±/Î‘Î»Î»Î±Î³Î® PIN Î¼ÏŒÎ½Î¿ Î¼Îµ PIN Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·.</div>
            <div class="row" style="gap:10px; flex-wrap:wrap;">
              <button class="btn pressable accent" style="height:38px; border-radius:999px;" id="btnAddUser">+ ÎÎ­Î¿Ï‚</button>
            </div>
            <div class="list" style="margin-top:10px;">
              ${db.users.map(u=>`
                <div class="li">
                  <div class="left">
                    <div class="name">${escapeHtml(u.name)}</div>
                    <div class="meta">PIN: ${u.pin ? "â—â—â—â—" : "<span class='dangerText'>Î§Ï‰ÏÎ¯Ï‚ PIN (ÏŒÏ‡Î¹ ÎµÏ€Î¹Ï„ÏÎµÏ€Ï„ÏŒ)</span>"}</div>
                  </div>
                  <div class="qty">
                    <button class="qbtn pressable" data-rename="${u.id}">ÎŒÎ½Î¿Î¼Î±</button>
                    <button class="qbtn pressable" data-pin="${u.id}">PIN</button>
                    <button class="qbtn pressable" data-del="${u.id}">ğŸ—‘</button>
                  </div>
                </div>
              `).join("")}
            </div>
          </div>

          <div class="card" style="margin:0; padding:12px;">
            <div class="h">Î‘Î´ÏÎ¬Î½ÎµÎ¹Î±</div>
            <div class="small">40s Î±Î´ÏÎ¬Î½ÎµÎ¹Î± â†’ Home. +12s â†’ screensaver.</div>
          </div>
        `,
        buttons: [ { text:"ÎŸÎš", cls:"good", onClick: closeModal } ]
      });

      setTimeout(()=>{
        const cshop = document.getElementById("btnChangeShop");
        const cpin  = document.getElementById("btnChangeOwnerPin");
        const addU  = document.getElementById("btnAddUser");
        if(cshop){ makePressable(cshop,8); cshop.addEventListener("click", changeShopNameOwnerOnly); }
        if(cpin){ makePressable(cpin,8); cpin.addEventListener("click", changeOwnerPin); }
        if(addU){ makePressable(addU,8); addU.addEventListener("click", addUserFlow); }

        modalBody.querySelectorAll("[data-rename]").forEach(b=>{
          makePressable(b,8);
          b.addEventListener("click", ()=> renameUserFlow(b.getAttribute("data-rename")));
        });
        modalBody.querySelectorAll("[data-pin]").forEach(b=>{
          makePressable(b,8);
          b.addEventListener("click", ()=> setUserPinFlow(b.getAttribute("data-pin")));
        });
        modalBody.querySelectorAll("[data-del]").forEach(b=>{
          makePressable(b,8);
          b.addEventListener("click", ()=> deleteUserFlow(b.getAttribute("data-del")));
        });
      },0);
    }

    async function requireOwner(){
      const pin = await askPin({ title:"PIN Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·", hint:"Î“Î¹Î± Î±Ï…Ï„Î® Ï„Î·Î½ ÎµÎ½Î­ÏÎ³ÎµÎ¹Î± Î±Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ PIN Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·." });
      if(pin===null) return false;
      if(pin !== db.ownerPin){
        await confirmModal({ title:"Î›Î¬Î¸Î¿Ï‚ PIN", bodyHtml:`<div class="small dangerText">Î›Î¬Î¸Î¿Ï‚ PIN Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·.</div>`, okText:"ÎŸÎš", cancelText:"" });
        return false;
      }
      return true;
    }

    async function changeShopNameOwnerOnly(){
      if(!(await requireOwner())) return;
      const name = await askText("ÎÎ­Î¿ ÏŒÎ½Î¿Î¼Î± Î¼Î±Î³Î±Î¶Î¹Î¿Ï", "Î Î»Î·ÎºÏ„ÏÎ¿Î»ÏŒÎ³Î·ÏƒÎµ Ï„Î¿ Î½Î­Î¿ ÏŒÎ½Î¿Î¼Î±.");
      if(!name) return;
      db.shopName = name.trim().slice(0,40);
      saveDB();
      setTop();
      closeModal();
      render();
    }

    async function changeOwnerPin(){
      const ok = await requireOwner();
      if(!ok) return;
      const newPin = await askPin({ title:"ÎÎ­Î¿ PIN Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·", hint:"Î”ÏÏƒÎµ Î½Î­Î¿ PIN (Î¼ÏŒÎ½Î¿ Î±ÏÎ¹Î¸Î¼Î¿ÏÏ‚)." });
      if(!newPin) return;
      db.ownerPin = newPin;
      saveDB();
      await confirmModal({ title:"ÎˆÎ³Î¹Î½Îµ", bodyHtml:`<div class="small okText">Î‘Î»Î»Î¬Ï‡Ï„Î·ÎºÎµ Ï„Î¿ PIN Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·.</div>`, okText:"ÎŸÎš", cancelText:"" });
      closeModal();
    }

    async function addUserFlow(){
      if(!(await requireOwner())) return;
      const name = await askText("ÎÎ­Î¿Ï‚ Ï…Ï€Î¬Î»Î»Î·Î»Î¿Ï‚", "Î’Î¬Î»Îµ ÏŒÎ½Î¿Î¼Î± Ï…Ï€Î±Î»Î»Î®Î»Î¿Ï… (Ï€.Ï‡. ÎœÎ±ÏÎ¯Î±).");
      if(!name) return;
      const pin = await askPin({ title:"PIN Ï…Ï€Î±Î»Î»Î®Î»Î¿Ï…", hint:"Î’Î¬Î»Îµ PIN (Î¼ÏŒÎ½Î¿ Î±ÏÎ¹Î¸Î¼Î¿ÏÏ‚).", maxLen:8 });
      if(!pin){ await confirmModal({ title:"Î‘ÎºÏ…ÏÏÎ¸Î·ÎºÎµ", bodyHtml:`<div class="small dangerText">Î§Ï‰ÏÎ¯Ï‚ PIN Î´ÎµÎ½ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯Ï„Î±Î¹ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚.</div>`, okText:"ÎŸÎš", cancelText:"" }); return; }

      const id = "u" + uid();
      db.users.push({ id, name: name.trim().slice(0,26), pin });
      saveDB();
      fillUsers();
      setTop();
      closeModal();
      openSettings();
    }

    async function renameUserFlow(userId){
      if(!(await requireOwner())) return;
      const u = db.users.find(x=>x.id===userId);
      if(!u) return;
      const name = await askText("ÎœÎµÏ„Î¿Î½Î¿Î¼Î±ÏƒÎ¯Î±", `Î¤ÏÎ­Ï‡Î¿Î½: ${u.name}`);
      if(!name) return;
      u.name = name.trim().slice(0,26);
      saveDB();
      fillUsers();
      setTop();
      closeModal();
      openSettings();
    }

    async function setUserPinFlow(userId){
      if(!(await requireOwner())) return;
      const u = db.users.find(x=>x.id===userId);
      if(!u) return;
      const pin = await askPin({ title:`PIN Î³Î¹Î± ${u.name}`, hint:"Î’Î¬Î»Îµ Î½Î­Î¿ PIN (Î¼ÏŒÎ½Î¿ Î±ÏÎ¹Î¸Î¼Î¿ÏÏ‚).", maxLen:8 });
      if(!pin) return;
      u.pin = pin;
      saveDB();
      closeModal();
      openSettings();
    }

    async function deleteUserFlow(userId){
      if(!(await requireOwner())) return;
      const u = db.users.find(x=>x.id===userId);
      if(!u) return;

      if(db.users.length<=1){
        await confirmModal({ title:"Î”ÎµÎ½ Î³Î¯Î½ÎµÏ„Î±Î¹", bodyHtml:`<div class="small dangerText">Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 1 Ï‡ÏÎ®ÏƒÏ„Î·Ï‚.</div>`, okText:"ÎŸÎš", cancelText:"" });
        return;
      }
      const ok = await confirmModal({
        title:"Î”Î¹Î±Î³ÏÎ±Ï†Î® Ï…Ï€Î±Î»Î»Î®Î»Î¿Ï…",
        bodyHtml:`<div class="small dangerText">ÎÎ± Î´Î¹Î±Î³ÏÎ±Ï†ÎµÎ¯ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ â€œ${escapeHtml(u.name)}â€; (Î”ÎµÎ½ ÏƒÎ²Î®Î½ÎµÎ¹ Ï€Î±Î»Î¹Î¬ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±, Î¼ÏŒÎ½Î¿ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î·.)</div>`,
        okText:"Î”Î¹Î±Î³ÏÎ±Ï†Î®",
        cancelText:"Î†ÎºÏ…ÏÎ¿",
        danger:true
      });
      if(!ok) return;

      // If current user deleted -> switch to first remaining
      db.users = db.users.filter(x=>x.id!==userId);
      if(db.currentUserId===userId) db.currentUserId = db.users[0].id;

      saveDB();
      fillUsers();
      setTop();
      closeModal();
      openSettings();
      render();
    }

    /* USER SWITCH: mandatory PIN */
    el("userSelect").addEventListener("change", async ()=>{
      const newId = el("userSelect").value;
      const u = db.users.find(x=>x.id===newId);
      if(!u){ fillUsers(); return; }

      // Must have PIN
      if(!u.pin){
        await confirmModal({ title:"Î§ÏÎ®ÏƒÏ„Î·Ï‚ Ï‡Ï‰ÏÎ¯Ï‚ PIN", bodyHtml:`<div class="small dangerText">Î‘Ï…Ï„ÏŒÏ‚ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ PIN. ÎŸÏÎ¯ÏƒÏ„Îµ PIN Î±Ï€ÏŒ Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚.</div>`, okText:"ÎŸÎš", cancelText:"" });
        fillUsers();
        return;
      }

      const pin = await askPin({ title:"PIN Ï‡ÏÎ®ÏƒÏ„Î·", hint:`Î”ÏÏƒÎµ PIN Î³Î¹Î± ${u.name}` });
      if(pin !== u.pin){
        await confirmModal({ title:"Î›Î¬Î¸Î¿Ï‚ PIN", bodyHtml:`<div class="small dangerText">Î›Î¬Î¸Î¿Ï‚ PIN.</div>`, okText:"ÎŸÎš", cancelText:"" });
        fillUsers();
        return;
      }

      db.currentUserId = newId;
      saveDB();
      setTop();
      render();
    });

    /* bottom + screens */
    function setBottomButtons(btns){
      bottomBar.innerHTML = "";
      if(!btns || btns.length===0){ bottom.style.display="none"; return; }
      bottom.style.display="block";
      for(const b of btns){
        const btn = document.createElement("button");
        btn.className = "btn pressable " + (b.kind || "");
        btn.textContent = b.text;
        btn.addEventListener("click", (ev)=>{
          pressPulse(btn, ev.clientX, ev.clientY);
          haptic(10);
          b.onClick();
        });
        bottomBar.appendChild(btn);
        makePressable(btn, 10);
      }
    }

    /* HOME */
    function renderHome(){
      view.innerHTML = `
        <div class="tables">
          ${db.tables.map(t=>{
            const total = tableTotal(t.id);
            const count = unpaidItems(t.id).length;
            const isOpen = total>0;
            return `
              <button class="tbtn pressable ${isOpen?"open":""}" data-tid="${t.id}">
                <div class="title">${t.label}</div>
                <div class="sub">${isOpen ? ("Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: " + euro(total)) : "â€”"}</div>
                <div class="badge">${count}</div>
              </button>
            `;
          }).join("")}
        </div>
      `;

      view.querySelectorAll("[data-tid]").forEach(b=>{
        makePressable(b, 12);
        b.addEventListener("click", ()=> gotoTable(b.getAttribute("data-tid")));
      });

      setBottomButtons([
        { text:"Î£ÏÎ½Î¿ÏˆÎ·", kind:"accent", onClick: ()=> gotoSummary() },
        { text:"CSV", kind:"", onClick: ()=> exportCSV() },
        { text:"Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚", kind:"", onClick: ()=> openSettings() }
      ]);
    }

    /* TABLE */
    function renderTable(){
      const tid = state.tableId;
      const t = db.tables.find(x=>x.id===tid);
      const groups = groupUnpaid(tid);
      const total = tableTotal(tid);

      view.innerHTML = `
        <div class="card">
          <div class="row space">
            <div>
              <div class="h">Î¤ÏÎ±Ï€Î­Î¶Î¹: ${escapeHtml(t?.label || tid)}</div>
              <div class="muted">Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: <b>${euro(total)}</b></div>
            </div>
          </div>
          <div class="small">Î“ÏÎ®Î³Î¿ÏÎ±: Î Î¯ÏƒÏ‰ / + Î ÏÎ¿ÏŠÏŒÎ½ / Î Î»Î·ÏÏ‰Î¼Î®</div>
        </div>

        <div class="card">
          <div class="h">Î‘Î½Î¿Î¹Ï‡Ï„Î¬ items</div>
          ${groups.length===0 ? `<div class="okText">ÎšÎ±Î¸Î±ÏÏŒ âœ…</div>` : `
            <div class="list">
              ${groups.map(g=>`
                <div class="li">
                  <div class="left">
                    <div class="name">${escapeHtml(g.name)}</div>
                    <div class="meta">${euro(g.price)} â€¢ ${g.qty} Ï„ÎµÎ¼.</div>
                  </div>
                  <div class="qty">
                    <button class="qbtn pressable" data-minus="${g.prodId}">âˆ’</button>
                    <div class="qnum">${g.qty}</div>
                    <button class="qbtn pressable" data-plus="${g.prodId}">+</button>
                  </div>
                </div>
              `).join("")}
            </div>
          `}
        </div>
      `;

      view.querySelectorAll("[data-minus]").forEach(b=>{
        makePressable(b, 8);
        b.addEventListener("click", ()=> removeOneUnit(tid, b.getAttribute("data-minus")));
      });
      view.querySelectorAll("[data-plus]").forEach(b=>{
        makePressable(b, 8);
        b.addEventListener("click", ()=> addProductToTable(b.getAttribute("data-plus")));
      });

      setBottomButtons([
        { text:"â† Î Î¯ÏƒÏ‰", kind:"", onClick: ()=> gotoHome() },
        { text:"+ Î ÏÎ¿ÏŠÏŒÎ½", kind:"accent", onClick: ()=> gotoAdd(tid) },
        { text:"Î Î»Î·ÏÏ‰Î¼Î®", kind:"good", onClick: ()=> gotoPay(tid) }
      ]);
    }

    /* ADD */
    function renderAdd(){
      const tid = state.tableId;
      const t = db.tables.find(x=>x.id===tid);
      const cats = db.menu.categories;
      const activeCat = state.categoryId || cats[0]?.id || null;
      const products = db.menu.products.filter(p=>p.cat===activeCat);

      view.innerHTML = `
        <div class="card">
          <div class="row space">
            <div>
              <div class="h">+ Î ÏÎ¿ÏŠÏŒÎ½ â€¢ ${escapeHtml(t?.label || tid)}</div>
              <div class="muted">Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ Ï„ÏÏÎ±: <b>${euro(tableTotal(tid))}</b></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="h">ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚</div>
          <div class="chips" id="catChips">
            ${cats.map(c=>`
              <button class="chip pressable ${c.id===activeCat?"active":""}" data-cat="${c.id}">
                ${c.emoji} ${escapeHtml(c.name)}
              </button>
            `).join("")}
          </div>
          <div class="small">Swipe Î¿ÏÎ¹Î¶ÏŒÎ½Ï„Î¹Î± ÏƒÏ„Î¹Ï‚ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚.</div>
        </div>

        <div class="card">
          <div class="h">Î ÏÎ¿ÏŠÏŒÎ½Ï„Î±</div>
          <div class="list">
            ${products.map(p=>`
              <div class="li pressable" data-add="${p.id}">
                <div class="left">
                  <div class="name">${escapeHtml(p.name)}</div>
                  <div class="meta">${escapeHtml(catTitle(p.cat))}</div>
                </div>
                <div class="price">${euro(p.price)}</div>
              </div>
            `).join("")}
          </div>
          <div class="small">Î Î¬Ï„Î± Î³ÏÎ±Î¼Î¼Î® Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î¿Ï‚ â†’ Ï€ÏÎ¿ÏƒÏ„Î¯Î¸ÎµÏ„Î±Î¹.</div>
        </div>
      `;

      view.querySelectorAll("[data-cat]").forEach(b=>{
        makePressable(b, 8);
        b.addEventListener("click", ()=>{
          state.categoryId = b.getAttribute("data-cat");
          render();
        });
      });

      view.querySelectorAll("[data-add]").forEach(li=>{
        makePressable(li, 8);
        li.addEventListener("click", ()=> addProductToTable(li.getAttribute("data-add")));
      });

      setBottomButtons([
        { text:"â† Î Î¯ÏƒÏ‰", kind:"", onClick: ()=> gotoTable(tid) },
        { text:"Î Î»Î·ÏÏ‰Î¼Î®", kind:"good", onClick: ()=> gotoPay(tid) }
      ]);
    }
    function catTitle(catId){
      const c = db.menu.categories.find(x=>x.id===catId);
      return c ? `${c.emoji} ${c.name}` : "";
    }

    /* PAY */
    async function treatOne(tid, prodId){
      const it = findOneUnpaidUnit(tid, prodId);
      if(!it) return;

      const ok = await confirmModal({
        title:"ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î¿",
        bodyHtml:`<div class="small">ÎÎ± Î³Î¯Î½ÎµÎ¹ ÎºÎµÏÎ±ÏƒÎ¼Î­Î½Î¿ <b>1 Ï„ÎµÎ¼.</b> â€œ${escapeHtml(it.name)}â€;</div>`,
        okText:"ÎÎ±Î¹",
        cancelText:"Î†ÎºÏ…ÏÎ¿"
      });
      if(!ok) return;

      it.paid = { method:"treat", ts: Date.now(), by: getUser()?.name || "" };
      db.days[TODAY].payments.push({
        id: uid(),
        tableId: tid,
        prodId: it.prodId,
        name: it.name,
        price: it.price,
        method: "treat",
        ts: it.paid.ts,
        by: it.paid.by
      });

      saveDB();
      render();
    }

    async function payAll(tid, method){
      const items = unpaidItems(tid);
      if(items.length===0){
        await confirmModal({ title:"Î Î»Î·ÏÏ‰Î¼Î®", bodyHtml:`<div class="small">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿.</div>`, okText:"ÎŸÎš", cancelText:"" });
        gotoHome();
        return;
      }

      const ok = await confirmModal({
        title:"Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·",
        bodyHtml:`<div class="small">ÎÎ± Ï€Î»Î·ÏÏ‰Î¸ÎµÎ¯ <b>ÏŒÎ»Î¿</b> Ï„Î¿ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ (${euro(tableTotal(tid))}) Î¼Îµ <b>${methodLabel(method)}</b>;</div>`,
        okText:"ÎÎ±Î¹",
        cancelText:"Î†ÎºÏ…ÏÎ¿"
      });
      if(!ok) return;

      const u = getUser()?.name || "";
      const ts = Date.now();

      for(const it of items){
        it.paid = { method, ts, by: u };
        db.days[TODAY].payments.push({
          id: uid(),
          tableId: tid,
          prodId: it.prodId,
          name: it.name,
          price: it.price,
          method,
          ts,
          by: u
        });
      }

      saveDB();
      gotoHome();
    }

    function renderPay(){
      const tid = state.tableId;
      const t = db.tables.find(x=>x.id===tid);
      const groups = groupUnpaid(tid);
      const total = tableTotal(tid);

      view.innerHTML = `
        <div class="card">
          <div class="h">Î Î»Î·ÏÏ‰Î¼Î® â€¢ ${escapeHtml(t?.label || tid)}</div>
          <div class="muted">Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: <b>${euro(total)}</b></div>
          <div class="row" style="gap:10px; margin-top:10px;">
            <button class="btn pressable good" style="flex:1;" id="payCash">Î Î›Î—Î¡Î©ÎœÎ— ÎœÎ•Î¤Î¡Î—Î¤Î‘</button>
            <button class="btn pressable accent" style="flex:1;" id="payCard">Î Î›Î—Î¡Î©ÎœÎ— ÎšÎ‘Î¡Î¤Î‘</button>
          </div>
          <div class="small">Î¤Î¿ â€œÎºÎµÏÎ±ÏƒÎ¼Î­Î½Î¿â€ Î±Ï†Î±Î¹ÏÎµÎ¯ 1 Ï„ÎµÎ¼. Î±Ï€ÏŒ Ï„Î¿ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿.</div>
        </div>

        <div class="card">
          <div class="h">Î‘Î½Î¿Î¹Ï‡Ï„Î¬ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±</div>
          ${groups.length===0 ? `<div class="okText">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ âœ…</div>` : `
            <div class="list">
              ${groups.map(g=>`
                <div class="li">
                  <div class="left">
                    <div class="name">${escapeHtml(g.name)}</div>
                    <div class="meta">${euro(g.price)} â€¢ ${g.qty} Ï„ÎµÎ¼.</div>
                  </div>
                  <div class="qty">
                    <button class="qbtn pressable" title="ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î¿ 1 Ï„ÎµÎ¼." data-treat="${g.prodId}">ğŸ</button>
                  </div>
                </div>
              `).join("")}
            </div>
          `}
        </div>
      `;

      const payCash = el("payCash");
      const payCard = el("payCard");
      makePressable(payCash, 14);
      makePressable(payCard, 14);
      payCash.addEventListener("click", ()=> payAll(tid, "cash"));
      payCard.addEventListener("click", ()=> payAll(tid, "card"));

      view.querySelectorAll("[data-treat]").forEach(b=>{
        makePressable(b, 8);
        b.addEventListener("click", ()=> treatOne(tid, b.getAttribute("data-treat")));
      });

      setBottomButtons([
        { text:"â† Î Î¯ÏƒÏ‰", kind:"", onClick: ()=> gotoTable(tid) },
        { text:"+ Î ÏÎ¿ÏŠÏŒÎ½", kind:"accent", onClick: ()=> gotoAdd(tid) }
      ]);
    }

    /* SUMMARY */
    function renderSummary(){
      const pay = db.days[TODAY].payments || [];
      const totals = { cash:0, card:0, treat:0, all:0 };
      const byUser = new Map();

      for(const p of pay){
        totals.all += p.price;
        if(p.method==="cash") totals.cash += p.price;
        if(p.method==="card") totals.card += p.price;
        if(p.method==="treat") totals.treat += p.price;

        const k = p.by || "â€”";
        if(!byUser.has(k)) byUser.set(k, { cash:0, card:0, treat:0, all:0, count:0 });
        const o = byUser.get(k);
        o.all += p.price; o.count += 1;
        if(p.method==="cash") o.cash += p.price;
        if(p.method==="card") o.card += p.price;
        if(p.method==="treat") o.treat += p.price;
      }

      const usersArr = [...byUser.entries()].sort((a,b)=>b[1].all-a[1].all);

      view.innerHTML = `
        <div class="card">
          <div class="h">Î£ÏÎ½Î¿ÏˆÎ· â€¢ ${TODAY}</div>
          <div class="row" style="flex-wrap:wrap;">
            <div class="pill">Î£ÏÎ½Î¿Î»Î¿: <b>${euro(totals.all)}</b></div>
            <div class="pill">ÎœÎµÏ„ÏÎ·Ï„Î¬: <b>${euro(totals.cash)}</b></div>
            <div class="pill">ÎšÎ¬ÏÏ„Î±: <b>${euro(totals.card)}</b></div>
            <div class="pill">ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±: <b>${euro(totals.treat)}</b></div>
          </div>
          <div class="small">Î Î¬Ï„Î± Ï‡ÏÎ®ÏƒÏ„Î· Î³Î¹Î± Î±Î½Î¬Î»Ï…ÏƒÎ·.</div>
        </div>

        <div class="card">
          <div class="h">Î‘Î½Î¬ Ï‡ÏÎ®ÏƒÏ„Î·</div>
          ${usersArr.length===0 ? `<div class="muted2">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚ Î±ÎºÏŒÎ¼Î±.</div>` : `
            <div class="list">
              ${usersArr.map(([uname,o])=>`
                <div class="li pressable" data-user="${escapeHtml(uname)}">
                  <div class="left">
                    <div class="name">${escapeHtml(uname)}</div>
                    <div class="meta">${o.count} ÎºÎ¹Î½Î®ÏƒÎµÎ¹Ï‚ â€¢ ÎœÎµÏ„ÏÎ·Ï„Î¬ ${euro(o.cash)} â€¢ ÎšÎ¬ÏÏ„Î± ${euro(o.card)} â€¢ ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î± ${euro(o.treat)}</div>
                  </div>
                  <div class="price">${euro(o.all)}</div>
                </div>
              `).join("")}
            </div>
          `}
        </div>
      `;

      view.querySelectorAll("[data-user]").forEach(li=>{
        makePressable(li, 8);
        li.addEventListener("click", ()=> userBreakdown(li.getAttribute("data-user")));
      });

      setBottomButtons([
        { text:"â† Home", kind:"", onClick: ()=> gotoHome() },
        { text:"CSV", kind:"", onClick: ()=> exportCSV() },
        { text:"Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚", kind:"", onClick: ()=> openSettings() }
      ]);
    }

    function userBreakdown(uname){
      const pay = (db.days[TODAY].payments || []).filter(p => (p.by||"â€”")===uname);
      let html = `<div class="small">ÎšÎ¹Î½Î®ÏƒÎµÎ¹Ï‚: <b>${pay.length}</b></div>`;
      html += `<div class="list">` + pay.slice().reverse().map(p=>`
        <div class="li">
          <div class="left">
            <div class="name">${escapeHtml(p.name)}</div>
            <div class="meta">${methodLabel(p.method)} â€¢ ${escapeHtml(p.tableId)} â€¢ ${new Date(p.ts).toLocaleTimeString("el-GR",{hour:"2-digit",minute:"2-digit"})}</div>
          </div>
          <div class="price">${euro(p.price)}</div>
        </div>
      `).join("") + `</div>`;

      openModal({ title:`Î‘Î½Î¬Î»Ï…ÏƒÎ·: ${uname}`, bodyHtml: html, buttons:[{text:"ÎŸÎš", cls:"good", onClick: closeModal}] });
    }

    function exportCSV(){
      haptic(12);
      const pay = db.days[TODAY].payments || [];
      const rows = [["date","time","table","product","price","method","user"].join(",")];
      for(const p of pay){
        const d = new Date(p.ts);
        rows.push([
          TODAY,
          d.toLocaleTimeString("el-GR",{hour:"2-digit",minute:"2-digit"}),
          p.tableId,
          `"${String(p.name).replaceAll('"','""')}"`,
          Number(p.price).toFixed(2),
          p.method,
          `"${String(p.by||"").replaceAll('"','""')}"`
        ].join(","));
      }
      const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `daily_cashier_${TODAY}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /* Idle */
    function resetIdle(){
      if(idleTimer) clearTimeout(idleTimer);
      if(saverTimer) clearTimeout(saverTimer);
      saver.style.display = "none";
      idleTimer = setTimeout(()=>{
        gotoHome();
        saverTimer = setTimeout(()=>{ saver.style.display = "flex"; }, IDLE_TO_SAVER_AFTER_HOME_MS);
      }, IDLE_TO_HOME_MS);
    }

    /* Render router */
    function render(){
      setTop();
      if(state.screen==="home") renderHome();
      else if(state.screen==="table") renderTable();
      else if(state.screen==="add") renderAdd();
      else if(state.screen==="pay") renderPay();
      else if(state.screen==="summary") renderSummary();
      resetIdle();
      // Make top buttons pressable
      makePressable(el("btnSettings"), 10);
    }

    /* SW register */
    async function registerSW(){
      if(!("serviceWorker" in navigator)) return;
      try{
        const reg = await navigator.serviceWorker.register("./sw.js", { scope:"./" });
        if(reg.update) reg.update();
      }catch(e){}
    }

    // Init + enforce current user has PIN
    function initSecurity(){
      // Ensure current user exists and has PIN
      const cur = getUser();
      if(!cur || !cur.pin){
        // force owner to set PIN via settings
        confirmModal({
          title:"Î‘ÏƒÏ†Î¬Î»ÎµÎ¹Î±",
          bodyHtml:`<div class="small dangerText">ÎŸ Ï„ÏÎ­Ï‡Ï‰Î½ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ PIN. Î Î®Î³Î±Î¹Î½Îµ Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ â†’ Î¥Ï€Î¬Î»Î»Î·Î»Î¿Î¹ ÎºÎ±Î¹ ÏŒÏÎ¹ÏƒÎµ PIN.</div>`,
          okText:"ÎŸÎš",
          cancelText:""
        });
      }
    }

    // wiring
    el("btnSettings").addEventListener("click", ()=>{ haptic(10); openSettings(); });
    makePressable(el("btnSettings"), 10);

    // idle listeners
    ["click","touchstart","keydown","pointerdown","scroll"].forEach(ev=>{
      window.addEventListener(ev, resetIdle, {passive:true});
    });
    saver.addEventListener("click", ()=>{ saver.style.display="none"; resetIdle(); haptic(12); });
    saver.addEventListener("touchstart", ()=>{ saver.style.display="none"; resetIdle(); haptic(12); }, {passive:true});

    // Start
    fillUsers();
    setTop();
    render();
    registerSW();
    initSecurity();
    resetIdle();
  </script>
</body>
</html>