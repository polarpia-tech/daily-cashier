<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Î—Î¼ÎµÏÎ®ÏƒÎ¹Î¿ Î¤Î±Î¼ÎµÎ¯Î¿</title>

  <style>
    :root{
      --bg:#0b0f14;
      --card:#141a22;
      --line:rgba(255,255,255,.10);
      --text:#eef2ff;
      --muted:#a9b1c3;
      --accent:#4cc3ff;
      --ok:#44d08a;
      --bad:#ff6363;
      --warn:#ffcc66;

      --r:16px;
      --pad:12px;
      --tap:42px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background: var(--bg);
      color: var(--text);
      overflow-x:hidden;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    .wrap{ width:min(980px, calc(100% - 16px)); margin:0 auto; }
    header{ padding:10px 0 6px; }

    .top{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand b{ font-size:18px; }
    .brand .muted{ font-size:12px; color:var(--muted); }

    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill{
      display:flex; gap:8px; align-items:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      white-space:nowrap;
      font-size:13px;
    }
    .pill b{ color:var(--text); }

    select{
      height: var(--tap);
      border-radius: 12px;
      padding:0 10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
      font-size:14px;
    }

    .btn{
      height: var(--tap);
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      font-weight:800;
      padding:0 12px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ border-color: rgba(76,195,255,.45); }
    .btn.ok{ border-color: rgba(68,208,138,.55); }
    .btn.bad{ border-color: rgba(255,99,99,.55); background: rgba(255,99,99,.08); }
    .btn.warn{ border-color: rgba(255,204,102,.55); background: rgba(255,204,102,.08); }

    .tabs{
      display:flex; gap:6px;
      padding:6px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      width:100%;
    }
    .tab{ flex:1; min-width:120px; background:transparent; }
    .tab.active{
      background: rgba(76,195,255,.12);
      border-color: rgba(76,195,255,.45);
    }

    .divider{ height:1px; background: var(--line); margin:10px 0; }

    main{ padding: 6px 0 14px; }
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 860px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    .card{
      border:1px solid var(--line);
      border-radius: var(--r);
      background: rgba(255,255,255,.02);
      padding: var(--pad);
      overflow:hidden;
    }
    .title{ font-size:16px; font-weight:900; }
    .muted{ color:var(--muted); font-size:13px; }

    /* TABLE GRID */
    #tablesGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (min-width:520px){ #tablesGrid{ grid-template-columns: 1fr 1fr 1fr; } }
    @media (min-width:860px){ #tablesGrid{ grid-template-columns: 1fr 1fr 1fr 1fr; } }

    #tablesGrid button{
      height: 56px;
      border-radius: 16px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:4px;
      font-weight:900;
      font-size:15px;
    }
    #tablesGrid button .sub{ font-size:12px; color:var(--muted); font-weight:800; }

    /* CATS */
    #catsRow{
      display:flex;
      gap:8px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom:6px;
    }
    #catsRow .btn{
      height: 40px;
      border-radius: 12px;
      font-size:13px;
    }

    /* PRODUCTS */
    #productsList{ display:flex; flex-direction:column; gap:10px; }
    .product{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding: 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
    }
    .product b{ font-size:15px; }
    .price{ font-weight:900; }

    input[type="search"]{
      height: var(--tap);
      border-radius: 12px;
      padding: 0 10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
      width: 100%;
      max-width: 220px;
    }

    /* ORDER LINES */
    #ticketList{ display:flex; flex-direction:column; gap:10px; }
    .line{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
    }
    .line .left b{ font-size:14px; }
    .line .meta{ font-size:12px; color:var(--muted); font-weight:700; }
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      color:var(--muted);
      font-weight:900;
      white-space:nowrap;
    }
    .badge.open{ border-color: rgba(255,204,102,.45); color: var(--warn); }
    .badge.paid{ border-color: rgba(68,208,138,.45); color: var(--ok); }

    /* ACTIONS */
    .actions{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (min-width:760px){
      .actions{ grid-template-columns: 1fr 1fr 1fr 1fr; }
    }
    .actions .btn{ height: 46px; font-size:13px; }

    /* MODAL (bottom sheet) */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index: 1000;
    }
    .sheet{
      position:fixed;
      left:0; right:0;
      bottom:0;
      background: rgba(20,26,34,.98);
      border-top:1px solid var(--line);
      border-radius: 18px 18px 0 0;
      padding: 12px;
      max-height: 82vh;
      overflow:auto;
      display:none;
      z-index: 1001;
    }
    .sheet .h{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .sheet .h b{ font-size:16px; }
    .sheet .sub{ color:var(--muted); font-size:12px; }

    .paylist{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .payrow{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
    }
    .payrow .name{ font-weight:900; font-size:14px; }
    .payrow .cat{ font-size:12px; color:var(--muted); font-weight:700; }
    .payrow .right{ display:flex; align-items:center; gap:10px; }
    .payrow input[type="checkbox"]{
      width:22px; height:22px;
      accent-color: var(--accent);
    }

    .methodRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:8px;
      margin-top:10px;
    }

    .sheetFooter{
      position: sticky;
      bottom: 0;
      background: rgba(20,26,34,.98);
      padding-top:10px;
      border-top: 1px solid rgba(255,255,255,.08);
      margin-top:10px;
    }

    @media (max-width:420px){
      :root{ --tap:40px; --pad:10px; }
      .brand b{ font-size:16px; }
      input[type="search"]{ max-width: 100%; }
      .tab{ min-width: 0; }
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <b>Î—Î¼ÎµÏÎ®ÏƒÎ¹Î¿ Î¤Î±Î¼ÎµÎ¯Î¿</b>
        <div class="muted" id="todayPill">Î£Î®Î¼ÎµÏÎ±: â€”</div>
      </div>

      <div class="row">
        <select id="userSelect" title="Î§ÏÎ®ÏƒÏ„Î·Ï‚"></select>
        <button class="btn" id="btnUsers">Î§ÏÎ®ÏƒÏ„ÎµÏ‚</button>
        <div class="pill">Î¤ÏÎ±Ï€Î­Î¶Î¹: <b id="activeTable">â€”</b> Â· Î‘Î½Î¿Î¹Ï‡Ï„Î¬: <b id="activeBal">0,00 â‚¬</b></div>
      </div>

      <div class="tabs">
        <button class="btn tab active" id="tabOrder">Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±</button>
        <button class="btn tab" id="tabTickets">Tickets</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="grid">

      <section class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="title">Î£ÏÎ½Î¿ÏˆÎ· Î·Î¼Î­ÏÎ±Ï‚</div>
            <div class="muted" id="daySummary">ÎœÎµÏ„ÏÎ·Ï„Î¬: 0,00 â‚¬ Â· ÎšÎ¬ÏÏ„Î±: 0,00 â‚¬ Â· ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±: 0,00 â‚¬</div>
          </div>
          <button class="btn warn" id="btnResetTable">ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ Î±Î½Î¿Î¹Ï‡Ï„Î¬</button>
        </div>

        <div class="divider"></div>

        <div class="title">Î“ÏÎ®Î³Î¿ÏÎ· ÎµÏ€Î¹Î»Î¿Î³Î® Ï„ÏÎ±Ï€ÎµÎ¶Î¹Î¿Ï</div>
        <div class="muted">Î Î¬Ï„Î± Ï„ÏÎ±Ï€Î­Î¶Î¹ â†’ Î¼ÎµÏ„Î¬ Î²Î¬Î»Îµ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± (Î¼Î­Î½Î¿Ï…Î½ Î±Î½Î¿Î¹Ï‡Ï„Î¬ Î¼Î­Ï‡ÏÎ¹ Î½Î± Ï€Î»Î·ÏÏ‰Î¸Î¿ÏÎ½).</div>

        <div class="divider"></div>
        <div id="tablesGrid"></div>

        <div class="divider"></div>

        <div class="title" style="margin-bottom:6px;">Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚</div>
        <div class="actions">
          <button class="btn ok" id="btnUndoPay">Undo Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚</button>
          <button class="btn primary" id="btnRedoPay">Redo Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚</button>
          <button class="btn" id="btnCSV">Î•Î¾Î±Î³Ï‰Î³Î® CSV</button>
          <button class="btn bad" id="btnWipeDay">Î”Î¹Î±Î³ÏÎ±Ï†Î® Î·Î¼Î­ÏÎ±Ï‚</button>
        </div>
      </section>

      <section class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="title">Î ÏÎ¿ÏŠÏŒÎ½Ï„Î±</div>
            <div class="muted">ÎŒ,Ï„Î¹ Ï€Î±Ï„Î¬Ï‚ Î¼Ï€Î±Î¯Î½ÎµÎ¹ ÏƒÏ„Î¿ ÎµÎ½ÎµÏÎ³ÏŒ Ï„ÏÎ±Ï€Î­Î¶Î¹.</div>
          </div>
          <input id="search" type="search" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·â€¦">
        </div>

        <div class="divider"></div>
        <div id="catsRow"></div>
        <div class="divider"></div>
        <div id="productsList"></div>
      </section>

      <section class="card" id="orderCard">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="title">Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± (Î‘Î½Î¿Î¹Ï‡Ï„Î¬)</div>
            <div class="muted">Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ ÏƒÏÎ½Î¿Î»Î¿: <b id="openTotal">0,00 â‚¬</b></div>
          </div>
          <div class="row">
            <button class="btn" id="btnRemoveLast">Î‘Ï†Î±Î¯ÏÎµÏƒÎ· Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿Ï…</button>
            <button class="btn primary" id="btnPaySplit">Î Î»Î·ÏÏ‰Î¼Î® / Split</button>
          </div>
        </div>
        <div class="divider"></div>
        <div id="ticketList"></div>
      </section>

      <section class="card" id="ticketsCard" style="display:none;">
        <div class="title">Tickets</div>
        <div class="muted">Î‘Î½Î¿Î¹Ï‡Ï„Î¬ Ï„ÏÎ±Ï€Î­Î¶Î¹Î±</div>
        <div class="divider"></div>
        <div id="ticketsList"></div>
      </section>

    </div>
  </div>
</main>

<!-- PAY MODAL -->
<div class="overlay" id="overlay"></div>
<div class="sheet" id="sheet">
  <div class="h">
    <div>
      <b id="sheetTitle">Î Î»Î·ÏÏ‰Î¼Î®</b>
      <div class="sub" id="sheetSub">Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± â†’ Î´Î¹Î¬Î»ÎµÎ¾Îµ Ï„ÏÏŒÏ€Î¿ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚.</div>
    </div>
    <button class="btn" id="btnCloseSheet">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
  </div>

  <div class="divider"></div>

  <div class="row" style="justify-content:space-between;">
    <button class="btn" id="btnSelectAll">Î•Ï€Î¯Î»ÎµÎ¾Îµ ÏŒÎ»Î±</button>
    <div class="pill">Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î±: <b id="selCount">0</b> Â· Î£ÏÎ½Î¿Î»Î¿: <b id="selSum">0,00 â‚¬</b></div>
  </div>

  <div class="paylist" id="payList"></div>

  <div class="sheetFooter">
    <div class="divider"></div>
    <div class="title">Î¤ÏÏŒÏ€Î¿Ï‚ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚</div>
    <div class="muted">ÎœÏ€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï€Î»Î·ÏÏÏƒÎµÎ¹Ï‚ 1-1 Î® Î¼ÎµÏÎ¹ÎºÎ¬. Î¤Î± Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î± Î¼Î­Î½Î¿Ï…Î½ Î±Î½Î¿Î¹Ï‡Ï„Î¬.</div>
    <div class="methodRow">
      <button class="btn ok" id="btnPayCash">ÎœÎµÏ„ÏÎ·Ï„Î¬</button>
      <button class="btn primary" id="btnPayCard">ÎšÎ¬ÏÏ„Î±</button>
      <button class="btn warn" id="btnPayFree">ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±</button>
    </div>
  </div>
</div>

<script>
(() => {
  const LS_KEY = "mini-cashier-db-v7";
  const LS_USERS = "mini-cashier-users-v5";
  const LS_USER = "mini-cashier-current-user-v5";
  const TODAY = new Date().toISOString().slice(0,10);

  const fmtEUR = (n) => (n||0).toFixed(2).replace(".", ",") + " â‚¬";
  const $ = (id) => document.getElementById(id);
  const uid = () => Math.random().toString(16).slice(2)+Date.now().toString(16);

  const menu = [
    {cat:"â˜• ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ Î–Î•Î£Î¤ÎŸÎ™", items:[
      ["Espresso Î¼Î¿Î½ÏŒÏ‚",2.60],["Espresso Î´Î¹Ï€Î»ÏŒÏ‚",3.20],["Espresso macchiato",2.90],["Americano",3.20],
      ["Cappuccino",3.60],["Cappuccino Î´Î¹Ï€Î»ÏŒÏ‚",4.20],["Latte macchiato",4.20],["Flat white",4.40],
      ["Mocha",4.50],["ÎšÎ±Ï†Î­Ï‚ Ï†Î¯Î»Ï„ÏÎ¿Ï…",3.00]
    ]},
    {cat:"â„ï¸ ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ ÎšÎ¡Î¥ÎŸÎ™", items:[
      ["Freddo espresso",3.80],["Freddo cappuccino",4.20],["Iced latte",4.50],["Cold brew",4.80],["Frappe",3.50]
    ]},
    {cat:"ğŸ«– Î¤Î£Î‘Îª â€“ Î–Î•Î£Î¤Î‘ Î¡ÎŸÎ¦Î—ÎœÎ‘Î¤Î‘", items:[
      ["Î¤ÏƒÎ¬Î¹ (Î¼Î±ÏÏÎ¿/Ï€ÏÎ¬ÏƒÎ¹Î½Î¿/Î²ÏŒÏ„Î±Î½Î±)",3.20],["Î¤ÏƒÎ¬Î¹ Ï†ÏÎ¿ÏÏ„Ï‰Î½",3.50],["Chai latte",4.30]
    ]},
    {cat:"ğŸ« Î£ÎŸÎšÎŸÎ›Î‘Î¤Î•Î£ â€“ Î“Î‘Î›Î‘ÎšÎ¤Î•Î¡Î‘", items:[
      ["Î–ÎµÏƒÏ„Î® ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±",4.20],["ÎšÏÏÎ± ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±",4.50],["Î›ÎµÏ…ÎºÎ® ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±",4.50],["ÎšÎ±ÎºÎ¬Î¿",4.00]
    ]},
    {cat:"ğŸ¥¤ Î‘ÎÎ‘Î¨Î¥ÎšÎ¤Î™ÎšÎ‘ â€“ ÎÎ•Î¡Î‘", items:[
      ["Coca-Cola / Zero / Fanta (0,33l)",3.40],["Ice Tea",3.60],["Î£ÏŒÎ´Î± / Î¤ÏŒÎ½Î¹Îº",3.20],
      ["ÎœÎµÏ„Î±Î»Î»Î¹ÎºÏŒ Î½ÎµÏÏŒ (0,33l)",2.80],["ÎœÎµÏ„Î±Î»Î»Î¹ÎºÏŒ Î½ÎµÏÏŒ (0,75l)",5.50]
    ]},
    {cat:"ğŸŠ Î§Î¥ÎœÎŸÎ™ â€“ SMOOTHIES", items:[
      ["Î¦Ï…ÏƒÎ¹ÎºÏŒÏ‚ Ï‡Ï…Î¼ÏŒÏ‚ Ï€Î¿ÏÏ„Î¿ÎºÎ¬Î»Î¹",4.50],["Î§Ï…Î¼ÏŒÏ‚ Î±Î½Î¬Î¼ÎµÎ¹ÎºÏ„Î¿Ï‚",4.80],["Smoothie Ï†ÏÎ¿ÏÏ„Ï‰Î½",5.80],["Milkshake",5.50]
    ]},
    {cat:"ğŸ¥ Î£ÎÎ‘Îš â€“ Î“Î›Î¥ÎšÎ‘", items:[
      ["ÎšÏÎ¿Ï…Î±ÏƒÎ¬Î½ ÏƒÎºÎ­Ï„Î¿",2.80],["ÎšÏÎ¿Ï…Î±ÏƒÎ¬Î½ ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±",3.20],["ÎœÎ¬Ï†Î¹Î½",3.50],["ÎšÎ­Î¹Îº (ÎºÎ¿Î¼Î¼Î¬Ï„Î¹)",4.20],
      ["Cheesecake",4.80],["ÎœÏ€Î¹ÏƒÎºÏŒÏ„Î±",2.50],["Î¤Î¿ÏƒÏ„ Î¶Î±Î¼Ï€ÏŒÎ½-Ï„Ï…ÏÎ¯",4.50],["Î¤Î¿ÏƒÏ„ vegetarian",4.80]
    ]},
    {cat:"ğŸº ÎœÎ Î¥Î¡Î•Î£", items:[
      ["ÎœÏ€ÏÏÎ± Î²Î±ÏÎµÎ»Î¯ÏƒÎ¹Î± (0,5l)",5.20],["ÎœÏ€ÏÏÎ± ÎµÎ¼Ï†Î¹Î±Î»Ï‰Î¼Î­Î½Î· (0,33l)",4.20],["Weissbier (0,5l)",5.50],["ÎœÏ€ÏÏÎ± Ï‡Ï‰ÏÎ¯Ï‚ Î±Î»ÎºÎ¿ÏŒÎ»",4.20]
    ]},
    {cat:"ğŸ· ÎšÎ¡Î‘Î£Î™Î‘", items:[
      ["ÎšÏÎ±ÏƒÎ¯ Ï€Î¿Ï„Î®ÏÎ¹",5.50],["ÎšÏÎ±ÏƒÎ¯ ÎºÎ±ÏÎ¬Ï†Î± (0,5l)",12.00],["Prosecco Ï€Î¿Ï„Î®ÏÎ¹",6.50]
    ]},
    {cat:"ğŸ¥ƒ Î ÎŸÎ¤Î‘ (4cl)", items:[
      ["ÎŸÏ…Î¯ÏƒÎºÎ¹ standard",8.50],["Premium Î¿Ï…Î¯ÏƒÎºÎ¹",10.50],["Î’ÏŒÏ„ÎºÎ±",8.00],["Î¡Î¿ÏÎ¼Î¹",8.50],["Î¤Î¶Î¹Î½",8.50],["ÎŸÏÎ¶Î¿ / Î¤ÏƒÎ¯Ï€Î¿Ï…ÏÎ¿",7.50],["Î›Î¹ÎºÎ­Ï",7.50]
    ]},
    {cat:"ğŸ¸ ÎšÎŸÎšÎ¤Î•ÎªÎ›", items:[
      ["Mojito",9.50],["Caipirinha",9.50],["Margarita",10.00],["Aperol Spritz",8.50],["Gin Tonic",9.00],["Negroni",10.50]
    ]},
  ];

  const DEFAULT_TABLES = ["T1","T2","T3","T4","T5","T6","T7","T8","T9","T10","T11","T12","T13","T14","T15","T16","T17","BAR","Î•ÎÎ©"];

  const load = (k, fallback) => {
    try { return JSON.parse(localStorage.getItem(k) || "null") ?? fallback; } catch { return fallback; }
  };
  const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));

  function ensureDB(){
    const db = load(LS_KEY, { days:{} });
    if(!db.days) db.days = {};
    if(!db.days[TODAY]) db.days[TODAY] = { tables:{}, meta:{}, payments:[], undone:[] };
    const day = db.days[TODAY];
    if(!day.tables) day.tables = {};
    DEFAULT_TABLES.forEach(t=>{
      if(!day.tables[t]) day.tables[t] = { lines:[] }; // lines = order lines (open or paid)
      if(!Array.isArray(day.tables[t].lines)) day.tables[t].lines = [];
    });
    if(!day.meta) day.meta = {};
    if(!day.meta.activeTable) day.meta.activeTable = "T1";
    if(!Array.isArray(day.payments)) day.payments = [];
    if(!Array.isArray(day.undone)) day.undone = [];
    save(LS_KEY, db);
    return db;
  }

  function ensureUsers(){
    let users = load(LS_USERS, null);
    if(!users || !Array.isArray(users) || users.length===0){
      users = ["Î§ÏÎ®ÏƒÏ„Î·Ï‚ 1"];
      save(LS_USERS, users);
      save(LS_USER, users[0]);
    }
    return users;
  }

  function currentUser(){
    const users = ensureUsers();
    let u = localStorage.getItem(LS_USER) || users[0];
    if(!users.includes(u)){ u = users[0]; save(LS_USER,u); }
    return u;
  }

  function setActiveTable(t){
    const db = ensureDB();
    db.days[TODAY].meta.activeTable = t;
    save(LS_KEY, db);
    renderAll();
  }

  function getLines(db, table){
    return db.days[TODAY].tables[table].lines;
  }

  function unpaidLines(lines){
    return lines.filter(x => !x.paid); // paid=null/undefined => unpaid
  }

  function sumLines(lines){
    return (lines||[]).reduce((s,x)=>s+(x.price||0),0);
  }

  function dayTotals(db){
    const day = db.days[TODAY];
    const totals = { cash:0, card:0, free:0 };
    for(const p of day.payments){
      if(p.method==="cash") totals.cash += p.total;
      if(p.method==="card") totals.card += p.total;
      if(p.method==="free") totals.free += p.total;
    }
    return totals;
  }

  function buildUsers(){
    const users = ensureUsers();
    const sel = $("userSelect");
    sel.innerHTML="";
    users.forEach(u=>{
      const opt=document.createElement("option");
      opt.value=u; opt.textContent=u;
      sel.appendChild(opt);
    });
    sel.value = currentUser();
    sel.onchange=()=>{ save(LS_USER, sel.value); renderAll(); };
  }

  function buildTables(){
    const db = ensureDB();
    const active = db.days[TODAY].meta.activeTable;

    const wrap = $("tablesGrid");
    wrap.innerHTML="";
    DEFAULT_TABLES.forEach(t=>{
      const lines = getLines(db,t);
      const open = unpaidLines(lines);
      const sum = sumLines(open);

      const btn = document.createElement("button");
      btn.className = "btn " + (t===active ? "primary" : "");
      if(sum>0) btn.style.borderColor = "rgba(255,204,102,.55)";
      btn.innerHTML = `<div>${t}</div><div class="sub">${sum>0?fmtEUR(sum):"â€”"}</div>`;
      btn.onclick=()=>setActiveTable(t);
      wrap.appendChild(btn);
    });
  }

  let activeCat = menu[0].cat;

  function buildCats(){
    const row = $("catsRow");
    row.innerHTML="";
    menu.forEach(c=>{
      const b=document.createElement("button");
      b.className = "btn " + (c.cat===activeCat ? "primary" : "");
      b.textContent = c.cat;
      b.onclick=()=>{ activeCat=c.cat; buildCats(); buildProducts(); };
      row.appendChild(b);
    });
  }

  function addLine(name, cat, price){
    const db = ensureDB();
    const t = db.days[TODAY].meta.activeTable;
    const lines = getLines(db,t);
    lines.push({
      id: uid(),
      name, cat,
      price: Number(price)||0,
      createdAt: Date.now(),
      createdBy: currentUser(),
      paid: null // unpaid
    });
    save(LS_KEY, db);
    renderAll();
  }

  function removeLastUnpaid(){
    const db = ensureDB();
    const t = db.days[TODAY].meta.activeTable;
    const lines = getLines(db,t);
    // remove last unpaid line (most recent)
    for(let i=lines.length-1;i>=0;i--){
      if(!lines[i].paid){
        lines.splice(i,1);
        save(LS_KEY, db);
        renderAll();
        return;
      }
    }
    alert("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î±Î½Î¿Î¹Ï‡Ï„ÏŒ Ï€ÏÎ¿ÏŠÏŒÎ½ Î³Î¹Î± Î±Ï†Î±Î¯ÏÎµÏƒÎ·.");
  }

  function buildProducts(){
    const q = ($("search").value||"").trim().toLowerCase();
    const list = $("productsList");
    list.innerHTML="";
    const cat = menu.find(x=>x.cat===activeCat);
    if(!cat) return;
    cat.items
      .filter(([n])=> !q || n.toLowerCase().includes(q))
      .forEach(([name,price])=>{
        const el=document.createElement("div");
        el.className="product";
        el.innerHTML = `<div><b>${name}</b><div class="muted">${activeCat}</div></div><div class="price">${fmtEUR(price)}</div>`;
        el.onclick=()=>addLine(name, activeCat, price);
        list.appendChild(el);
      });
  }

  let view="order";
  $("tabOrder").onclick=()=>{
    view="order";
    $("tabOrder").classList.add("active");
    $("tabTickets").classList.remove("active");
    $("orderCard").style.display="";
    $("ticketsCard").style.display="none";
  };
  $("tabTickets").onclick=()=>{
    view="tickets";
    $("tabTickets").classList.add("active");
    $("tabOrder").classList.remove("active");
    $("orderCard").style.display="none";
    $("ticketsCard").style.display="";
    renderTickets();
  };

  function renderSummary(){
    const db = ensureDB();
    const totals = dayTotals(db);
    $("daySummary").textContent =
      `ÎœÎµÏ„ÏÎ·Ï„Î¬: ${fmtEUR(totals.cash)} Â· ÎšÎ¬ÏÏ„Î±: ${fmtEUR(totals.card)} Â· ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±: ${fmtEUR(totals.free)}`;
  }

  function renderTicket(){
    const db = ensureDB();
    const t = db.days[TODAY].meta.activeTable;
    $("activeTable").textContent = t;

    const lines = getLines(db,t);
    const open = unpaidLines(lines);
    const openSum = sumLines(open);
    $("activeBal").textContent = fmtEUR(openSum);
    $("openTotal").textContent = fmtEUR(openSum);

    const list=$("ticketList");
    list.innerHTML="";
    if(open.length===0){
      list.innerHTML = `<div class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î½Î¿Î¹Ï‡Ï„Î¬ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± ÏƒÏ„Î¿ ${t}.</div>`;
      return;
    }

    // show newest first
    open.slice().reverse().forEach(line=>{
      const row=document.createElement("div");
      row.className="line";
      row.innerHTML = `
        <div class="left">
          <b>${line.name}</b>
          <div class="meta">${line.cat} Â· Î±Ï€ÏŒ ${line.createdBy || "â€”"}</div>
        </div>
        <div class="right" style="display:flex;gap:8px;align-items:center;">
          <span class="badge open">Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ</span>
          <b>${fmtEUR(line.price)}</b>
        </div>
      `;
      list.appendChild(row);
    });
  }

  function renderTickets(){
    const db = ensureDB();
    const wrap=$("ticketsList");
    wrap.innerHTML="";
    DEFAULT_TABLES.forEach(t=>{
      const open = unpaidLines(getLines(db,t));
      const sum = sumLines(open);
      if(sum<=0) return;
      const row=document.createElement("div");
      row.className="line";
      row.innerHTML = `<div class="left"><b>${t}</b><div class="meta">Î‘Î½Î¿Î¹Ï‡Ï„Î¬ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±: ${open.length}</div></div><div><b>${fmtEUR(sum)}</b></div>`;
      row.onclick=()=>{ setActiveTable(t); $("tabOrder").click(); };
      wrap.appendChild(row);
    });
    if(!wrap.children.length) wrap.innerHTML = `<div class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î½Î¿Î¹Ï‡Ï„Î¬ tickets.</div>`;
  }

  // --------- PAY / SPLIT (bottom sheet) ----------
  let payState = { ids:new Set(), all:false };

  function openPaySheet(){
    const db = ensureDB();
    const t = db.days[TODAY].meta.activeTable;
    const open = unpaidLines(getLines(db,t));
    if(open.length===0){
      alert("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î½Î¿Î¹Ï‡Ï„Î¬ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± Î³Î¹Î± Ï€Î»Î·ÏÏ‰Î¼Î®.");
      return;
    }
    payState.ids = new Set(); // start empty
    payState.all = false;

    $("sheetTitle").textContent = `Î Î»Î·ÏÏ‰Î¼Î® Â· ${t}`;
    $("sheetSub").textContent = "Î•Ï€Î¯Î»ÎµÎ¾Îµ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± (Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î¼ÎµÏÎ¹ÎºÎ¬) â†’ Î´Î¹Î¬Î»ÎµÎ¾Îµ Ï„ÏÏŒÏ€Î¿ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚.";
    renderPayList();
    showSheet(true);
  }

  function showSheet(on){
    $("overlay").style.display = on ? "block" : "none";
    $("sheet").style.display = on ? "block" : "none";
    if(!on){
      payState.ids = new Set();
      payState.all = false;
    }
  }

  function renderPayList(){
    const db = ensureDB();
    const t = db.days[TODAY].meta.activeTable;
    const open = unpaidLines(getLines(db,t));

    const list = $("payList");
    list.innerHTML = "";

    open.forEach(line=>{
      const row = document.createElement("div");
      row.className="payrow";

      const checked = payState.ids.has(line.id);
      row.innerHTML = `
        <div>
          <div class="name">${line.name}</div>
          <div class="cat">${line.cat}</div>
        </div>
        <div class="right">
          <b>${fmtEUR(line.price)}</b>
          <input type="checkbox" ${checked ? "checked":""} />
        </div>
      `;

      const cb = row.querySelector("input[type='checkbox']");
      cb.onchange = () => {
        if(cb.checked) payState.ids.add(line.id);
        else payState.ids.delete(line.id);
        updateSelectedInfo();
      };

      // tap on row toggles too
      row.onclick = (e) => {
        if(e.target.tagName.toLowerCase()==="input") return;
        cb.checked = !cb.checked;
        cb.onchange();
      };

      list.appendChild(row);
    });

    updateSelectedInfo();
  }

  function updateSelectedInfo(){
    const db = ensureDB();
    const t = db.days[TODAY].meta.activeTable;
    const open = unpaidLines(getLines(db,t));

    let sum=0, count=0;
    for(const line of open){
      if(payState.ids.has(line.id)){
        sum += line.price;
        count++;
      }
    }
    $("selCount").textContent = String(count);
    $("selSum").textContent = fmtEUR(sum);

    // update select all button label
    const all = count===open.length;
    $("btnSelectAll").textContent = all ? "Î‘Ï€Î¿ÎµÏ€Î¹Î»Î¿Î³Î® ÏŒÎ»Ï‰Î½" : "Î•Ï€Î¯Î»ÎµÎ¾Îµ ÏŒÎ»Î±";
  }

  function toggleSelectAll(){
    const db = ensureDB();
    const t = db.days[TODAY].meta.activeTable;
    const open = unpaidLines(getLines(db,t));

    const allSelected = open.length>0 && open.every(x=>payState.ids.has(x.id));
    payState.ids = new Set();
    if(!allSelected){
      open.forEach(x=>payState.ids.add(x.id));
    }
    renderPayList();
  }

  function doPayment(method){
    const db = ensureDB();
    const day = db.days[TODAY];
    const t = day.meta.activeTable;

    const lines = getLines(db,t);
    const open = unpaidLines(lines);

    const selected = open.filter(x=>payState.ids.has(x.id));
    if(selected.length===0){
      alert("Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 1 Ï€ÏÎ¿ÏŠÏŒÎ½ Î³Î¹Î± Ï€Î»Î·ÏÏ‰Î¼Î®.");
      return;
    }

    const now = Date.now();
    const user = currentUser();
    const total = selected.reduce((s,x)=>s+x.price,0);

    // apply paid state
    const ids = selected.map(x=>x.id);
    for(const l of lines){
      if(ids.includes(l.id)){
        l.paid = { method, at: now, by: user };
      }
    }

    // log payment for undo/redo
    const payRecord = {
      id: uid(),
      at: now,
      table: t,
      user,
      method,
      total,
      itemIds: ids
    };
    day.payments.push(payRecord);
    day.undone = []; // new payment clears redo stack
    save(LS_KEY, db);

    showSheet(false);
    renderAll();
  }

  function undoPayment(){
    const db = ensureDB();
    const day = db.days[TODAY];
    const last = day.payments.pop();
    if(!last){
      alert("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï€Î»Î·ÏÏ‰Î¼Î® Î³Î¹Î± Undo.");
      return;
    }
    const lines = getLines(db, last.table);
    for(const l of lines){
      if(last.itemIds.includes(l.id)){
        l.paid = null;
      }
    }
    day.undone.push(last);
    save(LS_KEY, db);
    renderAll();
  }

  function redoPayment(){
    const db = ensureDB();
    const day = db.days[TODAY];
    const last = day.undone.pop();
    if(!last){
      alert("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï€Î»Î·ÏÏ‰Î¼Î® Î³Î¹Î± Redo.");
      return;
    }
    const lines = getLines(db, last.table);
    for(const l of lines){
      if(last.itemIds.includes(l.id)){
        l.paid = { method:last.method, at:last.at, by:last.user };
      }
    }
    day.payments.push(last);
    save(LS_KEY, db);
    renderAll();
  }

  // Reset table open lines (only unpaid)
  function resetTableUnpaid(){
    const db = ensureDB();
    const t = db.days[TODAY].meta.activeTable;
    const lines = getLines(db,t);
    const before = lines.length;
    // remove only unpaid lines
    const kept = lines.filter(x=>x.paid);
    db.days[TODAY].tables[t].lines = kept;
    save(LS_KEY, db);
    renderAll();
    alert(`ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎ± Ï„Î± Î±Î½Î¿Î¹Ï‡Ï„Î¬ Î±Ï€ÏŒ ${t}. (ÎˆÏ†Ï…Î³Î±Î½ ${before-kept.length} Î³ÏÎ±Î¼Î¼Î­Ï‚)`);
  }

  // USERS: add / rename / delete via prompts (simple)
  function manageUsers(){
    const users = ensureUsers();
    const cur = currentUser();
    const msg =
`Î§ÏÎ®ÏƒÏ„ÎµÏ‚:
${users.map((u,i)=>`${i+1}) ${u}${u===cur?" (Ï„ÏÎ­Ï‡Ï‰Î½)":"")}`).join("\n")}

Î“ÏÎ¬ÏˆÎµ ÎµÏ€Î¹Î»Î¿Î³Î®:
1 = Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î½Î­Î¿Ï…
2 = ÎœÎµÏ„Î¿Î½Î¿Î¼Î±ÏƒÎ¯Î± Ï„ÏÎ­Ï‡Î¿Î½Ï„Î¿Ï‚
3 = Î”Î¹Î±Î³ÏÎ±Ï†Î® Ï„ÏÎ­Ï‡Î¿Î½Ï„Î¿Ï‚`;

    const choice = prompt(msg, "1");
    if(!choice) return;

    if(choice.trim()==="1"){
      const name = prompt("ÎŒÎ½Î¿Î¼Î± Î½Î­Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·:", "ÎÎ­Î¿Ï‚ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚");
      if(!name) return;
      users.push(name.trim());
      save(LS_USERS, users);
      save(LS_USER, name.trim());
      renderAll();
      return;
    }

    if(choice.trim()==="2"){
      const name = prompt("ÎÎ­Î¿ ÏŒÎ½Î¿Î¼Î± Î³Î¹Î± Ï„Î¿Î½ Ï„ÏÎ­Ï‡Î¿Î½Ï„Î± Ï‡ÏÎ®ÏƒÏ„Î·:", cur);
      if(!name) return;
      const idx = users.indexOf(cur);
      if(idx>=0) users[idx] = name.trim();
      save(LS_USERS, users);
      save(LS_USER, name.trim());
      renderAll();
      return;
    }

    if(choice.trim()==="3"){
      if(users.length===1){
        alert("Î”ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹Ï‚ Ï„Î¿Î½ Î¼Î¿Î½Î±Î´Î¹ÎºÏŒ Ï‡ÏÎ®ÏƒÏ„Î·.");
        return;
      }
      if(!confirm(`ÎÎ± Î´Î¹Î±Î³ÏÎ¬ÏˆÏ‰ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· "${cur}" Î±Ï€ÏŒ Ï„Î· Î»Î¯ÏƒÏ„Î±;`)) return;
      const next = users.find(u=>u!==cur);
      const newUsers = users.filter(u=>u!==cur);
      save(LS_USERS, newUsers);
      save(LS_USER, next);
      renderAll();
      return;
    }
  }

  function exportCSV(){
    const db=ensureDB();
    const day=db.days[TODAY];
    const rows=[["date","table","item","category","price","paid","method","paid_by","paid_at","created_by"]];
    for(const t of DEFAULT_TABLES){
      const lines = getLines(db,t);
      for(const l of lines){
        rows.push([
          TODAY, t, l.name, l.cat,
          (l.price??0),
          l.paid ? "yes":"no",
          l.paid?.method ?? "",
          l.paid?.by ?? "",
          l.paid?.at ?? "",
          l.createdBy ?? ""
        ]);
      }
    }
    const csv = rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=`cashier_${TODAY}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function wipeDay(){
    if(!confirm("Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏƒÎ·Î¼ÎµÏÎ¹Î½Î®Ï‚ Î·Î¼Î­ÏÎ±Ï‚;")) return;
    const db=ensureDB();
    delete db.days[TODAY];
    save(LS_KEY, db);
    renderAll();
  }

  // INIT UI WIRING
  $("btnPaySplit").onclick=openPaySheet;
  $("btnCloseSheet").onclick=()=>showSheet(false);
  $("overlay").onclick=()=>showSheet(false);

  $("btnSelectAll").onclick=toggleSelectAll;
  $("btnPayCash").onclick=()=>doPayment("cash");
  $("btnPayCard").onclick=()=>doPayment("card");
  $("btnPayFree").onclick=()=>doPayment("free");

  $("btnUndoPay").onclick=undoPayment;
  $("btnRedoPay").onclick=redoPayment;
  $("btnCSV").onclick=exportCSV;
  $("btnWipeDay").onclick=wipeDay;

  $("btnRemoveLast").onclick=removeLastUnpaid;
  $("btnResetTable").onclick=resetTableUnpaid;

  $("btnUsers").onclick=manageUsers;

  // SEARCH
  $("search").addEventListener("input", buildProducts);

  function renderAll(){
    $("todayPill").textContent="Î£Î®Î¼ÎµÏÎ±: "+TODAY;

    buildUsers();

    const db = ensureDB();
    const t = db.days[TODAY].meta.activeTable;

    buildTables();
    buildCats();
    buildProducts();
    renderSummary();
    renderTicket();
    if(view==="tickets") renderTickets();
  }

  renderAll();
})();
</script>
</body>
</html>
