<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Î—Î¼ÎµÏÎ®ÏƒÎ¹Î¿ Î¤Î±Î¼ÎµÎ¯Î¿</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#111111" />

  <style>
    :root { --bg:#0f1115; --card:#151a22; --muted:#a9b1c3; --text:#eef2ff; --accent:#4cc2ff; --ok:#42d392; --warn:#ffcd3c; --bad:#ff6b6b; }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin:0; background:var(--bg); color:var(--text); }
    header { position: sticky; top:0; z-index:10; background: linear-gradient(180deg, rgba(15,17,21,1), rgba(15,17,21,.92)); padding: 14px 14px 10px; border-bottom: 1px solid rgba(255,255,255,.06); }
    h1 { margin:0; font-size: 18px; letter-spacing:.2px; }
    .sub { margin-top:8px; color:var(--muted); font-size: 13px; display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .pill { padding:6px 10px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); border-radius:999px; font-size: 12px; color: var(--muted); display:flex; align-items:center; gap:8px; flex-wrap: wrap; }
    main { padding: 14px; padding-bottom: 140px; }
    .grid { display:grid; gap:12px; }
    .card { background: var(--card); border:1px solid rgba(255,255,255,.08); border-radius: 16px; padding: 12px; box-shadow: 0 8px 22px rgba(0,0,0,.25); }
    .row { display:flex; gap:10px; align-items:center; justify-content: space-between; flex-wrap: wrap; }
    .btn { border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); color: var(--text); padding: 12px 12px; border-radius: 14px; font-weight: 650; cursor:pointer; user-select:none; }
    .btn:active { transform: translateY(1px); }
    .btn.primary { border-color: rgba(76,194,255,.55); background: rgba(76,194,255,.12); }
    .btn.ok { border-color: rgba(66,211,146,.55); background: rgba(66,211,146,.14); }
    .btn.warn { border-color: rgba(255,205,60,.55); background: rgba(255,205,60,.14); }
    .btn.bad { border-color: rgba(255,107,107,.55); background: rgba(255,107,107,.14); }
    .muted { color: var(--muted); font-size: 13px; }
    .title { font-weight: 800; font-size: 15px; }
    .divider { height:1px; background: rgba(255,255,255,.08); margin: 10px 0; }
    .cats { display:flex; gap:8px; overflow:auto; padding-bottom:4px; }
    .cat { white-space: nowrap; }
    .cat.active { outline: 2px solid rgba(76,194,255,.5); }

    .products { display:grid; grid-template-columns: 1fr; gap:10px; }
    @media (min-width: 540px) { .products { grid-template-columns: 1fr 1fr; } }
    @media (min-width: 820px) { .products { grid-template-columns: 1fr 1fr 1fr; } }
    @media (min-width: 1100px) { .products { grid-template-columns: 1fr 1fr 1fr 1fr; } }

    .prod { display:flex; justify-content: space-between; gap: 10px; align-items:center; padding: 12px; border-radius: 14px; border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.05); cursor:pointer; }
    .prod small { color: var(--muted); display:block; margin-top:2px; }
    .price { font-weight: 850; color: rgba(238,242,255,.92); }

    .modalWrap { position: fixed; inset: 0; background: rgba(0,0,0,.55); display:none; align-items:flex-end; justify-content:center; padding: 14px; z-index: 50; }
    .modal { width: min(820px, 100%); background: var(--card); border:1px solid rgba(255,255,255,.10); border-radius: 18px; padding: 12px; box-shadow: 0 18px 50px rgba(0,0,0,.5); }
    .modal h2 { margin: 0 0 6px; font-size: 16px; }
    .qty { display:flex; gap:10px; align-items:center; justify-content:flex-start; }
    .qty .n { font-size: 18px; font-weight: 900; min-width: 36px; text-align:center; }
    .toggle { display:flex; gap:10px; flex-wrap: wrap; }
    label.cb { display:flex; gap:10px; align-items:center; padding: 10px 12px; border-radius: 14px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.05); cursor:pointer; }
    input[type="checkbox"] { width: 18px; height: 18px; }

    .footerBar { position: fixed; bottom: 0; left:0; right:0; padding: 10px 14px; background: linear-gradient(180deg, rgba(15,17,21,0), rgba(15,17,21,1)); border-top: 1px solid rgba(255,255,255,.06); z-index: 20; }
    .footerBar .row { gap: 8px; }
    .tiny { font-size: 12px; color: var(--muted); }
    .toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 104px; background: rgba(20,24,32,.95); border:1px solid rgba(255,255,255,.10); padding: 10px 12px; border-radius: 14px; display:none; z-index:60; }
    .table { width:100%; border-collapse: collapse; }
    .table td, .table th { padding: 8px 6px; border-bottom: 1px solid rgba(255,255,255,.08); text-align:left; font-size: 13px; }
    .table th { color: var(--muted); font-weight: 700; }
    .right { text-align:right; }
  </style>
</head>

<body>
<header>
  <h1>Î—Î¼ÎµÏÎ®ÏƒÎ¹Î¿ Î¤Î±Î¼ÎµÎ¯Î¿</h1>
  <div class="sub">
    <span class="pill" id="todayPill">Î£Î®Î¼ÎµÏÎ±: â€”</span>

    <span class="pill">
      Î—Î¼Î­ÏÎ±: <b id="dayKey">â€”</b> â€”
      Î§ÏÎ®ÏƒÏ„Î·Ï‚:
      <select id="userSel" style="margin-left:6px; padding:6px 8px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); color: var(--text);"></select>
      <button class="btn" id="userAdd" style="padding:8px 10px; border-radius:12px;">+ Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
      <button class="btn" id="userRename" style="padding:8px 10px; border-radius:12px;">âœ ÎœÎµÏ„Î¿Î½Î¿Î¼Î±ÏƒÎ¯Î±</button>
      <button class="btn bad" id="userDelete" style="padding:8px 10px; border-radius:12px;">ğŸ—‘ Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
    </span>

    <span class="pill">ÎœÎµÏ„ÏÎ·Ï„Î¬/ÎšÎ¬ÏÏ„Î±/ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±</span>
  </div>
</header>

<main class="grid">
  <section class="card">
    <div class="row">
      <div>
        <div class="title">ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚</div>
        <div class="muted">Î”Î¹Î¬Î»ÎµÎ¾Îµ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± ÎºÎ±Î¹ Ï€Î¬Ï„Î± Ï€ÏÎ¿ÏŠÏŒÎ½.</div>
      </div>
      <button class="btn" id="btnResetDay">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î·Î¼Î­ÏÎ±Ï‚</button>
    </div>
    <div class="divider"></div>
    <div class="cats" id="cats"></div>
  </section>

  <section class="card">
    <div class="row">
      <div>
        <div class="title" id="catTitle">Î ÏÎ¿ÏŠÏŒÎ½Ï„Î±</div>
        <div class="muted">Î Î¬Ï„Î·ÏƒÎµ Ï€ÏÎ¿ÏŠÏŒÎ½ Î³Î¹Î± ÎºÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ·.</div>
      </div>
      <input id="search" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·â€¦" style="padding:12px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.05); color: var(--text); outline:none; width: 180px;">
    </div>
    <div class="divider"></div>
    <div class="products" id="products"></div>
  </section>

  <section class="card">
    <div class="row">
      <div>
        <div class="title">Î£ÏÎ½Î¿ÏˆÎ· Î·Î¼Î­ÏÎ±Ï‚</div>
        <div class="muted">Î“Î¹Î± Ï„Î¿Î½ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿ Ï‡ÏÎ®ÏƒÏ„Î·.</div>
      </div>
      <button class="btn primary" id="btnClose">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Î·Î¼Î­ÏÎ±Ï‚</button>
    </div>
    <div class="divider"></div>

    <div style="display:grid; gap:6px;">
      <div class="row"><span>Î£ÏÎ½Î¿Î»Î¿</span><b id="sumTotal">0,00 â‚¬</b></div>
      <div class="row"><span>ÎœÎµÏ„ÏÎ·Ï„Î¬</span><b id="sumCash">0,00 â‚¬</b></div>
      <div class="row"><span>ÎšÎ¬ÏÏ„Î±</span><b id="sumCard">0,00 â‚¬</b></div>
      <div class="row"><span>ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î± (Î±Î¾Î¯Î±)</span><b id="sumGift">0,00 â‚¬</b></div>
    </div>

    <div class="divider"></div>
    <div class="muted">Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯ÎµÏ‚ ÎºÎ¹Î½Î®ÏƒÎµÎ¹Ï‚</div>
    <div id="lastList" class="tiny" style="margin-top:8px; display:grid; gap:6px;"></div>
  </section>
</main>

<div class="footerBar">
  <div class="row">
    <button class="btn ok" id="btnUndo">Î‘Î½Î±Î¯ÏÎµÏƒÎ· Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿Ï…</button>
    <button class="btn primary" id="btnRepeat">Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿ Î¾Î±Î½Î¬</button>
    <button class="btn" id="btnCSV">Î•Î¾Î±Î³Ï‰Î³Î® CSV</button>
    <button class="btn bad" id="btnWipeAll">Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏŒÎ»Ï‰Î½</button>
  </div>
  <div class="tiny" style="margin-top:6px;">Tip: Chrome â‹® â†’ <b>Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î·Î½ Î±ÏÏ‡Î¹ÎºÎ® Î¿Î¸ÏŒÎ½Î·</b>.</div>
</div>

<!-- Modal -->
<div class="modalWrap" id="modalWrap">
  <div class="modal">
    <div class="row" style="align-items:flex-start;">
      <div>
        <h2 id="mTitle">â€”</h2>
        <div class="muted" id="mPrice">â€”</div>
      </div>
      <button class="btn" id="mClose">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div class="qty">
        <button class="btn" id="qtyMinus">â€“</button>
        <div class="n" id="qtyVal">1</div>
        <button class="btn" id="qtyPlus">+</button>
      </div>

      <div class="muted">Î¤ÎµÎ»Î¹ÎºÏŒ:</div>
      <div class="title" id="mFinal">0,00 â‚¬</div>
    </div>

    <div class="divider"></div>

    <div class="toggle">
      <label class="cb"><input type="checkbox" id="xDecaf"> Decaf (+0,30â‚¬)</label>
      <label class="cb"><input type="checkbox" id="xPlant"> Î¦Ï…Ï„Î¹ÎºÏŒ Î³Î¬Î»Î± (+0,50â‚¬)</label>
    </div>

    <div class="divider"></div>

    <div class="row">
      <button class="btn ok" style="flex:1" id="payCash">Î Î›Î—Î¡Î©Î˜Î—ÎšÎ• ÎœÎ•Î¤Î¡Î—Î¤Î‘</button>
      <button class="btn primary" style="flex:1" id="payCard">Î Î›Î—Î¡Î©Î˜Î—ÎšÎ• ÎšÎ‘Î¡Î¤Î‘</button>
      <button class="btn warn" style="flex:1" id="payGift">ÎšÎ•Î¡Î‘Î£ÎœÎ•ÎÎŸ</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
  // PWA register
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function(){
      navigator.serviceWorker.register('./sw.js').catch(function(){});
    });
  }

  // Helpers
  function euro(n){ return n.toFixed(2).replace(".", ",") + " â‚¬"; }
  function dayKey(d){
    var y = d.getFullYear();
    var m = String(d.getMonth()+1).padStart(2,"0");
    var da = String(d.getDate()).padStart(2,"0");
    return y + "-" + m + "-" + da;
  }
  var toastEl = document.getElementById("toast");
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(function(){ toastEl.style.display = "none"; }, 1500);
  }

  // Menu
  var MENU = [
    { cat: "â˜• ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ Î–Î•Î£Î¤ÎŸÎ™", items: [
      ["Espresso Î¼Î¿Î½ÏŒÏ‚", 2.60], ["Espresso Î´Î¹Ï€Î»ÏŒÏ‚", 3.20], ["Espresso macchiato", 2.90],
      ["Americano", 3.20], ["Cappuccino", 3.60], ["Cappuccino Î´Î¹Ï€Î»ÏŒÏ‚", 4.20],
      ["Latte macchiato", 4.20], ["Flat white", 4.40], ["Mocha", 4.50], ["ÎšÎ±Ï†Î­Ï‚ Ï†Î¯Î»Ï„ÏÎ¿Ï…", 3.00]
    ]},
    { cat: "â„ï¸ ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ ÎšÎ¡Î¥ÎŸÎ™", items: [
      ["Freddo espresso", 3.80], ["Freddo cappuccino", 4.20], ["Iced latte", 4.50], ["Cold brew", 4.80], ["Frappe", 3.50]
    ]},
    { cat: "ğŸ«– Î¤Î£Î‘Îª â€“ Î–Î•Î£Î¤Î‘ Î¡ÎŸÎ¦Î—ÎœÎ‘Î¤Î‘", items: [
      ["Î¤ÏƒÎ¬Î¹ (Î¼Î±ÏÏÎ¿, Ï€ÏÎ¬ÏƒÎ¹Î½Î¿, Î²ÏŒÏ„Î±Î½Î±)", 3.20], ["Î¤ÏƒÎ¬Î¹ Ï†ÏÎ¿ÏÏ„Ï‰Î½", 3.50], ["Chai latte", 4.30]
    ]},
    { cat: "ğŸ« Î£ÎŸÎšÎŸÎ›Î‘Î¤Î•Î£ â€“ Î“Î‘Î›Î‘ÎšÎ¤Î•Î¡Î‘", items: [
      ["Î–ÎµÏƒÏ„Î® ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", 4.20], ["ÎšÏÏÎ± ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", 4.50], ["Î›ÎµÏ…ÎºÎ® ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", 4.50], ["ÎšÎ±ÎºÎ¬Î¿", 4.00]
    ]},
    { cat: "ğŸ¥¤ Î‘ÎÎ‘Î¨Î¥ÎšÎ¤Î™ÎšÎ‘ â€“ ÎÎ•Î¡Î‘", items: [
      ["Coca-Cola / Zero / Fanta (0,33l)", 3.40], ["Ice Tea", 3.60], ["Î£ÏŒÎ´Î± / Î¤ÏŒÎ½Î¹Îº", 3.20],
      ["ÎœÎµÏ„Î±Î»Î»Î¹ÎºÏŒ Î½ÎµÏÏŒ (0,33l)", 2.80], ["ÎœÎµÏ„Î±Î»Î»Î¹ÎºÏŒ Î½ÎµÏÏŒ (0,75l)", 5.50]
    ]},
    { cat: "ğŸŠ Î§Î¥ÎœÎŸÎ™ â€“ SMOOTHIES", items: [
      ["Î¦Ï…ÏƒÎ¹ÎºÏŒÏ‚ Ï‡Ï…Î¼ÏŒÏ‚ Ï€Î¿ÏÏ„Î¿ÎºÎ¬Î»Î¹", 4.50], ["Î§Ï…Î¼ÏŒÏ‚ Î±Î½Î¬Î¼ÎµÎ¹ÎºÏ„Î¿Ï‚", 4.80], ["Smoothie Ï†ÏÎ¿ÏÏ„Ï‰Î½", 5.80], ["Milkshake", 5.50]
    ]},
    { cat: "ğŸ¥ Î£ÎÎ‘Îš â€“ Î“Î›Î¥ÎšÎ‘", items: [
      ["ÎšÏÎ¿Ï…Î±ÏƒÎ¬Î½ ÏƒÎºÎ­Ï„Î¿", 2.80], ["ÎšÏÎ¿Ï…Î±ÏƒÎ¬Î½ ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", 3.20], ["ÎœÎ¬Ï†Î¹Î½", 3.50], ["ÎšÎ­Î¹Îº (ÎºÎ¿Î¼Î¼Î¬Ï„Î¹)", 4.20],
      ["Cheesecake", 4.80], ["ÎœÏ€Î¹ÏƒÎºÏŒÏ„Î±", 2.50], ["Î¤Î¿ÏƒÏ„ Î¶Î±Î¼Ï€ÏŒÎ½-Ï„Ï…ÏÎ¯", 4.50], ["Î¤Î¿ÏƒÏ„ vegetarian", 4.80]
    ]},
    { cat: "ğŸº ÎœÎ Î¥Î¡Î•Î£", items: [
      ["ÎœÏ€ÏÏÎ± Î²Î±ÏÎµÎ»Î¯ÏƒÎ¹Î± (0,5l)", 5.20], ["ÎœÏ€ÏÏÎ± ÎµÎ¼Ï†Î¹Î±Î»Ï‰Î¼Î­Î½Î· (0,33l)", 4.20], ["Weissbier (0,5l)", 5.50], ["ÎœÏ€ÏÏÎ± Ï‡Ï‰ÏÎ¯Ï‚ Î±Î»ÎºÎ¿ÏŒÎ»", 4.20]
    ]},
    { cat: "ğŸ· ÎšÎ¡Î‘Î£Î™Î‘", items: [
      ["ÎšÏÎ±ÏƒÎ¯ Ï€Î¿Ï„Î®ÏÎ¹", 5.50], ["ÎšÏÎ±ÏƒÎ¯ ÎºÎ±ÏÎ¬Ï†Î± (0,5l)", 12.00], ["Î¦Î¹Î¬Î»Î· ÎºÏÎ±ÏƒÎ¯ (22â‚¬)", 22.00], ["Î¦Î¹Î¬Î»Î· ÎºÏÎ±ÏƒÎ¯ (28â‚¬)", 28.00], ["Prosecco Ï€Î¿Ï„Î®ÏÎ¹", 6.50]
    ]},
    { cat: "ğŸ¥ƒ Î ÎŸÎ¤Î‘ (4cl)", items: [
      ["ÎŸÏ…Î¯ÏƒÎºÎ¹ standard", 8.50], ["Premium Î¿Ï…Î¯ÏƒÎºÎ¹", 10.50], ["Î’ÏŒÏ„ÎºÎ±", 8.00], ["Î¡Î¿ÏÎ¼Î¹", 8.50],
      ["Î¤Î¶Î¹Î½", 8.50], ["ÎŸÏÎ¶Î¿ / Î¤ÏƒÎ¯Ï€Î¿Ï…ÏÎ¿", 7.50], ["Î›Î¹ÎºÎ­Ï", 7.50]
    ]},
    { cat: "ğŸ¸ ÎšÎŸÎšÎ¤Î•ÎªÎ›", items: [
      ["Mojito", 9.50], ["Caipirinha", 9.50], ["Margarita", 10.00], ["Aperol Spritz", 8.50], ["Gin Tonic", 9.00], ["Negroni", 10.50]
    ]}
  ];

  var EXTRAS = { decaf:{name:"Decaf",price:0.30}, plant:{name:"Î¦Ï…Ï„Î¹ÎºÏŒ Î³Î¬Î»Î±",price:0.50} };

  // Storage
  var LS_KEY = "mini_cashier_db_v1";
  var LS_USERS = "mini_cashier_users_v1";
  var LS_USER = "mini_cashier_user_v1";

  function loadDB(){
    try { return JSON.parse(localStorage.getItem(LS_KEY)) || { days:{}, lastId:0 }; }
    catch(e){ return { days:{}, lastId:0 }; }
  }
  function saveDB(db){ localStorage.setItem(LS_KEY, JSON.stringify(db)); }

  function loadUsers(){
    var fallback = [{id:"pavlos",name:"Î Î±ÏÎ»Î¿Ï‚"},{id:"tablet",name:"Tablet (Î­ÎºÏ„Î±ÎºÏ„Î·)"}];
    try{
      var raw = localStorage.getItem(LS_USERS);
      if(!raw) return fallback;
      var arr = JSON.parse(raw);
      if(!Array.isArray(arr) || !arr.length) return fallback;
      return arr;
    }catch(e){ return fallback; }
  }
  function saveUsers(arr){ localStorage.setItem(LS_USERS, JSON.stringify(arr)); }

  function normalizeId(name){
    // Î±Ï€Î»ÏŒ/Î±ÏƒÏ†Î±Î»Î­Ï‚: ÎºÏÎ±Ï„Î¬ Î³ÏÎ¬Î¼Î¼Î±Ï„Î±/Î±ÏÎ¹Î¸Î¼Î¿ÏÏ‚/_/-
    var s = name.trim().toLowerCase().replace(/\s+/g,"_");
    s = s.replace(/[^a-z0-9\u0370-\u03ff_-]/g,"");
    return s;
  }

  var db = loadDB();
  var BASE_TODAY = dayKey(new Date());

  // User UI
  var userSel = document.getElementById("userSel");
  var userAdd = document.getElementById("userAdd");
  var userRename = document.getElementById("userRename");
  var userDelete = document.getElementById("userDelete");
  var USERS = loadUsers();

  function renderUserSelect(){
    var selected = localStorage.getItem(LS_USER) || (USERS[0] && USERS[0].id);
    userSel.innerHTML = "";
    USERS.forEach(function(u){
      var opt = document.createElement("option");
      opt.value = u.id;
      opt.textContent = u.name;
      userSel.appendChild(opt);
    });
    if(!USERS.some(function(u){ return u.id === selected; })) selected = USERS[0].id;
    userSel.value = selected;
    localStorage.setItem(LS_USER, selected);
  }

  function currentUser(){
    var id = userSel.value;
    var u = USERS.find(function(x){ return x.id === id; });
    return u || {id:id, name:id};
  }

  var TODAY = "";
  function currentDayKey(){
    return BASE_TODAY + "__" + currentUser().id;
  }

  function ensureDay(){
    TODAY = currentDayKey();
    if(!db.days[TODAY]) db.days[TODAY] = { entries:[] };
    saveDB(db);
    document.getElementById("dayKey").textContent = BASE_TODAY;
    document.getElementById("todayPill").textContent = "Î£Î®Î¼ÎµÏÎ±: " + BASE_TODAY.split("-").reverse().join("/");
  }

  userSel.addEventListener("change", function(){
    localStorage.setItem(LS_USER, userSel.value);
    ensureDay();
    renderAll();
  });

  userAdd.addEventListener("click", function(){
    var name = prompt("ÎŒÎ½Î¿Î¼Î± Ï…Ï€Î±Î»Î»Î®Î»Î¿Ï…/Ï‡ÏÎ®ÏƒÏ„Î·:");
    if(!name || !name.trim()) return;
    var id = normalizeId(name);
    if(!id){ alert("Î”ÏÏƒÎµ Î­Î³ÎºÏ…ÏÎ¿ ÏŒÎ½Î¿Î¼Î±."); return; }
    var base = id, n = 2;
    while(USERS.some(function(u){ return u.id === id; })) id = base + "_" + (n++);
    USERS.push({id:id, name:name.trim()});
    saveUsers(USERS);
    renderUserSelect();
    ensureDay();
    renderAll();
  });

  userRename.addEventListener("click", function(){
    var cur = currentUser();
    var name = prompt("ÎÎ­Î¿ ÏŒÎ½Î¿Î¼Î±:", cur.name);
    if(!name || !name.trim()) return;
    var idx = USERS.findIndex(function(u){ return u.id === cur.id; });
    if(idx < 0) return;
    USERS[idx].name = name.trim();
    saveUsers(USERS);
    renderUserSelect();
    ensureDay();
    renderAll();
  });

  userDelete.addEventListener("click", function(){
    var cur = currentUser();
    if(USERS.length <= 1){ alert("Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î­Î½Î±Ï‚ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚."); return; }
    if(!confirm('ÎÎ± Î´Î¹Î±Î³ÏÎ¬ÏˆÏ‰ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· "'+cur.name+'"; (Î”ÎµÎ½ ÏƒÎ²Î®Î½ÎµÎ¹ Ï€Î±Î»Î¹Î­Ï‚ ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚)')) return;
    USERS = USERS.filter(function(u){ return u.id !== cur.id; });
    saveUsers(USERS);
    renderUserSelect();
    ensureDay();
    renderAll();
  });

  // Category/Product UI
  var catsEl = document.getElementById("cats");
  var productsEl = document.getElementById("products");
  var catTitle = document.getElementById("catTitle");
  var searchEl = document.getElementById("search");
  var activeCat = MENU[0].cat;

  function buildCats(){
    catsEl.innerHTML = "";
    MENU.forEach(function(section){
      var b = document.createElement("button");
      b.className = "btn cat" + (section.cat === activeCat ? " active" : "");
      b.textContent = section.cat;
      b.onclick = function(){
        activeCat = section.cat;
        buildCats();
        buildProducts();
      };
      catsEl.appendChild(b);
    });
  }

  function buildProducts(){
    var q = (searchEl.value || "").trim().toLowerCase();
    productsEl.innerHTML = "";
    var section = MENU.find(function(s){ return s.cat === activeCat; });
    catTitle.textContent = activeCat;

    var items = section.items.map(function(it){ return {name:it[0], price:it[1], cat:section.cat}; });
    if(q) items = items.filter(function(x){ return x.name.toLowerCase().indexOf(q) >= 0; });

    items.forEach(function(item){
      var div = document.createElement("div");
      div.className = "prod";
      div.innerHTML =
        '<div><div class="title">'+item.name+'</div><small>'+item.cat+'</small></div>' +
        '<div class="price">'+euro(item.price)+'</div>';
      div.onclick = function(){ openModal(item); };
      productsEl.appendChild(div);
    });
  }
  searchEl.addEventListener("input", buildProducts);

  // Modal logic
  var modalWrap = document.getElementById("modalWrap");
  var mTitle = document.getElementById("mTitle");
  var mPrice = document.getElementById("mPrice");
  var mFinal = document.getElementById("mFinal");
  var qtyValEl = document.getElementById("qtyVal");
  var xDecaf = document.getElementById("xDecaf");
  var xPlant = document.getElementById("xPlant");
  var currentItem = null;
  var qty = 1;

  function calcFinal(base){
    var extra = 0;
    if(xDecaf.checked) extra += EXTRAS.decaf.price;
    if(xPlant.checked) extra += EXTRAS.plant.price;
    return (base + extra) * qty;
  }

  function openModal(item){
    currentItem = item;
    qty = 1;
    xDecaf.checked = false;
    xPlant.checked = false;

    mTitle.textContent = item.name;
    mPrice.textContent = "Î¤Î¹Î¼Î®: " + euro(item.price) + " (Î²Î¬ÏƒÎ·)";
    qtyValEl.textContent = String(qty);
    mFinal.textContent = euro(calcFinal(item.price));

    modalWrap.style.display = "flex";
  }

  function closeModal(){
    modalWrap.style.display = "none";
    currentItem = null;
  }

  document.getElementById("mClose").onclick = closeModal;
  modalWrap.addEventListener("click", function(e){ if(e.target === modalWrap) closeModal(); });

  document.getElementById("qtyMinus").onclick = function(){
    qty = Math.max(1, qty - 1);
    qtyValEl.textContent = String(qty);
    mFinal.textContent = euro(calcFinal(currentItem.price));
  };
  document.getElementById("qtyPlus").onclick = function(){
    qty = qty + 1;
    qtyValEl.textContent = String(qty);
    mFinal.textContent = euro(calcFinal(currentItem.price));
  };
  xDecaf.onchange = function(){ if(currentItem) mFinal.textContent = euro(calcFinal(currentItem.price)); };
  xPlant.onchange = function(){ if(currentItem) mFinal.textContent = euro(calcFinal(currentItem.price)); };

  function addEntry(method){
    ensureDay();
    var now = new Date();
    var time = now.toTimeString().slice(0,5);

    var extras = [];
    var extrasTotal = 0;
    if(xDecaf.checked){ extras.push(EXTRAS.decaf.name); extrasTotal += EXTRAS.decaf.price; }
    if(xPlant.checked){ extras.push(EXTRAS.plant.name); extrasTotal += EXTRAS.plant.price; }

    var unitFinal = currentItem.price + extrasTotal;
    var total = unitFinal * qty;

    var entry = {
      id: ++db.lastId,
      date: BASE_TODAY,
      time: time,
      category: currentItem.cat,
      item: currentItem.name,
      qty: qty,
      extras: extras,
      unit: unitFinal,
      total: total,
      method: method // cash | card | gift
    };

    db.days[TODAY].entries.push(entry);
    saveDB(db);
    toast(method === "gift" ? "ÎšÎ±Ï„Î±Ï‡Ï‰ÏÎ®Î¸Î·ÎºÎµ Ï‰Ï‚ ÎºÎµÏÎ±ÏƒÎ¼Î­Î½Î¿" : "ÎšÎ±Ï„Î±Ï‡Ï‰ÏÎ®Î¸Î·ÎºÎµ");
    closeModal();
    renderAll();
  }

  document.getElementById("payCash").onclick = function(){ addEntry("cash"); };
  document.getElementById("payCard").onclick = function(){ addEntry("card"); };
  document.getElementById("payGift").onclick = function(){ addEntry("gift"); };

  // Summary
  var sumTotalEl = document.getElementById("sumTotal");
  var sumCashEl = document.getElementById("sumCash");
  var sumCardEl = document.getElementById("sumCard");
  var sumGiftEl = document.getElementById("sumGift");
  var lastListEl = document.getElementById("lastList");

  function computeDay(){
    ensureDay();
    var entries = (db.days[TODAY] && db.days[TODAY].entries) ? db.days[TODAY].entries : [];
    var cash=0, card=0, gift=0;
    entries.forEach(function(e){
      if(e.method === "cash") cash += e.total;
      else if(e.method === "card") card += e.total;
      else if(e.method === "gift") gift += e.total;
    });
    return { entries:entries, cash:cash, card:card, gift:gift, total:(cash+card) };
  }

  function renderSummary(){
    var c = computeDay();
    sumTotalEl.textContent = euro(c.total);
    sumCashEl.textContent = euro(c.cash);
    sumCardEl.textContent = euro(c.card);
    sumGiftEl.textContent = euro(c.gift);

    lastListEl.innerHTML = "";
    var last = c.entries.slice(-6).reverse();
    if(!last.length){
      lastListEl.innerHTML = '<div class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎºÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· Î±ÎºÏŒÎ¼Î±.</div>';
      return;
    }
    last.forEach(function(e){
      var m = e.method === "cash" ? "ğŸ’¶" : (e.method === "card" ? "ğŸ’³" : "ğŸ");
      var ex = (e.extras && e.extras.length) ? (" +"+e.extras.join(", ")) : "";
      var line = document.createElement("div");
      line.textContent = m + " " + e.time + " â€” " + e.qty + "x " + e.item + ex + " = " + euro(e.total);
      lastListEl.appendChild(line);
    });
  }

  // Undo / Repeat
  document.getElementById("btnUndo").onclick = function(){
    ensureDay();
    var entries = db.days[TODAY].entries;
    if(!entries.length){ toast("Î¤Î¯Ï€Î¿Ï„Î± Î³Î¹Î± Î±Î½Î±Î¯ÏÎµÏƒÎ·"); return; }
    var removed = entries.pop();
    saveDB(db);
    toast("Î‘Î½Î±Î¹ÏÎ­Î¸Î·ÎºÎµ: " + removed.item);
    renderAll();
  };

  document.getElementById("btnRepeat").onclick = function(){
    ensureDay();
    var entries = db.days[TODAY].entries;
    if(!entries.length){ toast("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î· ÎºÎ¯Î½Î·ÏƒÎ·"); return; }
    var last = entries[entries.length-1];
    var now = new Date();
    var time = now.toTimeString().slice(0,5);
    var entry = Object.assign({}, last, { id: ++db.lastId, time: time });
    entries.push(entry);
    saveDB(db);
    toast("Î•Ï€Î±Î½Î±Î»Î®Ï†Î¸Î·ÎºÎµ: " + entry.item);
    renderAll();
  };

  // CSV export
  function escapeCSV(s){
    s = String(s == null ? "" : s);
    if (/[,"\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  }

  function downloadCSV(entries, filename){
    var uname = currentUser().name;
    var header = ["user","date","time","category","item","qty","extras","unit","total","method"];
    var lines = [header.join(",")];
    entries.forEach(function(e){
      lines.push([
        uname, e.date, e.time, e.category, e.item, e.qty,
        (e.extras||[]).join(" | "),
        e.unit.toFixed(2),
        e.total.toFixed(2),
        e.method
      ].map(escapeCSV).join(","));
    });
    var blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    var a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
    toast("ÎšÎ±Ï„Î­Î²Î·ÎºÎµ CSV");
  }

  document.getElementById("btnCSV").onclick = function(){
    var c = computeDay();
    if(!c.entries.length){ toast("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®ÏƒÎµÎ¹Ï‚"); return; }
    var uname = normalizeId(currentUser().name);
    downloadCSV(c.entries, "taMeio_" + BASE_TODAY + "_" + uname + ".csv");
  };

  // Reset day / wipe all
  document.getElementById("btnResetDay").onclick = function(){
    ensureDay();
    var uname = currentUser().name;
    if(!confirm('Î˜ÎµÏ‚ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î½Î± ÎºÎ±Î¸Î±ÏÎ¯ÏƒÎµÎ¹Ï‚ ÎœÎŸÎÎŸ Ï„Î· ÏƒÎ·Î¼ÎµÏÎ¹Î½Î® Î·Î¼Î­ÏÎ± Î³Î¹Î± Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· "'+uname+'";')) return;
    db.days[TODAY] = { entries:[] };
    saveDB(db);
    toast("ÎšÎ±Î¸Î±ÏÎ¯ÏƒÏ„Î·ÎºÎµ Î· Î·Î¼Î­ÏÎ±");
    renderAll();
  };

  document.getElementById("btnWipeAll").onclick = function(){
    if(!confirm("Î Î¡ÎŸÎ£ÎŸÎ§Î—: Î˜Î± Î´Î¹Î±Î³ÏÎ±Ï†Î¿ÏÎ½ ÎŸÎ›Î‘ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î±Ï€ÏŒ Ï„Î· ÏƒÏ…ÏƒÎºÎµÏ…Î®. Î£Ï…Î½Î­Ï‡ÎµÎ¹Î±;")) return;
    localStorage.removeItem(LS_KEY);
    localStorage.removeItem(LS_USERS);
    localStorage.removeItem(LS_USER);
    location.reload();
  };

  // Close day (simple modal report)
  document.getElementById("btnClose").onclick = function(){
    var c = computeDay();
    var uname = currentUser().name;

    var wrap = document.createElement("div");
    wrap.className = "modalWrap";
    wrap.style.display = "flex";

    var modal = document.createElement("div");
    modal.className = "modal";
    modal.innerHTML =
      '<div class="row" style="align-items:flex-start;">' +
        '<div><h2>ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Î—Î¼Î­ÏÎ±Ï‚ â€“ '+BASE_TODAY.split("-").reverse().join("/")+'</h2>' +
        '<div class="muted">Î§ÏÎ®ÏƒÏ„Î·Ï‚: <b>'+uname+'</b></div></div>' +
        '<button class="btn" id="rClose">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>' +
      '</div>' +
      '<div class="divider"></div>' +
      '<div style="display:grid; gap:6px;">' +
        '<div class="row"><span>Î£ÏÎ½Î¿Î»Î¿ (cash+card)</span><b>'+euro(c.total)+'</b></div>' +
        '<div class="row"><span>ÎœÎµÏ„ÏÎ·Ï„Î¬</span><b>'+euro(c.cash)+'</b></div>' +
        '<div class="row"><span>ÎšÎ¬ÏÏ„Î±</span><b>'+euro(c.card)+'</b></div>' +
        '<div class="row"><span>ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±</span><b>'+euro(c.gift)+'</b></div>' +
        '<div class="row"><span>Î£ÏÎ½Î¿Î»Î¿ ÎºÎ¹Î½Î®ÏƒÎµÏ‰Î½</span><b>'+c.entries.length+'</b></div>' +
      '</div>' +
      '<div class="divider"></div>' +
      '<button class="btn primary" id="rCSV" style="width:100%;">Î›Î®ÏˆÎ· CSV (ÏƒÎ·Î¼ÎµÏÎ¹Î½Î¬)</button>';

    wrap.appendChild(modal);
    document.body.appendChild(wrap);

    modal.querySelector("#rClose").onclick = function(){ wrap.remove(); };
    wrap.addEventListener("click", function(e){ if(e.target === wrap) wrap.remove(); });
    modal.querySelector("#rCSV").onclick = function(){
      var uname2 = normalizeId(currentUser().name);
      downloadCSV(c.entries, "taMeio_" + BASE_TODAY + "_" + uname2 + ".csv");
    };
  };

  function renderAll(){
    buildCats();
    buildProducts();
    renderSummary();
  }

  // INIT (Ï€Î¿Î»Ï ÏƒÎ·Î¼Î±Î½Ï„Î¹ÎºÏŒ: Î±Ï…Ï„Î¬ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï„ÏÎ­Î¾Î¿Ï…Î½)
  renderUserSelect();
  ensureDay();
  renderAll();

})(); // end IIFE
</script>
</body>
</html> 
