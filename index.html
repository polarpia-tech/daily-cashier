<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#0b0f14"/>
  <title>Î—Î¼ÎµÏÎ®ÏƒÎ¹Î¿ Î¤Î±Î¼ÎµÎ¯Î¿</title>
  <link rel="manifest" href="./manifest.webmanifest"/>

  <style>
    :root{
      --bg:#0b0f14;
      --text:#e9eef7;
      --muted:#9fb0c7;
      --line:rgba(255,255,255,.08);
      --accent:#3aa2ff;
      --ok:#24d18d;
      --danger:#ff5b6e;
      --warn:#ffb020;

      --r:18px;
      --pad:12px;
      --tap:42px;
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      background: radial-gradient(800px 500px at 50% -10%, rgba(58,162,255,.18), transparent 60%),
                  radial-gradient(600px 400px at 20% 10%, rgba(36,209,141,.12), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased;
      line-height:1.2;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
      overflow-x:hidden;
    }

    button, input, select{font:inherit; color:inherit;}
    .wrap{max-width:1040px; margin:0 auto; padding:16px 14px 170px;}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .between{justify-content:space-between;}
    .title{font-size:28px; font-weight:800; letter-spacing:.2px;}
    .sub{color:var(--muted); margin-top:2px; font-size:14px;}

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:14px;
      box-shadow:0 18px 60px rgba(0,0,0,.40);
    }
    .card2{
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:12px;
    }

    .pill{
      height:var(--tap);
      border-radius:999px;
      padding:0 14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
      transition:.15s transform,.15s border-color,.15s background;
      white-space:normal;
      text-align:center;
      line-height:1.1;
    }
    .pill:hover{transform:translateY(-1px); border-color:rgba(58,162,255,.35);}
    .pill:active{transform:translateY(0);}
    .pill.primary{border-color:rgba(58,162,255,.55); box-shadow:0 0 0 3px rgba(58,162,255,.12) inset;}
    .pill.ok{border-color:rgba(36,209,141,.55); box-shadow:0 0 0 3px rgba(36,209,141,.10) inset;}
    .pill.bad{border-color:rgba(255,91,110,.55); box-shadow:0 0 0 3px rgba(255,91,110,.10) inset;}
    .pill.warn{border-color:rgba(255,176,32,.55); box-shadow:0 0 0 3px rgba(255,176,32,.10) inset;}
    .pill.small{height:36px; padding:0 12px; font-size:14px;}
    .pill.block{width:100%;}
    .btnIcon{
      width:var(--tap);
      height:var(--tap);
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      cursor:pointer;
      display:grid;
      place-items:center;
      transition:.15s transform,.15s border-color;
    }

    .gridAuto{display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:10px;}
    .seg{
      display:grid; grid-template-columns:1fr 1fr; gap:8px;
      padding:8px;
      border-radius:999px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
    }
    .seg button{
      height:40px; border-radius:999px;
      border:1px solid transparent;
      background:transparent;
      cursor:pointer;
      color:var(--muted);
      font-weight:800;
    }
    .seg button.active{
      background:rgba(58,162,255,.12);
      border-color:rgba(58,162,255,.35);
      color:var(--text);
    }

    .list{display:flex; flex-direction:column; gap:10px;}
    .item{
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
      transition:.15s transform,.15s border-color;
    }
    .item:hover{transform:translateY(-1px); border-color:rgba(58,162,255,.28);}
    .item:active{transform:translateY(0);}
    .item .name{font-weight:900;}
    .item .meta{font-size:13px; color:var(--muted); margin-top:4px;}
    .price{font-weight:900; letter-spacing:.2px;}

    .muted{color:var(--muted);}
    .h2{font-size:18px; font-weight:900; margin:0 0 8px;}
    .sp{height:10px;}
    .hr{height:1px; background:var(--line); margin:12px 0;}
    .hide{display:none !important;}

    .bottomBar{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding:12px 12px calc(12px + env(safe-area-inset-bottom));
      background:linear-gradient(180deg, transparent, rgba(11,15,20,.65) 20%, rgba(11,15,20,.92));
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(255,255,255,.06);
      z-index:999;
    }
    .bottomBar .inner{
      max-width:1040px;
      margin:0 auto;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .bottomBar .pill{
      font-size:13px;
      padding:0 10px;
      min-height:46px;
    }

    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(4px);
      display:none;
      z-index:2000;
      padding:18px 12px;
    }
    .overlay.show{display:flex; align-items:flex-end; justify-content:center;}
    .sheet{
      width:min(720px, 100%);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(15,20,29,.92);
      box-shadow:0 30px 120px rgba(0,0,0,.65);
      padding:14px;
      max-height:85vh;
      overflow:auto;
    }
    .sheetHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding-bottom:10px;
    }

    .payLine{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:10px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }
    .payLine input{width:22px; height:22px; accent-color: var(--accent);}
    .payLine .left{display:flex; align-items:center; gap:10px;}
    .payLine .t{font-weight:900;}
    .payLine .s{color:var(--muted); font-size:13px; margin-top:3px;}
    .payLine .right{font-weight:900;}

    .catGrid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    @media (min-width:520px){
      .catGrid{ grid-template-columns: 1fr 1fr; }
    }
    .catBtn{
      height:56px;
      border-radius:18px;
      font-weight:900;
    }

    @media (max-width:420px){
      .title{font-size:24px;}
      .wrap{padding-bottom:190px;}
      .gridAuto{grid-template-columns:repeat(auto-fit,minmax(120px,1fr));}
      .pill{padding:0 12px;}
      .bottomBar .pill{font-size:12.5px;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="row between">
      <div>
        <div class="title">Î—Î¼ÎµÏÎ®ÏƒÎ¹Î¿ Î¤Î±Î¼ÎµÎ¯Î¿</div>
        <div class="sub" id="todayText">Î£Î®Î¼ÎµÏÎ±: â€”</div>
      </div>
    </div>

    <div class="sp"></div>

    <div class="card">
      <div class="row between">
        <div class="row" style="gap:10px; flex:1;">
          <select id="userSelect" class="pill" style="flex:1; min-width:180px;"></select>
          <div class="pill" id="activeInfo" style="flex:1; min-width:210px;">Î¤ÏÎ±Ï€Î­Î¶Î¹: â€” â€¢ Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: 0,00 â‚¬</div>
        </div>
        <button class="btnIcon" id="btnSettings" title="Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚">âš™</button>
      </div>

      <div class="sp"></div>

      <div class="seg">
        <button id="tabOrder" class="active">Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±</button>
        <button id="tabTickets">Tickets</button>
      </div>

      <div class="sp"></div>

      <div class="row" id="ticketActions">
        <button class="pill small" id="btnNewTicket">+ Ticket</button>
        <button class="pill small" id="btnCloseTicket">ÎšÎ»ÎµÎ¯ÏƒÎµ Ticket</button>
      </div>

      <div class="hr"></div>

      <div id="viewOrder">
        <div class="card2" id="tablesCard">
          <div class="h2">Î“ÏÎ®Î³Î¿ÏÎ· ÎµÏ€Î¹Î»Î¿Î³Î® Ï„ÏÎ±Ï€ÎµÎ¶Î¹Î¿Ï</div>
          <div class="muted">Î Î¬Ï„Î± Ï„ÏÎ±Ï€Î­Î¶Î¹ â†’ Î±Î½Î¿Î¯Î³Î¿Ï…Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚ â†’ Î¼ÎµÏ„Î¬ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±.</div>
          <div class="sp"></div>
          <div id="tableGrid" class="gridAuto"></div>
        </div>

        <div class="sp"></div>

        <div class="card2" id="productsCard">
          <div class="h2">Î ÏÎ¿ÏŠÏŒÎ½Ï„Î±</div>
          <div class="muted">Î”Î¹Î¬Î»ÎµÎ¾Îµ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± ÎºÎ±Î¹ Î¼ÎµÏ„Î¬ Ï€ÏÎ¿ÏŠÏŒÎ½.</div>
          <div class="sp"></div>
          <div id="catRow" class="row" style="gap:8px; flex-wrap:wrap;"></div>
          <div class="sp"></div>
          <input id="search" class="pill block" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·..." style="text-align:left; justify-content:flex-start;"/>
          <div class="sp"></div>
          <div id="productList" class="list"></div>
        </div>

        <div class="sp"></div>

        <div class="card2">
          <div class="row between">
            <div>
              <div class="h2">Ticket: <span id="ticketTitle">â€”</span></div>
              <div class="muted">Î Î»Î·ÏÏÎ½ÎµÎ¹Ï‚ Î±Î½Î¬ Ï€ÏÎ¿ÏŠÏŒÎ½ (split).</div>
            </div>
            <button class="pill warn small" id="btnPay">Î Î»Î·ÏÏ‰Î¼Î® / Split</button>
          </div>

          <div class="sp"></div>
          <div id="ticketLines" class="list"></div>

          <div class="hr"></div>

          <div class="row between">
            <button class="pill small" id="btnResetDay">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î±Î½Î¿Î¹Ï‡Ï„ÏÎ½ (Ï„ÏÎ±Ï€Î­Î¶Î¹)</button>
            <div class="muted" id="sumMini">ÎœÎµÏ„ÏÎ·Ï„Î¬: 0,00 â‚¬ â€¢ ÎšÎ¬ÏÏ„Î±: 0,00 â‚¬ â€¢ ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±: 0,00 â‚¬</div>
          </div>
        </div>
      </div>

      <div id="viewTickets" class="hide">
        <div class="card2">
          <div class="h2">Tickets</div>
          <div class="muted">Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï„ÏÎ±Ï€Î­Î¶Î¹ Î³Î¹Î± Î½Î± Î´ÎµÎ¹Ï‚/Ï€Î»Î·ÏÏÏƒÎµÎ¹Ï‚ Ï„Î± Î±Î½Î¿Î¹Ï‡Ï„Î¬ Ï„Î¿Ï….</div>
          <div class="sp"></div>
          <div id="ticketsList" class="list"></div>
        </div>

        <div class="sp"></div>

        <div class="card2">
          <div class="h2">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Î·Î¼Î­ÏÎ±Ï‚</div>
          <div class="muted">Î•Î¾Î±Î³Ï‰Î³Î® CSV Î³Î¹Î± Î½Î± Î´ÏÏƒÎµÎ¹Ï‚ Ï„Î±Î¼ÎµÎ¯Î¿.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Bar -->
  <div class="bottomBar">
    <div class="inner">
      <button class="pill ok block" id="btnUndoPay">Undo Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚</button>
      <button class="pill primary block" id="btnRedoPay">Redo Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚</button>
      <button class="pill block" id="btnCSV">Î•Î¾Î±Î³Ï‰Î³Î® CSV</button>
      <button class="pill bad block" id="btnWipeAll">Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏŒÎ»Ï‰Î½</button>
    </div>
    <div class="muted" style="max-width:1040px;margin:8px auto 0; font-size:13px;">
      Chrome â‹® â†’ <b>Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î·Î½ Î±ÏÏ‡Î¹ÎºÎ® Î¿Î¸ÏŒÎ½Î·</b>.
    </div>
  </div>

  <!-- Settings Sheet -->
  <div class="overlay" id="overlay">
    <div class="sheet" id="sheet">
      <div class="sheetHead">
        <div style="font-weight:900; font-size:18px;">Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</div>
        <button class="pill small" id="btnCloseSheet">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
      </div>

      <div class="card2">
        <div class="row between">
          <div>
            <div class="muted">Î—Î¼Î­ÏÎ±:</div>
            <div id="dayLabel" style="font-weight:900;">â€”</div>
          </div>
          <div>
            <div class="muted">Î§ÏÎ®ÏƒÏ„Î·Ï‚:</div>
            <div id="userLabel" style="font-weight:900;">â€”</div>
          </div>
          <button class="pill small" id="btnEndDay">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
        </div>

        <div class="hr"></div>

        <div class="row" style="gap:8px; flex-wrap:wrap;">
          <button class="pill small" id="btnAddUser">+ Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Ï‡ÏÎ®ÏƒÏ„Î·</button>
          <button class="pill small" id="btnRenameUser">âœ ÎœÎµÏ„Î¿Î½Î¿Î¼Î±ÏƒÎ¯Î±</button>
          <button class="pill small" id="btnSetPin">ğŸ”’ Î‘Î»Î»Î±Î³Î® PIN</button>
          <button class="pill small bad" id="btnDeleteUser">ğŸ—‘ Î”Î¹Î±Î³ÏÎ±Ï†Î® Ï‡ÏÎ®ÏƒÏ„Î·</button>
        </div>

        <div class="hr"></div>

        <div class="muted" style="font-size:13px;">
          Confirm Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚ Î¼ÏŒÎ½Î¿ Î±Î½ â‰¥ <b>15â‚¬</b> Î® â‰¥ <b>3 Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±</b>. Î£Ï„Î± <b>ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±</b> Ï€Î¬Î½Ï„Î± confirm.
        </div>
      </div>

      <div class="sp"></div>

      <div class="card2">
        <div class="h2">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î±Î½Î¿Î¹Ï‡Ï„ÏÎ½</div>
        <div class="muted">ÎšÎ±Î¸Î±ÏÎ¯Î¶ÎµÎ¹ Ï„Î± Î±Î½Î¿Î¹Ï‡Ï„Î¬ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± Ï„Î¿Ï… ÎµÎ½ÎµÏÎ³Î¿Ï Ï„ÏÎ±Ï€ÎµÎ¶Î¹Î¿Ï (Î´ÎµÎ½ Î±ÎºÎ¿Ï…Î¼Ï€Î¬ÎµÎ¹ Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚).</div>
        <div class="sp"></div>
        <button class="pill warn block" id="btnClearOpen">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î±Î½Î¿Î¹Ï‡Ï„ÏÎ½ (Ï„ÏÎ±Ï€Î­Î¶Î¹)</button>
      </div>
    </div>
  </div>

  <!-- Pay Sheet -->
  <div class="overlay" id="payOverlay">
    <div class="sheet">
      <div class="sheetHead">
        <div>
          <div id="payTitle" style="font-weight:900; font-size:18px;">â€”</div>
          <div class="muted" id="paySub">Î Î»Î®ÏÏ‰ÏƒÎµ Î±Î½Î¬ Ï€ÏÎ¿ÏŠÏŒÎ½.</div>
        </div>
        <button class="pill small" id="btnClosePay">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
      </div>

      <div class="card2">
        <div class="row between" style="gap:8px;">
          <button class="pill small" id="btnSelectAll">Î•Ï€Î¯Î»ÎµÎ¾Îµ ÏŒÎ»Î±</button>
          <div class="muted" id="payTotal">Î¤ÎµÎ»Î¹ÎºÏŒ: 0,00 â‚¬</div>
        </div>
        <div class="sp"></div>

        <div id="payList" class="list"></div>

        <div class="hr"></div>

        <div class="row" style="gap:10px; flex-wrap:wrap;">
          <button class="pill ok" id="btnPayCash">ÎœÎµÏ„ÏÎ·Ï„Î¬</button>
          <button class="pill primary" id="btnPayCard">ÎšÎ¬ÏÏ„Î±</button>
          <button class="pill warn" id="btnPayFree">ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Category Quick Sheet -->
  <div class="overlay" id="catOverlay">
    <div class="sheet">
      <div class="sheetHead">
        <div>
          <div id="catTitle" style="font-weight:900; font-size:18px;">ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚</div>
          <div class="muted" id="catSub">Î”Î¹Î¬Î»ÎµÎ¾Îµ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± Î³Î¹Î± Î½Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„Î¿ÏÎ½ Ï„Î± Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±.</div>
        </div>
        <button class="pill small" id="btnCloseCats">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
      </div>

      <div class="card2">
        <div class="catGrid" id="catGrid"></div>
      </div>
    </div>
  </div>

<script>
/* =================== CONFIG =================== */
const LS_KEY = "mini_cashier_db_v2";
const LS_USERS = "mini_cashier_users_v2";
const LS_ACTIVE_USER = "mini_cashier_active_user_v2";
const TODAY = new Date().toISOString().slice(0,10);

const CONFIRM_MIN_TOTAL = 15;
const CONFIRM_MIN_ITEMS = 3;

/* =================== MENU =================== */
const products = [
  {cat:"â˜• ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ Î–Î•Î£Î¤ÎŸÎ™", name:"Espresso Î¼Î¿Î½ÏŒÏ‚", price:2.60},
  {cat:"â˜• ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ Î–Î•Î£Î¤ÎŸÎ™", name:"Espresso Î´Î¹Ï€Î»ÏŒÏ‚", price:3.20},
  {cat:"â˜• ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ Î–Î•Î£Î¤ÎŸÎ™", name:"Espresso macchiato", price:2.90},
  {cat:"â˜• ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ Î–Î•Î£Î¤ÎŸÎ™", name:"Americano", price:3.20},
  {cat:"â˜• ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ Î–Î•Î£Î¤ÎŸÎ™", name:"Cappuccino", price:3.60},
  {cat:"â˜• ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ Î–Î•Î£Î¤ÎŸÎ™", name:"Cappuccino Î´Î¹Ï€Î»ÏŒÏ‚", price:4.20},
  {cat:"â˜• ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ Î–Î•Î£Î¤ÎŸÎ™", name:"Latte macchiato", price:4.20},
  {cat:"â˜• ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ Î–Î•Î£Î¤ÎŸÎ™", name:"Flat white", price:4.40},
  {cat:"â˜• ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ Î–Î•Î£Î¤ÎŸÎ™", name:"Mocha", price:4.50},
  {cat:"â˜• ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ Î–Î•Î£Î¤ÎŸÎ™", name:"ÎšÎ±Ï†Î­Ï‚ Ï†Î¯Î»Ï„ÏÎ¿Ï…", price:3.00},

  {cat:"â„ï¸ ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ ÎšÎ¡Î¥ÎŸÎ™", name:"Freddo espresso", price:3.80},
  {cat:"â„ï¸ ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ ÎšÎ¡Î¥ÎŸÎ™", name:"Freddo cappuccino", price:4.20},
  {cat:"â„ï¸ ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ ÎšÎ¡Î¥ÎŸÎ™", name:"Iced latte", price:4.50},
  {cat:"â„ï¸ ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ ÎšÎ¡Î¥ÎŸÎ™", name:"Cold brew", price:4.80},
  {cat:"â„ï¸ ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ ÎšÎ¡Î¥ÎŸÎ™", name:"Frappe", price:3.50},

  {cat:"ğŸ«– Î¤Î£Î‘Îª â€“ Î–Î•Î£Î¤Î‘ Î¡ÎŸÎ¦Î—ÎœÎ‘Î¤Î‘", name:"Î¤ÏƒÎ¬Î¹ (Î¼Î±ÏÏÎ¿/Ï€ÏÎ¬ÏƒÎ¹Î½Î¿/Î²ÏŒÏ„Î±Î½Î±)", price:3.20},
  {cat:"ğŸ«– Î¤Î£Î‘Îª â€“ Î–Î•Î£Î¤Î‘ Î¡ÎŸÎ¦Î—ÎœÎ‘Î¤Î‘", name:"Î¤ÏƒÎ¬Î¹ Ï†ÏÎ¿ÏÏ„Ï‰Î½", price:3.50},
  {cat:"ğŸ«– Î¤Î£Î‘Îª â€“ Î–Î•Î£Î¤Î‘ Î¡ÎŸÎ¦Î—ÎœÎ‘Î¤Î‘", name:"Chai latte", price:4.30},

  {cat:"ğŸ« Î£ÎŸÎšÎŸÎ›Î‘Î¤Î•Î£ â€“ Î“Î‘Î›Î‘ÎšÎ¤Î•Î¡Î‘", name:"Î–ÎµÏƒÏ„Î® ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:4.20},
  {cat:"ğŸ« Î£ÎŸÎšÎŸÎ›Î‘Î¤Î•Î£ â€“ Î“Î‘Î›Î‘ÎšÎ¤Î•Î¡Î‘", name:"ÎšÏÏÎ± ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:4.50},
  {cat:"ğŸ« Î£ÎŸÎšÎŸÎ›Î‘Î¤Î•Î£ â€“ Î“Î‘Î›Î‘ÎšÎ¤Î•Î¡Î‘", name:"Î›ÎµÏ…ÎºÎ® ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:4.50},
  {cat:"ğŸ« Î£ÎŸÎšÎŸÎ›Î‘Î¤Î•Î£ â€“ Î“Î‘Î›Î‘ÎšÎ¤Î•Î¡Î‘", name:"ÎšÎ±ÎºÎ¬Î¿", price:4.00},

  {cat:"ğŸ¥¤ Î‘ÎÎ‘Î¨Î¥ÎšÎ¤Î™ÎšÎ‘ â€“ ÎÎ•Î¡Î‘", name:"Coca-Cola / Zero / Fanta (0,33l)", price:3.40},
  {cat:"ğŸ¥¤ Î‘ÎÎ‘Î¨Î¥ÎšÎ¤Î™ÎšÎ‘ â€“ ÎÎ•Î¡Î‘", name:"Ice Tea", price:3.60},
  {cat:"ğŸ¥¤ Î‘ÎÎ‘Î¨Î¥ÎšÎ¤Î™ÎšÎ‘ â€“ ÎÎ•Î¡Î‘", name:"Î£ÏŒÎ´Î± / Î¤ÏŒÎ½Î¹Îº", price:3.20},
  {cat:"ğŸ¥¤ Î‘ÎÎ‘Î¨Î¥ÎšÎ¤Î™ÎšÎ‘ â€“ ÎÎ•Î¡Î‘", name:"ÎœÎµÏ„Î±Î»Î»Î¹ÎºÏŒ Î½ÎµÏÏŒ (0,33l)", price:2.80},
  {cat:"ğŸ¥¤ Î‘ÎÎ‘Î¨Î¥ÎšÎ¤Î™ÎšÎ‘ â€“ ÎÎ•Î¡Î‘", name:"ÎœÎµÏ„Î±Î»Î»Î¹ÎºÏŒ Î½ÎµÏÏŒ (0,75l)", price:5.50},

  {cat:"ğŸŠ Î§Î¥ÎœÎŸÎ™ â€“ SMOOTHIES", name:"Î¦Ï…ÏƒÎ¹ÎºÏŒÏ‚ Ï‡Ï…Î¼ÏŒÏ‚ Ï€Î¿ÏÏ„Î¿ÎºÎ¬Î»Î¹", price:4.50},
  {cat:"ğŸŠ Î§Î¥ÎœÎŸÎ™ â€“ SMOOTHIES", name:"Î§Ï…Î¼ÏŒÏ‚ Î±Î½Î¬Î¼ÎµÎ¹ÎºÏ„Î¿Ï‚", price:4.80},
  {cat:"ğŸŠ Î§Î¥ÎœÎŸÎ™ â€“ SMOOTHIES", name:"Smoothie Ï†ÏÎ¿ÏÏ„Ï‰Î½", price:5.80},
  {cat:"ğŸŠ Î§Î¥ÎœÎŸÎ™ â€“ SMOOTHIES", name:"Milkshake", price:5.50},

  {cat:"ğŸ¥ Î£ÎÎ‘Îš â€“ Î“Î›Î¥ÎšÎ‘", name:"ÎšÏÎ¿Ï…Î±ÏƒÎ¬Î½ ÏƒÎºÎ­Ï„Î¿", price:2.80},
  {cat:"ğŸ¥ Î£ÎÎ‘Îš â€“ Î“Î›Î¥ÎšÎ‘", name:"ÎšÏÎ¿Ï…Î±ÏƒÎ¬Î½ ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:3.20},
  {cat:"ğŸ¥ Î£ÎÎ‘Îš â€“ Î“Î›Î¥ÎšÎ‘", name:"ÎœÎ¬Ï†Î¹Î½", price:3.50},
  {cat:"ğŸ¥ Î£ÎÎ‘Îš â€“ Î“Î›Î¥ÎšÎ‘", name:"ÎšÎ­Î¹Îº (ÎºÎ¿Î¼Î¼Î¬Ï„Î¹)", price:4.20},
  {cat:"ğŸ¥ Î£ÎÎ‘Îš â€“ Î“Î›Î¥ÎšÎ‘", name:"Cheesecake", price:4.80},
  {cat:"ğŸ¥ Î£ÎÎ‘Îš â€“ Î“Î›Î¥ÎšÎ‘", name:"ÎœÏ€Î¹ÏƒÎºÏŒÏ„Î±", price:2.50},
  {cat:"ğŸ¥ Î£ÎÎ‘Îš â€“ Î“Î›Î¥ÎšÎ‘", name:"Î¤Î¿ÏƒÏ„ Î¶Î±Î¼Ï€ÏŒÎ½-Ï„Ï…ÏÎ¯", price:4.50},
  {cat:"ğŸ¥ Î£ÎÎ‘Îš â€“ Î“Î›Î¥ÎšÎ‘", name:"Î¤Î¿ÏƒÏ„ vegetarian", price:4.80},

  {cat:"ğŸº ÎœÎ Î¥Î¡Î•Î£", name:"ÎœÏ€ÏÏÎ± Î²Î±ÏÎµÎ»Î¯ÏƒÎ¹Î± (0,5l)", price:5.20},
  {cat:"ğŸº ÎœÎ Î¥Î¡Î•Î£", name:"ÎœÏ€ÏÏÎ± ÎµÎ¼Ï†Î¹Î±Î»Ï‰Î¼Î­Î½Î· (0,33l)", price:4.20},
  {cat:"ğŸº ÎœÎ Î¥Î¡Î•Î£", name:"Weissbier (0,5l)", price:5.50},
  {cat:"ğŸº ÎœÎ Î¥Î¡Î•Î£", name:"ÎœÏ€ÏÏÎ± Ï‡Ï‰ÏÎ¯Ï‚ Î±Î»ÎºÎ¿ÏŒÎ»", price:4.20},

  {cat:"ğŸ· ÎšÎ¡Î‘Î£Î™Î‘", name:"ÎšÏÎ±ÏƒÎ¯ Ï€Î¿Ï„Î®ÏÎ¹", price:5.50},
  {cat:"ğŸ· ÎšÎ¡Î‘Î£Î™Î‘", name:"ÎšÏÎ±ÏƒÎ¯ ÎºÎ±ÏÎ¬Ï†Î± (0,5l)", price:12.00},
  {cat:"ğŸ· ÎšÎ¡Î‘Î£Î™Î‘", name:"Prosecco Ï€Î¿Ï„Î®ÏÎ¹", price:6.50},

  {cat:"ğŸ¥ƒ Î ÎŸÎ¤Î‘ (4cl)", name:"ÎŸÏ…Î¯ÏƒÎºÎ¹ standard", price:8.50},
  {cat:"ğŸ¥ƒ Î ÎŸÎ¤Î‘ (4cl)", name:"Premium Î¿Ï…Î¯ÏƒÎºÎ¹", price:10.50},
  {cat:"ğŸ¥ƒ Î ÎŸÎ¤Î‘ (4cl)", name:"Î’ÏŒÏ„ÎºÎ±", price:8.00},
  {cat:"ğŸ¥ƒ Î ÎŸÎ¤Î‘ (4cl)", name:"Î¡Î¿ÏÎ¼Î¹", price:8.50},
  {cat:"ğŸ¥ƒ Î ÎŸÎ¤Î‘ (4cl)", name:"Î¤Î¶Î¹Î½", price:8.50},
  {cat:"ğŸ¥ƒ Î ÎŸÎ¤Î‘ (4cl)", name:"ÎŸÏÎ¶Î¿ / Î¤ÏƒÎ¯Ï€Î¿Ï…ÏÎ¿", price:7.50},
  {cat:"ğŸ¥ƒ Î ÎŸÎ¤Î‘ (4cl)", name:"Î›Î¹ÎºÎ­Ï", price:7.50},

  {cat:"ğŸ¸ ÎšÎŸÎšÎ¤Î•ÎªÎ›", name:"Mojito", price:9.50},
  {cat:"ğŸ¸ ÎšÎŸÎšÎ¤Î•ÎªÎ›", name:"Caipirinha", price:9.50},
  {cat:"ğŸ¸ ÎšÎŸÎšÎ¤Î•ÎªÎ›", name:"Margarita", price:10.00},
  {cat:"ğŸ¸ ÎšÎŸÎšÎ¤Î•ÎªÎ›", name:"Aperol Spritz", price:8.50},
  {cat:"ğŸ¸ ÎšÎŸÎšÎ¤Î•ÎªÎ›", name:"Gin Tonic", price:9.00},
  {cat:"ğŸ¸ ÎšÎŸÎšÎ¤Î•ÎªÎ›", name:"Negroni", price:10.50},
];

const defaultTables = ["T1","T2","T3","T4","T5","T6","T7","T8","T9","T10","T11","T12","T13","T14","T15","T16","T17","BAR","Î•ÎÎ©"];

/* =================== HELPERS =================== */
const $ = (id)=>document.getElementById(id);
const fmt = (n)=> (n||0).toLocaleString("el-GR",{minimumFractionDigits:2,maximumFractionDigits:2})+" â‚¬";
const uid = ()=> Math.random().toString(36).slice(2)+Date.now().toString(36);

function load(key, fallback){
  try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
  catch{ return fallback; }
}
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
}
function isValidPin(pin){ return /^\d{4}$/.test(pin); }

/* =================== USERS + PIN =================== */
function ensureUsers(){
  let users = load("mini_cashier_users_v2", null);
  if(!users || !Array.isArray(users) || users.length===0){
    users = [{id:uid(), name:"Î§ÏÎ®ÏƒÏ„Î·Ï‚ 1", pinHash:null}];
    save("mini_cashier_users_v2", users);
    save("mini_cashier_active_user_v2", users[0].id);
  }
  return users;
}
function getActiveUserId(){
  const users = ensureUsers();
  const saved = load("mini_cashier_active_user_v2", null);
  if(saved && users.some(u=>u.id===saved)) return saved;
  save("mini_cashier_active_user_v2", users[0].id);
  return users[0].id;
}
function getActiveUser(){
  const users = ensureUsers();
  const id = getActiveUserId();
  return users.find(u=>u.id===id) || users[0];
}
async function requirePin(user, reason){
  if(!user.pinHash){
    alert("ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ PIN Î±ÎºÏŒÎ¼Î±. Î’Î¬Î»Îµ 4-ÏˆÎ®Ï†Î¹Î¿ PIN.");
    const pin1 = prompt("Î’Î¬Î»Îµ Î½Î­Î¿ 4-ÏˆÎ®Ï†Î¹Î¿ PIN:");
    if(!pin1 || !isValidPin(pin1)) { alert("Î†ÎºÏ…ÏÎ¿ PIN."); return false; }
    const pin2 = prompt("ÎÎ±Î½Î±Î³ÏÎ¬ÏˆÎµ Ï„Î¿ PIN:");
    if(pin2 !== pin1) { alert("Î”ÎµÎ½ Ï„Î±Î¹ÏÎ¹Î¬Î¶Î¿Ï…Î½."); return false; }
    const users = ensureUsers();
    const idx = users.findIndex(u=>u.id===user.id);
    users[idx].pinHash = await sha256Hex(pin1);
    save("mini_cashier_users_v2", users);
    return true;
  }
  const pin = prompt(`PIN Î±Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ (${reason}).\nÎ“ÏÎ¬ÏˆÎµ 4-ÏˆÎ®Ï†Î¹Î¿ PIN:`);
  if(!pin) return false;
  if(!isValidPin(pin)) { alert("Î†ÎºÏ…ÏÎ¿ PIN."); return false; }
  const h = await sha256Hex(pin);
  if(h !== user.pinHash){ alert("Î›Î¬Î¸Î¿Ï‚ PIN."); return false; }
  return true;
}

/* =================== DB =================== */
function ensureDB(){
  const db = load("mini_cashier_db_v2", { days:{} });
  if(!db.days[TODAY]){
    db.days[TODAY] = {
      meta:{ day:TODAY, activeTable: defaultTables[0] },
      tables:{},
      payments:[],
      undone:[]
    };
    for(const t of defaultTables){
      db.days[TODAY].tables[t] = { lines:[] };
    }
    save("mini_cashier_db_v2", db);
  } else {
    for(const t of defaultTables){
      if(!db.days[TODAY].tables[t]) db.days[TODAY].tables[t] = { lines:[] };
      if(!Array.isArray(db.days[TODAY].tables[t].lines)) db.days[TODAY].tables[t].lines = [];
    }
    if(!Array.isArray(db.days[TODAY].payments)) db.days[TODAY].payments = [];
    if(!Array.isArray(db.days[TODAY].undone)) db.days[TODAY].undone = [];
  }
  return db;
}
function getLines(db, table){ return db.days[TODAY].tables[table].lines; }
function unpaidLines(lines){ return lines.filter(x=>!x.paid); }
function sumOpen(db, table){ return unpaidLines(getLines(db, table)).reduce((s,x)=>s+x.price,0); }
function sumByMethod(payments){
  const out = {cash:0, card:0, free:0};
  for(const p of payments) out[p.method] += p.total;
  return out;
}

/* =================== UI STATE =================== */
let activeCat = null;
let tab = "order";
const payState = { ids:new Set() };

/* =================== OVERLAYS =================== */
function showSheet(on){ $("overlay").classList.toggle("show", !!on); }
function showPay(on){ $("payOverlay").classList.toggle("show", !!on); }
function showCats(on){ $("catOverlay").classList.toggle("show", !!on); }

/* =================== RENDER =================== */
function renderTop(){
  $("todayText").textContent = "Î£Î®Î¼ÎµÏÎ±: " + TODAY.split("-").reverse().join("/");
  const users = ensureUsers();
  $("userSelect").innerHTML = users.map(u=>`<option value="${u.id}">${u.name}</option>`).join("");
  $("userSelect").value = getActiveUserId();
}
function renderActiveInfo(){
  const db = ensureDB();
  const day = db.days[TODAY];
  const t = day.meta.activeTable;
  const open = sumOpen(db, t);
  $("activeInfo").textContent = `Î¤ÏÎ±Ï€Î­Î¶Î¹: ${t}  â€¢  Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: ${fmt(open)}`;

  $("dayLabel").textContent = TODAY.split("-").reverse().join("/");
  $("userLabel").textContent = getActiveUser().name;

  const sums = sumByMethod(day.payments);
  $("sumMini").textContent = `ÎœÎµÏ„ÏÎ·Ï„Î¬: ${fmt(sums.cash)} â€¢ ÎšÎ¬ÏÏ„Î±: ${fmt(sums.card)} â€¢ ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±: ${fmt(sums.free)}`;
}
function renderTabs(){
  $("tabOrder").classList.toggle("active", tab==="order");
  $("tabTickets").classList.toggle("active", tab==="tickets");
  $("viewOrder").classList.toggle("hide", tab!=="order");
  $("viewTickets").classList.toggle("hide", tab!=="tickets");
  $("ticketActions").classList.toggle("hide", tab!=="order");
}
function getCats(){
  const cats = [...new Set(products.map(p=>p.cat))];
  if(!activeCat) activeCat = cats[0];
  return cats;
}

function renderTables(){
  const db = ensureDB();
  const day = db.days[TODAY];
  const grid = $("tableGrid");
  grid.innerHTML = "";

  for(const t of defaultTables){
    const open = sumOpen(db, t);
    const btn = document.createElement("button");
    btn.className = "pill block";
    btn.style.height = "58px";
    btn.style.borderRadius = "18px";
    btn.innerHTML = `<div style="font-weight:900">${t}</div><div class="muted" style="font-size:13px;">${open>0?fmt(open):"â€”"}</div>`;
    if(t === day.meta.activeTable) btn.classList.add("primary");
    if(open>0) btn.style.borderColor = "rgba(58,162,255,.35)";

    btn.onclick = ()=>{
      day.meta.activeTable = t;
      save("mini_cashier_db_v2", db);
      tab = "order";
      renderTabs();
      renderAll();
      openCategoriesQuick(); // OK ÎµÎ´Ï (Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±)
    };
    grid.appendChild(btn);
  }
}

function renderCatsRow(){
  const row = $("catRow");
  row.innerHTML = "";
  const cats = getCats();
  for(const c of cats){
    const b = document.createElement("button");
    b.className = "pill small";
    if(c===activeCat) b.classList.add("primary");
    b.textContent = c;
    b.onclick = ()=>{ activeCat=c; renderProducts(); };
    row.appendChild(b);
  }
}
function renderProducts(){
  const q = $("search").value.trim().toLowerCase();
  const list = $("productList");
  list.innerHTML = "";
  const filtered = products.filter(p=>{
    if(p.cat !== activeCat) return false;
    if(!q) return true;
    return p.name.toLowerCase().includes(q);
  });

  for(const p of filtered){
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div>
        <div class="name">${p.name}</div>
        <div class="meta">${p.cat}</div>
      </div>
      <div class="price">${fmt(p.price)}</div>
    `;
    div.onclick = ()=> addLine(p.name, p.cat, p.price);
    list.appendChild(div);
  }
}
function addLine(name, cat, price){
  const db = ensureDB();
  const day = db.days[TODAY];
  const t = day.meta.activeTable;

  day.tables[t].lines.push({
    id: uid(),
    name, cat, price,
    at: Date.now(),
    by: getActiveUser().name,
    paid: null
  });

  save("mini_cashier_db_v2", db);
  renderAll();
}

function renderTicket(){
  const db = ensureDB();
  const day = db.days[TODAY];
  const t = day.meta.activeTable;

  $("ticketTitle").textContent = t;

  const open = unpaidLines(getLines(db,t));
  const box = $("ticketLines");
  box.innerHTML = "";

  if(open.length===0){
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "â€” Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î½Î¿Î¹Ï‡Ï„Î¬ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±.";
    box.appendChild(empty);
    return;
  }

  for(const l of open){
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div>
        <div class="name">${l.name}</div>
        <div class="meta">${l.cat} â€¢ ${new Date(l.at).toLocaleTimeString("el-GR",{hour:"2-digit",minute:"2-digit"})} â€¢ ${l.by}</div>
      </div>
      <div class="price">${fmt(l.price)}</div>
    `;
    div.onclick = ()=> removeOneLine(l.id);
    box.appendChild(div);
  }
}
function removeOneLine(id){
  const db = ensureDB();
  const day = db.days[TODAY];
  const t = day.meta.activeTable;
  const lines = day.tables[t].lines;
  const idx = lines.findIndex(x=>x.id===id && !x.paid);
  if(idx>=0){
    lines.splice(idx,1);
    save("mini_cashier_db_v2", db);
    renderAll();
  }
}

function renderTicketsTab(){
  const db = ensureDB();
  const day = db.days[TODAY];
  const list = $("ticketsList");
  list.innerHTML = "";

  for(const t of defaultTables){
    const open = sumOpen(db,t);

    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div>
        <div class="name">${t}</div>
        <div class="meta">${open>0 ? "Î Î¬Ï„Î± Î³Î¹Î± Ï€Î»Î·ÏÏ‰Î¼Î® (Split)" : "Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î±Î½Î¿Î¹Ï‡Ï„Î¬"}</div>
      </div>
      <div class="price">${open>0?fmt(open):"â€”"}</div>
    `;

    div.onclick = ()=>{
      // âœ… FIX: Tickets -> Ï€Î¬ÎµÎ¹ ÏƒÏ„Î¿ ticket/Ï€Î»Î·ÏÏ‰Î¼Î®, ÎŸÎ§Î™ ÏƒÎµ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚/Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±
      day.meta.activeTable = t;
      save("mini_cashier_db_v2", db);

      tab="order";
      renderTabs();
      renderAll();

      if(open>0){
        // Î¬Î½Î¿Î¹Î¾Îµ ÎºÎ±Ï„ÎµÏ…Î¸ÎµÎ¯Î±Î½ Ï€Î»Î·ÏÏ‰Î¼Î®/split (Ï„Î¿ Î¶Î·Ï„Î¿ÏÎ¼ÎµÎ½Î¿ Ï„Î¿Ï… Tickets)
        openPaySheet();
      } else {
        alert("Î‘Ï…Ï„ÏŒ Ï„Î¿ Ï„ÏÎ±Ï€Î­Î¶Î¹ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Î±Î½Î¿Î¹Ï‡Ï„Î¬.");
      }
    };

    list.appendChild(div);
  }
}

function renderAll(){
  renderTop();
  renderActiveInfo();
  renderTables();
  renderCatsRow();
  renderProducts();
  renderTicket();
  renderTicketsTab();
}

/* =================== CATEGORY QUICK FLOW =================== */
function renderCatGrid(){
  const cats = getCats();
  const grid = $("catGrid");
  grid.innerHTML = "";
  for(const c of cats){
    const b = document.createElement("button");
    b.className = "pill catBtn";
    if(c===activeCat) b.classList.add("primary");
    b.textContent = c;
    b.onclick = ()=>{
      activeCat = c;
      $("search").value = "";
      renderCatsRow();
      renderProducts();
      showCats(false);
      setTimeout(()=> {
        document.getElementById("productsCard").scrollIntoView({behavior:"smooth", block:"start"});
      }, 50);
    };
    grid.appendChild(b);
  }
}
function openCategoriesQuick(){
  renderCatGrid();
  const db = ensureDB();
  const t = db.days[TODAY].meta.activeTable;
  $("catTitle").textContent = `ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚ Â· ${t}`;
  $("catSub").textContent = "Î”Î¹Î¬Î»ÎµÎ¾Îµ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± â†’ Î¼ÎµÏ„Î¬ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± Î¼Îµ Ï„Î¹Î¼Î­Ï‚.";
  showCats(true);
}

/* =================== PAY / SPLIT =================== */
function openPaySheet(){
  payState.ids = new Set();
  renderPayList();
  showPay(true);
}
function renderPayList(){
  const db = ensureDB();
  const day = db.days[TODAY];
  const t = day.meta.activeTable;
  const open = unpaidLines(getLines(db,t));

  $("payTitle").textContent = `Ticket: ${t}`;

  const list = $("payList");
  list.innerHTML = "";

  for(const l of open){
    const row = document.createElement("div");
    row.className = "payLine";
    row.innerHTML = `
      <div class="left">
        <input type="checkbox" />
        <div>
          <div class="t">${l.name}</div>
          <div class="s">${l.cat}</div>
        </div>
      </div>
      <div class="right">${fmt(l.price)}</div>
    `;
    const cb = row.querySelector("input");
    cb.checked = payState.ids.has(l.id);
    cb.onchange = ()=>{
      if(cb.checked) payState.ids.add(l.id);
      else payState.ids.delete(l.id);
      updatePayTotal();
    };
    row.onclick = (e)=>{
      if(e.target.tagName.toLowerCase()==="input") return;
      cb.checked = !cb.checked;
      cb.dispatchEvent(new Event("change"));
    };
    list.appendChild(row);
  }
  updatePayTotal();
}
function updatePayTotal(){
  const db = ensureDB();
  const day = db.days[TODAY];
  const t = day.meta.activeTable;
  const open = unpaidLines(getLines(db,t));
  const selected = open.filter(x=>payState.ids.has(x.id));
  const total = selected.reduce((s,x)=>s+x.price,0);
  $("payTotal").textContent = `Î¤ÎµÎ»Î¹ÎºÏŒ: ${fmt(total)}`;
}
function toggleSelectAll(){
  const db = ensureDB();
  const day = db.days[TODAY];
  const t = day.meta.activeTable;
  const open = unpaidLines(getLines(db,t));

  if(payState.ids.size === open.length){
    payState.ids = new Set();
    $("btnSelectAll").textContent = "Î•Ï€Î¯Î»ÎµÎ¾Îµ ÏŒÎ»Î±";
  }else{
    payState.ids = new Set(open.map(x=>x.id));
    $("btnSelectAll").textContent = "Î‘Ï€Î¿ÎµÏ€Î¹Î»Î¿Î³Î® ÏŒÎ»Ï‰Î½";
  }
  renderPayList();
}

async function doPayment(method){
  const db = ensureDB();
  const day = db.days[TODAY];
  const t = day.meta.activeTable;

  const open = unpaidLines(getLines(db,t));
  const selected = open.filter(x=>payState.ids.has(x.id));
  if(selected.length===0){ alert("Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 1 Ï€ÏÎ¿ÏŠÏŒÎ½ Î³Î¹Î± Ï€Î»Î·ÏÏ‰Î¼Î®."); return; }

  const now = Date.now();
  const user = getActiveUser().name;
  const total = selected.reduce((s,x)=>s+x.price,0);

  const mustConfirm = (method==="free") || (total >= CONFIRM_MIN_TOTAL) || (selected.length >= CONFIRM_MIN_ITEMS);
  if(mustConfirm){
    const methodLabel = ({cash:"ÎœÎµÏ„ÏÎ·Ï„Î¬", card:"ÎšÎ¬ÏÏ„Î±", free:"ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±"}[method] || method);
    const preview = selected.slice(0,4).map(x=>x.name).join(", ");
    const more = selected.length>4 ? ` (+${selected.length-4} Î±ÎºÏŒÎ¼Î±)` : "";
    const msg =
`Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚

Î¤ÏÎ±Ï€Î­Î¶Î¹: ${t}
Î§ÏÎ®ÏƒÏ„Î·Ï‚: ${user}
Î¤ÏÏŒÏ€Î¿Ï‚: ${methodLabel}
Î ÏÎ¿ÏŠÏŒÎ½Ï„Î±: ${selected.length}
Î£ÏÎ½Î¿Î»Î¿: ${fmt(total)}

${preview}${more}

ÎÎ± ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ·Î¸ÎµÎ¯ Î· Ï€Î»Î·ÏÏ‰Î¼Î®;`;
    if(!confirm(msg)) return;
  }

  const ids = selected.map(x=>x.id);
  const lines = getLines(db,t);
  for(const l of lines){
    if(ids.includes(l.id)) l.paid = { method, at: now, by: user };
  }

  day.payments.push({ id: uid(), at: now, table: t, user, method, total, itemIds: ids });
  day.undone = [];
  save("mini_cashier_db_v2", db);

  showPay(false);
  renderAll();
}

function undoPayment(){
  const db = ensureDB();
  const day = db.days[TODAY];
  const last = day.payments.pop();
  if(!last){ alert("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï€Î»Î·ÏÏ‰Î¼Î® Î³Î¹Î± Undo."); return; }

  const lines = getLines(db, last.table);
  for(const l of lines){
    if(l.paid && last.itemIds.includes(l.id)) l.paid = null;
  }
  day.undone.push(last);
  save("mini_cashier_db_v2", db);
  renderAll();
}
function redoPayment(){
  const db = ensureDB();
  const day = db.days[TODAY];
  const last = day.undone.pop();
  if(!last){ alert("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï€Î»Î·ÏÏ‰Î¼Î® Î³Î¹Î± Redo."); return; }

  const lines = getLines(db, last.table);
  for(const l of lines){
    if(!l.paid && last.itemIds.includes(l.id)){
      l.paid = { method:last.method, at:last.at, by:last.user };
    }
  }
  day.payments.push(last);
  save("mini_cashier_db_v2", db);
  renderAll();
}

function exportCSV(){
  const db = ensureDB();
  const day = db.days[TODAY];

  const rows = [];
  rows.push(["date","table","time","user","method","total"].join(","));
  for(const p of day.payments){
    rows.push([
      TODAY,
      p.table,
      new Date(p.at).toLocaleTimeString("el-GR",{hour:"2-digit",minute:"2-digit",second:"2-digit"}),
      p.user,
      p.method,
      p.total.toFixed(2)
    ].join(","));
  }

  const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `daily-cashier-${TODAY}.csv`;
  a.click();
}

/* =================== SAFER ACTIONS =================== */
async function resetOpenForTable(){
  const user = getActiveUser();
  const ok = await requirePin(user, "ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î±Î½Î¿Î¹Ï‡Ï„ÏÎ½");
  if(!ok) return;
  if(!confirm("Î˜Î± Î´Î¹Î±Î³ÏÎ±Ï†Î¿ÏÎ½ ÎœÎŸÎÎŸ Ï„Î± Î±Î½Î¿Î¹Ï‡Ï„Î¬ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± Ï„Î¿Ï… Ï„ÏÎ­Ï‡Î¿Î½Ï„Î¿Ï‚ Ï„ÏÎ±Ï€ÎµÎ¶Î¹Î¿Ï. Î£Ï…Î½Î­Ï‡ÎµÎ¹Î±;")) return;

  const db = ensureDB();
  const day = db.days[TODAY];
  const t = day.meta.activeTable;
  const lines = getLines(db,t);

  const before = lines.length;
  day.tables[t].lines = lines.filter(x=>x.paid);
  save("mini_cashier_db_v2", db);
  renderAll();
  alert(`ÎˆÎ³Î¹Î½Îµ. ÎˆÏ†Ï…Î³Î±Î½ ${before - day.tables[t].lines.length} Î±Î½Î¿Î¹Ï‡Ï„Î­Ï‚ Î³ÏÎ±Î¼Î¼Î­Ï‚.`);
}

async function wipeAll(){
  const user = getActiveUser();
  const ok = await requirePin(user, "Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏŒÎ»Ï‰Î½");
  if(!ok) return;

  const word = prompt("Î“Î¹Î± Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î± Î³ÏÎ¬ÏˆÎµ Î±ÎºÏÎ¹Î²ÏÏ‚: DELETE");
  if(word !== "DELETE"){ alert("Î‘ÎºÏ…ÏÏÎ¸Î·ÎºÎµ."); return; }
  if(!confirm("Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·: Î˜Î± ÏƒÎ²Î·ÏƒÏ„Î¿ÏÎ½ ÎŸÎ›Î‘. Î£Ï…Î½Î­Ï‡ÎµÎ¹Î±;")) return;

  localStorage.removeItem("mini_cashier_db_v2");
  localStorage.removeItem("mini_cashier_users_v2");
  localStorage.removeItem("mini_cashier_active_user_v2");
  location.reload();
}

/* =================== USER MANAGEMENT =================== */
async function addUser(){
  const name = prompt("ÎŒÎ½Î¿Î¼Î± Î½Î­Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·:");
  if(!name) return;

  const pin1 = prompt("Î’Î¬Î»Îµ 4-ÏˆÎ®Ï†Î¹Î¿ PIN:");
  if(!pin1 || !isValidPin(pin1)) { alert("Î†ÎºÏ…ÏÎ¿ PIN."); return; }
  const pin2 = prompt("ÎÎ±Î½Î±Î³ÏÎ¬ÏˆÎµ Ï„Î¿ PIN:");
  if(pin2 !== pin1){ alert("Î”ÎµÎ½ Ï„Î±Î¹ÏÎ¹Î¬Î¶Î¿Ï…Î½."); return; }

  const users = ensureUsers();
  users.push({ id: uid(), name: name.trim(), pinHash: await sha256Hex(pin1) });
  save("mini_cashier_users_v2", users);
  save("mini_cashier_active_user_v2", users[users.length-1].id);
  renderAll();
}
async function renameUser(){
  const active = getActiveUser();
  const ok = await requirePin(active, "ÎœÎµÏ„Î¿Î½Î¿Î¼Î±ÏƒÎ¯Î± Ï‡ÏÎ®ÏƒÏ„Î·");
  if(!ok) return;

  const name = prompt("ÎÎ­Î¿ ÏŒÎ½Î¿Î¼Î±:", active.name);
  if(!name) return;

  const users = ensureUsers();
  const idx = users.findIndex(u=>u.id===active.id);
  users[idx].name = name.trim();
  save("mini_cashier_users_v2", users);
  renderAll();
}
async function setPin(){
  const active = getActiveUser();
  const ok = await requirePin(active, "Î‘Î»Î»Î±Î³Î® PIN");
  if(!ok) return;

  const pin1 = prompt("ÎÎ­Î¿ 4-ÏˆÎ®Ï†Î¹Î¿ PIN:");
  if(!pin1 || !isValidPin(pin1)) { alert("Î†ÎºÏ…ÏÎ¿ PIN."); return; }
  const pin2 = prompt("ÎÎ±Î½Î±Î³ÏÎ¬ÏˆÎµ Ï„Î¿ PIN:");
  if(pin2 !== pin1){ alert("Î”ÎµÎ½ Ï„Î±Î¹ÏÎ¹Î¬Î¶Î¿Ï…Î½."); return; }

  const users = ensureUsers();
  const idx = users.findIndex(u=>u.id===active.id);
  users[idx].pinHash = await sha256Hex(pin1);
  save("mini_cashier_users_v2", users);
  alert("Î¤Î¿ PIN Î¬Î»Î»Î±Î¾Îµ.");
}
async function deleteUser(){
  const active = getActiveUser();
  const ok = await requirePin(active, "Î”Î¹Î±Î³ÏÎ±Ï†Î® Ï‡ÏÎ®ÏƒÏ„Î·");
  if(!ok) return;

  const users = ensureUsers();
  if(users.length<=1){ alert("Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 1 Ï‡ÏÎ®ÏƒÏ„Î·Ï‚."); return; }
  if(!confirm(`ÎÎ± Î´Î¹Î±Î³ÏÎ±Ï†ÎµÎ¯ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ "${active.name}";`)) return;

  const left = users.filter(u=>u.id!==active.id);
  save("mini_cashier_users_v2", left);
  save("mini_cashier_active_user_v2", left[0].id);
  renderAll();
}
async function changeUserWithPin(newId){
  const users = ensureUsers();
  const newUser = users.find(u=>u.id===newId);
  if(!newUser) return;

  const ok = await requirePin(newUser, "Î‘Î»Î»Î±Î³Î® Ï‡ÏÎ®ÏƒÏ„Î·");
  if(!ok){
    $("userSelect").value = getActiveUserId();
    return;
  }
  save("mini_cashier_active_user_v2", newUser.id);
  renderAll();
}

/* =================== EVENTS =================== */
$("search").addEventListener("input", renderProducts);

$("tabOrder").onclick=()=>{tab="order"; renderTabs();};
$("tabTickets").onclick=()=>{tab="tickets"; renderTabs();};

$("userSelect").onchange=(e)=>{ changeUserWithPin(e.target.value); };

$("btnSettings").onclick=()=>showSheet(true);
$("btnCloseSheet").onclick=()=>showSheet(false);
$("overlay").onclick=()=>showSheet(false);

$("btnAddUser").onclick=addUser;
$("btnRenameUser").onclick=renameUser;
$("btnSetPin").onclick=setPin;
$("btnDeleteUser").onclick=deleteUser;

$("btnResetDay").onclick=resetOpenForTable;
$("btnClearOpen").onclick=resetOpenForTable;

$("btnPay").onclick=openPaySheet;
$("btnClosePay").onclick=()=>showPay(false);
$("payOverlay").onclick=(e)=>{ if(e.target.id==="payOverlay") showPay(false); };

$("btnSelectAll").onclick=toggleSelectAll;
$("btnPayCash").onclick=()=>doPayment("cash");
$("btnPayCard").onclick=()=>doPayment("card");
$("btnPayFree").onclick=()=>doPayment("free");

$("btnUndoPay").onclick=undoPayment;
$("btnRedoPay").onclick=redoPayment;
$("btnCSV").onclick=exportCSV;
$("btnWipeAll").onclick=wipeAll;

/* Category overlay events */
$("btnCloseCats").onclick=()=>showCats(false);
$("catOverlay").onclick=(e)=>{ if(e.target.id==="catOverlay") showCats(false); };

/* =================== START =================== */
renderTabs();
renderAll();

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./sw.js");
}
</script>
</body>
</html>
