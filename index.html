<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <title>Î—Î¼ÎµÏÎ®ÏƒÎ¹Î¿ Î¤Î±Î¼ÎµÎ¯Î¿</title>
  <link rel="manifest" href="./manifest.webmanifest" />
  <style>
    :root{
      --bg0:#070a0f;
      --bg1:#0b0f14;
      --card:#111824;
      --card2:#0f1620;
      --line:rgba(255,255,255,.10);
      --text:#eaf1ff;
      --muted:rgba(234,241,255,.72);
      --muted2:rgba(234,241,255,.55);
      --accent:#4aa3ff;
      --good:#2fe39f;
      --warn:#ffcc66;
      --bad:#ff5566;

      --r:18px;
      --pad:12px;
      --tap:46px;

      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
      --safeLeft: env(safe-area-inset-left, 0px);
      --safeRight: env(safe-area-inset-right, 0px);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 70% -10%, rgba(74,163,255,.18), transparent 55%),
        radial-gradient(900px 700px at -10% 30%, rgba(47,227,159,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    /* FULL SCREEN APP SHELL */
    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      padding: calc(var(--safeTop) + 10px) calc(var(--safeRight) + 10px) calc(var(--safeBottom) + 10px) calc(var(--safeLeft) + 10px);
      gap:10px;
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      gap:10px;
    }
    .brand{
      flex:1;
      min-width:0;
    }
    .brand .name{
      font-weight:800;
      letter-spacing:.2px;
      font-size:20px;
      line-height:1.1;
      margin:0;
      padding:0;
    }
    .brand .sub{
      margin-top:4px;
      font-size:13px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .top-actions{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:nowrap;
    }

    .pill, select, input, button{
      font: inherit;
      color:var(--text);
    }
    .pill, .btn, select, input{
      border:1px solid var(--line);
      background: rgba(17,24,36,.75);
      backdrop-filter: blur(8px);
      border-radius: 999px;
      height: var(--tap);
      padding: 0 14px;
      display:inline-flex;
      align-items:center;
      gap:10px;
    }
    select{
      padding-right: 34px;
      appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, var(--muted) 50%),
        linear-gradient(135deg, var(--muted) 50%, transparent 50%);
      background-position:
        calc(100% - 18px) 50%,
        calc(100% - 12px) 50%;
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      min-width: 160px;
      max-width: 220px;
    }
    .iconbtn{
      width: var(--tap);
      justify-content:center;
      padding:0;
    }

    .content{
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* views scroll */
    .view{
      flex:1;
      min-height:0;
      overflow:auto;
      padding-bottom: calc(76px + var(--safeBottom)); /* for bottom bar */
    }
    .view::-webkit-scrollbar{ width:0; height:0; }

    /* cards (lightweight) */
    .card{
      background: rgba(17,24,36,.55);
      border:1px solid var(--line);
      border-radius: var(--r);
      padding: 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .row{ display:flex; gap:10px; align-items:center; }
    .row.wrap{ flex-wrap:wrap; }
    .space{ justify-content:space-between; }
    .muted{ color:var(--muted); }
    .muted2{ color:var(--muted2); }
    .h{
      font-weight:800;
      margin:0 0 8px 0;
      font-size:16px;
    }

    /* Tables grid */
    .tables{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    .tbtn{
      position:relative;
      text-align:left;
      padding: 14px 14px;
      border-radius: var(--r);
      border:1px solid var(--line);
      background: rgba(17,24,36,.45);
      min-height: 74px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:4px;
    }
    .tbtn .title{ font-weight:900; font-size:18px; letter-spacing:.2px; }
    .tbtn .sub{ color:var(--muted); font-size:13px; }
    .badge{
      position:absolute;
      right:10px;
      top:10px;
      min-width: 28px;
      height: 22px;
      padding:0 8px;
      border-radius: 999px;
      border:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      background: rgba(74,163,255,.12);
    }
    .tbtn.open{
      outline:2px solid rgba(74,163,255,.35);
    }
    .tbtn.open .badge{
      background: rgba(47,227,159,.10);
    }

    /* Chips */
    .chips{
      display:flex;
      gap:8px;
      overflow:auto;
      padding: 2px 2px 8px 2px;
      scroll-snap-type:x proximity;
    }
    .chips::-webkit-scrollbar{ height:0; }
    .chip{
      flex:0 0 auto;
      scroll-snap-align:start;
      border:1px solid var(--line);
      background: rgba(17,24,36,.45);
      border-radius:999px;
      height: 38px;
      padding: 0 12px;
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      color: var(--muted);
      white-space:nowrap;
    }
    .chip.active{
      color: var(--text);
      border-color: rgba(74,163,255,.35);
      box-shadow: 0 0 0 3px rgba(74,163,255,.08) inset;
    }

    /* Products list (notebook-style, no heavy boxes) */
    .list{
      display:flex;
      flex-direction:column;
      gap:0;
      border:1px solid var(--line);
      border-radius: var(--r);
      overflow:hidden;
      background: rgba(17,24,36,.35);
    }
    .li{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 12px;
      border-top:1px solid rgba(255,255,255,.07);
      gap:12px;
      background: rgba(0,0,0,.00);
    }
    .li:first-child{ border-top:none; }
    .li .left{
      min-width:0;
      flex:1;
    }
    .li .name{
      font-weight:800;
      line-height:1.15;
      margin:0;
      font-size:15px;
    }
    .li .meta{
      font-size:12px;
      color:var(--muted2);
      margin-top:3px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .price{
      font-weight:900;
      font-size:15px;
      white-space:nowrap;
    }

    .qty{
      display:flex;
      align-items:center;
      gap:6px;
      flex:0 0 auto;
    }
    .qbtn{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(17,24,36,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
    }
    .qnum{
      min-width: 22px;
      text-align:center;
      font-weight:900;
      color:var(--text);
    }

    /* Bottom actions */
    .bottom{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding: 10px calc(var(--safeRight) + 10px) calc(var(--safeBottom) + 10px) calc(var(--safeLeft) + 10px);
      background: linear-gradient(180deg, transparent, rgba(7,10,15,.72) 30%, rgba(7,10,15,.92));
      backdrop-filter: blur(10px);
      pointer-events:none;
    }
    .bottom .bar{
      pointer-events:auto;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    .btn{
      justify-content:center;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      border-radius: 16px;
      height: 48px;
      background: rgba(17,24,36,.62);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.good{ border-color: rgba(47,227,159,.35); box-shadow:0 0 0 3px rgba(47,227,159,.06) inset; }
    .btn.bad{ border-color: rgba(255,85,102,.35); box-shadow:0 0 0 3px rgba(255,85,102,.06) inset; }
    .btn.accent{ border-color: rgba(74,163,255,.35); box-shadow:0 0 0 3px rgba(74,163,255,.06) inset; }

    /* Modal */
    .modalBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 10px;
      padding-bottom: calc(10px + var(--safeBottom));
      z-index:999;
    }
    .modal{
      width:min(560px, 100%);
      border-radius: 22px;
      border:1px solid var(--line);
      background: rgba(17,24,36,.86);
      backdrop-filter: blur(14px);
      box-shadow: 0 30px 80px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .modal .head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 14px 14px 10px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modal .head .ttl{
      font-weight:900;
      font-size:16px;
    }
    .modal .body{
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .modal .foot{
      padding: 12px 14px 14px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    .small{
      font-size:12px;
      color:var(--muted2);
      line-height:1.35;
    }
    .dangerText{ color: rgba(255,85,102,.95); font-weight:800; }
    .okText{ color: rgba(47,227,159,.95); font-weight:800; }

    /* screensaver */
    .saver{
      position:fixed;
      inset:0;
      z-index: 2000;
      display:none;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(1000px 700px at 50% 20%, rgba(74,163,255,.14), transparent 60%),
        linear-gradient(180deg, #05070b, #070a0f);
      padding: 24px;
      text-align:center;
    }
    .saver .logo{
      font-weight:1000;
      font-size: 34px;
      letter-spacing:.3px;
      margin-bottom:10px;
    }
    .saver .line{
      color: var(--muted);
      font-weight:800;
      font-size: 16px;
    }
    .saver .hint{
      margin-top:16px;
      color: var(--muted2);
      font-size:13px;
    }

    /* responsive */
    @media (min-width: 520px){
      .tables{ grid-template-columns: repeat(3, minmax(0,1fr)); }
      .bottom .bar{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }

    /* prevent accidental text selection */
    button, .btn, .tbtn, .chip, .qbtn{ -webkit-user-select:none; user-select:none; }

  </style>
</head>

<body>
  <div class="app" id="app">

    <div class="topbar">
      <div class="brand">
        <div class="name" id="shopTitle">ÎšÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î±</div>
        <div class="sub" id="topSub">Î£Î®Î¼ÎµÏÎ±: â€” â€¢ Î•Î½ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±: â€”</div>
      </div>

      <div class="top-actions">
        <select id="userSelect" title="Î§ÏÎ®ÏƒÏ„Î·Ï‚"></select>
        <button class="pill iconbtn" id="btnSettings" title="Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚">âš™ï¸</button>
      </div>
    </div>

    <div class="content">
      <div class="view" id="view"></div>
    </div>

  </div>

  <!-- bottom actions -->
  <div class="bottom" id="bottom">
    <div class="bar" id="bottomBar"></div>
  </div>

  <!-- modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="head">
        <div class="ttl" id="modalTitle">â€”</div>
        <button class="pill iconbtn" id="modalClose">âœ•</button>
      </div>
      <div class="body" id="modalBody"></div>
      <div class="foot" id="modalFoot"></div>
    </div>
  </div>

  <!-- screensaver -->
  <div class="saver" id="saver">
    <div>
      <div class="logo" id="saverLogo">ÎšÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î±</div>
      <div class="line" id="saverLine">Î•Î½ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±: â€”</div>
      <div class="hint">Î†Î³Î³Î¹Î¾Îµ Ï„Î·Î½ Î¿Î¸ÏŒÎ½Î· Î³Î¹Î± ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î±</div>
    </div>
  </div>

  <script>
    /***********************
     *  DAILY CASHIER v1
     *  Single-file app (no app.js)
     ***********************/

    const LS_KEY = "daily_cashier_db_v1";
    const TODAY = new Date().toISOString().slice(0,10);

    // inactivity
    const IDLE_TO_HOME_MS = 40_000;      // 40s -> go home
    const IDLE_TO_SAVER_AFTER_HOME_MS = 12_000; // after home, 12s -> screensaver
    let idleTimer = null;
    let saverTimer = null;

    const el = (id) => document.getElementById(id);
    const view = el("view");
    const bottom = el("bottom");
    const bottomBar = el("bottomBar");

    // modal
    const modalBack = el("modalBack");
    const modalTitle = el("modalTitle");
    const modalBody = el("modalBody");
    const modalFoot = el("modalFoot");

    const saver = el("saver");

    function euro(x){
      const n = Number(x || 0);
      return n.toLocaleString("el-GR",{minimumFractionDigits:2, maximumFractionDigits:2}) + " â‚¬";
    }

    function uid(){
      return Math.random().toString(36).slice(2) + Date.now().toString(36);
    }

    function loadDB(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(raw) return JSON.parse(raw);
      }catch(e){}
      return null;
    }

    function defaultDB(){
      return {
        shopName: "Î—Î¼ÎµÏÎ®ÏƒÎ¹Î¿ Î¤Î±Î¼ÎµÎ¯Î¿",
        ownerPin: "1234", // Î¬Î»Î»Î±Î¾Î­ Ï„Î¿ Î±Ï€ÏŒ Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚
        users: [
          { id:"u1", name:"Î§ÏÎ®ÏƒÏ„Î·Ï‚ 1", pin:"" },
          { id:"u2", name:"Î§ÏÎ®ÏƒÏ„Î·Ï‚ 2", pin:"" }
        ],
        currentUserId: "u1",
        tables: [
          { id:"T1",  label:"T1" },
          { id:"T2",  label:"T2" },
          { id:"T3",  label:"T3" },
          { id:"T4",  label:"T4" },
          { id:"T5",  label:"T5" },
          { id:"T6",  label:"T6" },
          { id:"BAR", label:"BAR" },
          { id:"OUT", label:"Î•ÎÎ©" },
        ],
        menu: {
          categories: [
            { id:"coffee_hot",  name:"ÎšÎ±Ï†Î­Î´ÎµÏ‚ â€“ Î–ÎµÏƒÏ„Î¿Î¯", emoji:"â˜•" },
            { id:"coffee_cold", name:"ÎšÎ±Ï†Î­Î´ÎµÏ‚ â€“ ÎšÏÏÎ¿Î¹", emoji:"ğŸ§Š" },
            { id:"tea",         name:"Î¤ÏƒÎ¬Î¹ / Î–ÎµÏƒÏ„Î¬",    emoji:"ğŸ«–" },
            { id:"soft",        name:"Î‘Î½Î±ÏˆÏ…ÎºÏ„Î¹ÎºÎ¬",      emoji:"ğŸ¥¤" },
            { id:"beer",        name:"ÎœÏ€ÏÏÎµÏ‚",          emoji:"ğŸº" },
            { id:"wine",        name:"ÎšÏÎ±ÏƒÎ¯",           emoji:"ğŸ·" },
          ],
          products: [
            { id:"p1", cat:"coffee_hot",  name:"Espresso Î¼Î¿Î½ÏŒÏ‚",      price:2.60 },
            { id:"p2", cat:"coffee_hot",  name:"Espresso Î´Î¹Ï€Î»ÏŒÏ‚",     price:3.20 },
            { id:"p3", cat:"coffee_hot",  name:"Cappuccino",          price:3.60 },
            { id:"p4", cat:"coffee_hot",  name:"Latte macchiato",     price:4.20 },
            { id:"p5", cat:"coffee_cold", name:"Freddo espresso",     price:3.20 },
            { id:"p6", cat:"coffee_cold", name:"Freddo cappuccino",   price:3.90 },
            { id:"p7", cat:"tea",         name:"Î¤ÏƒÎ¬Î¹",                price:2.80 },
            { id:"p8", cat:"soft",        name:"Coca-Cola",           price:3.00 },
            { id:"p9", cat:"soft",        name:"ÎÎµÏÏŒ",                price:1.50 },
            { id:"p10",cat:"beer",        name:"ÎœÏ€ÏÏÎ± 0.5L",          price:4.50 },
            { id:"p11",cat:"wine",        name:"ÎšÏÎ±ÏƒÎ¯ (Ï€Î¿Ï„Î®ÏÎ¹)",      price:4.00 },
          ]
        },
        days: {} // per day: { tables: {T1:{items:[...] , paid:[...]} }, payments:[...] }
      };
    }

    let db = loadDB() || defaultDB();

    function saveDB(){
      localStorage.setItem(LS_KEY, JSON.stringify(db));
    }

    function ensureDay(){
      if(!db.days[TODAY]) db.days[TODAY] = { tables:{}, payments:[], stats:{} };
      for(const t of db.tables){
        if(!db.days[TODAY].tables[t.id]) db.days[TODAY].tables[t.id] = { items:[] };
      }
    }
    ensureDay();
    saveDB();

    function getUser(){
      return db.users.find(u=>u.id===db.currentUserId) || db.users[0];
    }

    function setTop(){
      el("shopTitle").textContent = db.shopName;
      el("saverLogo").textContent = db.shopName;
      const u = getUser();
      el("topSub").textContent = `Î£Î®Î¼ÎµÏÎ±: ${TODAY} â€¢ Î•Î½ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±: ${u?.name || "â€”"}`;
      el("saverLine").textContent = `Î•Î½ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±: ${u?.name || "â€”"}`;
      document.title = db.shopName;
    }

    function fillUsers(){
      const sel = el("userSelect");
      sel.innerHTML = "";
      for(const u of db.users){
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = u.name;
        if(u.id===db.currentUserId) opt.selected = true;
        sel.appendChild(opt);
      }
    }

    /***************
     * state / navigation
     ***************/
    let state = {
      screen: "home", // home | table | pay | summary
      tableId: null,
      categoryId: null
    };

    function gotoHome(){
      state.screen = "home";
      state.tableId = null;
      state.categoryId = null;
      render();
    }
    function gotoTable(tid){
      state.screen = "table";
      state.tableId = tid;
      state.categoryId = db.menu.categories[0]?.id || null;
      render();
    }
    function gotoPay(tid){
      state.screen = "pay";
      state.tableId = tid;
      render();
    }

    /***************
     * helpers for items
     ***************/
    function dayTable(tid){
      ensureDay();
      return db.days[TODAY].tables[tid];
    }

    function allItems(tid){
      return dayTable(tid).items;
    }

    function unpaidItems(tid){
      return allItems(tid).filter(it => !it.paid && !it.voided);
    }
    function paidItems(tid){
      return allItems(tid).filter(it => it.paid && !it.voided);
    }

    function tableTotal(tid){
      let sum = 0;
      for(const it of unpaidItems(tid)) sum += it.price;
      return sum;
    }

    function openCount(){
      let c = 0;
      for(const t of db.tables){
        if(unpaidItems(t.id).length>0) c++;
      }
      return c;
    }

    function paidTodayCount(){
      // count payments lines
      return db.days[TODAY].payments.length;
    }

    function top8Today(){
      // counts by productId for today (all added items)
      const map = new Map();
      for(const t of db.tables){
        for(const it of allItems(t.id)){
          if(it.voided) continue;
          map.set(it.prodId, (map.get(it.prodId)||0) + 1);
        }
      }
      const arr = [...map.entries()]
        .map(([pid,count])=>({pid,count}))
        .sort((a,b)=>b.count-a.count)
        .slice(0,8);

      return arr
        .map(x => {
          const p = db.menu.products.find(pp=>pp.id===x.pid);
          if(!p) return null;
          return { ...p, count:x.count };
        })
        .filter(Boolean);
    }

    /***************
     * actions
     ***************/
    function addProductToTable(prodId){
      const tid = state.tableId;
      if(!tid) return;
      const p = db.menu.products.find(x=>x.id===prodId);
      if(!p) return;
      const it = {
        id: uid(),
        prodId: p.id,
        name: p.name,
        cat: p.cat,
        price: Number(p.price),
        ts: Date.now(),
        by: getUser()?.name || "",
        paid: null,
        voided: false
      };
      dayTable(tid).items.push(it);
      saveDB();
      render();
    }

    function removeOneUnit(tid, prodId){
      // remove ONE unpaid unit of product
      const items = dayTable(tid).items;
      const idx = items.findIndex(it => it.prodId===prodId && !it.paid && !it.voided);
      if(idx>=0){
        items.splice(idx,1);
        saveDB();
        render();
      }
    }

    function groupUnpaid(tid){
      // group by prodId+price
      const map = new Map();
      for(const it of unpaidItems(tid)){
        const k = it.prodId + "|" + it.price;
        if(!map.has(k)){
          map.set(k, { prodId: it.prodId, name: it.name, price: it.price, qty:0 });
        }
        map.get(k).qty += 1;
      }
      return [...map.values()];
    }

    /***************
     * safety confirmations
     ***************/
    function confirmModal({title, bodyHtml, okText="ÎŸÎš", cancelText="Î†ÎºÏ…ÏÎ¿", danger=false}){
      return new Promise(resolve=>{
        openModal({
          title,
          bodyHtml,
          buttons: [
            { text: cancelText, cls:"btn", onClick: ()=>{ closeModal(); resolve(false); } },
            { text: okText, cls:"btn " + (danger? "bad":"good"), onClick: ()=>{ closeModal(); resolve(true); } }
          ]
        });
      });
    }

    function openModal({title, bodyHtml, buttons}){
      modalTitle.textContent = title || "";
      modalBody.innerHTML = bodyHtml || "";
      modalFoot.innerHTML = "";
      for(const b of (buttons||[])){
        const btn = document.createElement("button");
        btn.className = b.cls || "btn";
        btn.textContent = b.text || "ÎŸÎš";
        btn.addEventListener("click", b.onClick || closeModal);
        modalFoot.appendChild(btn);
      }
      modalBack.style.display = "flex";
    }
    function closeModal(){
      modalBack.style.display = "none";
      modalTitle.textContent = "";
      modalBody.innerHTML = "";
      modalFoot.innerHTML = "";
    }

    el("modalClose").addEventListener("click", closeModal);
    modalBack.addEventListener("click", (e)=>{
      if(e.target === modalBack) closeModal();
    });

    /***************
     * PIN helpers (numeric keyboard)
     ***************/
    function askPin({title, hint, maxLen=6}){
      return new Promise(resolve=>{
        const idInput = "pinInput";
        openModal({
          title,
          bodyHtml: `
            <div class="small">${hint || ""}</div>
            <input id="${idInput}" inputmode="numeric" pattern="[0-9]*" autocomplete="one-time-code"
              style="width:100%; height:46px; border-radius:14px; border:1px solid var(--line);
                     padding:0 12px; background:rgba(0,0,0,.18);" placeholder="PIN" />
          `,
          buttons: [
            { text:"Î†ÎºÏ…ÏÎ¿", cls:"btn", onClick: ()=>{ closeModal(); resolve(null); } },
            { text:"ÎŸÎš", cls:"btn good", onClick: ()=>{
                const v = (document.getElementById(idInput)?.value || "").trim();
                closeModal();
                resolve(v.slice(0,maxLen));
            } }
          ]
        });
        setTimeout(()=> document.getElementById(idInput)?.focus(), 50);
      });
    }

    /***************
     * screensaver + idle logic
     ***************/
    function resetIdle(){
      if(idleTimer) clearTimeout(idleTimer);
      if(saverTimer) clearTimeout(saverTimer);

      // hide saver on any activity
      saver.style.display = "none";

      idleTimer = setTimeout(()=>{
        // go home after idle
        gotoHome();
        // then if still idle, show saver
        saverTimer = setTimeout(()=>{
          saver.style.display = "flex";
        }, IDLE_TO_SAVER_AFTER_HOME_MS);
      }, IDLE_TO_HOME_MS);
    }

    ["click","touchstart","keydown","mousemove","scroll"].forEach(ev=>{
      window.addEventListener(ev, resetIdle, {passive:true});
    });
    saver.addEventListener("click", ()=>{ saver.style.display="none"; resetIdle(); });
    saver.addEventListener("touchstart", ()=>{ saver.style.display="none"; resetIdle(); }, {passive:true});

    /***************
     * RENDER
     ***************/
    function setBottomButtons(btns){
      bottomBar.innerHTML = "";
      if(!btns || btns.length===0){
        bottom.style.display = "none";
        return;
      }
      bottom.style.display = "block";
      for(const b of btns){
        const btn = document.createElement("button");
        btn.className = "btn " + (b.kind || "");
        btn.textContent = b.text;
        btn.addEventListener("click", b.onClick);
        bottomBar.appendChild(btn);
      }
    }

    function renderHome(){
      const open = openCount();
      const paid = paidTodayCount();
      const top = top8Today();

      view.innerHTML = `
        <div class="card">
          <div class="row space">
            <div>
              <div class="h">Î¤ÏÎ±Ï€Î­Î¶Î¹Î± (${db.tables.length})</div>
              <div class="muted">Î‘Î½Î¿Î¹Ï‡Ï„Î¬: <b>${open}</b> â€¢ Î Î»Î·ÏÏ‰Î¼Î­Î½Î± ÏƒÎ®Î¼ÎµÏÎ±: <b>${paid}</b></div>
            </div>
          </div>
        </div>

        <div class="tables">
          ${db.tables.map(t=>{
            const total = tableTotal(t.id);
            const isOpen = total>0;
            return `
              <button class="tbtn ${isOpen?"open":""}" data-tid="${t.id}">
                <div class="title">${t.label}</div>
                <div class="sub">${isOpen ? "Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: " + euro(total) : "â€”"}</div>
                <div class="badge">${isOpen ? unpaidItems(t.id).length : 0}</div>
              </button>
            `;
          }).join("")}
        </div>

        <div class="card">
          <div class="h">â­ Î“ÏÎ®Î³Î¿ÏÎ± (Top 8 ÏƒÎ®Î¼ÎµÏÎ±)</div>
          <div class="chips" id="top8">
            ${top.length===0 ? `<div class="muted2">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±ÎºÏŒÎ¼Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î±.</div>` :
              top.map(p=>`
                <button class="chip" data-quick="${p.id}">
                  ${p.name} â€¢ ${euro(p.price)}
                </button>
              `).join("")
            }
          </div>
          <div class="small">Tip: Î‘Ï€ÏŒ Chrome â†’ â€œÎ ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î·Î½ Î±ÏÏ‡Î¹ÎºÎ® Î¿Î¸ÏŒÎ½Î·â€ (Î±Î½Î¿Î¯Î³ÎµÎ¹ ÏƒÎ±Î½ app).</div>
        </div>
      `;

      // bind table clicks
      view.querySelectorAll("[data-tid]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const tid = b.getAttribute("data-tid");
          gotoTable(tid);
        });
      });

      // quick adds require table selected -> show friendly prompt
      view.querySelectorAll("[data-quick]").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const pid = b.getAttribute("data-quick");
          await confirmModal({
            title:"Î“ÏÎ®Î³Î¿ÏÎ· ÎºÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ·",
            bodyHtml:`<div class="small">Î“Î¹Î± Î½Î± Î³ÏÎ¬ÏˆÎµÎ¹Ï‚ Ï€ÏÎ¿ÏŠÏŒÎ½, Ï€ÏÏÏ„Î± Î´Î¹Î¬Î»ÎµÎ¾Îµ Ï„ÏÎ±Ï€Î­Î¶Î¹.</div>`,
            okText:"ÎŸÎš",
            cancelText:""
          });
        });
      });

      setBottomButtons([
        { text:"Î£ÏÎ½Î¿ÏˆÎ· Î—Î¼Î­ÏÎ±Ï‚", kind:"accent", onClick: ()=> renderSummary() },
        { text:"Î•Î¾Î±Î³Ï‰Î³Î® CSV", kind:"", onClick: ()=> exportCSV() },
        { text:"Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎŒÎ»Ï‰Î½ (ÏƒÎ®Î¼ÎµÏÎ±)", kind:"bad", onClick: ()=> wipeToday() },
      ]);
    }

    function renderTable(){
      const tid = state.tableId;
      const t = db.tables.find(x=>x.id===tid);
      const total = tableTotal(tid);
      const groups = groupUnpaid(tid);

      const cats = db.menu.categories;
      const activeCat = state.categoryId || (cats[0]?.id || null);

      const products = db.menu.products.filter(p=>p.cat===activeCat);

      view.innerHTML = `
        <div class="card">
          <div class="row space">
            <div>
              <div class="h">Î¤ÏÎ±Ï€Î­Î¶Î¹: ${t?.label || tid}</div>
              <div class="muted">Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: <b>${euro(total)}</b></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="h">Î‘Î½Î¿Î¹Ï‡Ï„Î¬ items</div>
          ${groups.length===0 ? `<div class="muted2">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î½Î¿Î¹Ï‡Ï„Î¬ items.</div>` : `
            <div class="list">
              ${groups.map(g=>`
                <div class="li">
                  <div class="left">
                    <div class="name">${g.name}</div>
                    <div class="meta">${euro(g.price)} â€¢ ${g.qty} Ï„ÎµÎ¼.</div>
                  </div>
                  <div class="qty">
                    <button class="qbtn" data-minus="${g.prodId}">âˆ’</button>
                    <div class="qnum">${g.qty}</div>
                    <button class="qbtn" data-plus="${g.prodId}">+</button>
                    <button class="qbtn" title="Î Î»Î·ÏÏ‰Î¼Î®/ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î¿/Î”Î¹Î±Î³ÏÎ±Ï†Î®" data-item-actions="${g.prodId}">â‹¯</button>
                  </div>
                </div>
              `).join("")}
            </div>
          `}
          <div class="small">Î£Ï…Î½/Ï€Î»Î·Î½ Î±Î»Î»Î¬Î¶ÎµÎ¹ Ï€Î¿ÏƒÏŒÏ„Î·Ï„Î±. Î¤Î¿ â€œâ‹¯â€ Î±Î½Î¿Î¯Î³ÎµÎ¹ ÎµÎ½Î­ÏÎ³ÎµÎ¹ÎµÏ‚ Î³Î¹Î± Ï„Î¿ Ï€ÏÎ¿ÏŠÏŒÎ½.</div>
        </div>

        <div class="card">
          <div class="h">ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚</div>
          <div class="chips" id="catChips">
            ${cats.map(c=>`
              <button class="chip ${c.id===activeCat?"active":""}" data-cat="${c.id}">
                ${c.emoji} ${c.name}
              </button>
            `).join("")}
          </div>
        </div>

        <div class="card">
          <div class="h">Î ÏÎ¿ÏŠÏŒÎ½Ï„Î±</div>
          <div class="list">
            ${products.map(p=>`
              <div class="li" data-add="${p.id}">
                <div class="left">
                  <div class="name">${p.name}</div>
                  <div class="meta">${catName(p.cat)}</div>
                </div>
                <div class="price">${euro(p.price)}</div>
              </div>
            `).join("")}
          </div>
          <div class="small">Î Î¬Ï„Î± ÏƒÎµÎ¹ÏÎ¬ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î¿Ï‚ â†’ Ï€ÏÎ¿ÏƒÏ„Î¯Î¸ÎµÏ„Î±Î¹ ÏƒÏ„Î¿ Ï„ÏÎ±Ï€Î­Î¶Î¹.</div>
        </div>
      `;

      // bind cats
      view.querySelectorAll("[data-cat]").forEach(b=>{
        b.addEventListener("click", ()=>{
          state.categoryId = b.getAttribute("data-cat");
          render();
        });
      });

      // bind add product
      view.querySelectorAll("[data-add]").forEach(li=>{
        li.addEventListener("click", ()=>{
          addProductToTable(li.getAttribute("data-add"));
        });
      });

      // plus/minus
      view.querySelectorAll("[data-minus]").forEach(b=>{
        b.addEventListener("click", (e)=>{
          e.stopPropagation();
          removeOneUnit(tid, b.getAttribute("data-minus"));
        });
      });
      view.querySelectorAll("[data-plus]").forEach(b=>{
        b.addEventListener("click", (e)=>{
          e.stopPropagation();
          addProductToTable(b.getAttribute("data-plus"));
        });
      });

      // item actions
      view.querySelectorAll("[data-item-actions]").forEach(b=>{
        b.addEventListener("click", (e)=>{
          e.stopPropagation();
          const prodId = b.getAttribute("data-item-actions");
          openItemActions(tid, prodId);
        });
      });

      setBottomButtons([
        { text:"â† Î¤ÏÎ±Ï€Î­Î¶Î¹Î±", kind:"", onClick: ()=> gotoHome() },
        { text:"Î Î»Î·ÏÏ‰Î¼Î®", kind:"good", onClick: ()=> gotoPay(tid) },
        { text:"Î†Î´ÎµÎ¹Î±ÏƒÎ¼Î±", kind:"bad", onClick: ()=> clearTableUnpaid(tid) },
      ]);
    }

    function catName(catId){
      const c = db.menu.categories.find(x=>x.id===catId);
      return c ? (c.emoji + " " + c.name) : "";
    }

    async function openItemActions(tid, prodId){
      const g = groupUnpaid(tid).find(x=>x.prodId===prodId);
      if(!g) return;

      openModal({
        title: "Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î¿Ï‚",
        bodyHtml: `
          <div><b>${g.name}</b></div>
          <div class="small">Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï„Î¹ Î¸Î­Î»ÎµÎ¹Ï‚ Î½Î± ÎºÎ¬Î½ÎµÎ¹Ï‚ Î³Î¹Î± <b>1 Ï„ÎµÎ¼.</b> ÎºÎ¬Î¸Îµ Ï†Î¿ÏÎ¬ (Î³Î¹Î± Î³ÏÎ®Î³Î¿ÏÎ· Î¼ÎµÏÎ¹ÎºÎ® Ï€Î»Î·ÏÏ‰Î¼Î® / ÎºÎµÏÎ±ÏƒÎ¼Î­Î½Î¿).</div>
        `,
        buttons: [
          { text:"ÎœÎµÏ„ÏÎ·Ï„Î¬", cls:"btn good", onClick: ()=>{ closeModal(); payOneUnit(tid, prodId, "cash"); } },
          { text:"ÎšÎ¬ÏÏ„Î±", cls:"btn accent", onClick: ()=>{ closeModal(); payOneUnit(tid, prodId, "card"); } },
          { text:"ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î¿", cls:"btn", onClick: ()=>{ closeModal(); payOneUnit(tid, prodId, "treat"); } },
          { text:"Î”Î¹Î±Î³ÏÎ±Ï†Î® (1 Ï„ÎµÎ¼.)", cls:"btn bad", onClick: async ()=> {
              const ok = await confirmModal({
                title:"Î”Î¹Î±Î³ÏÎ±Ï†Î® 1 Ï„ÎµÎ¼.",
                bodyHtml:`<div class="small dangerText">Î£Î¯Î³Î¿Ï…ÏÎ± Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÏ‰ 1 Ï„ÎµÎ¼. Î±Ï€ÏŒ: <b>${g.name}</b>;</div>`,
                okText:"ÎÎ±Î¹, Î´Î¹Î±Î³ÏÎ±Ï†Î®",
                cancelText:"Î†ÎºÏ…ÏÎ¿",
                danger:true
              });
              if(ok){ closeModal(); voidOneUnit(tid, prodId); }
              else closeModal();
            }
          }
        ]
      });
    }

    function findOneUnpaidUnit(tid, prodId){
      return dayTable(tid).items.find(it => it.prodId===prodId && !it.paid && !it.voided) || null;
    }

    async function payOneUnit(tid, prodId, method){
      const it = findOneUnpaidUnit(tid, prodId);
      if(!it) return;

      // confirmation payment (protect from mis-tap)
      const ok = await confirmModal({
        title:"Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚",
        bodyHtml:`<div class="small">ÎÎ± ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®ÏƒÏ‰ <b>1 Ï„ÎµÎ¼.</b> â€œ${it.name}â€ Ï‰Ï‚ <b>${methodLabel(method)}</b>;</div>`,
        okText:"ÎÎ±Î¹",
        cancelText:"Î†ÎºÏ…ÏÎ¿"
      });
      if(!ok) return;

      it.paid = { method, ts: Date.now(), by: getUser()?.name || "" };
      db.days[TODAY].payments.push({
        id: uid(),
        tableId: tid,
        prodId: it.prodId,
        name: it.name,
        price: it.price,
        method,
        ts: it.paid.ts,
        by: it.paid.by
      });

      saveDB();

      // if table fully settled -> return home
      if(unpaidItems(tid).length===0){
        gotoHome();
      }else{
        render();
      }
    }

    function voidOneUnit(tid, prodId){
      const it = findOneUnpaidUnit(tid, prodId);
      if(!it) return;
      it.voided = true;
      it.voidTs = Date.now();
      it.voidBy = getUser()?.name || "";
      saveDB();
      render();
    }

    function methodLabel(m){
      if(m==="cash") return "ÎœÎµÏ„ÏÎ·Ï„Î¬";
      if(m==="card") return "ÎšÎ¬ÏÏ„Î±";
      if(m==="treat") return "ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î¿";
      return m;
    }

    async function clearTableUnpaid(tid){
      const cnt = unpaidItems(tid).length;
      if(cnt===0){
        return;
      }
      const ok = await confirmModal({
        title:"Î†Î´ÎµÎ¹Î±ÏƒÎ¼Î± Ï„ÏÎ±Ï€ÎµÎ¶Î¹Î¿Ï",
        bodyHtml:`<div class="small dangerText">Î˜Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹ ÎŸÎ›Î‘ Ï„Î± Î±Î½Î¿Î¹Ï‡Ï„Î¬ items (${cnt}). Î£Î¯Î³Î¿Ï…ÏÎ±;</div>`,
        okText:"ÎÎ±Î¹, Î¬Î´ÎµÎ¹Î±ÏƒÎ¼Î±",
        cancelText:"Î†ÎºÏ…ÏÎ¿",
        danger:true
      });
      if(!ok) return;

      // mark unpaid as voided (keeps audit)
      for(const it of unpaidItems(tid)){
        it.voided = true;
        it.voidTs = Date.now();
        it.voidBy = getUser()?.name || "";
      }
      saveDB();
      gotoHome();
    }

    function renderPay(){
      const tid = state.tableId;
      const t = db.tables.find(x=>x.id===tid);
      const groups = groupUnpaid(tid);

      view.innerHTML = `
        <div class="card">
          <div class="row space">
            <div>
              <div class="h">Î Î»Î·ÏÏ‰Î¼Î® â€¢ ${t?.label || tid}</div>
              <div class="muted">Î‘Î½Î¿Î¹Ï‡Ï„Î¬: <b>${groups.reduce((s,g)=>s+g.qty,0)}</b> Ï„ÎµÎ¼. â€¢ Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: <b>${euro(tableTotal(tid))}</b></div>
            </div>
          </div>
          <div class="small">Î“Î¹Î± Î¼ÎµÏÎ¹ÎºÎ® Ï€Î»Î·ÏÏ‰Î¼Î®/ÎºÎµÏÎ±ÏƒÎ¼Î­Î½Î¿, Ï€Î¬Ï„Î± â€œâ‹¯â€ ÏƒÎµ Ï€ÏÎ¿ÏŠÏŒÎ½ (ÎµÏ€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÎ¹Ï‚ ÎµÎ´Ï Î® ÏƒÏ„Î± Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±).</div>
        </div>

        <div class="card">
          <div class="h">Î‘Î½Î¿Î¹Ï‡Ï„Î¬ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±</div>
          ${groups.length===0 ? `<div class="okText">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿. âœ…</div>` : `
            <div class="list">
              ${groups.map(g=>`
                <div class="li">
                  <div class="left">
                    <div class="name">${g.name}</div>
                    <div class="meta">${euro(g.price)} â€¢ ${g.qty} Ï„ÎµÎ¼.</div>
                  </div>
                  <div class="qty">
                    <button class="qbtn" data-item-actions="${g.prodId}">â‹¯</button>
                  </div>
                </div>
              `).join("")}
            </div>
          `}
        </div>
      `;

      view.querySelectorAll("[data-item-actions]").forEach(b=>{
        b.addEventListener("click", ()=>{
          openItemActions(tid, b.getAttribute("data-item-actions"));
        });
      });

      setBottomButtons([
        { text:"â† Î Î¯ÏƒÏ‰", kind:"", onClick: ()=> gotoTable(tid) },
        { text:"Î£ÏÎ½Î¿ÏˆÎ· Î—Î¼Î­ÏÎ±Ï‚", kind:"accent", onClick: ()=> renderSummary() },
        { text:"ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ (Î±Î½ Î¼Î·Î´Î­Î½)", kind:"good", onClick: ()=>{
            if(unpaidItems(tid).length===0) gotoHome();
            else confirmModal({
              title:"Î”ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î¼Î·Î´Î­Î½",
              bodyHtml:`<div class="small">Î¥Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±ÎºÏŒÎ¼Î± Î±Î½Î¿Î¹Ï‡Ï„Î¬ items.</div>`,
              okText:"ÎŸÎš",
              cancelText:""
            });
          }
        },
      ]);
    }

    function renderSummary(){
      state.screen = "summary";
      state.tableId = null;

      // totals by method and by user
      const pay = db.days[TODAY].payments || [];
      const totals = { cash:0, card:0, treat:0, all:0 };
      const byUser = new Map(); // userName -> {cash,card,treat,all,count}

      for(const p of pay){
        totals.all += p.price;
        if(p.method==="cash") totals.cash += p.price;
        if(p.method==="card") totals.card += p.price;
        if(p.method==="treat") totals.treat += p.price;

        const k = p.by || "â€”";
        if(!byUser.has(k)) byUser.set(k, { cash:0, card:0, treat:0, all:0, count:0 });
        const o = byUser.get(k);
        o.all += p.price;
        o.count += 1;
        if(p.method==="cash") o.cash += p.price;
        if(p.method==="card") o.card += p.price;
        if(p.method==="treat") o.treat += p.price;
      }

      const usersArr = [...byUser.entries()].sort((a,b)=>b[1].all - a[1].all);

      view.innerHTML = `
        <div class="card">
          <div class="h">Î£ÏÎ½Î¿ÏˆÎ· Î—Î¼Î­ÏÎ±Ï‚ â€¢ ${TODAY}</div>
          <div class="row wrap">
            <div class="pill">Î£ÏÎ½Î¿Î»Î¿: <b>${euro(totals.all)}</b></div>
            <div class="pill">ÎœÎµÏ„ÏÎ·Ï„Î¬: <b>${euro(totals.cash)}</b></div>
            <div class="pill">ÎšÎ¬ÏÏ„Î±: <b>${euro(totals.card)}</b></div>
            <div class="pill">ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±: <b>${euro(totals.treat)}</b></div>
          </div>
          <div class="small">Î Î¬Ï„Î± Ï‡ÏÎ®ÏƒÏ„Î· Î³Î¹Î± Î±Î½Î¬Î»Ï…ÏƒÎ·.</div>
        </div>

        <div class="card">
          <div class="h">Î‘Î½Î¬ Ï‡ÏÎ®ÏƒÏ„Î·</div>
          ${usersArr.length===0 ? `<div class="muted2">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚ Î±ÎºÏŒÎ¼Î±.</div>` : `
            <div class="list">
              ${usersArr.map(([uname,o])=>`
                <div class="li" data-user="${escapeHtml(uname)}">
                  <div class="left">
                    <div class="name">${escapeHtml(uname)}</div>
                    <div class="meta">${o.count} ÎºÎ¹Î½Î®ÏƒÎµÎ¹Ï‚ â€¢ ÎœÎµÏ„ÏÎ·Ï„Î¬ ${euro(o.cash)} â€¢ ÎšÎ¬ÏÏ„Î± ${euro(o.card)} â€¢ ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î± ${euro(o.treat)}</div>
                  </div>
                  <div class="price">${euro(o.all)}</div>
                </div>
              `).join("")}
            </div>
          `}
        </div>
      `;

      view.querySelectorAll("[data-user]").forEach(li=>{
        li.addEventListener("click", ()=>{
          const uname = li.getAttribute("data-user");
          userBreakdown(uname);
        });
      });

      setBottomButtons([
        { text:"â† Î¤ÏÎ±Ï€Î­Î¶Î¹Î±", kind:"", onClick: ()=> gotoHome() },
        { text:"Î•Î¾Î±Î³Ï‰Î³Î® CSV", kind:"", onClick: ()=> exportCSV() },
        { text:"Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚", kind:"accent", onClick: ()=> openSettings() },
      ]);
    }

    function userBreakdown(uname){
      const pay = db.days[TODAY].payments.filter(p => (p.by||"â€”")===uname);
      let html = `<div class="small">ÎšÎ¹Î½Î®ÏƒÎµÎ¹Ï‚: <b>${pay.length}</b></div>`;
      html += `<div class="list">` + pay
        .slice().reverse()
        .map(p=>`
          <div class="li">
            <div class="left">
              <div class="name">${escapeHtml(p.name)}</div>
              <div class="meta">${methodLabel(p.method)} â€¢ ${escapeHtml(p.tableId)} â€¢ ${new Date(p.ts).toLocaleTimeString("el-GR",{hour:"2-digit",minute:"2-digit"})}</div>
            </div>
            <div class="price">${euro(p.price)}</div>
          </div>
        `).join("") + `</div>`;

      openModal({
        title: `Î‘Î½Î¬Î»Ï…ÏƒÎ·: ${uname}`,
        bodyHtml: html,
        buttons: [
          { text:"ÎŸÎš", cls:"btn good", onClick: closeModal },
          { text:"", cls:"btn", onClick: closeModal }
        ]
      });
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /***************
     * CSV
     ***************/
    function exportCSV(){
      const pay = db.days[TODAY].payments || [];
      const rows = [
        ["date","time","table","product","price","method","user"].join(",")
      ];
      for(const p of pay){
        const d = new Date(p.ts);
        rows.push([
          TODAY,
          d.toLocaleTimeString("el-GR",{hour:"2-digit",minute:"2-digit"}),
          p.tableId,
          `"${String(p.name).replaceAll('"','""')}"`,
          p.price.toFixed(2),
          p.method,
          `"${String(p.by||"").replaceAll('"','""')}"`
        ].join(","));
      }
      const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `daily_cashier_${TODAY}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /***************
     * wipe today (safe)
     ***************/
    async function wipeToday(){
      const ok = await confirmModal({
        title:"Î”Î¹Î±Î³ÏÎ±Ï†Î® Î·Î¼Î­ÏÎ±Ï‚",
        bodyHtml:`<div class="small dangerText">Î˜Î± ÏƒÎ²Î®ÏƒÎµÎ¹ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ ÎºÎ¹Î½Î®ÏƒÎµÎ¹Ï‚ Ï„Î·Ï‚ Î·Î¼Î­ÏÎ±Ï‚ (${TODAY}). Î£Î¯Î³Î¿Ï…ÏÎ±;</div>`,
        okText:"ÎÎ±Î¹, Î´Î¹Î±Î³ÏÎ±Ï†Î®",
        cancelText:"Î†ÎºÏ…ÏÎ¿",
        danger:true
      });
      if(!ok) return;
      db.days[TODAY] = { tables:{}, payments:[], stats:{} };
      ensureDay();
      saveDB();
      gotoHome();
    }

    /***************
     * Settings (owner-only shop name)
     ***************/
    async function openSettings(){
      // Settings panel
      const u = getUser();

      const usersHtml = db.users.map(uu=>`
        <div class="li">
          <div class="left">
            <div class="name">${escapeHtml(uu.name)}</div>
            <div class="meta">PIN Ï‡ÏÎ®ÏƒÏ„Î·: ${uu.pin ? "â—â—â—â—" : "â€”"} (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)</div>
          </div>
          <div class="qty">
            <button class="qbtn" data-setpin="${uu.id}">PIN</button>
          </div>
        </div>
      `).join("");

      openModal({
        title:"Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚",
        bodyHtml: `
          <div class="card" style="margin:0; padding:12px;">
            <div class="h">ÎŒÎ½Î¿Î¼Î± Î¼Î±Î³Î±Î¶Î¹Î¿Ï (Î¼ÏŒÎ½Î¿ Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·Ï‚)</div>
            <div class="small">Î“Î¹Î± Î±Î»Î»Î±Î³Î® Î¶Î·Ï„Î¬ÎµÎ¹ PIN Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î· (Î¼ÏŒÎ½Î¿ Î±ÏÎ¹Î¸Î¼Î¿ÏÏ‚).</div>
            <div class="row wrap">
              <div class="pill" style="flex:1; min-width:0;">Î¤ÏÎ­Ï‡Î¿Î½: <b>${escapeHtml(db.shopName)}</b></div>
              <button class="pill" id="btnChangeShop">âœï¸ Î‘Î»Î»Î±Î³Î®</button>
            </div>
          </div>

          <div class="card" style="margin:0; padding:12px;">
            <div class="h">PIN Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·</div>
            <div class="small">Î†Î»Î»Î±Î¾Î­ Ï„Î¿ ÏƒÎµ ÎºÎ¬Ï„Î¹ Ï€Î¿Ï… Î¾Î­ÏÎµÎ¹Ï‚ Î¼ÏŒÎ½Î¿ ÎµÏƒÏ.</div>
            <button class="pill" id="btnChangeOwnerPin">ğŸ”’ Î‘Î»Î»Î±Î³Î® PIN Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·</button>
          </div>

          <div class="card" style="margin:0; padding:12px;">
            <div class="h">Î§ÏÎ®ÏƒÏ„ÎµÏ‚</div>
            <div class="small">Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ PIN Î±Î½Î¬ Ï‡ÏÎ®ÏƒÏ„Î· (Î´ÎµÎ½ Î¶Î·Ï„Î¬Î¼Îµ PIN ÏƒÏ„Î·Î½ Ï€Î»Î·ÏÏ‰Î¼Î®, Î³Î¹Î± Î½Î± Î¼Î·Î½ ÎºÎ±Î¸Ï…ÏƒÏ„ÎµÏÎµÎ¯).</div>
            <div class="list">${usersHtml}</div>
          </div>

          <div class="card" style="margin:0; padding:12px;">
            <div class="h">Î‘Î´ÏÎ¬Î½ÎµÎ¹Î± / Î ÏÎ¿ÏƒÏ„Î±ÏƒÎ¯Î± Î¿Î¸ÏŒÎ½Î·Ï‚</div>
            <div class="small">40s Î±Î´ÏÎ¬Î½ÎµÎ¹Î± â†’ ÎµÏ€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î± Î¤ÏÎ±Ï€Î­Î¶Î¹Î±. ÎœÎµÏ„Î¬ 12s Ï‡Ï‰ÏÎ¯Ï‚ ÎºÎ¯Î½Î·ÏƒÎ· â†’ screensaver Î¼Îµ â€œÎ•Î½ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±â€.</div>
          </div>
        `,
        buttons: [
          { text:"ÎŸÎš", cls:"btn good", onClick: closeModal },
          { text:"", cls:"btn", onClick: closeModal }
        ]
      });

      // bind
      setTimeout(()=>{
        document.getElementById("btnChangeShop")?.addEventListener("click", changeShopNameOwnerOnly);
        document.getElementById("btnChangeOwnerPin")?.addEventListener("click", changeOwnerPin);

        modalBody.querySelectorAll("[data-setpin]").forEach(b=>{
          b.addEventListener("click", ()=> setUserPin(b.getAttribute("data-setpin")));
        });
      }, 0);
    }

    async function changeShopNameOwnerOnly(){
      const pin = await askPin({
        title:"PIN Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·",
        hint:"Î”ÏÏƒÎµ Ï„Î¿ PIN Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î· Î³Î¹Î± Î½Î± Î±Î»Î»Î¬Î¾ÎµÎ¹Ï‚ Ï„Î¿ ÏŒÎ½Î¿Î¼Î± Î¼Î±Î³Î±Î¶Î¹Î¿Ï."
      });
      if(pin===null) return;
      if(pin !== db.ownerPin){
        await confirmModal({ title:"Î›Î¬Î¸Î¿Ï‚ PIN", bodyHtml:`<div class="small dangerText">Î›Î¬Î¸Î¿Ï‚ PIN Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·.</div>`, okText:"ÎŸÎš", cancelText:"" });
        return;
      }
      const name = await askText("ÎÎ­Î¿ ÏŒÎ½Î¿Î¼Î± Î¼Î±Î³Î±Î¶Î¹Î¿Ï", "Î Î»Î·ÎºÏ„ÏÎ¿Î»ÏŒÎ³Î·ÏƒÎµ Ï„Î¿ Î½Î­Î¿ ÏŒÎ½Î¿Î¼Î±.");
      if(!name) return;
      db.shopName = name.trim().slice(0,40);
      saveDB();
      setTop();
      closeModal();
      render();
    }

    async function changeOwnerPin(){
      const oldPin = await askPin({ title:"PIN Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·", hint:"Î”ÏÏƒÎµ Ï„Î¿ Ï„ÏÎ­Ï‡Î¿Î½ PIN Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·." });
      if(oldPin===null) return;
      if(oldPin !== db.ownerPin){
        await confirmModal({ title:"Î›Î¬Î¸Î¿Ï‚ PIN", bodyHtml:`<div class="small dangerText">Î›Î¬Î¸Î¿Ï‚ PIN Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·.</div>`, okText:"ÎŸÎš", cancelText:"" });
        return;
      }
      const newPin = await askPin({ title:"ÎÎ­Î¿ PIN", hint:"Î”ÏÏƒÎµ Î½Î­Î¿ PIN (Î¼ÏŒÎ½Î¿ Î±ÏÎ¹Î¸Î¼Î¿ÏÏ‚)." });
      if(!newPin) return;
      db.ownerPin = newPin;
      saveDB();
      await confirmModal({ title:"ÎˆÎ³Î¹Î½Îµ", bodyHtml:`<div class="small okText">Î‘Î»Î»Î¬Ï‡Ï„Î·ÎºÎµ Ï„Î¿ PIN Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·.</div>`, okText:"ÎŸÎš", cancelText:"" });
      closeModal();
    }

    async function setUserPin(userId){
      const u = db.users.find(x=>x.id===userId);
      if(!u) return;
      const pin = await askPin({ title:`PIN Î³Î¹Î± ${u.name}`, hint:"Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ. Î†Ï†Î·ÏƒÎ­ Ï„Î¿ ÎºÎµÎ½ÏŒ Î³Î¹Î± Î½Î± Î¼Î·Î½ Î­Ï‡ÎµÎ¹ PIN." });
      if(pin===null) return;
      u.pin = (pin || "").trim();
      saveDB();
      await confirmModal({ title:"ÎŸÎš", bodyHtml:`<div class="small okText">Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ.</div>`, okText:"ÎŸÎš", cancelText:"" });
      closeModal();
      openSettings();
    }

    function askText(title, hint){
      return new Promise(resolve=>{
        const idInput = "txtInput";
        openModal({
          title,
          bodyHtml: `
            <div class="small">${hint||""}</div>
            <input id="${idInput}"
              style="width:100%; height:46px; border-radius:14px; border:1px solid var(--line);
                     padding:0 12px; background:rgba(0,0,0,.18);" placeholder="ÎšÎµÎ¯Î¼ÎµÎ½Î¿" />
          `,
          buttons: [
            { text:"Î†ÎºÏ…ÏÎ¿", cls:"btn", onClick: ()=>{ closeModal(); resolve(null); } },
            { text:"ÎŸÎš", cls:"btn good", onClick: ()=>{
                const v = (document.getElementById(idInput)?.value || "").trim();
                closeModal();
                resolve(v);
            } }
          ]
        });
        setTimeout(()=> document.getElementById(idInput)?.focus(), 50);
      });
    }

    /***************
     * user switching (optional pin)
     ***************/
    el("userSelect").addEventListener("change", async ()=>{
      const newId = el("userSelect").value;
      const u = db.users.find(x=>x.id===newId);
      if(u?.pin){
        const pin = await askPin({ title:"PIN Ï‡ÏÎ®ÏƒÏ„Î·", hint:`Î”ÏÏƒÎµ PIN Î³Î¹Î± ${u.name}` });
        if(pin !== u.pin){
          await confirmModal({ title:"Î›Î¬Î¸Î¿Ï‚ PIN", bodyHtml:`<div class="small dangerText">Î›Î¬Î¸Î¿Ï‚ PIN.</div>`, okText:"ÎŸÎš", cancelText:"" });
          // revert
          fillUsers();
          return;
        }
      }
      db.currentUserId = newId;
      saveDB();
      setTop();
      render();
    });

    el("btnSettings").addEventListener("click", openSettings);

    /***************
     * main render switch
     ***************/
    function render(){
      setTop();
      if(state.screen==="home") renderHome();
      else if(state.screen==="table") renderTable();
      else if(state.screen==="pay") renderPay();
      else if(state.screen==="summary") renderSummary();
      resetIdle();
    }

    /***************
     * service worker register
     ***************/
    async function registerSW(){
      if(!("serviceWorker" in navigator)) return;
      try{
        const reg = await navigator.serviceWorker.register("./sw.js", { scope: "./" });
        // update check
        if(reg.update) reg.update();
      }catch(e){
        // ignore
      }
    }

    // initial
    fillUsers();
    setTop();
    render();
    registerSW();
    resetIdle();
  </script>
</body>
</html>