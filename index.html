<!doctype html>
<html lang="el">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Simple Cafe Cashier</title>
<meta name="theme-color" content="#0b0f14">
<style>
:root{
  --bg:#0b0f14; --card:#141b26; --line:#263247; --text:#eef2ff; --muted:#9fb0c7;
  --accent:#3aa2ff; --ok:#24d18d; --warn:#ffb020; --danger:#ff5b6e;
}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto}
.hidden{display:none}
.wrap{max-width:720px;margin:0 auto;padding:14px 14px 120px}

.header{display:flex;justify-content:space-between;align-items:center;gap:10px}
.hTitle{font-weight:900;font-size:20px;margin:0}
.hSub{color:var(--muted);font-size:12px;margin-top:4px}

.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:12px;margin-top:12px}
.btn{height:46px;border-radius:14px;border:1px solid var(--line);background:#101624;color:inherit;font:inherit;padding:0 14px}
.btn.big{height:64px;border-radius:18px;font-weight:900;width:100%;display:flex;justify-content:space-between;align-items:center}
.btn.block{width:100%} .btn.ok{border-color:rgba(36,209,141,.5)} .btn.warn{border-color:rgba(255,176,32,.5)} .btn.bad{border-color:rgba(255,91,110,.6)}
.meta{color:var(--muted);font-size:12px}
.list{display:flex;flex-direction:column;gap:10px}
.item{border:1px solid var(--line);background:#101624;border-radius:16px;padding:12px;display:flex;justify-content:space-between;align-items:center;gap:10px;cursor:pointer}
.badge{border:1px solid var(--line);background:rgba(255,255,255,.06);border-radius:999px;padding:2px 8px;font-weight:900;font-size:12px}

.sticky{position:sticky;top:0;background:rgba(11,15,20,.92);backdrop-filter:blur(8px);z-index:10;border-bottom:1px solid rgba(255,255,255,.06);padding:8px 0}
.lines{display:flex;flex-direction:column;gap:8px}
.line{border:1px solid var(--line);background:#101624;border-radius:16px;padding:10px;display:flex;justify-content:space-between;align-items:center;gap:8px}
.lname{font-weight:900} .lmeta{color:var(--muted);font-size:12px;margin-top:4px}
.qtyBar{display:flex;align-items:center;gap:6px}
.qtyBtn{width:32px;height:32px;border-radius:50%;border:1px solid var(--line);background:#0f1622;font-weight:900}
.payIcons{display:flex;gap:6px} .iconBtn{width:34px;height:34px;border-radius:50%;border:1px solid var(--line);background:#0f1622}

.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
@media(min-width:520px){ .grid2{grid-template-columns:repeat(3,1fr)} }
.prod{height:64px;border:1px solid var(--line);background:#101624;border-radius:16px;padding:10px;display:flex;flex-direction:column;justify-content:center}
.pPrice{color:var(--muted);font-size:12px;margin-top:6px}

.bottom{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,transparent,rgba(11,15,20,.8) 25%,rgba(11,15,20,.95));border-top:1px solid rgba(255,255,255,.06);backdrop-filter:blur(8px);padding:10px 12px calc(12px + env(safe-area-inset-bottom));z-index:99}
.bottomInner{max-width:720px;margin:0 auto;display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.hr{height:1px;background:var(--line);margin:10px 0}
.muted{color:var(--muted)}

.overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);display:none;align-items:flex-end;justify-content:center;z-index:200}
.sheet{width:min(860px, calc(100vw - 24px));border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(15,20,29,.98);max-height:85vh;overflow:auto;padding:14px}
.sheetHead{display:flex;justify-content:space-between;align-items:center}

.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:90px;display:none;background:rgba(20,28,40,.95);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:10px 14px;z-index:300}
.toast.show{display:block}
</style>
</head>
<body>
<div class="wrap">

  <div class="header">
    <div>
      <h1 class="hTitle" id="shopName">Î¤Î¿ ÎœÎ±Î³Î±Î¶Î¯</h1>
      <div class="hSub" id="todayText">â€”</div>
    </div>
    <div class="row">
      <select id="userSelect" class="btn"></select>
      <button class="btn" id="btnSummaryTop" title="Î£ÏÎ½Î¿ÏˆÎ·">ğŸ“Š</button>
      <button class="btn" id="btnSettings" title="Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚">âš™</button>
    </div>
  </div>

  <!-- HOME -->
  <div id="home" class="card">
    <div id="homeStats" class="meta">â€”</div>
    <button class="btn big" id="btnNewOrder"><span>â• ÎÎ­Î± Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±</span><span class="meta">Î´Î¹Î¬Î»ÎµÎ¾Îµ Ï„ÏÎ±Ï€Î­Î¶Î¹</span></button>
    <button class="btn big" id="btnOpenOrders"><span>ğŸ“„ Î‘Î½Î¿Î¹Ï‡Ï„Î­Ï‚ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯ÎµÏ‚</span><span class="meta" id="openCount">0</span></button>
    <button class="btn big" id="btnSummary"><span>ğŸ“Š Î£ÏÎ½Î¿ÏˆÎ· / Export</span><span class="meta">Î·Î¼Î­ÏÎ±Ï‚</span></button>
  </div>

  <!-- TABLE PICKER -->
  <div id="tables" class="hidden card">
    <div class="row" style="justify-content:space-between">
      <button class="btn" id="backHome1">â† Home</button>
      <div class="row">
        <button class="btn" id="btnAll">ÎŒÎ»Î±</button>
        <button class="btn" id="btnOpen">Î‘Î½Î¿Î¹Ï‡Ï„Î¬</button>
        <button class="btn" id="btnFindTable">ğŸ”</button>
      </div>
    </div>
    <div class="hr"></div>
    <div id="tableList" class="list"></div>
    <div id="emptyTables" class="muted hidden">â€” Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î½Î¿Î¹Ï‡Ï„Î¬.</div>
  </div>

  <!-- TICKET -->
  <div id="ticket" class="hidden card">
    <div class="sticky">
      <div class="row" style="justify-content:space-between">
        <button class="btn" id="backHome2">â† Home</button>
        <div class="row">
          <button class="btn" id="btnNote">âœï¸ Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·</button>
          <button class="btn warn" id="btnPay">Î Î»Î·ÏÏ‰Î¼Î®</button>
        </div>
      </div>
      <div class="hSub" id="ticketInfo">â€”</div>
    </div>

    <div class="lines" id="openGrouped"></div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div><b>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚</b></div>
        <div class="muted" id="catHint">â€”</div>
      </div>
      <div class="row" id="catRow"></div>
      <div class="hr"></div>
      <div class="grid2" id="prodGrid"></div>
    </div>
  </div>

  <!-- SUMMARY VIEW TRIGGERED FROM HOME -->
  <div id="summaryView" class="hidden card">
    <button class="btn" id="backHome3">â† Home</button>
    <div class="hr"></div>
    <div id="summaryUsers"></div>
  </div>

</div>

<!-- BOTTOM BAR -->
<div class="bottom">
  <div class="bottomInner">
    <button class="btn block" id="btnCSV">Î•Î¾Î±Î³Ï‰Î³Î® CSV</button>
    <button class="btn block" id="btnSummaryBottom">ğŸ“Š Î£ÏÎ½Î¿ÏˆÎ·</button>
    <button class="btn bad block" id="btnUndo">â†© Undo</button>
  </div>
</div>

<!-- PAYMENT OVERLAY (split) -->
<div class="overlay" id="payOverlay">
  <div class="sheet">
    <div class="sheetHead">
      <div><b id="payTitle">Î Î»Î·ÏÏ‰Î¼Î®</b><div class="muted">Î”Î¹Î¬Î»ÎµÎ¾Îµ items</div></div>
      <button class="btn" id="closePay">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
    <div class="row" style="justify-content:space-between">
      <button class="btn" id="btnSelectAll">Î•Ï€Î¯Î»ÎµÎ¾Îµ ÏŒÎ»Î±</button>
      <div class="badge" id="payTotal">0,00 â‚¬</div>
    </div>
    <div class="hr"></div>
    <div id="payList" class="lines"></div>
    <div class="hr"></div>
    <div class="row">
      <button class="btn ok" id="doCash">ğŸ’¶ ÎœÎµÏ„ÏÎ·Ï„Î¬</button>
      <button class="btn" id="doCard">ğŸ’³ ÎšÎ¬ÏÏ„Î±</button>
      <button class="btn warn" id="doFree">ğŸ ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±</button>
    </div>
  </div>
</div>

<!-- USER SUMMARY OVERLAY (drilldown) -->
<div class="overlay" id="userOverlay">
  <div class="sheet">
    <div class="sheetHead">
      <div><b id="userTitle">Î§ÏÎ®ÏƒÏ„Î·Ï‚</b></div>
      <button class="btn" id="closeUser">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
    <div id="userDetailList"></div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"><div id="toastText">â€”</div></div>

<script>
/* ========= BASICS ========= */
const TODAY = new Date().toISOString().slice(0,10);
const $ = id => document.getElementById(id);
const fmt = n => (n||0).toLocaleString("el-GR",{minimumFractionDigits:2,maximumFractionDigits:2})+" â‚¬";
function toast(t){ $("toastText").textContent=t; $("toast").classList.add("show"); setTimeout(()=>$("toast").classList.remove("show"),1800); }

/* ========= MENU ========= */
const cats = [
  {id:"coffee", label:"â˜• ÎšÎ±Ï†Î­Î´ÎµÏ‚", allow:["coffee_hot","coffee_cold","tea","choco","extras"]},
  {id:"snack",  label:"ğŸ¥ Î£Î½Î±Îº",     allow:["snack"]},
  {id:"drinks", label:"ğŸº Î Î¿Ï„Î¬",     allow:["beer","wine","spirit","cocktail"]},
  {id:"soft",   label:"ğŸ¥¤ Î‘Î½Î±ÏˆÏ…ÎºÏ„Î¹ÎºÎ¬",allow:["soft","juice"]},
];
const products = [
  {cat:"coffee_hot", name:"Espresso Î¼Î¿Î½ÏŒÏ‚", price:2.60},
  {cat:"coffee_hot", name:"Espresso Î´Î¹Ï€Î»ÏŒÏ‚", price:3.20},
  {cat:"coffee_hot", name:"Espresso macchiato", price:2.90},
  {cat:"coffee_hot", name:"Americano", price:3.20},
  {cat:"coffee_hot", name:"Cappuccino", price:3.60},
  {cat:"coffee_hot", name:"Cappuccino Î´Î¹Ï€Î»ÏŒÏ‚", price:4.20},
  {cat:"coffee_hot", name:"Latte macchiato", price:4.20},
  {cat:"coffee_hot", name:"Flat white", price:4.40},
  {cat:"coffee_hot", name:"Mocha", price:4.50},
  {cat:"coffee_hot", name:"ÎšÎ±Ï†Î­Ï‚ Ï†Î¯Î»Ï„ÏÎ¿Ï…", price:3.00},
  {cat:"extras", name:"Decaf (+)", price:0.30},

  {cat:"coffee_cold", name:"Freddo espresso", price:3.80},
  {cat:"coffee_cold", name:"Freddo cappuccino", price:4.20},
  {cat:"coffee_cold", name:"Iced latte", price:4.50},
  {cat:"coffee_cold", name:"Cold brew", price:4.80},
  {cat:"coffee_cold", name:"Frappe", price:3.50},

  {cat:"tea", name:"Î¤ÏƒÎ¬Î¹ (Î¼Î±ÏÏÎ¿, Ï€ÏÎ¬ÏƒÎ¹Î½Î¿, Î²ÏŒÏ„Î±Î½Î±)", price:3.20},
  {cat:"tea", name:"Î¤ÏƒÎ¬Î¹ Ï†ÏÎ¿ÏÏ„Ï‰Î½", price:3.50},
  {cat:"tea", name:"Chai latte", price:4.30},

  {cat:"choco", name:"Î–ÎµÏƒÏ„Î® ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:4.20},
  {cat:"choco", name:"ÎšÏÏÎ± ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:4.50},
  {cat:"choco", name:"Î›ÎµÏ…ÎºÎ® ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:4.50},
  {cat:"choco", name:"ÎšÎ±ÎºÎ¬Î¿", price:4.00},
  {cat:"extras", name:"Î¦Ï…Ï„Î¹ÎºÏŒ Î³Î¬Î»Î± (+)", price:0.50},

  {cat:"soft", name:"Coca-Cola / Zero / Fanta (0,33l)", price:3.40},
  {cat:"soft", name:"Ice Tea", price:3.60},
  {cat:"soft", name:"Î£ÏŒÎ´Î± / Î¤ÏŒÎ½Î¹Îº", price:3.20},
  {cat:"soft", name:"ÎœÎµÏ„Î±Î»Î»Î¹ÎºÏŒ Î½ÎµÏÏŒ (0,33l)", price:2.80},
  {cat:"soft", name:"ÎœÎµÏ„Î±Î»Î»Î¹ÎºÏŒ Î½ÎµÏÏŒ (0,75l)", price:5.50},

  {cat:"juice", name:"Î¦Ï…ÏƒÎ¹ÎºÏŒÏ‚ Ï‡Ï…Î¼ÏŒÏ‚ Ï€Î¿ÏÏ„Î¿ÎºÎ¬Î»Î¹", price:4.50},
  {cat:"juice", name:"Î§Ï…Î¼ÏŒÏ‚ Î±Î½Î¬Î¼ÎµÎ¹ÎºÏ„Î¿Ï‚", price:4.80},
  {cat:"juice", name:"Smoothie Ï†ÏÎ¿ÏÏ„Ï‰Î½", price:5.80},
  {cat:"juice", name:"Milkshake", price:5.50},

  {cat:"snack", name:"ÎšÏÎ¿Ï…Î±ÏƒÎ¬Î½ ÏƒÎºÎ­Ï„Î¿", price:2.80},
  {cat:"snack", name:"ÎšÏÎ¿Ï…Î±ÏƒÎ¬Î½ ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:3.20},
  {cat:"snack", name:"ÎœÎ¬Ï†Î¹Î½", price:3.50},
  {cat:"snack", name:"ÎšÎ­Î¹Îº (ÎºÎ¿Î¼Î¼Î¬Ï„Î¹)", price:4.20},
  {cat:"snack", name:"Cheesecake", price:4.80},
  {cat:"snack", name:"ÎœÏ€Î¹ÏƒÎºÏŒÏ„Î±", price:2.50},
  {cat:"snack", name:"Î¤Î¿ÏƒÏ„ Î¶Î±Î¼Ï€ÏŒÎ½-Ï„Ï…ÏÎ¯", price:4.50},
  {cat:"snack", name:"Î¤Î¿ÏƒÏ„ vegetarian", price:4.80},

  {cat:"beer", name:"ÎœÏ€ÏÏÎ± Î²Î±ÏÎµÎ»Î¯ÏƒÎ¹Î± (0,5l)", price:5.20},
  {cat:"beer", name:"ÎœÏ€ÏÏÎ± ÎµÎ¼Ï†Î¹Î±Î»Ï‰Î¼Î­Î½Î· (0,33l)", price:4.20},
  {cat:"beer", name:"Weissbier (0,5l)", price:5.50},
  {cat:"beer", name:"ÎœÏ€ÏÏÎ± Ï‡Ï‰ÏÎ¯Ï‚ Î±Î»ÎºÎ¿ÏŒÎ»", price:4.20},

  {cat:"wine", name:"ÎšÏÎ±ÏƒÎ¯ Ï€Î¿Ï„Î®ÏÎ¹", price:5.50},
  {cat:"wine", name:"ÎšÏÎ±ÏƒÎ¯ ÎºÎ±ÏÎ¬Ï†Î± (0,5l)", price:12.00},
  {cat:"wine", name:"Î¦Î¹Î¬Î»Î· ÎºÏÎ±ÏƒÎ¯ (Î±Ï€ÏŒ)", price:22.00},
  {cat:"wine", name:"Prosecco Ï€Î¿Ï„Î®ÏÎ¹", price:6.50},

  {cat:"spirit", name:"ÎŸÏ…Î¯ÏƒÎºÎ¹ standard", price:8.50},
  {cat:"spirit", name:"Premium Î¿Ï…Î¯ÏƒÎºÎ¹", price:10.50},
  {cat:"spirit", name:"Î’ÏŒÏ„ÎºÎ±", price:8.00},
  {cat:"spirit", name:"Î¡Î¿ÏÎ¼Î¹", price:8.50},
  {cat:"spirit", name:"Î¤Î¶Î¹Î½", price:8.50},
  {cat:"spirit", name:"ÎŸÏÎ¶Î¿ / Î¤ÏƒÎ¯Ï€Î¿Ï…ÏÎ¿", price:7.50},
  {cat:"spirit", name:"Î›Î¹ÎºÎ­Ï", price:7.50},

  {cat:"cocktail", name:"Mojito", price:9.50},
  {cat:"cocktail", name:"Caipirinha", price:9.50},
  {cat:"cocktail", name:"Margarita", price:10.00},
  {cat:"cocktail", name:"Aperol Spritz", price:8.50},
  {cat:"cocktail", name:"Gin Tonic", price:9.00},
  {cat:"cocktail", name:"Negroni", price:10.50},
];

/* ========= STATE ========= */
const TABLES = ["T1","T2","T3","T4","T5","T6","T7","T8","BAR","Î•ÎÎ©"];
const LS_DB="cashier_db_v1", LS_USERS="cashier_users_v1", LS_ACTIVE="cashier_active_user_v1", LS_SHOP="cashier_shop_v1";
function load(k,fb){try{const r=localStorage.getItem(k);return r?JSON.parse(r):fb}catch{return fb}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}

function ensureDB(){
  let db=load(LS_DB,null);
  if(!db){ db={days:{}}; }
  if(!db.days[TODAY]){
    const tablesObj={}; for(const t of TABLES) tablesObj[t]={lines:[]};
    db.days[TODAY]={meta:{activeTable:TABLES[0],activeCat:"coffee",filter:"open",notes:{}},tables:tablesObj,payments:[],undo:[]};
  }
  // normalize
  for(const t of TABLES){ if(!db.days[TODAY].tables[t]) db.days[TODAY].tables[t]={lines:[]}; }
  if(!db.days[TODAY].payments) db.days[TODAY].payments=[];
  if(!db.days[TODAY].undo) db.days[TODAY].undo=[];
  return db;
}
function ensureUsers(){
  let users=load(LS_USERS,null);
  if(!users||users.length===0){ users=[{id:uid(),name:"Î£ÎµÏÎ²Î¹Ï„ÏŒÏÎ±"}]; save(LS_USERS,users); save(LS_ACTIVE,users[0].id); }
  return users;
}
function activeUser(){ const users=ensureUsers(); const id=load(LS_ACTIVE,users[0].id); return users.find(u=>u.id===id)||users[0]; }
function getShop(){ return load(LS_SHOP,{name:"Î¤Î¿ ÎœÎ±Î³Î±Î¶Î¯"}).name; }
function setShop(n){ save(LS_SHOP,{name:n}); renderTop(); }

function sum(arr,fn){return arr.reduce((s,x)=>s+(fn?fn(x):x),0)}
function fmtTime(ts){ return new Date(ts).toLocaleTimeString("el-GR",{hour:"2-digit",minute:"2-digit"}) }

/* ========= IDLE AUTO-HOME ========= */
let idleTimer;
["click","touchstart","scroll","keydown"].forEach(ev=>document.addEventListener(ev,resetIdle,true));
function resetIdle(){ clearTimeout(idleTimer); idleTimer=setTimeout(()=>{ closeOverlays(); showHome(); },35000); }
function closeOverlays(){ $("payOverlay").style.display="none"; $("userOverlay").style.display="none"; }

/* ========= RENDER TOP ========= */
function renderTop(){
  $("todayText").textContent = "Î£Î®Î¼ÎµÏÎ±: " + TODAY.split("-").reverse().join("/");
  $("shopName").textContent = getShop();

  const users = ensureUsers();
  $("userSelect").innerHTML = users.map(u=>`<option value="${u.id}">${u.name}</option>`).join("");
  $("userSelect").value = activeUser().id;
}

/* ========= HOME ========= */
function calcStats(){
  const db=ensureDB();
  let openTables=0, openItems=0, totalPaid=0;
  for(const t of TABLES){
    const lines=db.days[TODAY].tables[t].lines;
    const open=lines.filter(l=>!l.paid).length;
    if(open>0) openTables++;
    openItems+=open;
  }
  totalPaid = sum(db.days[TODAY].payments,p=>p.total);
  return {openTables,openItems,totalPaid};
}
function renderHome(){
  const st=calcStats();
  $("homeStats").textContent = `Î‘Î½Î¿Î¹Ï‡Ï„Î¬ Ï„ÏÎ±Ï€Î­Î¶Î¹Î±: ${st.openTables} â€¢ Î‘Î½Î¿Î¹Ï‡Ï„Î¬ items: ${st.openItems} â€¢ Î£ÏÎ½Î¿Î»Î¿ ÎµÎ¹ÏƒÏ€ÏÎ¬Î¾ÎµÏ‰Î½: ${fmt(st.totalPaid)}`;
  $("openCount").textContent = st.openTables;
}
function showHome(){ hideAll(); $("home").classList.remove("hidden"); renderHome(); }
function hideAll(){ ["home","tables","ticket","summaryView"].forEach(id=>$(`${id}`).classList.add("hidden")); }

/* ========= TABLE PICKER ========= */
function showTables(openOnly){
  const db=ensureDB(); db.days[TODAY].meta.filter = openOnly?"open":"all"; save(LS_DB,db);
  hideAll(); $("tables").classList.remove("hidden"); renderTables();
}
function renderTables(){
  const db=ensureDB(), filter=db.days[TODAY].meta.filter;
  const box=$("tableList"); box.innerHTML="";
  let any=false;
  for(const t of TABLES){
    const lines=db.days[TODAY].tables[t].lines;
    const open=lines.filter(l=>!l.paid);
    if(filter==="open" && open.length===0) continue;
    any=true;
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`<div><b>${t}</b><div class="muted">${open.length?open.length+" items â€¢ "+fmt(sum(open,l=>l.price)):"â€” ÎºÎµÎ½ÏŒ"}</div></div><div class="badge">${open.length}</div>`;
    div.onclick=()=>{ db.days[TODAY].meta.activeTable=t; save(LS_DB,db); showTicket(); };
    box.appendChild(div);
  }
  $("emptyTables").classList.toggle("hidden", any);
}

/* ========= TICKET ========= */
function showTicket(){ hideAll(); $("ticket").classList.remove("hidden"); renderTicket(); renderCategories(); renderProducts(); }
function renderTicket(){
  const db=ensureDB(); const day=db.days[TODAY]; const t=day.meta.activeTable;
  const open=day.tables[t].lines.filter(l=>!l.paid);
  // group by name (keep unit price consistency per name)
  const gmap={}; open.forEach(l=>{ const k=l.name+"|"+l.price; gmap[k]=(gmap[k]||{name:l.name,price:l.price,ids:[]}); gmap[k].ids.push(l.id); });
  const groups=Object.values(gmap);

  $("ticketInfo").textContent = `Î¤ÏÎ±Ï€Î­Î¶Î¹: ${t} â€¢ Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: ${fmt(sum(groups,g=>g.price*g.ids.length))} â€¢ Î§ÏÎ®ÏƒÏ„Î·Ï‚: ${activeUser().name}`;

  const box=$("openGrouped"); box.innerHTML="";
  if(groups.length===0){ box.innerHTML=`<div class="muted">â€” Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î½Î¿Î¹Ï‡Ï„Î¬ items.</div>`; return; }

  for(const g of groups){
    const row=document.createElement("div");
    row.className="line";
    const qty=g.ids.length, total=(qty*g.price);
    row.innerHTML=`
      <div style="min-width:0">
        <div class="lname">${g.name}</div>
        <div class="lmeta">${qty} Ã— ${g.price.toFixed(2)}â‚¬ = <b>${total.toFixed(2)}â‚¬</b></div>
      </div>
      <div class="qtyBar">
        <button class="qtyBtn" title="âˆ’" aria-label="decrease">âˆ’</button>
        <div>${qty}</div>
        <button class="qtyBtn" title="+" aria-label="increase">+</button>
      </div>
      <div class="payIcons">
        <button class="iconBtn" title="ÎœÎµÏ„ÏÎ·Ï„Î¬">ğŸ’¶</button>
        <button class="iconBtn" title="ÎšÎ¬ÏÏ„Î±">ğŸ’³</button>
        <button class="iconBtn" title="ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±">ğŸ</button>
      </div>
    `;
    const [btnMinus, , btnPlus] = row.querySelectorAll(".qtyBtn");
    const [btnCash,btnCard,btnFree] = row.querySelectorAll(".iconBtn");

    btnPlus.onclick=()=>{ addLine(g.name,g.price); renderTicket(); };
    btnMinus.onclick=()=>{ removeOneUnit(g.name,g.price); renderTicket(); };

    btnCash.onclick = ()=> quickPayGroup(t,g,"cash");
    btnCard.onclick = ()=> quickPayGroup(t,g,"card");
    btnFree.onclick = ()=> quickPayGroup(t,g,"free");

    box.appendChild(row);
  }
}
function addLine(name,price){
  const db=ensureDB(); const t=db.days[TODAY].meta.activeTable;
  db.days[TODAY].tables[t].lines.push({id:uid(),name,price,at:Date.now(),by:activeUser().name,paid:null});
  db.days[TODAY].undo.unshift({type:"add",table:t,name,price,ts:Date.now()}); db.days[TODAY].undo=db.days[TODAY].undo.slice(0,30);
  save(LS_DB,db);
}
function removeOneUnit(name,price){
  const db=ensureDB(); const t=db.days[TODAY].meta.activeTable;
  const lines=db.days[TODAY].tables[t].lines;
  const idx=lines.findIndex(l=>!l.paid && l.name===name && l.price===price);
  if(idx>=0){
    const removed=lines.splice(idx,1)[0];
    db.days[TODAY].undo.unshift({type:"remove",table:t,line:removed,ts:Date.now()}); db.days[TODAY].undo=db.days[TODAY].undo.slice(0,30);
    save(LS_DB,db);
  }
}

/* quick pay from a single grouped product */
function quickPayGroup(table, group, method){
  const qty = group.ids.length;
  let take = 1;
  if(qty>1){
    const inStr = prompt(`Î ÏŒÏƒÎ± "${group.name}" Î½Î± Ï€Î»Î·ÏÏ‰Î¸Î¿ÏÎ½ Ï„ÏÏÎ±; (1â€“${qty})`, "1");
    const n = Number(inStr);
    if(!n || n<1 || n>qty) return;
    take = n;
  }
  doPaymentOnIds(table, group.ids.slice(0,take), method);
  toast(`Î Î»Î·ÏÏÎ¸Î·ÎºÎ±Î½ ${take} Ã— ${group.name} (${method})`);
  renderTicket();
}

/* ========= CATEGORIES & PRODUCTS ========= */
function renderCategories(){
  const db=ensureDB(); const active=db.days[TODAY].meta.activeCat;
  const row=$("catRow"); row.innerHTML="";
  for(const c of cats){
    const b=document.createElement("button");
    b.className="btn"; b.textContent=c.label;
    if(c.id===active) b.style.borderColor="rgba(58,162,255,.6)";
    b.onclick=()=>{ const db2=ensureDB(); db2.days[TODAY].meta.activeCat=c.id; save(LS_DB,db2); renderCategories(); renderProducts(); };
    row.appendChild(b);
  }
  const lab=cats.find(x=>x.id===active)?.label||""; $("catHint").textContent="Î•Î½ÎµÏÎ³Î®: "+lab;
}
function renderProducts(){
  const db=ensureDB(); const active=db.days[TODAY].meta.activeCat;
  const allow=cats.find(x=>x.id===active)?.allow||[];
  const list=products.filter(p=>allow.includes(p.cat));
  const grid=$("prodGrid"); grid.innerHTML="";
  for(const p of list){
    const b=document.createElement("button");
    b.className="prod"; b.innerHTML=`<div>${p.name}</div><div class="pPrice">${p.price.toFixed(2)}â‚¬</div>`;
    b.onclick=()=>{ addLine(p.name,p.price); renderTicket(); };
    grid.appendChild(b);
  }
}

/* ========= PAY OVERLAY (classic split) ========= */
const paySel = new Set();
function openPay(){
  const db=ensureDB(); const t=db.days[TODAY].meta.activeTable;
  $("payTitle").textContent = `Î Î»Î·ÏÏ‰Î¼Î® â€” ${t}`;
  paySel.clear();
  renderPayList();
  $("payOverlay").style.display="flex";
}
function renderPayList(){
  const db=ensureDB(); const t=db.days[TODAY].meta.activeTable;
  const open=db.days[TODAY].tables[t].lines.filter(l=>!l.paid);
  const box=$("payList"); box.innerHTML="";
  for(const l of open){
    const row=document.createElement("div");
    row.className="line";
    const checked = paySel.has(l.id);
    row.innerHTML=`
      <div style="min-width:0">
        <div class="lname">${l.name}</div>
        <div class="lmeta">${activeUser().name} â€¢ ${fmtTime(l.at)}</div>
      </div>
      <div class="row" style="gap:10px">
        <div>${fmt(l.price)}</div>
        <input type="checkbox" ${checked?"checked":""}/>
      </div>`;
    const cb=row.querySelector("input");
    cb.onchange=()=>{ if(cb.checked) paySel.add(l.id); else paySel.delete(l.id); updatePayTotal(); };
    row.onclick=(e)=>{ if(e.target.tagName.toLowerCase()==="input") return; cb.checked=!cb.checked; cb.dispatchEvent(new Event("change")); };
    box.appendChild(row);
  }
  updatePayTotal();
}
function updatePayTotal(){
  const db=ensureDB(); const t=db.days[TODAY].meta.activeTable;
  const open=db.days[TODAY].tables[t].lines.filter(l=>!l.paid && paySel.has(l.id));
  $("payTotal").textContent = fmt(sum(open,l=>l.price));
}
function toggleSelectAll(){
  const db=ensureDB(); const t=db.days[TODAY].meta.activeTable;
  const open=db.days[TODAY].tables[t].lines.filter(l=>!l.paid);
  if(paySel.size===open.length) paySel.clear(); else { paySel.clear(); open.forEach(l=>paySel.add(l.id)); }
  renderPayList();
}
function doPayment(method){
  const db=ensureDB(); const t=db.days[TODAY].meta.activeTable;
  const ids=[...paySel]; if(ids.length===0){ alert("Î”Î¹Î¬Î»ÎµÎ¾Îµ items."); return; }
  doPaymentOnIds(t, ids, method);
  $("payOverlay").style.display="none";
  showHome();
  toast("âœ… Î Î»Î·ÏÏ‰Î¼Î® Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ");
}
function doPaymentOnIds(table, ids, method){
  const db=ensureDB();
  const lines=db.days[TODAY].tables[table].lines;
  const now=Date.now(); const user=activeUser().name;

  let total=0;
  for(const l of lines){ if(ids.includes(l.id) && !l.paid){ l.paid={method,at:now,by:user}; total+=l.price; } }
  db.days[TODAY].payments.push({id:uid(),at:now,table,user,method,total,itemIds:ids});
  db.days[TODAY].undo.unshift({type:"pay",table,itemIds:ids,method,total,at:now}); db.days[TODAY].undo=db.days[TODAY].undo.slice(0,30);
  save(LS_DB,db);
}

/* ========= UNDO ========= */
function undo(){
  const db=ensureDB(); const a=db.days[TODAY].undo.shift(); if(!a){ toast("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎºÎ¬Ï„Î¹ Î³Î¹Î± Undo."); return; }
  if(a.type==="add"){
    const lines=db.days[TODAY].tables[a.table].lines;
    const idx=lines.slice().reverse().findIndex(l=>!l.paid && l.name===a.name && l.price===a.price);
    if(idx>=0){ lines.splice(lines.length-1-idx,1); }
  } else if(a.type==="remove"){
    db.days[TODAY].tables[a.table].lines.push(a.line);
  } else if(a.type==="pay"){
    const lines=db.days[TODAY].tables[a.table].lines;
    for(const l of lines){ if(a.itemIds.includes(l.id)) l.paid=null; }
    db.days[TODAY].payments = db.days[TODAY].payments.filter(p=>!(p.at===a.at && p.total===a.total && p.table===a.table));
  }
  save(LS_DB,db);
  renderHome(); renderTables(); renderTicket();
  toast("ÎˆÎ³Î¹Î½Îµ Undo.");
}

/* ========= SUMMARY ========= */
function showSummaryView(){ hideAll(); $("summaryView").classList.remove("hidden"); renderSummary(); }
function renderSummary(){
  const db=ensureDB(); const byUser={};
  for(const p of db.days[TODAY].payments){
    byUser[p.user] = byUser[p.user] || {cash:0,card:0,free:0,total:0,count:0};
    byUser[p.user][p.method]+=p.total;
    byUser[p.user].total += p.total; byUser[p.user].count += 1;
  }
  const box=$("summaryUsers"); box.innerHTML="";
  if(Object.keys(byUser).length===0){ box.innerHTML=`<div class="muted">â€” Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚ ÏƒÎ®Î¼ÎµÏÎ±.</div>`; return; }
  for(const [name,agg] of Object.entries(byUser).sort((a,b)=>b[1].total-a[1].total)){
    const row=document.createElement("div");
    row.className="item";
    row.innerHTML=`<div><b>${name}</b><div class="muted">ÎœÎµÏ„ÏÎ·Ï„Î¬: ${fmt(agg.cash)} â€¢ ÎšÎ¬ÏÏ„Î±: ${fmt(agg.card)} â€¢ ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±: ${fmt(agg.free)} â€¢ ÎšÎ¹Î½Î®ÏƒÎµÎ¹Ï‚: ${agg.count}</div></div><div class="badge">${fmt(agg.total)}</div>`;
    row.onclick=()=>openUserDetail(name);
    box.appendChild(row);
  }
}
function openUserDetail(name){
  const db=ensureDB();
  const list=db.days[TODAY].payments.filter(p=>p.user===name).sort((a,b)=>a.at-b.at);
  $("userTitle").textContent = name+" â€” ÎºÎ¹Î½Î®ÏƒÎµÎ¹Ï‚";
  const box=$("userDetailList"); box.innerHTML="";
  for(const p of list){
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`<div><b>${fmt(p.total)}</b><div class="muted">${new Date(p.at).toLocaleTimeString("el-GR",{hour:"2-digit",minute:"2-digit",second:"2-digit"})} â€¢ ${p.table} â€¢ ${p.method}</div></div>`;
    box.appendChild(div);
  }
  $("userOverlay").style.display="flex";
}

/* ========= CSV ========= */
function exportCSV(){
  const db=ensureDB(); const rows=[["date","time","table","user","method","total"].join(",")];
  for(const p of db.days[TODAY].payments){
    rows.push([TODAY,new Date(p.at).toLocaleTimeString("el-GR",{hour:"2-digit",minute:"2-digit",second:"2-digit"}),p.table,p.user,p.method,p.total.toFixed(2)].join(","));
  }
  const blob=new Blob([rows.join("\n")],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`daily-cashier-${TODAY}.csv`; a.click();
}

/* ========= NOTES ========= */
function editNote(){
  const db=ensureDB(); const t=db.days[TODAY].meta.activeTable;
  const cur=(db.days[TODAY].meta.notes[t]||"");
  const val=prompt(`Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ· Î³Î¹Î± ${t}:`,cur);
  if(val===null) return;
  db.days[TODAY].meta.notes[t]=val.trim();
  save(LS_DB,db);
  renderTicket();
}

/* ========= UI EVENTS ========= */
$("btnNewOrder").onclick = ()=> showTables(false);
$("btnOpenOrders").onclick = ()=> showTables(true);
$("btnSummary").onclick = showSummaryView;
$("btnSummaryTop").onclick = showSummaryView;
$("btnSummaryBottom").onclick = showSummaryView;
$("backHome1").onclick = showHome; $("backHome2").onclick = showHome; $("backHome3").onclick = showHome;

$("btnAll").onclick = ()=>{ const db=ensureDB(); db.days[TODAY].meta.filter="all"; save(LS_DB,db); renderTables(); };
$("btnOpen").onclick = ()=>{ const db=ensureDB(); db.days[TODAY].meta.filter="open"; save(LS_DB,db); renderTables(); };
$("btnFindTable").onclick = ()=>{
  const q=prompt("Î’ÏÎµÏ‚ Ï„ÏÎ±Ï€Î­Î¶Î¹ (Ï€.Ï‡. T3, BAR):",""); if(!q) return;
  const t = TABLES.find(x=>x.toUpperCase().includes(q.toUpperCase()));
  if(!t) return alert("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ.");
  const db=ensureDB(); db.days[TODAY].meta.activeTable=t; save(LS_DB,db); showTicket();
};

$("btnNote").onclick = editNote;
$("btnPay").onclick = openPay;
$("closePay").onclick = ()=> $("payOverlay").style.display="none";
$("btnSelectAll").onclick = toggleSelectAll;
$("doCash").onclick = ()=> doPayment("cash");
$("doCard").onclick = ()=> doPayment("card");
$("doFree").onclick = ()=> doPayment("free");

$("btnCSV").onclick = exportCSV;
$("btnUndo").onclick = undo;

$("userSelect").onchange = (e)=>{ save(LS_ACTIVE,e.target.value); renderTop(); renderHome(); renderTicket(); renderSummary(); };
$("btnSettings").onclick = ()=>{
  const act = confirm("Î‘Î»Î»Î¬Î³Î® Î¿Î½ÏŒÎ¼Î±Ï„Î¿Ï‚ Î¼Î±Î³Î±Î¶Î¹Î¿Ï; Î Î±Ï„Î¬Ï‚ ÎŸÎš Î³Î¹Î± Î±Î»Î»Î±Î³Î®.");
  if(!act) return;
  const name = prompt("ÎÎ­Î¿ ÏŒÎ½Î¿Î¼Î± Î¼Î±Î³Î±Î¶Î¹Î¿Ï:", getShop()); if(!name) return;
  setShop(name.trim());
};

$("closeUser").onclick = ()=> $("userOverlay").style.display="none";

/* ========= INIT ========= */
function firstInit(){
  // init db users shop if missing
  ensureDB(); ensureUsers();
  if(!load(LS_SHOP,null)) setShop("Î¤Î¿ ÎœÎ±Î³Î±Î¶Î¯");
  renderTop(); renderHome();
}
firstInit(); showHome();
</script>
</body>
</html>
