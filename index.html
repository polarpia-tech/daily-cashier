<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Î—Î¼ÎµÏÎ®ÏƒÎ¹Î¿ Î¤Î±Î¼ÎµÎ¯Î¿</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0f1115" />

  <style>
    :root{
      --bg:#0f1115; --card:#151a22; --muted:#a9b1c3; --text:#eef2ff;
      --accent:#4cc2ff; --ok:#42d392; --warn:#ffcd3c; --bad:#ff6b6b;
      --stroke: rgba(255,255,255,.10);
      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.10);
    }
    *{ box-sizing:border-box; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    html,body{ height:100%; width:100%; }
    html{ -webkit-text-size-adjust:100%; text-size-adjust:100%; }
    body{ margin:0; background:var(--bg); color:var(--text); -webkit-tap-highlight-color: transparent; overflow-x:hidden; }

    .wrap{ width:100%; max-width:980px; margin:0 auto; padding:0 12px; }

    header{
      position: sticky; top: 0; z-index: 10;
      background: rgba(15,17,21,.92);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.08);
      padding: 10px 0;
    }
    .topRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .topLeft{ min-width:0; }
    .appTitle{ font-weight:900; font-size:18px; }
    .appSub{ color:var(--muted); font-size:12px; margin-top:2px; }

    .topRight{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    select, input{
      padding:10px 10px; border-radius:14px; border:1px solid var(--stroke);
      background:rgba(255,255,255,.05); color:var(--text);
      outline:none; min-height:44px; font-size:16px; max-width:100%;
    }

    .btn{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 12px;
      border-radius:16px;
      font-weight:750;
      cursor:pointer;
      user-select:none;
      min-height:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition: transform .06s ease;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ border-color: rgba(76,194,255,.55); background: rgba(76,194,255,.14); }
    .btn.ok{ border-color: rgba(66,211,146,.55); background: rgba(66,211,146,.16); }
    .btn.warn{ border-color: rgba(255,205,60,.55); background: rgba(255,205,60,.16); }
    .btn.bad{ border-color: rgba(255,107,107,.55); background: rgba(255,107,107,.18); }
    .btn.ghost{ background: rgba(255,255,255,.04); }

    .pill{
      padding:10px 12px; background:var(--glass); border:1px solid var(--glass2);
      border-radius:16px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      min-height:44px; overflow:hidden; color:var(--muted); font-size:13px;
    }
    .pill b{ color:var(--text); }

    main{ padding: 12px 0; padding-bottom: calc(190px + env(safe-area-inset-bottom, 0px)); }
    .grid{ display:grid; gap: 12px; }
    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      padding:12px;
      box-shadow:0 10px 28px rgba(0,0,0,.28);
      overflow:hidden;
    }
    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .title{ font-weight:900; font-size:15px; }
    .muted{ color:var(--muted); font-size:13px; }
    .divider{ height:1px; background: rgba(255,255,255,.08); margin:10px 0; }

    .cats{ display:flex; gap:8px; overflow:auto; padding-bottom:6px; -webkit-overflow-scrolling: touch; }
    .cat{ white-space:nowrap; }
    .cat.active{ outline:2px solid rgba(76,194,255,.55); }

    .products{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media (min-width:560px){ .products{ grid-template-columns:1fr 1fr; } }
    @media (min-width:920px){ .products{ grid-template-columns:1fr 1fr 1fr; } }

    .prod{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px; border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      min-width:0;
    }
    .prod > div:first-child{ min-width:0; }
    .prod .title{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .prod small{ color:var(--muted); display:block; margin-top:2px; }
    .price{ font-weight:900; white-space:nowrap; }

    /* Tickets list */
    .ticketList{ display:grid; gap:10px; }
    .ticket{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      border-radius:16px;
      padding:10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .ticketName{ font-weight:900; }
    .ticketMeta{ color:var(--muted); font-size:12px; margin-top:2px; }
    .ticketBtns{ display:flex; gap:8px; flex-wrap:wrap; }

    /* Ticket detail lines */
    .lineList{ display:grid; gap:10px; }
    .line{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      border-radius:16px;
      padding:10px;
      display:grid;
      gap:10px;
    }
    .lineTop{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between; }
    .lineName{ font-weight:900; }
    .lineMeta{ color:var(--muted); font-size:12px; margin-top:2px; }
    .lineBtns{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .miniBtn{ padding:10px 10px; border-radius:14px; min-height:40px; font-size:14px; }
    .qtyNow{
      display:flex; gap:8px; align-items:center;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      min-height:40px;
    }
    .qtyNow b{ min-width: 18px; text-align:center; }
    .qtyNow .miniBtn{ min-height:34px; padding:8px 10px; }

    /* Modal */
    .modalWrap{
      position:fixed; inset:0;
      background: rgba(0,0,0,.56);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:12px;
      z-index:50;
    }
    .modal{
      width:min(860px, 100%);
      background:var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-radius:20px;
      padding:12px;
      box-shadow:0 18px 55px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal h2{ margin:0 0 6px; font-size:16px; }
    .qty{ display:flex; gap:10px; align-items:center; }
    .qty .n{ font-size:18px; font-weight:900; min-width:40px; text-align:center; }
    .toggle{ display:flex; gap:10px; flex-wrap:wrap; }
    label.cb{
      display:flex; gap:10px; align-items:center;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      min-height:44px;
    }
    input[type="checkbox"]{ width:18px; height:18px; }

    /* Footer */
    .footerBar{
      position:fixed; left:0; right:0; bottom:0;
      padding: 10px 0 calc(10px + env(safe-area-inset-bottom, 0px));
      z-index: 20;
      background: rgba(15,17,21,0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 -14px 40px rgba(0,0,0,.55);
    }
    .footerGrid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (min-width:760px){ .footerGrid{ grid-template-columns:1fr 1fr 1fr 1fr; } }
    .tiny{ font-size:12px; color:var(--muted); margin-top:8px; }

    .toast{
      position: fixed; left:50%; transform:translateX(-50%);
      bottom: calc(126px + env(safe-area-inset-bottom, 0px));
      background: rgba(20,24,32,.95);
      border:1px solid rgba(255,255,255,.10);
      padding:10px 12px;
      border-radius:16px;
      display:none;
      z-index:60;
      max-width:92vw;
      text-align:center;
    }
  </style>
</head>

<body>

<header>
  <div class="wrap">
    <div class="topRow">
      <div class="topLeft">
        <div class="appTitle">Î—Î¼ÎµÏÎ®ÏƒÎ¹Î¿ Î¤Î±Î¼ÎµÎ¯Î¿</div>
        <div class="appSub" id="todayPill">Î£Î®Î¼ÎµÏÎ±: â€”</div>
      </div>

      <div class="topRight">
        <select id="userSel"></select>

        <select id="ticketSel"></select>
        <button class="btn ghost" id="btnNewTicket">+ Ticket</button>
        <button class="btn ghost" id="btnCloseTicket">ÎšÎ»ÎµÎ¯ÏƒÎµ Ticket</button>

        <button class="btn ghost" id="btnSettings">âš™</button>
      </div>
    </div>
  </div>
</header>

<!-- Settings -->
<div class="modalWrap" id="settingsWrap">
  <div class="modal">
    <div class="row" style="align-items:flex-start;">
      <div>
        <h2>Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</h2>
        <div class="muted">Î—Î¼Î­ÏÎ±: <b id="dayKey">â€”</b> â€” Î§ÏÎ®ÏƒÏ„Î·Ï‚: <b id="userNameLabel">â€”</b></div>
      </div>
      <button class="btn" id="btnSettingsClose">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
    <div class="divider"></div>
    <div class="row" style="gap:10px;">
      <button class="btn ghost" style="flex:1" id="userAdd">+ Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Ï‡ÏÎ®ÏƒÏ„Î·</button>
      <button class="btn ghost" style="flex:1" id="userRename">âœ ÎœÎµÏ„Î¿Î½Î¿Î¼Î±ÏƒÎ¯Î±</button>
      <button class="btn bad" style="flex:1" id="userDelete">ğŸ—‘ Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
    </div>
    <div class="divider"></div>
    <div class="pill">Î¡Î¿Î®: <b>Ticket (Ï„ÏÎ±Ï€Î­Î¶Î¹) â†’ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± â†’ Î¼ÎµÏÎ¹ÎºÎ® Ï€Î»Î·ÏÏ‰Î¼Î® Î±Î½Î¬ Ï€ÏÎ¿ÏŠÏŒÎ½</b></div>
  </div>
</div>

<main>
  <div class="wrap">
    <div class="grid">

      <!-- Tickets -->
      <section class="card">
        <div class="row">
          <div>
            <div class="title">Î‘Î½Î¿Î¹Ï‡Ï„Î¬ Tickets (Î¤ÏÎ±Ï€Î­Î¶Î¹Î±)</div>
            <div class="muted">ÎšÎ¬Î¸Îµ ticket Î­Ï‡ÎµÎ¹ Ï€Î¿Î»Î»Î¬ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± (ÎºÎ±Ï†Î­/Î¼Ï€ÏÏÎ±/Ï€Î¿Ï„ÏŒ) ÎºÎ±Î¹ Ï€Î»Î·ÏÏÎ½Î¿Î½Ï„Î±Î¹ Î¾ÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„Î¬.</div>
          </div>
          <div class="pill" style="min-height:auto;">
            Ticket: <b id="activeTicketLabel">â€”</b> â€” Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: <b id="activeTicketDue">0,00 â‚¬</b>
          </div>
        </div>
        <div class="divider"></div>
        <div id="ticketList" class="ticketList"></div>
      </section>

      <!-- Ticket detail -->
      <section class="card" id="ticketDetailCard" style="display:none;">
        <div class="row">
          <div>
            <div class="title">Ticket: <span id="detailTicketName">â€”</span></div>
            <div class="muted">Î Î¬Ï„Î± ğŸ’¶/ğŸ’³/ğŸ Î³Î¹Î± Î½Î± Ï€Î»Î·ÏÏÏƒÎµÎ¹Ï‚ Î¼Î­ÏÎ¿Ï‚ Î® ÏŒÎ»Î¿, Î±Î½Î¬ Î³ÏÎ±Î¼Î¼Î®.</div>
          </div>
          <button class="btn" id="btnBackTickets">Î Î¯ÏƒÏ‰</button>
        </div>
        <div class="divider"></div>
        <div id="lineList" class="lineList"></div>
      </section>

      <!-- Categories -->
      <section class="card">
        <div class="row">
          <div>
            <div class="title">ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚</div>
            <div class="muted">Î Î¬Ï„Î± Ï€ÏÎ¿ÏŠÏŒÎ½ Î³Î¹Î± Î½Î± Î¼Ï€ÎµÎ¹ ÏƒÏ„Î¿ Î•ÎÎ•Î¡Î“ÎŸ ticket.</div>
          </div>
          <button class="btn" id="btnResetDay">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î·Î¼Î­ÏÎ±Ï‚</button>
        </div>
        <div class="divider"></div>
        <div class="cats" id="cats"></div>
      </section>

      <!-- Products -->
      <section class="card">
        <div class="row">
          <div>
            <div class="title" id="catTitle">Î ÏÎ¿ÏŠÏŒÎ½Ï„Î±</div>
            <div class="muted">Î‘Î½ Î¸ÎµÏ‚ Î¬Î»Î»Î¿ Ï„ÏÎ±Ï€Î­Î¶Î¹, Î¬Î»Î»Î±Î¾Îµ ticket Î±Ï€ÏŒ Ï€Î¬Î½Ï‰.</div>
          </div>
          <input id="search" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·â€¦">
        </div>
        <div class="divider"></div>
        <div class="products" id="products"></div>
      </section>

      <!-- Summary -->
      <section class="card">
        <div class="row">
          <div>
            <div class="title">Î£ÏÎ½Î¿ÏˆÎ· Î·Î¼Î­ÏÎ±Ï‚</div>
            <div class="muted">ÎœÎµÏ„ÏÎ¬ÎµÎ¹ Î¼ÏŒÎ½Î¿ Ï€Î»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚ (ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ tickets).</div>
          </div>
          <button class="btn primary" id="btnClose">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Î·Î¼Î­ÏÎ±Ï‚</button>
        </div>
        <div class="divider"></div>
        <div style="display:grid; gap:6px;">
          <div class="row"><span>Î£ÏÎ½Î¿Î»Î¿ (cash+card)</span><b id="sumTotal">0,00 â‚¬</b></div>
          <div class="row"><span>ÎœÎµÏ„ÏÎ·Ï„Î¬</span><b id="sumCash">0,00 â‚¬</b></div>
          <div class="row"><span>ÎšÎ¬ÏÏ„Î±</span><b id="sumCard">0,00 â‚¬</b></div>
          <div class="row"><span>ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î± (Î±Î¾Î¯Î±)</span><b id="sumGift">0,00 â‚¬</b></div>
        </div>
        <div class="divider"></div>
        <div class="muted">Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯ÎµÏ‚ Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚</div>
        <div id="lastList" class="tiny" style="margin-top:8px; display:grid; gap:6px;"></div>
      </section>

    </div>
  </div>
</main>

<div class="footerBar">
  <div class="wrap">
    <div class="footerGrid">
      <button class="btn ok" id="btnUndo">Î‘Î½Î±Î¯ÏÎµÏƒÎ· Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î±Ï‚ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚</button>
      <button class="btn primary" id="btnRepeat">Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± Ï€Î»Î·ÏÏ‰Î¼Î® Î¾Î±Î½Î¬</button>
      <button class="btn" id="btnCSV">Î•Î¾Î±Î³Ï‰Î³Î® CSV</button>
      <button class="btn bad" id="btnWipeAll">Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏŒÎ»Ï‰Î½</button>
    </div>
    <div class="tiny">Tip: Chrome â‹® â†’ <b>Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î·Î½ Î±ÏÏ‡Î¹ÎºÎ® Î¿Î¸ÏŒÎ½Î·</b>.</div>
  </div>
</div>

<!-- Product modal -->
<div class="modalWrap" id="modalWrap">
  <div class="modal">
    <div class="row" style="align-items:flex-start;">
      <div>
        <h2 id="mTitle">â€”</h2>
        <div class="muted" id="mPrice">â€”</div>
      </div>
      <button class="btn" id="mClose">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div class="qty">
        <button class="btn" id="qtyMinus">â€“</button>
        <div class="n" id="qtyVal">1</div>
        <button class="btn" id="qtyPlus">+</button>
      </div>

      <div class="muted">Î¤ÎµÎ»Î¹ÎºÏŒ:</div>
      <div class="title" id="mFinal">0,00 â‚¬</div>
    </div>

    <div class="divider"></div>

    <div class="toggle">
      <label class="cb"><input type="checkbox" id="xDecaf"> Decaf (+0,30â‚¬)</label>
      <label class="cb"><input type="checkbox" id="xPlant"> Î¦Ï…Ï„Î¹ÎºÏŒ Î³Î¬Î»Î± (+0,50â‚¬)</label>
    </div>

    <div class="divider"></div>

    <div class="row">
      <button class="btn primary" style="flex:1" id="addToTicket">â• Î Î¡ÎŸÎ£Î˜Î—ÎšÎ— Î£Î¤ÎŸ TICKET</button>
    </div>
    <div class="tiny">Î˜Î± Î¼Ï€ÎµÎ¹ ÏƒÏ„Î¿ ÎµÎ½ÎµÏÎ³ÏŒ ticket (Ï„ÏÎ±Ï€Î­Î¶Î¹) Ï€Î¿Ï… Î­Ï‡ÎµÎ¹Ï‚ Ï€Î¬Î½Ï‰.</div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function(){
      navigator.serviceWorker.register('./sw.js').catch(function(){});
    });
  }

  function euro(n){ return n.toFixed(2).replace(".", ",") + " â‚¬"; }
  function dayKey(d){
    var y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), da=String(d.getDate()).padStart(2,"0");
    return y+"-"+m+"-"+da;
  }
  function nowHM(){ return (new Date()).toTimeString().slice(0,5); }
  function escapeCSV(s){
    s=String(s==null?"":s);
    if(/[,"\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  }

  var toastEl=document.getElementById("toast");
  function toast(msg){
    toastEl.textContent=msg;
    toastEl.style.display="block";
    clearTimeout(toastEl._t);
    toastEl._t=setTimeout(function(){ toastEl.style.display="none"; }, 1600);
  }

  var MENU=[
    { cat:"â˜• ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ Î–Î•Î£Î¤ÎŸÎ™", items:[
      ["Espresso Î¼Î¿Î½ÏŒÏ‚",2.60],["Espresso Î´Î¹Ï€Î»ÏŒÏ‚",3.20],["Espresso macchiato",2.90],
      ["Americano",3.20],["Cappuccino",3.60],["Cappuccino Î´Î¹Ï€Î»ÏŒÏ‚",4.20],
      ["Latte macchiato",4.20],["Flat white",4.40],["Mocha",4.50],["ÎšÎ±Ï†Î­Ï‚ Ï†Î¯Î»Ï„ÏÎ¿Ï…",3.00]
    ]},
    { cat:"â„ï¸ ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ ÎšÎ¡Î¥ÎŸÎ™", items:[
      ["Freddo espresso",3.80],["Freddo cappuccino",4.20],["Iced latte",4.50],["Cold brew",4.80],["Frappe",3.50]
    ]},
    { cat:"ğŸ«– Î¤Î£Î‘Îª â€“ Î–Î•Î£Î¤Î‘ Î¡ÎŸÎ¦Î—ÎœÎ‘Î¤Î‘", items:[
      ["Î¤ÏƒÎ¬Î¹ (Î¼Î±ÏÏÎ¿, Ï€ÏÎ¬ÏƒÎ¹Î½Î¿, Î²ÏŒÏ„Î±Î½Î±)",3.20],["Î¤ÏƒÎ¬Î¹ Ï†ÏÎ¿ÏÏ„Ï‰Î½",3.50],["Chai latte",4.30]
    ]},
    { cat:"ğŸ« Î£ÎŸÎšÎŸÎ›Î‘Î¤Î•Î£ â€“ Î“Î‘Î›Î‘ÎšÎ¤Î•Î¡Î‘", items:[
      ["Î–ÎµÏƒÏ„Î® ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±",4.20],["ÎšÏÏÎ± ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±",4.50],["Î›ÎµÏ…ÎºÎ® ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±",4.50],["ÎšÎ±ÎºÎ¬Î¿",4.00]
    ]},
    { cat:"ğŸ¥¤ Î‘ÎÎ‘Î¨Î¥ÎšÎ¤Î™ÎšÎ‘ â€“ ÎÎ•Î¡Î‘", items:[
      ["Coca-Cola / Zero / Fanta (0,33l)",3.40],["Ice Tea",3.60],["Î£ÏŒÎ´Î± / Î¤ÏŒÎ½Î¹Îº",3.20],
      ["ÎœÎµÏ„Î±Î»Î»Î¹ÎºÏŒ Î½ÎµÏÏŒ (0,33l)",2.80],["ÎœÎµÏ„Î±Î»Î»Î¹ÎºÏŒ Î½ÎµÏÏŒ (0,75l)",5.50]
    ]},
    { cat:"ğŸŠ Î§Î¥ÎœÎŸÎ™ â€“ SMOOTHIES", items:[
      ["Î¦Ï…ÏƒÎ¹ÎºÏŒÏ‚ Ï‡Ï…Î¼ÏŒÏ‚ Ï€Î¿ÏÏ„Î¿ÎºÎ¬Î»Î¹",4.50],["Î§Ï…Î¼ÏŒÏ‚ Î±Î½Î¬Î¼ÎµÎ¹ÎºÏ„Î¿Ï‚",4.80],["Smoothie Ï†ÏÎ¿ÏÏ„Ï‰Î½",5.80],["Milkshake",5.50]
    ]},
    { cat:"ğŸ¥ Î£ÎÎ‘Îš â€“ Î“Î›Î¥ÎšÎ‘", items:[
      ["ÎšÏÎ¿Ï…Î±ÏƒÎ¬Î½ ÏƒÎºÎ­Ï„Î¿",2.80],["ÎšÏÎ¿Ï…Î±ÏƒÎ¬Î½ ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±",3.20],["ÎœÎ¬Ï†Î¹Î½",3.50],["ÎšÎ­Î¹Îº (ÎºÎ¿Î¼Î¼Î¬Ï„Î¹)",4.20],
      ["Cheesecake",4.80],["ÎœÏ€Î¹ÏƒÎºÏŒÏ„Î±",2.50],["Î¤Î¿ÏƒÏ„ Î¶Î±Î¼Ï€ÏŒÎ½-Ï„Ï…ÏÎ¯",4.50],["Î¤Î¿ÏƒÏ„ vegetarian",4.80]
    ]},
    { cat:"ğŸº ÎœÎ Î¥Î¡Î•Î£", items:[
      ["ÎœÏ€ÏÏÎ± Î²Î±ÏÎµÎ»Î¯ÏƒÎ¹Î± (0,5l)",5.20],["ÎœÏ€ÏÏÎ± ÎµÎ¼Ï†Î¹Î±Î»Ï‰Î¼Î­Î½Î· (0,33l)",4.20],["Weissbier (0,5l)",5.50],["ÎœÏ€ÏÏÎ± Ï‡Ï‰ÏÎ¯Ï‚ Î±Î»ÎºÎ¿ÏŒÎ»",4.20]
    ]},
    { cat:"ğŸ· ÎšÎ¡Î‘Î£Î™Î‘", items:[
      ["ÎšÏÎ±ÏƒÎ¯ Ï€Î¿Ï„Î®ÏÎ¹",5.50],["ÎšÏÎ±ÏƒÎ¯ ÎºÎ±ÏÎ¬Ï†Î± (0,5l)",12.00],["Î¦Î¹Î¬Î»Î· ÎºÏÎ±ÏƒÎ¯ (22â‚¬)",22.00],["Î¦Î¹Î¬Î»Î· ÎºÏÎ±ÏƒÎ¯ (28â‚¬)",28.00],["Prosecco Ï€Î¿Ï„Î®ÏÎ¹",6.50]
    ]},
    { cat:"ğŸ¥ƒ Î ÎŸÎ¤Î‘ (4cl)", items:[
      ["ÎŸÏ…Î¯ÏƒÎºÎ¹ standard",8.50],["Premium Î¿Ï…Î¯ÏƒÎºÎ¹",10.50],["Î’ÏŒÏ„ÎºÎ±",8.00],["Î¡Î¿ÏÎ¼Î¹",8.50],
      ["Î¤Î¶Î¹Î½",8.50],["ÎŸÏÎ¶Î¿ / Î¤ÏƒÎ¯Ï€Î¿Ï…ÏÎ¿",7.50],["Î›Î¹ÎºÎ­Ï",7.50]
    ]},
    { cat:"ğŸ¸ ÎšÎŸÎšÎ¤Î•ÎªÎ›", items:[
      ["Mojito",9.50],["Caipirinha",9.50],["Margarita",10.00],["Aperol Spritz",8.50],["Gin Tonic",9.00],["Negroni",10.50]
    ]}
  ];

  var EXTRAS={ decaf:{name:"Decaf",price:0.30}, plant:{name:"Î¦Ï…Ï„Î¹ÎºÏŒ Î³Î¬Î»Î±",price:0.50} };

  // DB:
  // day => { tickets: [{id,name,createdAt, lines:[{id,item,category,extras,unit,qty_open,pay_now,time}]}], paid:[{...}] }
  var LS_KEY="mini_cashier_db_tickets_v1";
  var LS_USERS="mini_cashier_users_v1";
  var LS_USER="mini_cashier_user_v1";
  var LS_ACTIVE_TICKET="mini_cashier_active_ticket_v1";

  function loadDB(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)) || {days:{},lastId:0}; }catch(e){ return {days:{},lastId:0}; } }
  function saveDB(db){ localStorage.setItem(LS_KEY, JSON.stringify(db)); }

  function loadUsers(){
    var fallback=[{id:"user1",name:"Î§ÏÎ®ÏƒÏ„Î·Ï‚ 1"},{id:"tablet",name:"Tablet (Î­ÎºÏ„Î±ÎºÏ„Î·)"}];
    try{
      var raw=localStorage.getItem(LS_USERS);
      if(!raw) return fallback;
      var arr=JSON.parse(raw);
      if(!Array.isArray(arr)||!arr.length) return fallback;
      return arr;
    }catch(e){ return fallback; }
  }
  function saveUsers(arr){ localStorage.setItem(LS_USERS, JSON.stringify(arr)); }
  function normalizeId(name){
    var s=name.trim().toLowerCase().replace(/\s+/g,"_");
    s=s.replace(/[^a-z0-9\u0370-\u03ff_-]/g,"");
    return s;
  }

  var db=loadDB();
  var BASE_TODAY=dayKey(new Date());

  // Settings
  var settingsWrap=document.getElementById("settingsWrap");
  var btnSettings=document.getElementById("btnSettings");
  var btnSettingsClose=document.getElementById("btnSettingsClose");
  var userNameLabel=document.getElementById("userNameLabel");
  function openSettings(){
    if(userNameLabel) userNameLabel.textContent = currentUser().name;
    settingsWrap.style.display="flex";
  }
  function closeSettings(){ settingsWrap.style.display="none"; }
  btnSettings.onclick=openSettings;
  btnSettingsClose.onclick=closeSettings;
  settingsWrap.addEventListener("click", function(e){ if(e.target===settingsWrap) closeSettings(); });

  // Users
  var userSel=document.getElementById("userSel");
  var userAdd=document.getElementById("userAdd");
  var userRename=document.getElementById("userRename");
  var userDelete=document.getElementById("userDelete");
  var USERS=loadUsers();

  function renderUserSelect(){
    var selected=localStorage.getItem(LS_USER) || (USERS[0] && USERS[0].id);
    userSel.innerHTML="";
    USERS.forEach(function(u){
      var opt=document.createElement("option");
      opt.value=u.id; opt.textContent=u.name;
      userSel.appendChild(opt);
    });
    if(!USERS.some(function(u){return u.id===selected;})) selected=USERS[0].id;
    userSel.value=selected;
    localStorage.setItem(LS_USER, selected);
  }
  function currentUser(){
    var id=userSel.value;
    var u=USERS.find(function(x){return x.id===id;});
    return u || {id:id,name:id};
  }

  var TODAY="";
  function dayUserKey(){ return BASE_TODAY + "__" + currentUser().id; }

  function ensureDay(){
    TODAY=dayUserKey();
    if(!db.days[TODAY]) db.days[TODAY]={tickets:[], paid:[]};
    if(!db.days[TODAY].tickets) db.days[TODAY].tickets=[];
    if(!db.days[TODAY].paid) db.days[TODAY].paid=[];
    saveDB(db);

    document.getElementById("dayKey").textContent=BASE_TODAY;
    document.getElementById("todayPill").textContent="Î£Î®Î¼ÎµÏÎ±: " + BASE_TODAY.split("-").reverse().join("/");
    if(userNameLabel) userNameLabel.textContent = currentUser().name;

    // ensure at least 1 ticket
    var tickets=db.days[TODAY].tickets;
    if(!tickets.length){
      tickets.push({id: ++db.lastId, name:"BAR", createdAt: nowHM(), lines:[]});
      saveDB(db);
    }
  }

  userSel.addEventListener("change", function(){
    localStorage.setItem(LS_USER, userSel.value);
    ensureDay(); renderAll();
  });

  userAdd.addEventListener("click", function(){
    var name=prompt("ÎŒÎ½Î¿Î¼Î± Ï…Ï€Î±Î»Î»Î®Î»Î¿Ï…/Ï‡ÏÎ®ÏƒÏ„Î·:");
    if(!name||!name.trim()) return;
    var id=normalizeId(name);
    if(!id){ alert("Î”ÏÏƒÎµ Î­Î³ÎºÏ…ÏÎ¿ ÏŒÎ½Î¿Î¼Î±."); return; }
    var base=id,n=2;
    while(USERS.some(function(u){return u.id===id;})) id=base+"_"+(n++);
    USERS.push({id:id,name:name.trim()});
    saveUsers(USERS);
    renderUserSelect(); ensureDay(); renderAll();
  });

  userRename.addEventListener("click", function(){
    var cur=currentUser();
    var name=prompt("ÎÎ­Î¿ ÏŒÎ½Î¿Î¼Î±:", cur.name);
    if(!name||!name.trim()) return;
    var idx=USERS.findIndex(function(u){return u.id===cur.id;});
    if(idx<0) return;
    USERS[idx].name=name.trim();
    saveUsers(USERS);
    renderUserSelect(); ensureDay(); renderAll();
  });

  userDelete.addEventListener("click", function(){
    var cur=currentUser();
    if(USERS.length<=1){ alert("Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î­Î½Î±Ï‚ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚."); return; }
    if(!confirm('ÎÎ± Î´Î¹Î±Î³ÏÎ¬ÏˆÏ‰ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· "'+cur.name+'"; (Î”ÎµÎ½ ÏƒÎ²Î®Î½ÎµÎ¹ Ï€Î±Î»Î¹Î­Ï‚ ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚)')) return;
    USERS=USERS.filter(function(u){return u.id!==cur.id;});
    saveUsers(USERS);
    renderUserSelect(); ensureDay(); renderAll();
  });

  // Tickets
  var ticketSel=document.getElementById("ticketSel");
  var btnNewTicket=document.getElementById("btnNewTicket");
  var btnCloseTicket=document.getElementById("btnCloseTicket");
  var activeTicketLabel=document.getElementById("activeTicketLabel");
  var activeTicketDue=document.getElementById("activeTicketDue");
  var ticketListEl=document.getElementById("ticketList");

  var ticketDetailCard=document.getElementById("ticketDetailCard");
  var detailTicketName=document.getElementById("detailTicketName");
  var lineListEl=document.getElementById("lineList");
  var btnBackTickets=document.getElementById("btnBackTickets");

  var viewingTicketId=null;

  function tickets(){ ensureDay(); return db.days[TODAY].tickets; }

  function getActiveTicketId(){
    var key=LS_ACTIVE_TICKET + "__" + TODAY;
    var id=parseInt(localStorage.getItem(key)||"",10);
    if(!id) return tickets()[0].id;
    if(!tickets().some(t=>t.id===id)) return tickets()[0].id;
    return id;
  }
  function setActiveTicketId(id){
    var key=LS_ACTIVE_TICKET + "__" + TODAY;
    localStorage.setItem(key, String(id));
  }
  function activeTicket(){
    var id=getActiveTicketId();
    return tickets().find(t=>t.id===id) || tickets()[0];
  }

  function ticketDue(t){
    var sum=0;
    (t.lines||[]).forEach(l => sum += l.qty_open*l.unit);
    return sum;
  }
  function ticketOpenCount(t){
    var c=0;
    (t.lines||[]).forEach(l => c += l.qty_open);
    return c;
  }

  function renderTicketSelect(){
    var ts=tickets();
    ticketSel.innerHTML="";
    ts.forEach(function(t){
      var opt=document.createElement("option");
      opt.value=String(t.id);
      opt.textContent=t.name + " ("+ticketOpenCount(t)+")";
      ticketSel.appendChild(opt);
    });
    var a=activeTicket();
    ticketSel.value=String(a.id);
  }

  ticketSel.addEventListener("change", function(){
    setActiveTicketId(parseInt(ticketSel.value,10));
    renderAll();
  });

  btnNewTicket.addEventListener("click", function(){
    ensureDay();
    var name=prompt("ÎŒÎ½Î¿Î¼Î± Ticket (Ï€.Ï‡. T12, Î•ÎÎ©3, BAR):");
    if(!name||!name.trim()) return;
    db.days[TODAY].tickets.push({id: ++db.lastId, name:name.trim(), createdAt: nowHM(), lines:[]});
    saveDB(db);
    setActiveTicketId(db.lastId);
    toast("ÎÎ­Î¿ ticket: "+name.trim());
    renderAll();
  });

  btnCloseTicket.addEventListener("click", function(){
    ensureDay();
    var t=activeTicket();
    var due=ticketDue(t);
    if(due>0){
      alert("Î”ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎºÎ»ÎµÎ¯ÏƒÎµÎ¹. ÎˆÏ‡ÎµÎ¹ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ " + euro(due) + ". Î Î»Î®ÏÏ‰ÏƒÎµ Ï€ÏÏÏ„Î± Ï„Î¹Ï‚ Î³ÏÎ±Î¼Î¼Î­Ï‚.");
      return;
    }
    if(!confirm('ÎÎ± ÎºÎ»ÎµÎ¯ÏƒÏ‰ Ï„Î¿ ticket "'+t.name+'";')) return;
    // remove ticket
    db.days[TODAY].tickets = db.days[TODAY].tickets.filter(x=>x.id!==t.id);
    if(!db.days[TODAY].tickets.length){
      db.days[TODAY].tickets.push({id: ++db.lastId, name:"BAR", createdAt: nowHM(), lines:[]});
    }
    saveDB(db);
    setActiveTicketId(db.days[TODAY].tickets[0].id);
    toast("ÎˆÎºÎ»ÎµÎ¹ÏƒÎµ ticket");
    renderAll();
  });

  function renderTicketsList(){
    var ts=tickets().slice().sort((a,b)=>ticketDue(b)-ticketDue(a));
    ticketListEl.innerHTML="";

    var a=activeTicket();
    activeTicketLabel.textContent = a.name;
    activeTicketDue.textContent = euro(ticketDue(a));

    if(!ts.length){
      ticketListEl.innerHTML='<div class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ tickets.</div>';
      return;
    }

    ts.forEach(function(t){
      var div=document.createElement("div");
      div.className="ticket";
      div.innerHTML =
        '<div>' +
          '<div class="ticketName">'+t.name+'</div>' +
          '<div class="ticketMeta">Î‘Î½Î¿Î¹Ï‡Ï„Î¬: '+ticketOpenCount(t)+' â€” Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: '+euro(ticketDue(t))+' â€” Î¬Î½Î¿Î¹Î¾Îµ: '+t.createdAt+'</div>' +
        '</div>' +
        '<div class="ticketBtns">' +
          '<button class="btn primary miniBtn" data-act="open" data-id="'+t.id+'">Î†Î½Î¿Î¹Î³Î¼Î±</button>' +
          '<button class="btn ghost miniBtn" data-act="set" data-id="'+t.id+'">Î•Î½ÎµÏÎ³ÏŒ</button>' +
        '</div>';

      div.querySelectorAll("button").forEach(function(b){
        b.onclick=function(){
          var act=b.getAttribute("data-act");
          var id=parseInt(b.getAttribute("data-id"),10);
          if(act==="set"){ setActiveTicketId(id); toast("Î•Î½ÎµÏÎ³ÏŒ ticket"); renderAll(); return; }
          if(act==="open"){ openTicketDetail(id); return; }
        };
      });

      ticketListEl.appendChild(div);
    });
  }

  function openTicketDetail(id){
    viewingTicketId=id;
    var t=tickets().find(x=>x.id===id);
    if(!t) return;
    detailTicketName.textContent=t.name;
    ticketDetailCard.style.display="block";
    // scroll into view
    ticketDetailCard.scrollIntoView({behavior:"smooth", block:"start"});
    renderTicketLines();
  }
  btnBackTickets.onclick=function(){
    ticketDetailCard.style.display="none";
    viewingTicketId=null;
  };

  function renderTicketLines(){
    if(!viewingTicketId){ lineListEl.innerHTML=""; return; }
    var t=tickets().find(x=>x.id===viewingTicketId);
    if(!t){ lineListEl.innerHTML=""; return; }

    lineListEl.innerHTML="";
    if(!t.lines || !t.lines.length){
      lineListEl.innerHTML='<div class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± ÏƒÎµ Î±Ï…Ï„ÏŒ Ï„Î¿ ticket.</div>';
      return;
    }

    t.lines.slice().reverse().forEach(function(l){
      var ex=(l.extras && l.extras.length) ? (" +"+l.extras.join(", ")) : "";
      var payNow=Math.min(l.pay_now||1, l.qty_open);

      var div=document.createElement("div");
      div.className="line";
      div.innerHTML =
        '<div class="lineTop">' +
          '<div>' +
            '<div class="lineName">'+l.qty_open+'x '+l.item+ex+'</div>' +
            '<div class="lineMeta">â± '+l.time+' â€” ÎœÎ¿Î½Î¬Î´Î± '+euro(l.unit)+' â€” Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ '+euro(l.qty_open*l.unit)+'</div>' +
          '</div>' +
        '</div>' +
        '<div class="lineBtns">' +
          '<div class="qtyNow">' +
            '<button class="btn miniBtn" data-act="minus" data-id="'+l.id+'">â€“</button>' +
            '<span class="muted">Î Î»Î·ÏÏ‰Î¼Î® Ï„ÏÏÎ±:</span> <b>'+payNow+'</b>' +
            '<button class="btn miniBtn" data-act="plus" data-id="'+l.id+'">+</button>' +
          '</div>' +
          '<button class="btn ok miniBtn" data-act="cash" data-id="'+l.id+'">ğŸ’¶ Î Î»Î®ÏÏ‰ÏƒÎµ</button>' +
          '<button class="btn primary miniBtn" data-act="card" data-id="'+l.id+'">ğŸ’³ Î Î»Î®ÏÏ‰ÏƒÎµ</button>' +
          '<button class="btn warn miniBtn" data-act="gift" data-id="'+l.id+'">ğŸ Î Î»Î®ÏÏ‰ÏƒÎµ</button>' +
          '<button class="btn bad miniBtn" data-act="cancel1" data-id="'+l.id+'">ğŸ—‘ Î‘ÎºÏÏÏ‰ÏƒÎ· 1</button>' +
          '<button class="btn bad miniBtn" data-act="cancelAll" data-id="'+l.id+'">ğŸ—‘ Î‘ÎºÏÏÏ‰ÏƒÎ· ÏŒÎ»Î±</button>' +
        '</div>';

      div.querySelectorAll("button").forEach(function(b){
        b.onclick=function(){
          var act=b.getAttribute("data-act");
          var lid=parseInt(b.getAttribute("data-id"),10);
          if(act==="minus") return adjustLinePayNow(t.id, lid, -1);
          if(act==="plus") return adjustLinePayNow(t.id, lid, +1);
          if(act==="cancel1") return cancelLineQty(t.id, lid, 1);
          if(act==="cancelAll") return cancelLineQty(t.id, lid, 9999);
          payLinePartial(t.id, lid, act);
        };
      });

      lineListEl.appendChild(div);
    });
  }

  function findLine(ticketId, lineId){
    ensureDay();
    var t=tickets().find(x=>x.id===ticketId);
    if(!t) return {t:null, idx:-1, line:null};
    var idx=t.lines.findIndex(x=>x.id===lineId);
    return {t:t, idx:idx, line: idx>=0?t.lines[idx]:null};
  }

  function adjustLinePayNow(ticketId, lineId, delta){
    var f=findLine(ticketId, lineId);
    if(!f.line) return;
    var l=f.line;
    var cur=l.pay_now||1;
    cur+=delta;
    cur=Math.max(1, Math.min(cur, l.qty_open));
    l.pay_now=cur;
    saveDB(db);
    renderAll();
  }

  function cancelLineQty(ticketId, lineId, qty){
    var f=findLine(ticketId, lineId);
    if(!f.line) return;
    var l=f.line;
    var q=Math.min(qty, l.qty_open);
    l.qty_open -= q;
    l.pay_now = Math.max(1, Math.min(l.pay_now||1, l.qty_open||1));
    if(l.qty_open<=0){
      f.t.lines.splice(f.idx,1);
    }
    saveDB(db);
    toast(qty>=9999 ? "Î‘ÎºÏ…ÏÏÎ¸Î·ÎºÎµ Î³ÏÎ±Î¼Î¼Î®" : ("Î‘ÎºÏ…ÏÏÎ¸Î·ÎºÎ±Î½ "+q+" Ï„ÎµÎ¼."));
    renderAll();
  }

  function payLinePartial(ticketId, lineId, method){
    var f=findLine(ticketId, lineId);
    if(!f.line) return;
    var l=f.line;
    var q=Math.min(l.pay_now||1, l.qty_open);
    if(q<=0) return;

    l.qty_open -= q;
    l.pay_now = Math.max(1, Math.min(l.pay_now||1, l.qty_open||1));

    var paidEntry={
      id: ++db.lastId,
      ticketId: ticketId,
      ticketName: (f.t && f.t.name) || "",
      date: BASE_TODAY,
      openTime: l.time,
      paidTime: nowHM(),
      category: l.category,
      item: l.item,
      qty_paid: q,
      extras: l.extras,
      unit: l.unit,
      total: q*l.unit,
      method: method
    };
    db.days[TODAY].paid.push(paidEntry);

    if(l.qty_open<=0){
      f.t.lines.splice(f.idx,1);
    }

    saveDB(db);
    toast("Î Î»Î·ÏÏÎ¸Î·ÎºÎ±Î½ "+q+" Ï„ÎµÎ¼.");
    renderAll();
  }

  // Add to ticket (merge same lines in the same ticket)
  function mergeLine(t, item, unit, extras){
    var exKey=(extras||[]).join("|");
    return (t.lines||[]).find(function(l){
      return l.item===item && Math.abs(l.unit-unit)<0.0001 && (l.extras||[]).join("|")===exKey;
    });
  }

  // Categories / Products
  var catsEl=document.getElementById("cats");
  var productsEl=document.getElementById("products");
  var catTitle=document.getElementById("catTitle");
  var searchEl=document.getElementById("search");
  var activeCat=MENU[0].cat;

  function buildCats(){
    catsEl.innerHTML="";
    MENU.forEach(function(section){
      var b=document.createElement("button");
      b.className="btn cat"+(section.cat===activeCat?" active":"");
      b.textContent=section.cat;
      b.onclick=function(){ activeCat=section.cat; buildCats(); buildProducts(); };
      catsEl.appendChild(b);
    });
  }

  function buildProducts(){
    var q=(searchEl.value||"").trim().toLowerCase();
    productsEl.innerHTML="";
    var section=MENU.find(function(s){return s.cat===activeCat;});
    catTitle.textContent=activeCat;

    var items=section.items.map(function(it){return {name:it[0],price:it[1],cat:section.cat};});
    if(q) items=items.filter(function(x){return x.name.toLowerCase().indexOf(q)>=0;});

    items.forEach(function(item){
      var div=document.createElement("div");
      div.className="prod";
      div.innerHTML=
        '<div><div class="title">'+item.name+'</div><small>'+item.cat+'</small></div>'+
        '<div class="price">'+euro(item.price)+'</div>';
      div.onclick=function(){ openModal(item); };
      productsEl.appendChild(div);
    });
  }
  searchEl.addEventListener("input", buildProducts);

  // Product modal
  var modalWrap=document.getElementById("modalWrap");
  var mTitle=document.getElementById("mTitle");
  var mPrice=document.getElementById("mPrice");
  var mFinal=document.getElementById("mFinal");
  var qtyValEl=document.getElementById("qtyVal");
  var xDecaf=document.getElementById("xDecaf");
  var xPlant=document.getElementById("xPlant");
  var addToTicketBtn=document.getElementById("addToTicket");
  var currentItem=null;
  var qty=1;

  function calcFinal(base){
    var extra=0;
    if(xDecaf.checked) extra+=EXTRAS.decaf.price;
    if(xPlant.checked) extra+=EXTRAS.plant.price;
    return (base+extra)*qty;
  }

  function openModal(item){
    currentItem=item;
    qty=1;
    xDecaf.checked=false;
    xPlant.checked=false;
    mTitle.textContent=item.name;
    mPrice.textContent="Î¤Î¹Î¼Î®: "+euro(item.price)+" (Î²Î¬ÏƒÎ·)";
    qtyValEl.textContent=String(qty);
    mFinal.textContent=euro(calcFinal(item.price));
    modalWrap.style.display="flex";
  }
  function closeModal(){ modalWrap.style.display="none"; currentItem=null; }
  document.getElementById("mClose").onclick=closeModal;
  modalWrap.addEventListener("click", function(e){ if(e.target===modalWrap) closeModal(); });

  document.getElementById("qtyMinus").onclick=function(){
    qty=Math.max(1, qty-1);
    qtyValEl.textContent=String(qty);
    mFinal.textContent=euro(calcFinal(currentItem.price));
  };
  document.getElementById("qtyPlus").onclick=function(){
    qty=qty+1;
    qtyValEl.textContent=String(qty);
    mFinal.textContent=euro(calcFinal(currentItem.price));
  };
  xDecaf.onchange=function(){ if(currentItem) mFinal.textContent=euro(calcFinal(currentItem.price)); };
  xPlant.onchange=function(){ if(currentItem) mFinal.textContent=euro(calcFinal(currentItem.price)); };

  addToTicketBtn.onclick=function(){
    ensureDay();
    var t=activeTicket();
    var extras=[], extraTotal=0;
    if(xDecaf.checked){ extras.push(EXTRAS.decaf.name); extraTotal+=EXTRAS.decaf.price; }
    if(xPlant.checked){ extras.push(EXTRAS.plant.name); extraTotal+=EXTRAS.plant.price; }
    var unit=currentItem.price + extraTotal;

    var existing = mergeLine(t, currentItem.name, unit, extras);
    if(existing){
      existing.qty_open += qty;
      existing.pay_now = Math.max(1, Math.min(existing.pay_now||1, existing.qty_open));
    }else{
      t.lines.push({
        id: ++db.lastId,
        category: currentItem.cat,
        item: currentItem.name,
        extras: extras,
        unit: unit,
        qty_open: qty,
        pay_now: 1,
        time: nowHM()
      });
    }
    saveDB(db);
    toast("ÎœÏ€Î®ÎºÎµ ÏƒÏ„Î¿ "+t.name);
    closeModal();
    renderAll();
  };

  // Paid summary
  var sumTotalEl=document.getElementById("sumTotal");
  var sumCashEl=document.getElementById("sumCash");
  var sumCardEl=document.getElementById("sumCard");
  var sumGiftEl=document.getElementById("sumGift");
  var lastListEl=document.getElementById("lastList");

  function computePaid(){
    ensureDay();
    var paid=db.days[TODAY].paid || [];
    var cash=0, card=0, gift=0;
    paid.forEach(function(e){
      if(e.method==="cash") cash+=e.total;
      else if(e.method==="card") card+=e.total;
      else if(e.method==="gift") gift+=e.total;
    });
    return {paid:paid, cash:cash, card:card, gift:gift, total:(cash+card)};
  }

  function renderPaidSummary(){
    var c=computePaid();
    sumTotalEl.textContent=euro(c.total);
    sumCashEl.textContent=euro(c.cash);
    sumCardEl.textContent=euro(c.card);
    sumGiftEl.textContent=euro(c.gift);

    lastListEl.innerHTML="";
    var last=c.paid.slice(-6).reverse();
    if(!last.length){
      lastListEl.innerHTML='<div class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï€Î»Î·ÏÏ‰Î¼Î® Î±ÎºÏŒÎ¼Î±.</div>';
      return;
    }
    last.forEach(function(e){
      var m=e.method==="cash"?"ğŸ’¶":(e.method==="card"?"ğŸ’³":"ğŸ");
      var ex=(e.extras && e.extras.length) ? (" +"+e.extras.join(", ")) : "";
      var line=document.createElement("div");
      line.textContent=m+" "+e.paidTime+" â€” "+e.ticketName+" â€” "+e.qty_paid+"x "+e.item+ex+" = "+euro(e.total);
      lastListEl.appendChild(line);
    });
  }

  // Undo: remove last paid, restore to that ticket (merge)
  document.getElementById("btnUndo").onclick=function(){
    ensureDay();
    var paid=db.days[TODAY].paid;
    if(!paid.length){ toast("Î¤Î¯Ï€Î¿Ï„Î± Î³Î¹Î± Î±Î½Î±Î¯ÏÎµÏƒÎ·"); return; }
    var last=paid.pop();

    var t=tickets().find(x=>x.id===last.ticketId);
    if(!t){
      // if ticket no longer exists, create it back
      db.days[TODAY].tickets.push({id:last.ticketId, name:last.ticketName||("T"+last.ticketId), createdAt: nowHM(), lines:[]});
      t=tickets().find(x=>x.id===last.ticketId);
    }
    var existing = mergeLine(t, last.item, last.unit, last.extras||[]);
    if(existing){
      existing.qty_open += last.qty_paid;
      existing.pay_now = Math.max(1, Math.min(existing.pay_now||1, existing.qty_open));
    }else{
      t.lines.push({
        id: ++db.lastId,
        category: last.category,
        item: last.item,
        extras: last.extras||[],
        unit: last.unit,
        qty_open: last.qty_paid,
        pay_now: 1,
        time: nowHM()
      });
    }

    saveDB(db);
    toast("Î‘Î½Î±Î¹ÏÎ­Î¸Î·ÎºÎµ Ï€Î»Î·ÏÏ‰Î¼Î®");
    renderAll();
  };

  // Repeat last paid: add as open to active ticket
  document.getElementById("btnRepeat").onclick=function(){
    ensureDay();
    var paid=db.days[TODAY].paid;
    if(!paid.length){ toast("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± Ï€Î»Î·ÏÏ‰Î¼Î®"); return; }
    var last=paid[paid.length-1];
    var t=activeTicket();

    var existing = mergeLine(t, last.item, last.unit, last.extras||[]);
    if(existing){
      existing.qty_open += last.qty_paid;
      existing.pay_now = Math.max(1, Math.min(existing.pay_now||1, existing.qty_open));
    }else{
      t.lines.push({
        id: ++db.lastId,
        category: last.category,
        item: last.item,
        extras: last.extras||[],
        unit: last.unit,
        qty_open: last.qty_paid,
        pay_now: 1,
        time: nowHM()
      });
    }
    saveDB(db);
    toast("Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ "+t.name);
    renderAll();
  };

  // CSV
  document.getElementById("btnCSV").onclick=function(){
    ensureDay();
    var rows=[];
    // open
    tickets().forEach(function(t){
      (t.lines||[]).forEach(function(l){
        rows.push({
          status:"open",
          ticketId:t.id, ticketName:t.name,
          date: BASE_TODAY,
          openTime:l.time,
          paidTime:"",
          category:l.category,
          item:l.item,
          qty:l.qty_open,
          extras:(l.extras||[]).join(" | "),
          unit:l.unit.toFixed(2),
          total:(l.qty_open*l.unit).toFixed(2),
          method:""
        });
      });
    });
    // paid
    (db.days[TODAY].paid||[]).forEach(function(p){
      rows.push({
        status:"paid",
        ticketId:p.ticketId, ticketName:p.ticketName,
        date: p.date,
        openTime:p.openTime,
        paidTime:p.paidTime,
        category:p.category,
        item:p.item,
        qty:p.qty_paid,
        extras:(p.extras||[]).join(" | "),
        unit:p.unit.toFixed(2),
        total:p.total.toFixed(2),
        method:p.method
      });
    });

    if(!rows.length){ toast("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚"); return; }

    var header=["user","date","status","ticketId","ticketName","openTime","paidTime","category","item","qty","extras","unit","total","method"];
    var lines=[header.join(",")];
    rows.forEach(function(r){
      lines.push([
        currentUser().name,
        r.date, r.status, r.ticketId, r.ticketName, r.openTime, r.paidTime,
        r.category, r.item, r.qty, r.extras, r.unit, r.total, r.method
      ].map(escapeCSV).join(","));
    });

    var blob=new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    var a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="taMeio_"+BASE_TODAY+"_"+normalizeId(currentUser().name)+".csv";
    a.click();
    URL.revokeObjectURL(a.href);
    toast("ÎšÎ±Ï„Î­Î²Î·ÎºÎµ CSV");
  };

  // Reset day
  document.getElementById("btnResetDay").onclick=function(){
    ensureDay();
    var uname=currentUser().name;
    if(!confirm('Î˜ÎµÏ‚ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î½Î± ÎºÎ±Î¸Î±ÏÎ¯ÏƒÎµÎ¹Ï‚ ÎœÎŸÎÎŸ Ï„Î· ÏƒÎ·Î¼ÎµÏÎ¹Î½Î® Î·Î¼Î­ÏÎ± Î³Î¹Î± Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· "'+uname+'";')) return;
    db.days[TODAY]={tickets:[{id: ++db.lastId, name:"BAR", createdAt: nowHM(), lines:[]}], paid:[]};
    saveDB(db);
    setActiveTicketId(db.days[TODAY].tickets[0].id);
    toast("ÎšÎ±Î¸Î±ÏÎ¯ÏƒÏ„Î·ÎºÎµ Î· Î·Î¼Î­ÏÎ±");
    renderAll();
  };

  // Wipe all
  document.getElementById("btnWipeAll").onclick=function(){
    if(!confirm("Î Î¡ÎŸÎ£ÎŸÎ§Î—: Î˜Î± Î´Î¹Î±Î³ÏÎ±Ï†Î¿ÏÎ½ ÎŸÎ›Î‘ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î±Ï€ÏŒ Ï„Î· ÏƒÏ…ÏƒÎºÎµÏ…Î®. Î£Ï…Î½Î­Ï‡ÎµÎ¹Î±;")) return;
    localStorage.removeItem(LS_KEY);
    localStorage.removeItem(LS_USERS);
    localStorage.removeItem(LS_USER);
    localStorage.removeItem(LS_ACTIVE_TICKET+"__"+TODAY);
    location.reload();
  };

  // Close day report
  document.getElementById("btnClose").onclick=function(){
    ensureDay();
    var paid=computePaid();

    var openCount=0, openSum=0;
    tickets().forEach(function(t){
      (t.lines||[]).forEach(function(l){
        openCount += l.qty_open;
        openSum += l.qty_open*l.unit;
      });
    });

    var wrap=document.createElement("div");
    wrap.className="modalWrap";
    wrap.style.display="flex";

    var modal=document.createElement("div");
    modal.className="modal";
    modal.innerHTML=
      '<div class="row" style="align-items:flex-start;">'+
        '<div><h2>ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Î—Î¼Î­ÏÎ±Ï‚ â€“ '+BASE_TODAY.split("-").reverse().join("/")+'</h2>'+
        '<div class="muted">Î§ÏÎ®ÏƒÏ„Î·Ï‚: <b>'+currentUser().name+'</b></div></div>'+
        '<button class="btn" id="rClose">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>'+
      '</div>'+
      '<div class="divider"></div>'+
      '<div style="display:grid; gap:6px;">'+
        '<div class="row"><span>Î£ÏÎ½Î¿Î»Î¿ (cash+card)</span><b>'+euro(paid.total)+'</b></div>'+
        '<div class="row"><span>ÎœÎµÏ„ÏÎ·Ï„Î¬</span><b>'+euro(paid.cash)+'</b></div>'+
        '<div class="row"><span>ÎšÎ¬ÏÏ„Î±</span><b>'+euro(paid.card)+'</b></div>'+
        '<div class="row"><span>ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±</span><b>'+euro(paid.gift)+'</b></div>'+
        '<div class="row"><span>Î‘Î½Î¿Î¹Ï‡Ï„Î¬ (Ï„ÎµÎ¼Î¬Ï‡Î¹Î±)</span><b>'+openCount+'</b></div>'+
        '<div class="row"><span>Î‘Î½Î¿Î¹Ï‡Ï„Î¬ (Î±Î¾Î¯Î±)</span><b>'+euro(openSum)+'</b></div>'+
      '</div>'+
      '<div class="divider"></div>'+
      '<button class="btn primary" id="rCSV" style="width:100%;">Î›Î®ÏˆÎ· CSV (open+paid)</button>';

    wrap.appendChild(modal);
    document.body.appendChild(wrap);

    modal.querySelector("#rClose").onclick=function(){ wrap.remove(); };
    wrap.addEventListener("click", function(e){ if(e.target===wrap) wrap.remove(); });
    modal.querySelector("#rCSV").onclick=function(){ document.getElementById("btnCSV").click(); };
  };

  function renderAll(){
    ensureDay();
    renderUserSelect();
    renderTicketSelect();
    renderTicketsList();
    if(viewingTicketId) renderTicketLines();
    buildCats();
    buildProducts();
    renderPaidSummary();
  }

  // INIT
  renderUserSelect();
  ensureDay();
  renderAll();

})();
</script>

</body>
</html>
