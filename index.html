<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#0b0f14"/>
  <title>Daily Cashier</title>

  <style>
    :root{
      --bg:#0b0f14;
      --text:#e9eef7;
      --muted:#9fb0c7;
      --line:rgba(255,255,255,.10);
      --accent:#3aa2ff;
      --ok:#24d18d;
      --warn:#ffb020;
      --danger:#ff5b6e;
      --tap:44px;
      --r:20px;
    }
    html, body{ width:100%; max-width:100%; overflow-x:hidden; height:100%; }
    *{ box-sizing:border-box; min-width:0; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-font-smoothing:antialiased;
      overflow-x:hidden;
      position:relative;
      min-height:100%;
    }
    body::before{
      content:"";
      position:fixed; inset:0; z-index:-1;
      background:
        radial-gradient(900px 560px at 50% -10%, rgba(58,162,255,.18), transparent 60%),
        radial-gradient(700px 460px at 18% 16%, rgba(36,209,141,.10), transparent 62%),
        radial-gradient(780px 520px at 82% 26%, rgba(255,176,32,.06), transparent 62%);
      pointer-events:none;
    }

    button,input,select{ font:inherit; color:inherit; max-width:100%; }
    button{ touch-action:manipulation; }

    /* âœ… FULL WIDTH: no max-width on mobile */
    .wrap{
      width:100%;
      max-width:100%;
      margin:0;
      padding:10px 10px 120px;
      overflow-x:hidden;
    }
    /* âœ… On larger screens, keep it pleasant */
    @media(min-width:900px){
      .wrap{ max-width:900px; margin:0 auto; padding:14px 14px 120px; }
    }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .between{ justify-content:space-between; }
    .title{ font-size:22px; font-weight:900; line-height:1.1; }
    .sub{ color:var(--muted); font-size:13px; line-height:1.25; margin-top:4px; }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:12px;
      box-shadow:0 18px 60px rgba(0,0,0,.40);
      width:100%;
      overflow:hidden;
    }
    .card2{
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      width:100%;
      overflow:hidden;
    }

    .pill{
      height:var(--tap);
      border-radius:999px;
      padding:0 16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      display:inline-flex; align-items:center; justify-content:center;
      cursor:pointer; user-select:none;
      transition:.15s transform,.15s border-color;
      line-height:1.15;
      max-width:100%;
      text-align:center;
      white-space:nowrap;
    }
    .pill:hover{ transform:translateY(-1px); border-color:rgba(58,162,255,.35); }
    .pill:active{ transform:none; }
    .pill.primary{ border-color:rgba(58,162,255,.55); box-shadow:0 0 0 3px rgba(58,162,255,.12) inset; }
    .pill.ok{ border-color:rgba(36,209,141,.55); box-shadow:0 0 0 3px rgba(36,209,141,.10) inset; }
    .pill.warn{ border-color:rgba(255,176,32,.55); box-shadow:0 0 0 3px rgba(255,176,32,.10) inset; }
    .pill.bad{ border-color:rgba(255,91,110,.65); box-shadow:0 0 0 3px rgba(255,91,110,.10) inset; }
    .pill.small{ height:36px; padding:0 14px; font-size:14px; }
    .pill.block{ width:100%; }
    .btnIcon{
      width:var(--tap); height:var(--tap);
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      display:grid; place-items:center;
      cursor:pointer;
      max-width:var(--tap);
    }

    .view{ display:none; }
    .view.show{ display:block; }

    .bigBtn{
      height:68px;
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      cursor:pointer;
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      font-weight:900;
    }
    .bigBtn .meta{ color:var(--muted); font-weight:800; font-size:13px; }

    .list{ display:flex; flex-direction:column; gap:10px; width:100%; }
    .listItem{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:16px;
      padding:12px;
      display:flex; align-items:center; justify-content:space-between;
      cursor:pointer;
      gap:10px;
    }
    .listItem .n{ font-weight:900; }
    .listItem .m{ color:var(--muted); font-size:13px; margin-top:4px; }

    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:22px; height:22px; padding:0 7px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      font-size:12px; font-weight:900;
    }

    .ticketHeader{
      position:sticky; top:0;
      z-index:50;
      padding:10px 0;
      background:rgba(11,15,20,.86);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }

    .lines{ display:flex; flex-direction:column; gap:10px; }
    .lines.scrollBox{
      max-height:280px;
      overflow:auto;
      padding-right:2px;
    }

    /* âœ… tighter line layout (more space for name) */
    .line{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:16px;
      padding:10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    .lineLeft .n{ font-weight:900; line-height:1.2; }
    .lineLeft .m{ color:var(--muted); font-size:12.5px; margin-top:6px; line-height:1.25; }
    .lineRight{
      display:flex; gap:8px; align-items:center;
    }

    /* âœ… smaller +/- and icons */
    .qtyBox{
      display:flex; align-items:center; gap:6px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:4px;
      background:rgba(255,255,255,.02);
      flex:0 0 auto;
    }
    .qbtn{
      width:30px; height:30px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      cursor:pointer;
      display:grid; place-items:center;
      font-weight:900;
      font-size:16px;
    }
    .qval{
      min-width:24px;
      text-align:center;
      font-weight:900;
      font-size:14px;
    }

    .payIcons{ display:flex; align-items:center; gap:6px; flex:0 0 auto; }
    .picon{
      width:30px; height:30px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      cursor:pointer;
      display:grid; place-items:center;
      font-weight:900;
      font-size:15px;
    }
    .picon.ok{ border-color:rgba(36,209,141,.55); }
    .picon.primary{ border-color:rgba(58,162,255,.55); }
    .picon.warn{ border-color:rgba(255,176,32,.55); }

    .quickGrid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
      width:100%;
    }
    @media(min-width:520px){ .quickGrid{ grid-template-columns:repeat(4,minmax(0,1fr)); } }
    .qCard{
      height:62px;
      border-radius:18px;
      padding:10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      cursor:pointer;
      display:flex; flex-direction:column; justify-content:center; align-items:flex-start;
      overflow:hidden;
      font-weight:900;
      text-align:left;
      line-height:1.2;
      position:relative;
    }
    .qCard .price{ color:var(--muted); font-size:13px; font-weight:800; margin-top:6px; }

    .catRow{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
      width:100%;
    }
    @media(min-width:520px){ .catRow{ grid-template-columns:repeat(4,minmax(0,1fr)); } }
    .catBtn{
      height:46px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      display:flex; align-items:center; justify-content:center;
      padding:0 10px;
      text-align:center;
      line-height:1.1;
    }
    .catBtn.active{
      border-color:rgba(58,162,255,.55);
      box-shadow:0 0 0 3px rgba(58,162,255,.12) inset;
    }

    /* âœ… products: add +/- inside tile */
    .prodGrid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
      width:100%;
    }
    @media(min-width:520px){ .prodGrid{ grid-template-columns:repeat(3,minmax(0,1fr)); } }
    .pTile{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:18px;
      padding:10px;
      position:relative;
      overflow:hidden;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px;
      align-items:center;
      min-height:74px;
    }
    .pName{ font-weight:900; line-height:1.2; }
    .pPrice{ color:var(--muted); font-size:13px; font-weight:800; margin-top:6px; }
    .pCtrls{ display:flex; flex-direction:column; gap:6px; align-items:center; }
    .pSmall{
      width:30px;height:30px;border-radius:999px;
      border:1px solid var(--line); background:rgba(255,255,255,.03);
      display:grid; place-items:center; cursor:pointer;
      font-weight:900; font-size:16px;
    }
    .pQty{
      font-weight:900; font-size:13px;
      min-width:26px; text-align:center;
      color:var(--text);
      opacity:.9;
    }
    .pAddTap{
      position:absolute; inset:0;
      background:transparent;
      border:none;
      cursor:pointer;
    }
    .pAddTap:active{ background:rgba(255,255,255,.03); }

    .bottom{
      position:fixed; left:0; right:0; bottom:0;
      width:100%;
      max-width:100%;
      padding:10px 10px calc(10px + env(safe-area-inset-bottom));
      background:linear-gradient(180deg, transparent, rgba(11,15,20,.70) 25%, rgba(11,15,20,.94));
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(255,255,255,.06);
      z-index:900;
      overflow:hidden;
    }
    .bottom .inner{
      width:100%;
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px;
    }
    @media(min-width:900px){
      .bottom .inner{ max-width:900px; margin:0 auto; }
    }

    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(4px);
      display:none;
      z-index:2000;
      padding:18px 10px;
      overflow:hidden;
    }
    .overlay.show{ display:flex; align-items:flex-end; justify-content:center; }
    .sheet{
      width:calc(100vw - 20px);
      max-width:900px;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(15,20,29,.92);
      box-shadow:0 30px 120px rgba(0,0,0,.65);
      padding:14px;
      max-height:85vh;
      overflow:auto;
    }
    .sheetHead{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; padding-bottom:10px; }
    .hr{ height:1px; background:var(--line); margin:12px 0; }
    .muted{ color:var(--muted); }

    .payLine{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px; border-radius:14px; border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      cursor:pointer;
    }
    .payLine input{ width:20px; height:20px; accent-color:var(--accent); flex:0 0 auto; }
    .payLine .left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .payLine .t{ font-weight:900; line-height:1.15; word-break:break-word; }
    .payLine .s{ color:var(--muted); font-size:13px; margin-top:4px; line-height:1.2; }
    .payLine .right{ font-weight:900; flex:0 0 auto; }

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:calc(86px + env(safe-area-inset-bottom));
      background:rgba(20,28,40,.92);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:10px 14px;
      box-shadow:0 18px 60px rgba(0,0,0,.45);
      z-index:4000;
      display:none;
      max-width:calc(100vw - 20px);
    }
    .toast.show{ display:block; }
    .toast .t{ font-weight:900; }
    .toast .s{ color:var(--muted); font-size:13px; margin-top:4px; line-height:1.2; }

    .tinyTable{ width:100%; border-collapse:separate; border-spacing:0 8px; }
    .tinyTable td{
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      padding:10px 10px;
      border-radius:14px;
      vertical-align:top;
      font-size:13px;
      line-height:1.25;
      overflow:hidden;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="row between">
      <div>
        <div class="title" id="shopName">â€”</div>
        <div class="sub" id="todayText">â€”</div>
      </div>
      <div class="row" style="gap:8px;">
        <button class="btnIcon" id="btnSummaryTop" title="Î£ÏÎ½Î¿ÏˆÎ·">ğŸ“Š</button>
        <button class="btnIcon" id="btnSettings" title="Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚">âš™</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <!-- HOME -->
      <div id="viewHome" class="view show">
        <div class="card2">
          <div class="row between" style="gap:10px;">
            <select id="userSelect" class="pill" style="flex:1; min-width:180px;"></select>
            <button class="pill small" id="btnUndo">â†© Undo</button>
          </div>
          <div class="sub" id="homeStats" style="margin-top:10px;">â€”</div>
        </div>

        <button class="bigBtn" id="btnNewOrder" style="margin-top:12px;">
          <span>â• ÎÎ­Î± Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±</span>
          <span class="meta">Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï„ÏÎ±Ï€Î­Î¶Î¹</span>
        </button>

        <button class="bigBtn" id="btnOpenOrders" style="margin-top:12px;">
          <span>ğŸ“„ Î‘Î½Î¿Î¹Ï‡Ï„Î­Ï‚ Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯ÎµÏ‚</span>
          <span class="meta" id="openOrdersCount">0</span>
        </button>

        <button class="bigBtn" id="btnSummary2" style="margin-top:12px;">
          <span>ğŸ“Š Î£ÏÎ½Î¿ÏˆÎ· / Export</span>
          <span class="meta">Î—Î¼Î­ÏÎ±Ï‚</span>
        </button>

        <div class="sub muted" style="margin-top:12px;">
          Î¡Î¿Î®: <b>Home â†’ Ticket â†’ Î Î»Î·ÏÏ‰Î¼Î® â†’ Home</b>
        </div>
      </div>

      <!-- TABLE PICKER -->
      <div id="viewTables" class="view">
        <div class="row between">
          <button class="pill small" id="btnBackHome1">â† Home</button>
          <div class="row" style="gap:8px;">
            <button class="pill small" id="btnShowAll">ÎŒÎ»Î±</button>
            <button class="pill small primary" id="btnShowOpen">Î‘Î½Î¿Î¹Ï‡Ï„Î¬</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="card2">
          <div style="font-weight:900;">Î•Ï€Î¹Î»Î¿Î³Î® Ï„ÏÎ±Ï€ÎµÎ¶Î¹Î¿Ï</div>
          <div class="sub muted">Î›Î¯ÏƒÏ„Î± Î³Î¹Î± Ï„Î±Ï‡ÏÏ„Î·Ï„Î±.</div>
        </div>

        <div style="height:10px;"></div>

        <div class="card2">
          <div class="row between">
            <div>
              <div style="font-weight:900;">Î¤ÏÎ±Ï€Î­Î¶Î¹Î±</div>
              <div class="sub muted" id="tablesHint">â€”</div>
            </div>
            <button class="pill small" id="btnSearchOpen">ğŸ” Î•ÏÏÎµÏƒÎ·</button>
          </div>
          <div style="height:10px;"></div>
          <div id="tableList" class="list"></div>
          <div class="sub" id="tablesEmpty" style="display:none;margin-top:10px;">â€” Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î½Î¿Î¹Ï‡Ï„Î¬.</div>
        </div>
      </div>

      <!-- TICKET -->
      <div id="viewTicket" class="view">
        <div class="ticketHeader">
          <div class="row between">
            <button class="pill small" id="btnBackHome2">â† Home</button>
            <div class="row" style="gap:8px;">
              <button class="pill small" id="btnNote">âœï¸ Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·</button>
              <button class="pill small" id="btnSearch">ğŸ” Search</button>
              <button class="pill warn small" id="btnPay">Î Î»Î·ÏÏ‰Î¼Î®</button>
            </div>
          </div>
          <div class="sub" id="ticketInfo">â€”</div>
        </div>

        <div class="card2" style="margin-top:12px;">
          <div class="row between">
            <div>
              <div style="font-weight:900;">Î‘Î½Î¿Î¹Ï‡Ï„Î¬ items</div>
              <div class="sub muted">ÎŸÎ¼Î±Î´Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î± Î¼Îµ Ï€Î¿ÏƒÏŒÏ„Î·Ï„Î± (+/âˆ’) & Î³ÏÎ®Î³Î¿ÏÎ· Ï€Î»Î·ÏÏ‰Î¼Î®.</div>
            </div>
            <div class="pill small" id="ticketTotalPill">Î£ÏÎ½Î¿Î»Î¿: 0,00 â‚¬</div>
          </div>
          <div style="height:10px;"></div>
          <div id="ticketLines" class="lines scrollBox"></div>
        </div>

        <div class="card2" style="margin-top:12px;">
          <div class="row between">
            <div>
              <div style="font-weight:900;">Î“ÏÎ®Î³Î¿ÏÎ± (Top 8 ÏƒÎ®Î¼ÎµÏÎ±)</div>
              <div class="sub muted">Tap Î³Î¹Î± +1</div>
            </div>
            <button class="pill small" id="btnClearQuick">Reset</button>
          </div>
          <div style="height:10px;"></div>
          <div id="quickGrid" class="quickGrid"></div>
        </div>

        <div class="card2" style="margin-top:12px;">
          <div style="font-weight:900;">ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚</div>
          <div class="sub muted" id="catHint">â€”</div>
          <div style="height:10px;"></div>
          <div class="catRow" id="catRow"></div>

          <div style="height:10px;"></div>
          <div id="prodGrid" class="prodGrid"></div>
        </div>

        <div style="height:140px;"></div>
      </div>
    </div>
  </div>

  <!-- Bottom bar -->
  <div class="bottom" id="bottomBar">
    <div class="inner">
      <button class="pill block" id="btnCSV">Î•Î¾Î±Î³Ï‰Î³Î® CSV</button>
      <button class="pill block" id="btnSummary3">ğŸ“Š Î£ÏÎ½Î¿ÏˆÎ·</button>
      <button class="pill bad block" id="btnWipeAll">Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏŒÎ»Ï‰Î½</button>
    </div>
  </div>

  <!-- Settings -->
  <div class="overlay" id="overlay">
    <div class="sheet">
      <div class="sheetHead">
        <div style="font-weight:900; font-size:18px;">Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</div>
        <button class="pill small" id="btnCloseSheet">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
      </div>

      <div class="card2">
        <div class="row between">
          <div>
            <div class="sub">Î—Î¼Î­ÏÎ±</div>
            <div style="font-weight:900;" id="dayLabel">â€”</div>
          </div>
          <div>
            <div class="sub">Î§ÏÎ®ÏƒÏ„Î·Ï‚</div>
            <div style="font-weight:900;" id="userLabel">â€”</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row" style="gap:8px;flex-wrap:wrap;">
          <button class="pill small" id="btnAddUser">+ Î§ÏÎ®ÏƒÏ„Î·Ï‚</button>
          <button class="pill small" id="btnRenameUser">âœ ÎœÎµÏ„Î¿Î½Î¿Î¼Î±ÏƒÎ¯Î±</button>
          <button class="pill small" id="btnSetPin">ğŸ”’ PIN</button>
          <button class="pill small" id="btnAdminShop">ğŸ· ÎŒÎ½Î¿Î¼Î± Î¼Î±Î³Î±Î¶Î¹Î¿Ï</button>
          <button class="pill small bad" id="btnDeleteUser">ğŸ—‘ Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
        </div>

        <div class="sub muted" style="margin-top:10px;">
          Î¤Î¿ <b>ğŸ· ÎŒÎ½Î¿Î¼Î± Î¼Î±Î³Î±Î¶Î¹Î¿Ï</b> Î±Î»Î»Î¬Î¶ÎµÎ¹ Î¼ÏŒÎ½Î¿ Î¼Îµ <b>Admin PIN</b>.
        </div>
      </div>
    </div>
  </div>

  <!-- Summary -->
  <div class="overlay" id="summaryOverlay">
    <div class="sheet">
      <div class="sheetHead">
        <div style="font-weight:900; font-size:18px;">ğŸ“Š Î£ÏÎ½Î¿ÏˆÎ· Î·Î¼Î­ÏÎ±Ï‚</div>
        <button class="pill small" id="btnCloseSummary">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
      </div>

      <div class="card2">
        <div class="sub" id="daySummaryFull">â€”</div>

        <div class="hr"></div>

        <div style="font-weight:900;">Top 5 Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± ÏƒÎ®Î¼ÎµÏÎ±</div>
        <div class="sub muted">ÎœÎµ Î²Î¬ÏƒÎ· Ï„Î± items Ï€Î¿Ï… ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®Î¸Î·ÎºÎ±Î½ ÏƒÎ®Î¼ÎµÏÎ±.</div>
        <div style="height:8px;"></div>
        <table class="tinyTable" id="topProductsTable"></table>

        <div class="hr"></div>

        <div style="font-weight:900;">Î£ÏÎ½Î¿ÏˆÎ· Î±Î½Î¬ Ï‡ÏÎ®ÏƒÏ„Î·</div>
        <div class="sub muted">Î Î¬Ï„Î± Ï€Î¬Î½Ï‰ ÏƒÎµ Ï‡ÏÎ®ÏƒÏ„Î· Î³Î¹Î± Î±Î½Î±Î»Ï…Ï„Î¹ÎºÎ¬.</div>
        <div style="height:8px;"></div>
        <table class="tinyTable" id="userSummaryTable"></table>
      </div>
    </div>
  </div>

  <!-- User drilldown -->
  <div class="overlay" id="userOverlay">
    <div class="sheet">
      <div class="sheetHead">
        <div>
          <div style="font-weight:900; font-size:18px;" id="userDetailTitle">â€”</div>
          <div class="sub muted" id="userDetailSub">â€”</div>
        </div>
        <button class="pill small" id="btnCloseUserOverlay">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
      </div>
      <div class="card2" id="userDetailBody"></div>
    </div>
  </div>

  <!-- Search -->
  <div class="overlay" id="searchOverlay">
    <div class="sheet">
      <div class="sheetHead">
        <div style="font-weight:900; font-size:18px;">Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î¿Ï‚</div>
        <button class="pill small" id="btnCloseSearch">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
      </div>
      <div class="card2">
        <input id="search" class="pill block" placeholder="Î“ÏÎ¬ÏˆÎµ Ï€.Ï‡. cappuccino..." style="text-align:left;justify-content:flex-start;"/>
        <div style="height:10px;"></div>
        <div id="searchList" class="lines"></div>
      </div>
    </div>
  </div>

  <!-- Pay sheet -->
  <div class="overlay" id="payOverlay">
    <div class="sheet">
      <div class="sheetHead">
        <div>
          <div id="payTitle" style="font-weight:900; font-size:18px;">â€”</div>
          <div class="sub">Split: Î´Î¹Î¬Î»ÎµÎ¾Îµ items ÎºÎ±Î¹ Ï„ÏÏŒÏ€Î¿ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚.</div>
        </div>
        <button class="pill small" id="btnClosePay">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
      </div>

      <div class="card2">
        <div class="row between" style="gap:8px;">
          <button class="pill small" id="btnSelectAll">Î•Ï€Î¯Î»ÎµÎ¾Îµ ÏŒÎ»Î±</button>
          <div class="sub" id="payTotal">Î¤ÎµÎ»Î¹ÎºÏŒ: 0,00 â‚¬</div>
        </div>
        <div style="height:10px;"></div>

        <div id="payList" class="lines"></div>

        <div class="hr"></div>

        <div class="row" style="gap:10px;flex-wrap:wrap;">
          <button class="pill ok" id="btnPayCash">ÎœÎµÏ„ÏÎ·Ï„Î¬</button>
          <button class="pill primary" id="btnPayCard">ÎšÎ¬ÏÏ„Î±</button>
          <button class="pill warn" id="btnPayFree">ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Table search -->
  <div class="overlay" id="tableSearchOverlay">
    <div class="sheet">
      <div class="sheetHead">
        <div style="font-weight:900; font-size:18px;">Î•ÏÏÎµÏƒÎ· Ï„ÏÎ±Ï€ÎµÎ¶Î¹Î¿Ï</div>
        <button class="pill small" id="btnCloseTableSearch">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
      </div>
      <div class="card2">
        <input id="tableSearch" class="pill block" placeholder="Î“ÏÎ¬ÏˆÎµ Ï€.Ï‡. T3 Î® BAR..." style="text-align:left;justify-content:flex-start;"/>
        <div style="height:10px;"></div>
        <div id="tableSearchList" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Quick pay qty -->
  <div class="overlay" id="quickPayOverlay">
    <div class="sheet">
      <div class="sheetHead">
        <div style="font-weight:900; font-size:18px;" id="quickPayTitle">â€”</div>
        <button class="pill small" id="btnCloseQuickPay">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
      </div>
      <div class="card2">
        <div class="sub muted" id="quickPayInfo">â€”</div>
        <div class="hr"></div>
        <div class="row" style="gap:10px;flex-wrap:wrap;" id="quickPayQtyRow"></div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div class="t" id="toastT">â€”</div>
    <div class="s" id="toastS">â€”</div>
  </div>

<script>
/* ===================== STORAGE KEYS ===================== */
const LS_KEY = "mini_cashier_db_v9"; // bump to force fresh storage format
const LS_USERS = "mini_cashier_users_v4";
const LS_ACTIVE_USER = "mini_cashier_active_user_v4";
const LS_FAVS = "mini_cashier_favs_v3";
const LS_SHOP = "mini_cashier_shop_v2";
const LS_ADMIN_HASH = "mini_cashier_admin_hash_v2";

/* ===================== CONFIG ===================== */
const TODAY = new Date().toISOString().slice(0,10);
const tables = ["T1","T2","T3","T4","T5","T6","T7","T8","BAR","Î•ÎÎ©"];
const tableGroups = [
  { title:"Î•ÏƒÏ‰Ï„ÎµÏÎ¹ÎºÎ¬", list:["T1","T2","T3","T4","T5","T6","T7","T8"] },
  { title:"BAR", list:["BAR"] },
  { title:"Î•ÎÎ©", list:["Î•ÎÎ©"] },
];
const CONFIRM_MIN_TOTAL = 15;
const CONFIRM_MIN_ITEMS = 3;
const IDLE_HOME_MS = 35000;

/* ===================== HAPTIC ===================== */
function vibrate(ms){ try{ if(navigator.vibrate) navigator.vibrate(ms);}catch{} }

/* ===================== HELPERS ===================== */
const $ = (id)=>document.getElementById(id);
const fmt = (n)=> (n||0).toLocaleString("el-GR",{minimumFractionDigits:2,maximumFractionDigits:2})+" â‚¬";
const uid = ()=> Math.random().toString(36).slice(2)+Date.now().toString(36);
function load(key, fallback){
  try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
  catch{ return fallback; }
}
function save(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
function toast(title, msg){
  $("toastT").textContent = title;
  $("toastS").textContent = msg;
  $("toast").classList.add("show");
  setTimeout(()=> $("toast").classList.remove("show"), 2200);
}
async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
}
function isValidPin(pin){ return /^\d{4}$/.test(pin); }

/* ===================== AUTO HOME (IDLE) ===================== */
let idleTimer = null;
function closeAllOverlays(){
  ["overlay","summaryOverlay","searchOverlay","payOverlay","tableSearchOverlay","userOverlay","quickPayOverlay"]
    .forEach(id => $(id).classList.remove("show"));
}
function showView(v){
  view=v;
  $("viewHome").classList.toggle("show", v==="home");
  $("viewTables").classList.toggle("show", v==="tables");
  $("viewTicket").classList.toggle("show", v==="ticket");
}
function goHomeFromIdle(){
  closeAllOverlays();
  showView("home");
  renderAll();
}
function resetIdle(){
  if(idleTimer) clearTimeout(idleTimer);
  idleTimer = setTimeout(goHomeFromIdle, IDLE_HOME_MS);
}
["click","touchstart","scroll","keydown","input"].forEach(ev=>{
  document.addEventListener(ev, resetIdle, {capture:true, passive:true});
});
resetIdle();

/* ===================== SHOP NAME (Admin) ===================== */
function getShopName(){
  const s = load(LS_SHOP, null);
  return s?.name || "Î¤Î¿ ÎœÎ±Î³Î±Î¶Î¯";
}
function setShopNameLocal(name){
  save(LS_SHOP, {name});
  $("shopName").textContent = name;
}
async function ensureAdminPin(){
  let h = localStorage.getItem(LS_ADMIN_HASH);
  if(h) return h;
  alert("Î ÏÏÏ„Î· Ï†Î¿ÏÎ¬: ÎŒÏÎ¹ÏƒÎµ Admin PIN (Î¼ÏŒÎ½Î¿ ÎµÏƒÏ).");
  const p1 = prompt("Î’Î¬Î»Îµ Admin PIN (4 ÏˆÎ·Ï†Î¯Î±):");
  if(!p1 || !isValidPin(p1)) { alert("Î†ÎºÏ…ÏÎ¿ PIN."); return null; }
  const p2 = prompt("ÎÎ±Î½Î±Î³ÏÎ¬ÏˆÎµ Ï„Î¿ Admin PIN:");
  if(p2 !== p1) { alert("Î”ÎµÎ½ Ï„Î±Î¹ÏÎ¹Î¬Î¶Î¿Ï…Î½."); return null; }
  h = await sha256Hex(p1);
  localStorage.setItem(LS_ADMIN_HASH, h);
  return h;
}
async function verifyAdminPin(reason){
  const h = localStorage.getItem(LS_ADMIN_HASH) || await ensureAdminPin();
  if(!h) return false;
  const p = prompt(`Admin PIN Î±Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ (${reason}).\nÎ“ÏÎ¬ÏˆÎµ 4-ÏˆÎ®Ï†Î¹Î¿ PIN:`);
  if(!p) return false;
  if(!isValidPin(p)) { alert("Î†ÎºÏ…ÏÎ¿ PIN."); return false; }
  const ph = await sha256Hex(p);
  if(ph !== h){ alert("Î›Î¬Î¸Î¿Ï‚ Admin PIN."); return false; }
  return true;
}

/* ===================== USERS ===================== */
function ensureUsers(){
  let users = load(LS_USERS, null);
  if(!users || !Array.isArray(users) || users.length===0){
    users = [{id:uid(), name:"Î§ÏÎ®ÏƒÏ„Î·Ï‚ 1", pinHash:null}];
    save(LS_USERS, users);
    save(LS_ACTIVE_USER, users[0].id);
  }
  return users;
}
function getActiveUserId(){
  const users = ensureUsers();
  const saved = load(LS_ACTIVE_USER, null);
  if(saved && users.some(u=>u.id===saved)) return saved;
  save(LS_ACTIVE_USER, users[0].id);
  return users[0].id;
}
function getActiveUser(){
  const users = ensureUsers();
  const id = getActiveUserId();
  return users.find(u=>u.id===id) || users[0];
}
async function requireUserPinIfExists(user, reason){
  if(!user.pinHash) return true;
  const pin = prompt(`PIN Î±Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ (${reason}).\nÎ“ÏÎ¬ÏˆÎµ 4-ÏˆÎ®Ï†Î¹Î¿ PIN:`);
  if(!pin) return false;
  if(!isValidPin(pin)) { alert("Î†ÎºÏ…ÏÎ¿ PIN."); return false; }
  const h = await sha256Hex(pin);
  if(h !== user.pinHash){ alert("Î›Î¬Î¸Î¿Ï‚ PIN."); return false; }
  return true;
}
async function changeUserWithPin(newId){
  const users = ensureUsers();
  const newUser = users.find(u=>u.id===newId);
  if(!newUser) return;
  const ok = await requireUserPinIfExists(newUser, "Î‘Î»Î»Î±Î³Î® Ï‡ÏÎ®ÏƒÏ„Î·");
  if(!ok){ $("userSelect").value = getActiveUserId(); return; }
  save(LS_ACTIVE_USER, newUser.id);
  renderAll();
}

/* ===================== MENU ===================== */
const products = [
  {cat:"coffee_hot", group:"â˜• ÎšÎ±Ï†Î­Î´ÎµÏ‚", name:"Espresso Î¼Î¿Î½ÏŒÏ‚", price:2.60},
  {cat:"coffee_hot", group:"â˜• ÎšÎ±Ï†Î­Î´ÎµÏ‚", name:"Espresso Î´Î¹Ï€Î»ÏŒÏ‚", price:3.20},
  {cat:"coffee_hot", group:"â˜• ÎšÎ±Ï†Î­Î´ÎµÏ‚", name:"Espresso macchiato", price:2.90},
  {cat:"coffee_hot", group:"â˜• ÎšÎ±Ï†Î­Î´ÎµÏ‚", name:"Americano", price:3.20},
  {cat:"coffee_hot", group:"â˜• ÎšÎ±Ï†Î­Î´ÎµÏ‚", name:"Cappuccino", price:3.60},
  {cat:"coffee_hot", group:"â˜• ÎšÎ±Ï†Î­Î´ÎµÏ‚", name:"Cappuccino Î´Î¹Ï€Î»ÏŒÏ‚", price:4.20},
  {cat:"coffee_hot", group:"â˜• ÎšÎ±Ï†Î­Î´ÎµÏ‚", name:"Latte macchiato", price:4.20},
  {cat:"coffee_hot", group:"â˜• ÎšÎ±Ï†Î­Î´ÎµÏ‚", name:"Flat white", price:4.40},
  {cat:"coffee_hot", group:"â˜• ÎšÎ±Ï†Î­Î´ÎµÏ‚", name:"Mocha", price:4.50},
  {cat:"coffee_hot", group:"â˜• ÎšÎ±Ï†Î­Î´ÎµÏ‚", name:"ÎšÎ±Ï†Î­Ï‚ Ï†Î¯Î»Ï„ÏÎ¿Ï…", price:3.00},
  {cat:"extras", group:"â• Extras", name:"Decaf (+)", price:0.30},

  {cat:"coffee_cold", group:"â„ï¸ ÎšÏÏÎ¿Î¹ ÎºÎ±Ï†Î­Î´ÎµÏ‚", name:"Freddo espresso", price:3.80},
  {cat:"coffee_cold", group:"â„ï¸ ÎšÏÏÎ¿Î¹ ÎºÎ±Ï†Î­Î´ÎµÏ‚", name:"Freddo cappuccino", price:4.20},
  {cat:"coffee_cold", group:"â„ï¸ ÎšÏÏÎ¿Î¹ ÎºÎ±Ï†Î­Î´ÎµÏ‚", name:"Iced latte", price:4.50},
  {cat:"coffee_cold", group:"â„ï¸ ÎšÏÏÎ¿Î¹ ÎºÎ±Ï†Î­Î´ÎµÏ‚", name:"Cold brew", price:4.80},
  {cat:"coffee_cold", group:"â„ï¸ ÎšÏÏÎ¿Î¹ ÎºÎ±Ï†Î­Î´ÎµÏ‚", name:"Frappe", price:3.50},

  {cat:"tea", group:"ğŸ«– Î¤ÏƒÎ¬Î¹", name:"Î¤ÏƒÎ¬Î¹ (Î¼Î±ÏÏÎ¿, Ï€ÏÎ¬ÏƒÎ¹Î½Î¿, Î²ÏŒÏ„Î±Î½Î±)", price:3.20},
  {cat:"tea", group:"ğŸ«– Î¤ÏƒÎ¬Î¹", name:"Î¤ÏƒÎ¬Î¹ Ï†ÏÎ¿ÏÏ„Ï‰Î½", price:3.50},
  {cat:"tea", group:"ğŸ«– Î¤ÏƒÎ¬Î¹", name:"Chai latte", price:4.30},

  {cat:"choco", group:"ğŸ« Î£Î¿ÎºÎ¿Î»Î¬Ï„ÎµÏ‚", name:"Î–ÎµÏƒÏ„Î® ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:4.20},
  {cat:"choco", group:"ğŸ« Î£Î¿ÎºÎ¿Î»Î¬Ï„ÎµÏ‚", name:"ÎšÏÏÎ± ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:4.50},
  {cat:"choco", group:"ğŸ« Î£Î¿ÎºÎ¿Î»Î¬Ï„ÎµÏ‚", name:"Î›ÎµÏ…ÎºÎ® ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:4.50},
  {cat:"choco", group:"ğŸ« Î£Î¿ÎºÎ¿Î»Î¬Ï„ÎµÏ‚", name:"ÎšÎ±ÎºÎ¬Î¿", price:4.00},
  {cat:"extras", group:"â• Extras", name:"Î¦Ï…Ï„Î¹ÎºÏŒ Î³Î¬Î»Î± (Î²ÏÏÎ¼Î·Ï‚/Î±Î¼Ï…Î³Î´Î¬Î»Î¿Ï…) (+)", price:0.50},

  {cat:"soft", group:"ğŸ¥¤ Î‘Î½Î±ÏˆÏ…ÎºÏ„Î¹ÎºÎ¬", name:"Coca-Cola / Zero / Fanta (0,33l)", price:3.40},
  {cat:"soft", group:"ğŸ¥¤ Î‘Î½Î±ÏˆÏ…ÎºÏ„Î¹ÎºÎ¬", name:"Ice Tea", price:3.60},
  {cat:"soft", group:"ğŸ¥¤ Î‘Î½Î±ÏˆÏ…ÎºÏ„Î¹ÎºÎ¬", name:"Î£ÏŒÎ´Î± / Î¤ÏŒÎ½Î¹Îº", price:3.20},
  {cat:"soft", group:"ğŸ¥¤ Î‘Î½Î±ÏˆÏ…ÎºÏ„Î¹ÎºÎ¬", name:"ÎœÎµÏ„Î±Î»Î»Î¹ÎºÏŒ Î½ÎµÏÏŒ (0,33l)", price:2.80},
  {cat:"soft", group:"ğŸ¥¤ Î‘Î½Î±ÏˆÏ…ÎºÏ„Î¹ÎºÎ¬", name:"ÎœÎµÏ„Î±Î»Î»Î¹ÎºÏŒ Î½ÎµÏÏŒ (0,75l)", price:5.50},

  {cat:"juice", group:"ğŸŠ Î§Ï…Î¼Î¿Î¯", name:"Î¦Ï…ÏƒÎ¹ÎºÏŒÏ‚ Ï‡Ï…Î¼ÏŒÏ‚ Ï€Î¿ÏÏ„Î¿ÎºÎ¬Î»Î¹", price:4.50},
  {cat:"juice", group:"ğŸŠ Î§Ï…Î¼Î¿Î¯", name:"Î§Ï…Î¼ÏŒÏ‚ Î±Î½Î¬Î¼ÎµÎ¹ÎºÏ„Î¿Ï‚", price:4.80},
  {cat:"juice", group:"ğŸŠ Î§Ï…Î¼Î¿Î¯", name:"Smoothie Ï†ÏÎ¿ÏÏ„Ï‰Î½", price:5.80},
  {cat:"juice", group:"ğŸŠ Î§Ï…Î¼Î¿Î¯", name:"Milkshake", price:5.50},

  {cat:"snack", group:"ğŸ¥ Î£Î½Î±Îº", name:"ÎšÏÎ¿Ï…Î±ÏƒÎ¬Î½ ÏƒÎºÎ­Ï„Î¿", price:2.80},
  {cat:"snack", group:"ğŸ¥ Î£Î½Î±Îº", name:"ÎšÏÎ¿Ï…Î±ÏƒÎ¬Î½ ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:3.20},
  {cat:"snack", group:"ğŸ¥ Î£Î½Î±Îº", name:"ÎœÎ¬Ï†Î¹Î½", price:3.50},
  {cat:"snack", group:"ğŸ¥ Î£Î½Î±Îº", name:"ÎšÎ­Î¹Îº (ÎºÎ¿Î¼Î¼Î¬Ï„Î¹)", price:4.20},
  {cat:"snack", group:"ğŸ¥ Î£Î½Î±Îº", name:"Cheesecake", price:4.80},
  {cat:"snack", group:"ğŸ¥ Î£Î½Î±Îº", name:"ÎœÏ€Î¹ÏƒÎºÏŒÏ„Î±", price:2.50},
  {cat:"snack", group:"ğŸ¥ Î£Î½Î±Îº", name:"Î¤Î¿ÏƒÏ„ Î¶Î±Î¼Ï€ÏŒÎ½-Ï„Ï…ÏÎ¯", price:4.50},
  {cat:"snack", group:"ğŸ¥ Î£Î½Î±Îº", name:"Î¤Î¿ÏƒÏ„ vegetarian", price:4.80},

  {cat:"beer", group:"ğŸº ÎœÏ€ÏÏÎµÏ‚", name:"ÎœÏ€ÏÏÎ± Î²Î±ÏÎµÎ»Î¯ÏƒÎ¹Î± (0,5l)", price:5.20},
  {cat:"beer", group:"ğŸº ÎœÏ€ÏÏÎµÏ‚", name:"ÎœÏ€ÏÏÎ± ÎµÎ¼Ï†Î¹Î±Î»Ï‰Î¼Î­Î½Î· (0,33l)", price:4.20},
  {cat:"beer", group:"ğŸº ÎœÏ€ÏÏÎµÏ‚", name:"Weissbier (0,5l)", price:5.50},
  {cat:"beer", group:"ğŸº ÎœÏ€ÏÏÎµÏ‚", name:"ÎœÏ€ÏÏÎ± Ï‡Ï‰ÏÎ¯Ï‚ Î±Î»ÎºÎ¿ÏŒÎ»", price:4.20},

  {cat:"wine", group:"ğŸ· ÎšÏÎ±ÏƒÎ¹Î¬", name:"ÎšÏÎ±ÏƒÎ¯ Ï€Î¿Ï„Î®ÏÎ¹", price:5.50},
  {cat:"wine", group:"ğŸ· ÎšÏÎ±ÏƒÎ¹Î¬", name:"ÎšÏÎ±ÏƒÎ¯ ÎºÎ±ÏÎ¬Ï†Î± (0,5l)", price:12.00},
  {cat:"wine", group:"ğŸ· ÎšÏÎ±ÏƒÎ¹Î¬", name:"Î¦Î¹Î¬Î»Î· ÎºÏÎ±ÏƒÎ¯ (Î±Ï€ÏŒ)", price:22.00},
  {cat:"wine", group:"ğŸ· ÎšÏÎ±ÏƒÎ¹Î¬", name:"Prosecco Ï€Î¿Ï„Î®ÏÎ¹", price:6.50},

  {cat:"spirit", group:"ğŸ¥ƒ Î Î¿Ï„Î¬", name:"ÎŸÏ…Î¯ÏƒÎºÎ¹ standard", price:8.50},
  {cat:"spirit", group:"ğŸ¥ƒ Î Î¿Ï„Î¬", name:"Premium Î¿Ï…Î¯ÏƒÎºÎ¹", price:10.50},
  {cat:"spirit", group:"ğŸ¥ƒ Î Î¿Ï„Î¬", name:"Î’ÏŒÏ„ÎºÎ±", price:8.00},
  {cat:"spirit", group:"ğŸ¥ƒ Î Î¿Ï„Î¬", name:"Î¡Î¿ÏÎ¼Î¹", price:8.50},
  {cat:"spirit", group:"ğŸ¥ƒ Î Î¿Ï„Î¬", name:"Î¤Î¶Î¹Î½", price:8.50},
  {cat:"spirit", group:"ğŸ¥ƒ Î Î¿Ï„Î¬", name:"ÎŸÏÎ¶Î¿ / Î¤ÏƒÎ¯Ï€Î¿Ï…ÏÎ¿", price:7.50},
  {cat:"spirit", group:"ğŸ¥ƒ Î Î¿Ï„Î¬", name:"Î›Î¹ÎºÎ­Ï", price:7.50},

  {cat:"cocktail", group:"ğŸ¸ ÎšÎ¿ÎºÏ„Î­Î¹Î»", name:"Mojito", price:9.50},
  {cat:"cocktail", group:"ğŸ¸ ÎšÎ¿ÎºÏ„Î­Î¹Î»", name:"Caipirinha", price:9.50},
  {cat:"cocktail", group:"ğŸ¸ ÎšÎ¿ÎºÏ„Î­Î¹Î»", name:"Margarita", price:10.00},
  {cat:"cocktail", group:"ğŸ¸ ÎšÎ¿ÎºÏ„Î­Î¹Î»", name:"Aperol Spritz", price:8.50},
  {cat:"cocktail", group:"ğŸ¸ ÎšÎ¿ÎºÏ„Î­Î¹Î»", name:"Gin Tonic", price:9.00},
  {cat:"cocktail", group:"ğŸ¸ ÎšÎ¿ÎºÏ„Î­Î¹Î»", name:"Negroni", price:10.50},
];

const cats = [
  {id:"coffee", label:"â˜• ÎšÎ±Ï†Î­Î´ÎµÏ‚", allowed:["coffee_hot","coffee_cold","tea","choco","extras"]},
  {id:"snack", label:"ğŸ¥ Î£Î½Î±Îº", allowed:["snack"]},
  {id:"drinks", label:"ğŸº Î Î¿Ï„Î¬", allowed:["beer","wine","spirit","cocktail"]},
  {id:"soft", label:"ğŸ¥¤ Î‘Î½Î±ÏˆÏ…ÎºÏ„Î¹ÎºÎ¬", allowed:["soft","juice"]},
];

/* ===================== FAVORITES ===================== */
function loadFavs(){ return load(LS_FAVS, { day:TODAY, counts:{} }); }
function saveFavs(obj){ save(LS_FAVS, obj); }
function bumpFav(name){
  let favs = loadFavs();
  if(favs.day !== TODAY) favs = { day:TODAY, counts:{} };
  favs.counts[name] = (favs.counts[name]||0)+1;
  saveFavs(favs);
}
function resetFavs(){ saveFavs({day:TODAY, counts:{}}); }
function getTop8Products(){
  let favs = loadFavs();
  const counts = favs.day===TODAY ? favs.counts : {};
  const names = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,8).map(x=>x[0]);
  const arr = names.map(n=>products.find(p=>p.name===n)).filter(Boolean);
  if(arr.length < 8){
    for(const p of products){
      if(arr.length>=8) break;
      if(!arr.some(x=>x.name===p.name) && p.cat!=="extras") arr.push(p);
    }
  }
  return arr.slice(0,8);
}

/* ===================== DB ===================== */
function ensureDB(){
  const db = load(LS_KEY, { days:{} });
  if(!db.days[TODAY]){
    db.days[TODAY] = {
      meta:{ day:TODAY, activeTable: tables[0], activeCat: "coffee", tableFilter:"open" },
      tables:{},
      payments:[],
      undone:[],
      notes:{}
    };
    for(const t of tables) db.days[TODAY].tables[t] = { lines:[] };
    save(LS_KEY, db);
  } else {
    for(const t of tables){
      if(!db.days[TODAY].tables[t]) db.days[TODAY].tables[t] = { lines:[] };
      if(!Array.isArray(db.days[TODAY].tables[t].lines)) db.days[TODAY].tables[t].lines = [];
    }
    if(!Array.isArray(db.days[TODAY].payments)) db.days[TODAY].payments = [];
    if(!Array.isArray(db.days[TODAY].undone)) db.days[TODAY].undone = [];
    if(!db.days[TODAY].notes) db.days[TODAY].notes = {};
    if(!db.days[TODAY].meta.activeCat) db.days[TODAY].meta.activeCat = "coffee";
    if(!db.days[TODAY].meta.tableFilter) db.days[TODAY].meta.tableFilter = "open";
  }
  return db;
}
function getLines(db, table){ return db.days[TODAY].tables[table].lines; }
function unpaidLines(lines){ return lines.filter(x=>!x.paid); }
function paidLines(lines){ return lines.filter(x=>!!x.paid); }
function sumOpen(db, table){ return unpaidLines(getLines(db, table)).reduce((s,x)=>s+x.price,0); }
function countOpenItems(db, table){ return unpaidLines(getLines(db, table)).length; }

function calcDayStats(db){
  const day = db.days[TODAY];
  let openTables=0, openItems=0, paidItems=0, totalItems=0;
  const prodCounts = {};
  for(const t of tables){
    const lines = getLines(db,t);
    const open = unpaidLines(lines).length;
    const paid = paidLines(lines).length;
    if(open>0) openTables++;
    openItems += open;
    paidItems += paid;
    totalItems += lines.length;
    for(const l of lines){
      prodCounts[l.name] = (prodCounts[l.name]||0)+1;
    }
  }
  const paymentsCount = day.payments.length;
  const paidTotal = day.payments.reduce((s,p)=>s+p.total,0);
  const sums = {cash:0, card:0, free:0};
  for(const p of day.payments){ sums[p.method]+=p.total; }
  return { openTables, openItems, paidItems, totalItems, paymentsCount, paidTotal, sums, prodCounts };
}
function getTopProducts(prodCounts, limit=5){
  return Object.entries(prodCounts).sort((a,b)=>b[1]-a[1]).slice(0,limit).map(([name,count])=>({name,count}));
}
function calcUserPaymentSummary(db){
  const day = db.days[TODAY];
  const users = ensureUsers();
  const map = {};
  for(const u of users) map[u.name] = { cash:0, card:0, free:0, count:0 };
  for(const p of day.payments){
    if(!map[p.user]) map[p.user] = { cash:0, card:0, free:0, count:0 };
    map[p.user][p.method] += p.total;
    map[p.user].count += 1;
  }
  return Object.entries(map).map(([name,v])=>({name,...v,total:v.cash+v.card+v.free}))
    .sort((a,b)=>b.total-a.total);
}

/* ===================== GROUPING (for +/âˆ’) ===================== */
function groupOpenByNameAndPrice(lines){
  const map = new Map();
  for(const l of lines){
    if(l.paid) continue;
    const key = l.name + "||" + l.price.toFixed(2);
    if(!map.has(key)) map.set(key, { name:l.name, price:l.price, ids:[], by:lastByFor(lines,l.name,l.price), lastAt:lastAtFor(lines,l.name,l.price) });
    map.get(key).ids.push(l.id);
  }
  return [...map.values()].sort((a,b)=>b.lastAt-a.lastAt);
}
function lastAtFor(lines,name,price){
  let m=0;
  for(const l of lines){
    if(!l.paid && l.name===name && l.price===price) m=Math.max(m,l.at||0);
  }
  return m;
}
function lastByFor(lines,name,price){
  let last=null, at=0;
  for(const l of lines){
    if(!l.paid && l.name===name && l.price===price){
      if((l.at||0)>=at){ at=l.at||0; last=l.by||null; }
    }
  }
  return last;
}
function addOneUnit(name, price){
  const db = ensureDB();
  const t = db.days[TODAY].meta.activeTable;
  const line = { id: uid(), name, price, at: Date.now(), by: getActiveUser().name, paid: null };
  db.days[TODAY].tables[t].lines.push(line);
  bumpFav(name);
  db.days[TODAY].undone.unshift({type:"add", table:t, line});
  db.days[TODAY].undone = db.days[TODAY].undone.slice(0,25);
  save(LS_KEY, db);
}
function removeOneUnit(name, price){
  const db = ensureDB();
  const t = db.days[TODAY].meta.activeTable;
  const lines = db.days[TODAY].tables[t].lines;
  const idx = lines.findIndex(x=>!x.paid && x.name===name && x.price===price);
  if(idx>=0){
    const removed = lines.splice(idx,1)[0];
    db.days[TODAY].undone.unshift({type:"remove", table:t, line:removed});
    db.days[TODAY].undone = db.days[TODAY].undone.slice(0,25);
    save(LS_KEY, db);
  }
}

/* ===================== VIEWS ===================== */
let view = "home";

/* ===================== TOP RENDER ===================== */
function renderTop(){
  $("todayText").textContent = "Î£Î®Î¼ÎµÏÎ±: " + TODAY.split("-").reverse().join("/");
  $("shopName").textContent = getShopName();

  const users = ensureUsers();
  $("userSelect").innerHTML = users.map(u=>`<option value="${u.id}">${u.name}</option>`).join("");
  $("userSelect").value = getActiveUserId();

  $("dayLabel").textContent = TODAY.split("-").reverse().join("/");
  $("userLabel").textContent = getActiveUser().name;
}

/* ===================== HOME ===================== */
function renderHome(){
  const db = ensureDB();
  const st = calcDayStats(db);
  $("homeStats").textContent =
    `Î‘Î½Î¿Î¹Ï‡Ï„Î¬: ${st.openTables} Ï„ÏÎ±Ï€Î­Î¶Î¹Î± â€¢ ${st.openItems} items â€¢ Î Î»Î·ÏÏ‰Î¼Î­Ï‚: ${st.paymentsCount} â€¢ Î£ÏÎ½Î¿Î»Î¿ Î·Î¼Î­ÏÎ±Ï‚: ${fmt(st.paidTotal)}`;
  $("openOrdersCount").textContent = `${st.openTables}`;
}

/* ===================== TABLE PICKER ===================== */
function renderTables(){
  const db = ensureDB();
  const filter = db.days[TODAY].meta.tableFilter;
  $("tablesHint").textContent = (filter==="open") ? "Î”ÎµÎ¯Ï‡Î½ÎµÎ¹ Î¼ÏŒÎ½Î¿ ÏŒÏƒÎ± Î­Ï‡Î¿Ï…Î½ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿." : "Î”ÎµÎ¯Ï‡Î½ÎµÎ¹ ÏŒÎ»Î±.";

  const list = $("tableList");
  list.innerHTML = "";

  let any = false;
  for(const g of tableGroups){
    const head = document.createElement("div");
    head.className = "sub muted";
    head.style.marginTop = "6px";
    head.textContent = g.title;
    list.appendChild(head);

    for(const t of g.list){
      const openTotal = sumOpen(db,t);
      const openCount = countOpenItems(db,t);
      const note = (db.days[TODAY].notes?.[t]||"").trim();
      const show = (filter==="all") ? true : openCount>0;
      if(!show) continue;

      any = true;
      const item = document.createElement("div");
      item.className = "listItem";
      item.innerHTML = `
        <div>
          <div class="n">${t} ${note ? `<span class="badge" title="Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·">âœï¸</span>` : ""}</div>
          <div class="m">${openCount>0 ? `${openCount} items â€¢ Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: ${fmt(openTotal)}` : "â€” ÎºÎµÎ½ÏŒ"}</div>
        </div>
        <div class="badge">${openCount}</div>
      `;
      item.onclick = ()=>{
        const db2 = ensureDB();
        db2.days[TODAY].meta.activeTable = t;
        save(LS_KEY, db2);
        showView("ticket");
        renderAll();
      };
      list.appendChild(item);
    }
  }
  $("tablesEmpty").style.display = any ? "none" : "block";
}

/* ===================== TICKET ===================== */
function renderTicketHeader(){
  const db = ensureDB();
  const day = db.days[TODAY];
  const t = day.meta.activeTable;
  const openTotal = sumOpen(db,t);
  const note = (day.notes?.[t]||"").trim();
  const user = getActiveUser().name;

  $("ticketInfo").textContent =
    `Î¤ÏÎ±Ï€Î­Î¶Î¹: ${t} â€¢ Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: ${fmt(openTotal)} â€¢ Î§ÏÎ®ÏƒÏ„Î·Ï‚: ${user}${note?` â€¢ Î£Î·Î¼.: ${note}`:""}`;
  $("ticketTotalPill").textContent = `Î£ÏÎ½Î¿Î»Î¿: ${fmt(openTotal)}`;
}

/* ---- Quick pay state ---- */
const quickPayState = { table:null, name:null, price:null, ids:[], method:null };

function showOverlay(id,on){ $(id).classList.toggle("show",!!on); }

/* quick pay: ask qty if >1 */
function openQuickPay(table, name, price, ids, method){
  quickPayState.table = table;
  quickPayState.name = name;
  quickPayState.price = price;
  quickPayState.ids = ids.slice();
  quickPayState.method = method;

  const label = method==="cash"?"ÎœÎµÏ„ÏÎ·Ï„Î¬":method==="card"?"ÎšÎ¬ÏÏ„Î±":"ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±";
  $("quickPayTitle").textContent = `${label} â€” ${name}`;
  $("quickPayInfo").textContent = `Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î±: ${ids.length} Ã— ${fmt(price)}. Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï€ÏŒÏƒÎ± Î½Î± ÎºÎ»ÎµÎ¯ÏƒÎ¿Ï…Î½ Ï„ÏÏÎ±.`;

  const row = $("quickPayQtyRow");
  row.innerHTML = "";
  const max = ids.length;
  const options = max<=8 ? Array.from({length:max},(_,i)=>i+1) : [1,2,3,4,5,max];

  for(const n of options){
    const b = document.createElement("button");
    b.className = "pill";
    b.textContent = `${n}`;
    b.onclick = ()=>{ quickPayCommit(n); };
    row.appendChild(b);
  }
  showOverlay("quickPayOverlay", true);
}
function quickPayCommit(qty){
  const table = quickPayState.table;
  const ids = quickPayState.ids.slice(0, qty);
  const method = quickPayState.method;

  doPaymentOnIds(table, ids, method, /*fromQuick=*/true);

  showOverlay("quickPayOverlay", false);
  toast("âœ… Î Î»Î·ÏÏÎ¸Î·ÎºÎµ", `${qty} Ã— ${quickPayState.name}`);
  renderAll();
}

/* Render grouped open items with +/- and quick pay icons */
function renderTicketLines(){
  const db = ensureDB();
  const t = db.days[TODAY].meta.activeTable;
  const lines = getLines(db,t);
  const groups = groupOpenByNameAndPrice(lines);

  const box = $("ticketLines");
  box.innerHTML = "";

  if(groups.length===0){
    const d = document.createElement("div");
    d.className = "sub";
    d.textContent = "â€” Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î½Î¿Î¹Ï‡Ï„Î¬ items.";
    box.appendChild(d);
    return;
  }

  for(const g of groups){
    const qty = g.ids.length;
    const total = qty * g.price;

    const div = document.createElement("div");
    div.className = "line";
    div.innerHTML = `
      <div class="lineLeft">
        <div class="n">${g.name}</div>
        <div class="m">${qty} Ã— ${fmt(g.price)} = <b>${fmt(total)}</b></div>
      </div>

      <div class="lineRight">
        <div class="qtyBox" title="Î Î¿ÏƒÏŒÏ„Î·Ï„Î±">
          <button class="qbtn" data-act="minus">âˆ’</button>
          <div class="qval">${qty}</div>
          <button class="qbtn" data-act="plus">+</button>
        </div>

        <div class="payIcons" title="Î Î»Î·ÏÏ‰Î¼Î® Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î¿Ï‚">
          <button class="picon ok" data-pay="cash">ğŸ’¶</button>
          <button class="picon primary" data-pay="card">ğŸ’³</button>
          <button class="picon warn" data-pay="free">ğŸ</button>
        </div>
      </div>
    `;

    div.querySelector('[data-act="plus"]').onclick = (e)=>{
      e.stopPropagation();
      addOneUnit(g.name, g.price);
      vibrate(18);
      renderAll();
    };
    div.querySelector('[data-act="minus"]').onclick = (e)=>{
      e.stopPropagation();
      removeOneUnit(g.name, g.price);
      vibrate([12,25,12]);
      renderAll();
    };

    div.querySelector('[data-pay="cash"]').onclick = (e)=>{ e.stopPropagation(); quickPayHandle(t,g,"cash"); };
    div.querySelector('[data-pay="card"]').onclick = (e)=>{ e.stopPropagation(); quickPayHandle(t,g,"card"); };
    div.querySelector('[data-pay="free"]').onclick = (e)=>{ e.stopPropagation(); quickPayHandle(t,g,"free"); };

    box.appendChild(div);
  }
}

function quickPayHandle(table, group, method){
  const ids = group.ids.slice();
  if(ids.length === 1){
    doPaymentOnIds(table, ids, method, /*fromQuick=*/true);
    toast("âœ… Î Î»Î·ÏÏÎ¸Î·ÎºÎµ", `${group.name}`);
    renderAll();
    return;
  }
  openQuickPay(table, group.name, group.price, ids, method);
}

/* ===================== QUICK GRID ===================== */
function renderQuick(){
  const grid = $("quickGrid");
  grid.innerHTML = "";
  const top8 = getTop8Products();
  for(const p of top8){
    const b = document.createElement("button");
    b.className = "qCard";
    b.innerHTML = `<div>${p.name}</div><div class="price">${fmt(p.price)}</div>`;
    b.onclick = ()=>{
      addOneUnit(p.name, p.price);
      vibrate(18);
      renderAll();
    };
    grid.appendChild(b);
  }
}

/* ===================== CATEGORIES / PRODUCTS ===================== */
function renderCategories(){
  const db = ensureDB();
  const active = db.days[TODAY].meta.activeCat || "coffee";
  const row = $("catRow");
  row.innerHTML = "";

  for(const c of cats){
    const b = document.createElement("button");
    b.className = "catBtn" + (c.id===active ? " active" : "");
    b.textContent = c.label;
    b.onclick = ()=>{
      const db2 = ensureDB();
      db2.days[TODAY].meta.activeCat = c.id;
      save(LS_KEY, db2);
      renderCategories();
      renderProductGrid();
    };
    row.appendChild(b);
  }
  const label = cats.find(x=>x.id===active)?.label || "";
  $("catHint").textContent = `Î•Î½ÎµÏÎ³Î®: ${label}`;
}

/* âœ… product tile with +/- */
function renderProductGrid(){
  const db = ensureDB();
  const t = db.days[TODAY].meta.activeTable;
  const lines = getLines(db,t);
  const open = unpaidLines(lines);
  const qtyMap = {};
  for(const l of open){
    qtyMap[l.name] = (qtyMap[l.name]||0) + 1;
  }

  const active = db.days[TODAY].meta.activeCat || "coffee";
  const allowed = cats.find(x=>x.id===active)?.allowed || [];
  const list = products.filter(p=>allowed.includes(p.cat));

  const grid = $("prodGrid");
  grid.innerHTML = "";

  for(const p of list){
    const qty = qtyMap[p.name] || 0;
    const tile = document.createElement("div");
    tile.className = "pTile";
    tile.innerHTML = `
      <button class="pAddTap" title="Tap Î³Î¹Î± +1"></button>
      <div>
        <div class="pName">${p.name}</div>
        <div class="pPrice">${fmt(p.price)}</div>
      </div>
      <div class="pCtrls">
        <button class="pSmall" data-act="plus">+</button>
        <div class="pQty">${qty}</div>
        <button class="pSmall" data-act="minus">âˆ’</button>
      </div>
    `;

    // tap anywhere adds +1 (fast)
    tile.querySelector(".pAddTap").onclick = ()=>{
      addOneUnit(p.name, p.price);
      vibrate(18);
      renderAll();
    };
    tile.querySelector('[data-act="plus"]').onclick = (e)=>{
      e.stopPropagation();
      addOneUnit(p.name, p.price);
      vibrate(18);
      renderAll();
    };
    tile.querySelector('[data-act="minus"]').onclick = (e)=>{
      e.stopPropagation();
      removeOneUnit(p.name, p.price);
      vibrate([12,25,12]);
      renderAll();
    };

    grid.appendChild(tile);
  }
}

/* ===================== NOTES ===================== */
function editNote(){
  const db = ensureDB();
  const t = db.days[TODAY].meta.activeTable;
  const current = (db.days[TODAY].notes?.[t]||"").trim();
  const val = prompt(`Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ· Î³Î¹Î± ${t}:`, current);
  if(val===null) return;
  db.days[TODAY].notes[t] = val.trim();
  save(LS_KEY, db);
  toast("Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·", val.trim()? "Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ." : "ÎšÎ±Î¸Î±ÏÎ¯ÏƒÏ„Î·ÎºÎµ.");
  renderAll();
}

/* ===================== SEARCH ===================== */
function renderSearch(){
  const q = $("search").value.trim().toLowerCase();
  const box = $("searchList");
  box.innerHTML = "";
  const res = products.filter(p=>p.name.toLowerCase().includes(q)).slice(0,80);
  for(const p of res){
    const div = document.createElement("div");
    div.className = "line";
    div.style.cursor="pointer";
    div.innerHTML = `
      <div class="lineLeft">
        <div class="n">${p.name}</div>
        <div class="m">${p.group}</div>
      </div>
      <div style="font-weight:900;flex:0 0 auto;">${fmt(p.price)}</div>
    `;
    div.onclick = ()=>{
      addOneUnit(p.name, p.price);
      showOverlay("searchOverlay", false);
      renderAll();
    };
    box.appendChild(div);
  }
}

/* ===================== PAY (Split) ===================== */
const payState = { ids:new Set() };

function openPaySheet(){
  payState.ids = new Set();
  renderPayList();
  showOverlay("payOverlay", true);
}

function renderPayList(){
  const db = ensureDB();
  const t = db.days[TODAY].meta.activeTable;
  const open = unpaidLines(getLines(db,t));
  $("payTitle").textContent = `Ticket: ${t}`;

  const list = $("payList");
  list.innerHTML = "";
  for(const l of open){
    const row = document.createElement("div");
    row.className="payLine";
    row.innerHTML = `
      <div class="left">
        <input type="checkbox"/>
        <div style="min-width:0;">
          <div class="t">${l.name}</div>
          <div class="s">${l.by} â€¢ ${new Date(l.at).toLocaleTimeString("el-GR",{hour:"2-digit",minute:"2-digit"})}</div>
        </div>
      </div>
      <div class="right">${fmt(l.price)}</div>
    `;
    const cb = row.querySelector("input");
    cb.checked = payState.ids.has(l.id);
    cb.onchange=()=>{
      if(cb.checked) payState.ids.add(l.id); else payState.ids.delete(l.id);
      updatePayTotal();
    };
    row.onclick=(e)=>{
      if(e.target.tagName.toLowerCase()==="input") return;
      cb.checked=!cb.checked; cb.dispatchEvent(new Event("change"));
    };
    list.appendChild(row);
  }
  updatePayTotal();
}
function updatePayTotal(){
  const db = ensureDB();
  const t = db.days[TODAY].meta.activeTable;
  const open = unpaidLines(getLines(db,t));
  const selected = open.filter(x=>payState.ids.has(x.id));
  const total = selected.reduce((s,x)=>s+x.price,0);
  $("payTotal").textContent = `Î¤ÎµÎ»Î¹ÎºÏŒ: ${fmt(total)}`;
}
function toggleSelectAll(){
  const db = ensureDB();
  const t = db.days[TODAY].meta.activeTable;
  const open = unpaidLines(getLines(db,t));
  if(payState.ids.size===open.length){
    payState.ids=new Set();
    $("btnSelectAll").textContent="Î•Ï€Î¯Î»ÎµÎ¾Îµ ÏŒÎ»Î±";
  }else{
    payState.ids=new Set(open.map(x=>x.id));
    $("btnSelectAll").textContent="Î‘Ï€Î¿ÎµÏ€Î¹Î»Î¿Î³Î® ÏŒÎ»Ï‰Î½";
  }
  renderPayList();
}

function mustConfirmPayment(method, total, count){
  return (method==="free") || (total>=CONFIRM_MIN_TOTAL) || (count>=CONFIRM_MIN_ITEMS);
}

function doPaymentOnIds(table, ids, method, fromQuick=false){
  const db = ensureDB();
  const lines = getLines(db, table);
  const now=Date.now();
  const user=getActiveUser().name;

  let total=0;
  const realIds=[];
  for(const l of lines){
    if(ids.includes(l.id) && !l.paid){
      total += l.price;
      realIds.push(l.id);
    }
  }
  if(realIds.length===0) return;

  const label = ({cash:"ÎœÎµÏ„ÏÎ·Ï„Î¬",card:"ÎšÎ¬ÏÏ„Î±",free:"ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±"}[method]||method);
  const needConfirm = mustConfirmPayment(method, total, realIds.length);
  if(needConfirm){
    if(!confirm(`Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·\n\nÎ¤ÏÎ±Ï€Î­Î¶Î¹: ${table}\nÎ§ÏÎ®ÏƒÏ„Î·Ï‚: ${user}\nÎ¤ÏÏŒÏ€Î¿Ï‚: ${label}\nItems: ${realIds.length}\nÎ£ÏÎ½Î¿Î»Î¿: ${fmt(total)}\n\nÎÎ± ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ·Î¸ÎµÎ¯;`)) return;
  }

  for(const l of lines){
    if(realIds.includes(l.id)) l.paid = { method, at: now, by: user };
  }

  const paymentId = uid();
  db.days[TODAY].payments.push({ id: paymentId, at: now, table, user, method, total, itemIds: realIds });

  db.days[TODAY].undone.unshift({type:"pay", paymentId, table, itemIds: realIds});
  db.days[TODAY].undone = db.days[TODAY].undone.slice(0,25);

  save(LS_KEY, db);

  const remaining = unpaidLines(getLines(db, table)).length;
  if(!fromQuick){
    showOverlay("payOverlay", false);
    showView("home");
  } else {
    if(remaining===0){
      showView("home");
    }
  }
}

function doPayment(method){
  const db = ensureDB();
  const t = db.days[TODAY].meta.activeTable;
  const open = unpaidLines(getLines(db,t));
  const selected = open.filter(x=>payState.ids.has(x.id));
  if(selected.length===0){ alert("Î”Î¹Î¬Î»ÎµÎ¾Îµ items."); return; }
  const ids = selected.map(x=>x.id);

  doPaymentOnIds(t, ids, method, false);
  toast("âœ… Î Î»Î·ÏÏ‰Î¼Î®", `${t} â€” ${fmt(selected.reduce((s,x)=>s+x.price,0))}`);
  renderAll();
}

/* ===================== UNDO ===================== */
function undoLast(){
  const db = ensureDB();
  const a = db.days[TODAY].undone.shift();
  if(!a){ toast("Undo", "Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎºÎ¬Ï„Î¹ Î³Î¹Î± Î±Î½Î±Î¯ÏÎµÏƒÎ·."); return; }

  if(a.type==="add"){
    const lines = db.days[TODAY].tables[a.table].lines;
    const idx = lines.findIndex(x=>x.id===a.line.id);
    if(idx>=0) lines.splice(idx,1);
    toast("Undo", "Î‘Ï†Î±Î¹ÏÎ­Î¸Î·ÎºÎµ Ï„Î¿ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿ item.");
  } else if(a.type==="remove"){
    db.days[TODAY].tables[a.table].lines.push(a.line);
    toast("Undo", "Î•Ï€Î±Î½Î±Ï†Î­ÏÎ¸Î·ÎºÎµ Ï„Î¿ item.");
  } else if(a.type==="pay"){
    const lines = db.days[TODAY].tables[a.table].lines;
    for(const l of lines){
      if(a.itemIds.includes(l.id)) l.paid = null;
    }
    db.days[TODAY].payments = db.days[TODAY].payments.filter(p=>p.id!==a.paymentId);
    toast("Undo", "Î‘Î½Î±Î¹ÏÎ­Î¸Î·ÎºÎµ Î· Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± Ï€Î»Î·ÏÏ‰Î¼Î®.");
  }

  save(LS_KEY, db);
  renderAll();
}

/* ===================== SUMMARY + USER DRILLDOWN ===================== */
function renderSummary(){
  const db = ensureDB();
  const st = calcDayStats(db);

  $("daySummaryFull").textContent =
    `Î‘Î½Î¿Î¹Ï‡Ï„Î¬ Ï„ÏÎ±Ï€Î­Î¶Î¹Î±: ${st.openTables} â€¢ Î‘Î½Î¿Î¹Ï‡Ï„Î¬ items: ${st.openItems} â€¢ Î Î»Î·ÏÏ‰Î¼Î­Î½Î± items: ${st.paidItems} â€¢ Î£ÏÎ½Î¿Î»Î¿ items: ${st.totalItems} â€¢ Î Î»Î·ÏÏ‰Î¼Î­Ï‚: ${st.paymentsCount} â€¢ Î£ÏÎ½Î¿Î»Î¿ ÎµÎ¹ÏƒÏ€ÏÎ¬Î¾ÎµÏ‰Î½: ${fmt(st.paidTotal)}`
    + `\n(ÎœÎµÏ„ÏÎ·Ï„Î¬: ${fmt(st.sums.cash)} â€¢ ÎšÎ¬ÏÏ„Î±: ${fmt(st.sums.card)} â€¢ ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±: ${fmt(st.sums.free)})`;

  const top = getTopProducts(st.prodCounts, 5);
  const tt = $("topProductsTable");
  tt.innerHTML = "";
  if(top.length===0){
    tt.innerHTML = `<tr><td class="muted">â€” Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®ÏƒÎµÎ¹Ï‚ Î±ÎºÏŒÎ¼Î± ÏƒÎ®Î¼ÎµÏÎ±.</td></tr>`;
  } else {
    for(const it of top){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td><b>${it.name}</b><div class="muted">Î¤ÎµÎ¼Î¬Ï‡Î¹Î±: ${it.count}</div></td>`;
      tt.appendChild(tr);
    }
  }

  const us = calcUserPaymentSummary(db);
  const ut = $("userSummaryTable");
  ut.innerHTML = "";

  for(const u of us){
    const tr = document.createElement("tr");
    tr.style.cursor="pointer";
    tr.innerHTML = `
      <td>
        <b>${u.name}</b>
        <div class="muted">Î Î»Î·ÏÏ‰Î¼Î­Ï‚: ${u.count}</div>
        <div class="muted">ÎœÎµÏ„ÏÎ·Ï„Î¬: ${fmt(u.cash)} â€¢ ÎšÎ¬ÏÏ„Î±: ${fmt(u.card)} â€¢ ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±: ${fmt(u.free)}</div>
        <div class="muted">Î£ÏÎ½Î¿Î»Î¿: ${fmt(u.total)}</div>
      </td>`;
    tr.onclick = ()=> openUserDetails(u.name);
    ut.appendChild(tr);
  }
}

function openUserDetails(userName){
  const db = ensureDB();
  const day = db.days[TODAY];
  const payments = day.payments.filter(p=>p.user===userName).sort((a,b)=>b.at-a.at);

  const sums = {cash:0, card:0, free:0};
  let count=0;
  for(const p of payments){ sums[p.method]+=p.total; count++; }

  $("userDetailTitle").textContent = `ğŸ‘¤ ${userName}`;
  $("userDetailSub").textContent = `ÎšÎ¹Î½Î®ÏƒÎµÎ¹Ï‚: ${count} â€¢ ÎœÎµÏ„ÏÎ·Ï„Î¬: ${fmt(sums.cash)} â€¢ ÎšÎ¬ÏÏ„Î±: ${fmt(sums.card)} â€¢ ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±: ${fmt(sums.free)} â€¢ Î£ÏÎ½Î¿Î»Î¿: ${fmt(sums.cash+sums.card+sums.free)}`;

  const body = $("userDetailBody");
  body.innerHTML = "";

  if(payments.length===0){
    body.innerHTML = `<div class="muted">â€” Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚.</div>`;
  } else {
    for(const p of payments.slice(0,200)){
      const div = document.createElement("div");
      div.className="listItem";
      div.style.cursor="default";
      div.innerHTML = `
        <div>
          <div class="n">${fmt(p.total)} <span class="badge">${p.method}</span></div>
          <div class="m">${new Date(p.at).toLocaleTimeString("el-GR",{hour:"2-digit",minute:"2-digit",second:"2-digit"})} â€¢ ${p.table}</div>
        </div>
        <div class="badge">${p.itemIds?.length || 0}</div>
      `;
      body.appendChild(div);
    }
  }

  showOverlay("userOverlay", true);
}

/* ===================== CSV ===================== */
function exportCSV(){
  const db = ensureDB();
  const day = db.days[TODAY];
  const rows = [];
  rows.push(["date","time","table","user","method","total","items"].join(","));
  for(const p of day.payments){
    rows.push([
      TODAY,
      new Date(p.at).toLocaleTimeString("el-GR",{hour:"2-digit",minute:"2-digit",second:"2-digit"}),
      p.table,
      p.user,
      p.method,
      (p.total||0).toFixed(2),
      (p.itemIds?.length || 0)
    ].join(","));
  }
  const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `daily-cashier-${TODAY}.csv`;
  a.click();
}

/* ===================== WIPE ALL ===================== */
async function wipeAll(){
  if(!confirm("Î˜Î± ÏƒÎ²Î·ÏƒÏ„Î¿ÏÎ½ ÎŸÎ›Î‘. Î£Ï…Î½Î­Ï‡ÎµÎ¹Î±;")) return;
  const word = prompt("Î“Î¹Î± Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î± Î³ÏÎ¬ÏˆÎµ Î±ÎºÏÎ¹Î²ÏÏ‚: DELETE");
  if(word!=="DELETE"){ alert("Î‘ÎºÏ…ÏÏÎ¸Î·ÎºÎµ."); return; }
  localStorage.removeItem(LS_KEY);
  localStorage.removeItem(LS_USERS);
  localStorage.removeItem(LS_ACTIVE_USER);
  localStorage.removeItem(LS_FAVS);
  localStorage.removeItem(LS_SHOP);
  localStorage.removeItem(LS_ADMIN_HASH);
  location.reload();
}

/* ===================== USER MANAGEMENT ===================== */
async function addUser(){
  const name = prompt("ÎŒÎ½Î¿Î¼Î± Î½Î­Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·:");
  if(!name) return;
  const users = ensureUsers();
  users.push({ id: uid(), name: name.trim(), pinHash: null });
  save(LS_USERS, users);
  save(LS_ACTIVE_USER, users[users.length-1].id);
  renderAll();
}
async function renameUser(){
  const active = getActiveUser();
  const ok = await requireUserPinIfExists(active, "ÎœÎµÏ„Î¿Î½Î¿Î¼Î±ÏƒÎ¯Î±");
  if(!ok) return;
  const name = prompt("ÎÎ­Î¿ ÏŒÎ½Î¿Î¼Î±:", active.name);
  if(!name) return;
  const users = ensureUsers();
  const idx = users.findIndex(u=>u.id===active.id);
  users[idx].name = name.trim();
  save(LS_USERS, users);
  renderAll();
}
async function setPin(){
  const active = getActiveUser();
  const ok = await requireUserPinIfExists(active, "Î‘Î»Î»Î±Î³Î® PIN");
  if(!ok) return;
  const pin1 = prompt("ÎÎ­Î¿ 4-ÏˆÎ®Ï†Î¹Î¿ PIN:");
  if(!pin1 || !isValidPin(pin1)) { alert("Î†ÎºÏ…ÏÎ¿ PIN."); return; }
  const pin2 = prompt("ÎÎ±Î½Î±Î³ÏÎ¬ÏˆÎµ Ï„Î¿ PIN:");
  if(pin2 !== pin1) { alert("Î”ÎµÎ½ Ï„Î±Î¹ÏÎ¹Î¬Î¶Î¿Ï…Î½."); return; }
  const users = ensureUsers();
  const idx = users.findIndex(u=>u.id===active.id);
  users[idx].pinHash = await sha256Hex(pin1);
  save(LS_USERS, users);
  alert("Î¤Î¿ PIN Î¬Î»Î»Î±Î¾Îµ.");
}
async function deleteUser(){
  const active = getActiveUser();
  const ok = await requireUserPinIfExists(active, "Î”Î¹Î±Î³ÏÎ±Ï†Î® Ï‡ÏÎ®ÏƒÏ„Î·");
  if(!ok) return;
  const users = ensureUsers();
  if(users.length<=1){ alert("Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 1 Ï‡ÏÎ®ÏƒÏ„Î·Ï‚."); return; }
  if(!confirm(`ÎÎ± Î´Î¹Î±Î³ÏÎ±Ï†ÎµÎ¯ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ "${active.name}";`)) return;
  const left = users.filter(u=>u.id!==active.id);
  save(LS_USERS, left);
  save(LS_ACTIVE_USER, left[0].id);
  renderAll();
}
async function changeShopName(){
  const ok = await verifyAdminPin("Î‘Î»Î»Î±Î³Î® Î¿Î½ÏŒÎ¼Î±Ï„Î¿Ï‚ Î¼Î±Î³Î±Î¶Î¹Î¿Ï");
  if(!ok) return;
  const cur = getShopName();
  const name = prompt("ÎÎ­Î¿ ÏŒÎ½Î¿Î¼Î± Î¼Î±Î³Î±Î¶Î¹Î¿Ï:", cur);
  if(!name) return;
  setShopNameLocal(name.trim());
  toast("ğŸ· ÎŒÎ½Î¿Î¼Î± Î¼Î±Î³Î±Î¶Î¹Î¿Ï", "Î‘Î»Î»Î¬Ï‡Ï„Î·ÎºÎµ.");
}

/* ===================== TABLE SEARCH ===================== */
function openTableSearch(){
  $("tableSearch").value = "";
  renderTableSearch("");
  showOverlay("tableSearchOverlay", true);
  setTimeout(()=> $("tableSearch").focus(), 50);
}
function renderTableSearch(q){
  const db = ensureDB();
  const filter = (q||"").trim().toUpperCase();
  const list = $("tableSearchList");
  list.innerHTML = "";

  const openTables = tables
    .map(t=>({t, open:countOpenItems(db,t), total:sumOpen(db,t)}))
    .filter(x=>x.open>0);

  const filtered = openTables.filter(x=>x.t.includes(filter));
  const arr = (filter ? filtered : openTables).slice(0,30);

  if(arr.length===0){
    const d = document.createElement("div");
    d.className="sub muted";
    d.textContent="â€” Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ.";
    list.appendChild(d);
    return;
  }

  for(const it of arr){
    const row = document.createElement("div");
    row.className="listItem";
    row.innerHTML = `
      <div>
        <div class="n">${it.t}</div>
        <div class="m">${it.open} items â€¢ ${fmt(it.total)}</div>
      </div>
      <div class="badge">${it.open}</div>
    `;
    row.onclick = ()=>{
      const db2 = ensureDB();
      db2.days[TODAY].meta.activeTable = it.t;
      save(LS_KEY, db2);
      showOverlay("tableSearchOverlay", false);
      showView("ticket");
      renderAll();
    };
    list.appendChild(row);
  }
}

/* ===================== MAIN RENDER ===================== */
function renderAll(){
  renderTop();
  renderHome();
  renderTables();
  renderTicketHeader();
  renderTicketLines();
  renderQuick();
  renderCategories();
  renderProductGrid();
  renderSummary();
}

/* ===================== EVENTS ===================== */
$("btnSettings").onclick = ()=> showOverlay("overlay", true);
$("btnCloseSheet").onclick = ()=> showOverlay("overlay", false);
$("overlay").onclick = (e)=>{ if(e.target.id==="overlay") showOverlay("overlay", false); };

$("btnSummaryTop").onclick = ()=> { renderSummary(); showOverlay("summaryOverlay", true); };
$("btnSummary2").onclick = ()=> { renderSummary(); showOverlay("summaryOverlay", true); };
$("btnSummary3").onclick = ()=> { renderSummary(); showOverlay("summaryOverlay", true); };
$("btnCloseSummary").onclick = ()=> showOverlay("summaryOverlay", false);
$("summaryOverlay").onclick = (e)=>{ if(e.target.id==="summaryOverlay") showOverlay("summaryOverlay", false); };

$("btnCloseUserOverlay").onclick = ()=> showOverlay("userOverlay", false);
$("userOverlay").onclick = (e)=>{ if(e.target.id==="userOverlay") showOverlay("userOverlay", false); };

$("btnNewOrder").onclick = ()=>{
  const db = ensureDB();
  db.days[TODAY].meta.tableFilter = "all";
  save(LS_KEY, db);
  showView("tables");
  renderAll();
};
$("btnOpenOrders").onclick = ()=>{
  const db = ensureDB();
  db.days[TODAY].meta.tableFilter = "open";
  save(LS_KEY, db);
  showView("tables");
  renderAll();
};
$("btnBackHome1").onclick = ()=> { showView("home"); renderAll(); };
$("btnBackHome2").onclick = ()=> { showView("home"); renderAll(); };

$("btnShowAll").onclick = ()=>{
  const db = ensureDB();
  db.days[TODAY].meta.tableFilter = "all";
  save(LS_KEY, db);
  renderTables();
};
$("btnShowOpen").onclick = ()=>{
  const db = ensureDB();
  db.days[TODAY].meta.tableFilter = "open";
  save(LS_KEY, db);
  renderTables();
};

$("btnSearchOpen").onclick = openTableSearch;
$("btnCloseTableSearch").onclick = ()=> showOverlay("tableSearchOverlay", false);
$("tableSearchOverlay").onclick = (e)=>{ if(e.target.id==="tableSearchOverlay") showOverlay("tableSearchOverlay", false); };
$("tableSearch").addEventListener("input", (e)=>renderTableSearch(e.target.value));

$("btnPay").onclick = openPaySheet;
$("btnClosePay").onclick = ()=> showOverlay("payOverlay", false);
$("payOverlay").onclick = (e)=>{ if(e.target.id==="payOverlay") showOverlay("payOverlay", false); };

$("btnSelectAll").onclick = toggleSelectAll;
$("btnPayCash").onclick = ()=>doPayment("cash");
$("btnPayCard").onclick = ()=>doPayment("card");
$("btnPayFree").onclick = ()=>doPayment("free");

$("btnCloseQuickPay").onclick = ()=> showOverlay("quickPayOverlay", false);
$("quickPayOverlay").onclick = (e)=>{ if(e.target.id==="quickPayOverlay") showOverlay("quickPayOverlay", false); };

$("btnCSV").onclick = exportCSV;
$("btnWipeAll").onclick = wipeAll;

$("btnAddUser").onclick = addUser;
$("btnRenameUser").onclick = renameUser;
$("btnSetPin").onclick = setPin;
$("btnDeleteUser").onclick = deleteUser;
$("btnAdminShop").onclick = changeShopName;

$("userSelect").onchange = (e)=> changeUserWithPin(e.target.value);

$("btnUndo").onclick = undoLast;
$("btnNote").onclick = editNote;

$("btnClearQuick").onclick = ()=>{
  if(confirm("Reset Top 8 Î³Î¹Î± ÏƒÎ®Î¼ÎµÏÎ±;")){ resetFavs(); renderQuick(); toast("Top 8", "ÎˆÎ³Î¹Î½Îµ reset."); }
};

$("btnSearch").onclick = ()=>{
  $("search").value = "";
  renderSearch();
  showOverlay("searchOverlay", true);
  setTimeout(()=> $("search").focus(), 50);
};
$("btnCloseSearch").onclick = ()=> showOverlay("searchOverlay", false);
$("searchOverlay").onclick = (e)=>{ if(e.target.id==="searchOverlay") showOverlay("searchOverlay", false); };
$("search").addEventListener("input", renderSearch);

/* start */
setShopNameLocal(getShopName());
showView("home");
renderAll();

/* optional service worker register if you use it */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./sw.js");
}
</script>
</body>
</html>
