<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#0b0f14"/>
  <title>Daily Cashier</title>

  <style>
    :root{
      --bg:#0b0f14;
      --text:#e9eef7;
      --muted:#9fb0c7;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.06);
      --accent:#3aa2ff;
      --ok:#24d18d;
      --warn:#ffb020;
      --danger:#ff5b6e;
      --tap:44px;
      --r:14px;
    }
    html,body{height:100%; width:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; overflow-x:hidden;}
    *{box-sizing:border-box; min-width:0;}
    button,input,select{font:inherit; color:inherit;}
    button{touch-action:manipulation;}
    .app{min-height:100%; display:flex; flex-direction:column;}

    /* Top bar */
    .topbar{
      position:sticky; top:0; z-index:1000;
      padding:10px 10px 8px;
      background:rgba(11,15,20,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line2);
    }
    .toprow{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .shop{font-weight:900; font-size:18px; line-height:1.1;}
    .sub{color:var(--muted); font-size:12.5px; line-height:1.2; margin-top:4px; white-space:pre-line;}
    .right{display:flex; align-items:center; gap:8px;}
    .iconbtn{
      width:40px; height:40px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      display:grid; place-items:center;
      cursor:pointer;
    }
    .select{
      height:40px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      padding:0 12px;
      max-width:52vw;
    }

    /* Main */
    .main{flex:1; padding:10px 10px 96px;}
    .view{display:none;}
    .view.show{display:block;}

    /* Buttons / rows */
    .big{
      width:100%;
      height:56px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      display:flex; align-items:center; justify-content:space-between;
      padding:0 14px;
      cursor:pointer;
      font-weight:900;
    }
    .big .meta{color:var(--muted); font-weight:800; font-size:13px;}
    .row{
      width:100%;
      border:1px solid transparent;
      background:transparent;
      padding:12px 6px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .row:active{background:rgba(255,255,255,.03);}
    .row + .row{border-top:1px solid var(--line2); border-radius:0;}
    .leftcol{display:flex; flex-direction:column; gap:4px; min-width:0;}
    .title{font-weight:900; line-height:1.15; word-break:break-word;}
    .mini{color:var(--muted); font-size:12.5px; line-height:1.2;}
    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      padding:0 10px; height:22px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      font-size:12px; font-weight:900;
      flex:0 0 auto;
      white-space:nowrap;
    }

    /* Controls */
    .ctrls{display:flex; align-items:center; gap:8px; flex:0 0 auto;}
    .qty{
      display:flex; align-items:center; gap:6px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:4px;
      background:rgba(255,255,255,.02);
    }
    .qbtn{
      width:30px; height:30px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      display:grid; place-items:center;
      cursor:pointer;
      font-weight:900;
      font-size:16px;
    }
    .qval{min-width:22px; text-align:center; font-weight:900; font-size:14px;}
    .payicons{display:flex; align-items:center; gap:6px;}
    .pbtn{
      width:30px; height:30px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      display:grid; place-items:center;
      cursor:pointer;
      font-size:15px;
    }
    .pbtn.cash{border-color:rgba(36,209,141,.55);}
    .pbtn.card{border-color:rgba(58,162,255,.55);}
    .pbtn.free{border-color:rgba(255,176,32,.55);}

    /* Tabs */
    .tabs{
      display:flex; gap:8px; overflow:auto; padding:6px 0 10px;
      -webkit-overflow-scrolling: touch;
    }
    .tab{
      flex:0 0 auto;
      height:38px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      padding:0 12px;
      font-weight:900;
      cursor:pointer;
      font-size:13px;
      display:flex; align-items:center;
      white-space:nowrap;
    }
    .tab.active{border-color:rgba(58,162,255,.55); box-shadow:0 0 0 3px rgba(58,162,255,.12) inset;}
    .search{
      width:100%;
      height:42px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      padding:0 14px;
      outline:none;
    }

    /* Bottom bar */
    .bottombar{
      position:fixed; left:0; right:0; bottom:0; z-index:1200;
      padding:10px 10px calc(10px + env(safe-area-inset-bottom));
      background:linear-gradient(180deg, transparent, rgba(11,15,20,.78) 22%, rgba(11,15,20,.96));
      border-top:1px solid var(--line2);
      backdrop-filter: blur(10px);
    }
    .bwrap{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px;
    }
    .bbtn{
      height:46px; border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      cursor:pointer;
      font-weight:900;
      width:100%;
      display:flex; align-items:center; justify-content:center;
      gap:8px;
      white-space:nowrap;
    }
    .bbtn.danger{border-color:rgba(255,91,110,.55);}
    .bbtn.primary{border-color:rgba(58,162,255,.55);}
    .bbtn.ok{border-color:rgba(36,209,141,.55);}

    /* Overlay */
    .overlay{
      position:fixed; inset:0; z-index:3000;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(4px);
      display:none;
      padding:14px 10px;
    }
    .overlay.show{display:flex; align-items:flex-end; justify-content:center;}
    .sheet{
      width:calc(100vw - 20px);
      max-width:900px;
      max-height:86vh;
      overflow:auto;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(15,20,29,.92);
      padding:12px;
      box-shadow:0 30px 120px rgba(0,0,0,.65);
    }
    .sheethead{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .sheettitle{font-weight:900; font-size:16px;}
    .hr{height:1px; background:var(--line2); margin:10px 0;}
    .sheetbtnrow{display:flex; gap:10px; flex-wrap:wrap;}
    .sheetbtn{
      height:42px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      padding:0 14px;
      cursor:pointer;
      font-weight:900;
    }
    .sheetbtn.danger{border-color:rgba(255,91,110,.55);}
    .sheetbtn.ok{border-color:rgba(36,209,141,.55);}
    .sheetbtn.primary{border-color:rgba(58,162,255,.55);}

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:calc(82px + env(safe-area-inset-bottom));
      z-index:5000;
      background:rgba(20,28,40,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:10px 12px;
      display:none;
      max-width:calc(100vw - 20px);
    }
    .toast.show{display:block;}
    .toast .t{font-weight:900;}
    .toast .s{color:var(--muted); font-size:12.5px; margin-top:4px; line-height:1.2;}

    /* PIN Modal (numeric keyboard) */
    .pinBox{
      width:calc(100vw - 20px);
      max-width:420px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(15,20,29,.96);
      padding:14px;
      box-shadow:0 30px 120px rgba(0,0,0,.65);
    }
    .pinTitle{font-weight:900; font-size:16px;}
    .pinSub{color:var(--muted); font-size:12.5px; margin-top:6px; white-space:pre-line;}
    .pinInput{
      margin-top:12px;
      width:100%;
      height:52px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      padding:0 14px;
      outline:none;
      font-size:22px;
      letter-spacing:10px;
      text-align:center;
    }

    /* Screensaver */
    .screensaver{
      position:fixed; inset:0; z-index:9999;
      display:none;
      background:#000;
      color:#fff;
      padding:24px;
    }
    .screensaver.show{display:flex; align-items:center; justify-content:center;}
    .ssCenter{text-align:center; max-width:92vw;}
    .ssLogo{
      font-weight:1000;
      font-size:40px;
      letter-spacing:.8px;
      line-height:1.1;
      word-break:break-word;
    }
    .ssUser{
      margin-top:16px;
      font-size:16px;
      opacity:.85;
      letter-spacing:.2px;
    }
    .ssHint{
      margin-top:26px;
      font-size:12.5px;
      opacity:.55;
    }
  </style>
</head>

<body>
<div class="app">
  <div class="topbar">
    <div class="toprow">
      <div style="min-width:0;">
        <div class="shop" id="shopName">â€”</div>
        <div class="sub" id="topSub">â€”</div>
      </div>
      <div class="right">
        <select id="userSelect" class="select"></select>
        <button class="iconbtn" id="btnSummaryTop" title="Î£ÏÎ½Î¿ÏˆÎ·">ğŸ“Š</button>
        <button class="iconbtn" id="btnSettings" title="Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚">âš™ï¸</button>
      </div>
    </div>
  </div>

  <div class="main">
    <!-- HOME -->
    <div id="viewHome" class="view show">
      <button class="big" id="btnNewOrder"><span>â• ÎÎ­Î± Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±</span><span class="meta">Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï„ÏÎ±Ï€Î­Î¶Î¹</span></button>
      <div style="height:10px;"></div>
      <button class="big" id="btnOpenOrders"><span>ğŸ“„ Î‘Î½Î¿Î¹Ï‡Ï„Î¬</span><span class="meta" id="openCountMeta">0</span></button>
      <div style="height:10px;"></div>
      <button class="big" id="btnSummaryHome"><span>ğŸ“Š Î£ÏÎ½Î¿ÏˆÎ·</span><span class="meta">Î—Î¼Î­ÏÎ±Ï‚</span></button>
      <div style="height:12px;"></div>
      <div class="sub" id="homeStats">â€”</div>
    </div>

    <!-- TABLES -->
    <div id="viewTables" class="view">
      <div class="toprow" style="margin-bottom:10px;">
        <button class="sheetbtn" id="btnBackHome">â† Home</button>
        <div class="sub" id="tablesSub" style="margin:0;">â€”</div>
        <button class="sheetbtn" id="btnToggleTables">ÎœÏŒÎ½Î¿ Î±Î½Î¿Î¹Ï‡Ï„Î¬</button>
      </div>
      <div id="tablesList"></div>
    </div>

    <!-- TICKET -->
    <div id="viewTicket" class="view">
      <div class="toprow" style="margin-bottom:8px;">
        <button class="sheetbtn" id="btnBackTables">â† Î¤ÏÎ±Ï€Î­Î¶Î¹Î±</button>
        <div class="sub" id="ticketSub" style="margin:0;">â€”</div>
        <button class="sheetbtn primary" id="btnPay">Î Î»Î·ÏÏ‰Î¼Î®</button>
      </div>

      <div class="sub" style="margin-bottom:8px;">Î‘Î½Î¿Î¹Ï‡Ï„Î¬ items</div>
      <div id="openItemsList"></div>

      <div style="height:12px;"></div>
      <div class="sub">Top 8 ÏƒÎ®Î¼ÎµÏÎ±</div>
      <div class="tabs" id="top8Row"></div>

      <div style="height:12px;"></div>
      <div class="sub">ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚</div>
      <div class="tabs" id="catTabs"></div>

      <input id="prodSearch" class="search" placeholder="ğŸ” Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î¿Ï‚..." />

      <div style="height:10px;"></div>
      <div id="productsList"></div>
    </div>
  </div>

  <div class="bottombar">
    <div class="bwrap">
      <button class="bbtn" id="btnUndo">â†© Undo</button>
      <button class="bbtn primary" id="btnCSV">CSV</button>
      <button class="bbtn danger" id="btnWipe">Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
    </div>
  </div>
</div>

<!-- Settings overlay -->
<div class="overlay" id="settingsOv">
  <div class="sheet">
    <div class="sheethead">
      <div class="sheettitle">âš™ï¸ Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</div>
      <button class="sheetbtn" id="btnCloseSettings">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
    <div class="hr"></div>
    <div class="sub" id="settingsSub">â€”</div>
    <div class="hr"></div>
    <div class="sheetbtnrow">
      <button class="sheetbtn" id="btnAddUser">+ Î§ÏÎ®ÏƒÏ„Î·Ï‚</button>
      <button class="sheetbtn" id="btnRenameUser">âœï¸ ÎœÎµÏ„Î¿Î½Î¿Î¼Î±ÏƒÎ¯Î±</button>
      <button class="sheetbtn" id="btnSetPin">ğŸ”’ PIN Ï‡ÏÎ®ÏƒÏ„Î·</button>
      <button class="sheetbtn" id="btnShopName">ğŸ· ÎŒÎ½Î¿Î¼Î± Î¼Î±Î³Î±Î¶Î¹Î¿Ï</button>
      <button class="sheetbtn danger" id="btnDelUser">ğŸ—‘ Î”Î¹Î±Î³ÏÎ±Ï†Î® Ï‡ÏÎ®ÏƒÏ„Î·</button>
    </div>
    <div class="hr"></div>
    <div class="sub">
      Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·: Î´ÎµÎ½ Î¶Î·Ï„Î¬ÎµÎ¹ PIN ÏƒÏ„Î·Î½ Ï€Î»Î·ÏÏ‰Î¼Î® (Î³Î¹Î± Î½Î± Î¼Î·Î½ ÎºÎ±Î¸Ï…ÏƒÏ„ÎµÏÎµÎ¯).
      Î¤Î¿ PIN Î´Î¿Ï…Î»ÎµÏÎµÎ¹ ÏƒÏ„Î·Î½ Î±Î»Î»Î±Î³Î®/Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Ï‡ÏÎ®ÏƒÏ„Î· & ÏƒÎµ ÎµÏ…Î±Î¯ÏƒÎ¸Î·Ï„ÎµÏ‚ ÎµÎ½Î­ÏÎ³ÎµÎ¹ÎµÏ‚.
    </div>
  </div>
</div>

<!-- Summary overlay -->
<div class="overlay" id="summaryOv">
  <div class="sheet">
    <div class="sheethead">
      <div class="sheettitle">ğŸ“Š Î£ÏÎ½Î¿ÏˆÎ· Î·Î¼Î­ÏÎ±Ï‚</div>
      <button class="sheetbtn" id="btnCloseSummary">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
    <div class="hr"></div>
    <div class="sub" id="summaryText">â€”</div>
    <div class="hr"></div>
    <div class="sub" style="margin-bottom:6px;">Top Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±</div>
    <div id="topList"></div>
    <div class="hr"></div>
    <div class="sub" style="margin-bottom:6px;">Î‘Î½Î¬ Ï‡ÏÎ®ÏƒÏ„Î· (Ï€Î¬Ï„Î± Î³Î¹Î± Î»ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚)</div>
    <div id="userSumList"></div>
  </div>
</div>

<!-- User details overlay -->
<div class="overlay" id="userOv">
  <div class="sheet">
    <div class="sheethead">
      <div class="sheettitle" id="userTitle">â€”</div>
      <button class="sheetbtn" id="btnCloseUser">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
    <div class="hr"></div>
    <div class="sub" id="userSub">â€”</div>
    <div class="hr"></div>
    <div id="userBody"></div>
  </div>
</div>

<!-- Pay overlay -->
<div class="overlay" id="payOv">
  <div class="sheet">
    <div class="sheethead">
      <div class="sheettitle" id="payTitle">Î Î»Î·ÏÏ‰Î¼Î®</div>
      <button class="sheetbtn" id="btnClosePay">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
    <div class="hr"></div>
    <div class="sub">Î•Ï€Î¯Î»ÎµÎ¾Îµ items (split) ÎºÎ±Î¹ Î¼ÎµÏ„Î¬ Ï„ÏÏŒÏ€Î¿ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚.</div>
    <div class="hr"></div>
    <div id="payList"></div>
    <div class="hr"></div>
    <div class="sub" id="payTotal">Î¤ÎµÎ»Î¹ÎºÏŒ: 0,00 â‚¬</div>
    <div style="height:10px;"></div>
    <div class="sheetbtnrow">
      <button class="sheetbtn ok" id="btnPayCash">ğŸ’¶ ÎœÎµÏ„ÏÎ·Ï„Î¬</button>
      <button class="sheetbtn primary" id="btnPayCard">ğŸ’³ ÎšÎ¬ÏÏ„Î±</button>
      <button class="sheetbtn" style="border-color:rgba(255,176,32,.55)" id="btnPayFree">ğŸ ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±</button>
      <button class="sheetbtn" id="btnSelAll">Î•Ï€Î¯Î»ÎµÎ¾Îµ ÏŒÎ»Î±</button>
    </div>
  </div>
</div>

<!-- QuickPay overlay -->
<div class="overlay" id="qpayOv">
  <div class="sheet">
    <div class="sheethead">
      <div class="sheettitle" id="qpayTitle">â€”</div>
      <button class="sheetbtn" id="btnCloseQPay">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
    <div class="hr"></div>
    <div class="sub" id="qpaySub">â€”</div>
    <div class="hr"></div>
    <div class="sheetbtnrow" id="qpayBtns"></div>
  </div>
</div>

<!-- PIN Overlay (numeric keyboard) -->
<div class="overlay" id="pinOv" style="align-items:center;">
  <div class="pinBox">
    <div class="sheethead">
      <div class="pinTitle" id="pinTitle">PIN</div>
      <button class="sheetbtn" id="pinCancel">Î†ÎºÏ…ÏÎ¿</button>
    </div>
    <div class="pinSub" id="pinSub">â€”</div>
    <input
      class="pinInput"
      id="pinInput"
      type="password"
      inputmode="numeric"
      pattern="[0-9]*"
      maxlength="4"
      autocomplete="one-time-code"
      placeholder="â€¢â€¢â€¢â€¢"
    />
    <div class="hr"></div>
    <div class="sheetbtnrow" style="justify-content:flex-end;">
      <button class="sheetbtn primary" id="pinOk">ÎŸÎš</button>
    </div>
  </div>
</div>

<!-- Screensaver -->
<div class="screensaver" id="ss">
  <div class="ssCenter">
    <div class="ssLogo" id="ssLogo">â€”</div>
    <div class="ssUser" id="ssUser">â€”</div>
    <div class="ssHint">Î Î¬Ï„Î·ÏƒÎµ Î¿Ï€Î¿Ï…Î´Î®Ï€Î¿Ï„Îµ Î³Î¹Î± ÎµÏ€Î¹ÏƒÏ„ÏÎ¿Ï†Î®</div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast">
  <div class="t" id="toastT">â€”</div>
  <div class="s" id="toastS">â€”</div>
</div>

<script>
/* ===================== STORAGE ===================== */
const LS_DB = "dcash_db_v2";
const LS_USERS = "dcash_users_v2";
const LS_ACTIVE = "dcash_active_user_v2";
const LS_SHOP = "dcash_shop_v2";
const LS_ADMIN_HASH = "dcash_admin_hash_v2";
const LS_FAVS = "dcash_favs_v2";

/* ===================== CONFIG ===================== */
const TODAY = new Date().toISOString().slice(0,10);
const IDLE_HOME_MS = 35000;          // 30-40s -> Home
const IDLE_SCREENSAVER_EXTRA = 12000; // +few seconds -> Screensaver
const TABLES = ["T1","T2","T3","T4","T5","T6","T7","T8","BAR","Î•ÎÎ©"];
const CATS = [
  {id:"coffee", label:"â˜• ÎšÎ±Ï†Î­Î´ÎµÏ‚", allowed:["coffee_hot","coffee_cold","tea","choco","extras"]},
  {id:"snack",  label:"ğŸ¥ Î£Î½Î±Îº", allowed:["snack"]},
  {id:"drinks", label:"ğŸº Î Î¿Ï„Î¬", allowed:["beer","wine","spirit","cocktail"]},
  {id:"soft",   label:"ğŸ¥¤ Î‘Î½Î±ÏˆÏ…ÎºÏ„Î¹ÎºÎ¬", allowed:["soft","juice"]},
];

const PRODUCTS = [
  {cat:"coffee_hot", name:"Espresso Î¼Î¿Î½ÏŒÏ‚", price:2.60},
  {cat:"coffee_hot", name:"Espresso Î´Î¹Ï€Î»ÏŒÏ‚", price:3.20},
  {cat:"coffee_hot", name:"Espresso macchiato", price:2.90},
  {cat:"coffee_hot", name:"Americano", price:3.20},
  {cat:"coffee_hot", name:"Cappuccino", price:3.60},
  {cat:"coffee_hot", name:"Cappuccino Î´Î¹Ï€Î»ÏŒÏ‚", price:4.20},
  {cat:"coffee_hot", name:"Latte macchiato", price:4.20},
  {cat:"coffee_hot", name:"Flat white", price:4.40},
  {cat:"coffee_hot", name:"Mocha", price:4.50},
  {cat:"coffee_hot", name:"ÎšÎ±Ï†Î­Ï‚ Ï†Î¯Î»Ï„ÏÎ¿Ï…", price:3.00},
  {cat:"extras", name:"Decaf (+)", price:0.30},

  {cat:"coffee_cold", name:"Freddo espresso", price:3.80},
  {cat:"coffee_cold", name:"Freddo cappuccino", price:4.20},
  {cat:"coffee_cold", name:"Iced latte", price:4.50},
  {cat:"coffee_cold", name:"Cold brew", price:4.80},
  {cat:"coffee_cold", name:"Frappe", price:3.50},

  {cat:"tea", name:"Î¤ÏƒÎ¬Î¹ (Î¼Î±ÏÏÎ¿, Ï€ÏÎ¬ÏƒÎ¹Î½Î¿, Î²ÏŒÏ„Î±Î½Î±)", price:3.20},
  {cat:"tea", name:"Î¤ÏƒÎ¬Î¹ Ï†ÏÎ¿ÏÏ„Ï‰Î½", price:3.50},
  {cat:"tea", name:"Chai latte", price:4.30},

  {cat:"choco", name:"Î–ÎµÏƒÏ„Î® ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:4.20},
  {cat:"choco", name:"ÎšÏÏÎ± ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:4.50},
  {cat:"choco", name:"Î›ÎµÏ…ÎºÎ® ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:4.50},
  {cat:"choco", name:"ÎšÎ±ÎºÎ¬Î¿", price:4.00},
  {cat:"extras", name:"Î¦Ï…Ï„Î¹ÎºÏŒ Î³Î¬Î»Î± (Î²ÏÏÎ¼Î·Ï‚/Î±Î¼Ï…Î³Î´Î¬Î»Î¿Ï…) (+)", price:0.50},

  {cat:"soft", name:"Coca-Cola / Zero / Fanta (0,33l)", price:3.40},
  {cat:"soft", name:"Ice Tea", price:3.60},
  {cat:"soft", name:"Î£ÏŒÎ´Î± / Î¤ÏŒÎ½Î¹Îº", price:3.20},
  {cat:"soft", name:"ÎœÎµÏ„Î±Î»Î»Î¹ÎºÏŒ Î½ÎµÏÏŒ (0,33l)", price:2.80},
  {cat:"soft", name:"ÎœÎµÏ„Î±Î»Î»Î¹ÎºÏŒ Î½ÎµÏÏŒ (0,75l)", price:5.50},

  {cat:"juice", name:"Î¦Ï…ÏƒÎ¹ÎºÏŒÏ‚ Ï‡Ï…Î¼ÏŒÏ‚ Ï€Î¿ÏÏ„Î¿ÎºÎ¬Î»Î¹", price:4.50},
  {cat:"juice", name:"Î§Ï…Î¼ÏŒÏ‚ Î±Î½Î¬Î¼ÎµÎ¹ÎºÏ„Î¿Ï‚", price:4.80},
  {cat:"juice", name:"Smoothie Ï†ÏÎ¿ÏÏ„Ï‰Î½", price:5.80},
  {cat:"juice", name:"Milkshake", price:5.50},

  {cat:"snack", name:"ÎšÏÎ¿Ï…Î±ÏƒÎ¬Î½ ÏƒÎºÎ­Ï„Î¿", price:2.80},
  {cat:"snack", name:"ÎšÏÎ¿Ï…Î±ÏƒÎ¬Î½ ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:3.20},
  {cat:"snack", name:"ÎœÎ¬Ï†Î¹Î½", price:3.50},
  {cat:"snack", name:"ÎšÎ­Î¹Îº (ÎºÎ¿Î¼Î¼Î¬Ï„Î¹)", price:4.20},
  {cat:"snack", name:"Cheesecake", price:4.80},
  {cat:"snack", name:"ÎœÏ€Î¹ÏƒÎºÏŒÏ„Î±", price:2.50},
  {cat:"snack", name:"Î¤Î¿ÏƒÏ„ Î¶Î±Î¼Ï€ÏŒÎ½-Ï„Ï…ÏÎ¯", price:4.50},
  {cat:"snack", name:"Î¤Î¿ÏƒÏ„ vegetarian", price:4.80},

  {cat:"beer", name:"ÎœÏ€ÏÏÎ± Î²Î±ÏÎµÎ»Î¯ÏƒÎ¹Î± (0,5l)", price:5.20},
  {cat:"beer", name:"ÎœÏ€ÏÏÎ± ÎµÎ¼Ï†Î¹Î±Î»Ï‰Î¼Î­Î½Î· (0,33l)", price:4.20},
  {cat:"beer", name:"Weissbier (0,5l)", price:5.50},
  {cat:"beer", name:"ÎœÏ€ÏÏÎ± Ï‡Ï‰ÏÎ¯Ï‚ Î±Î»ÎºÎ¿ÏŒÎ»", price:4.20},

  {cat:"wine", name:"ÎšÏÎ±ÏƒÎ¯ Ï€Î¿Ï„Î®ÏÎ¹", price:5.50},
  {cat:"wine", name:"ÎšÏÎ±ÏƒÎ¯ ÎºÎ±ÏÎ¬Ï†Î± (0,5l)", price:12.00},
  {cat:"wine", name:"Î¦Î¹Î¬Î»Î· ÎºÏÎ±ÏƒÎ¯ (Î±Ï€ÏŒ)", price:22.00},
  {cat:"wine", name:"Prosecco Ï€Î¿Ï„Î®ÏÎ¹", price:6.50},

  {cat:"spirit", name:"ÎŸÏ…Î¯ÏƒÎºÎ¹ standard", price:8.50},
  {cat:"spirit", name:"Premium Î¿Ï…Î¯ÏƒÎºÎ¹", price:10.50},
  {cat:"spirit", name:"Î’ÏŒÏ„ÎºÎ±", price:8.00},
  {cat:"spirit", name:"Î¡Î¿ÏÎ¼Î¹", price:8.50},
  {cat:"spirit", name:"Î¤Î¶Î¹Î½", price:8.50},
  {cat:"spirit", name:"ÎŸÏÎ¶Î¿ / Î¤ÏƒÎ¯Ï€Î¿Ï…ÏÎ¿", price:7.50},
  {cat:"spirit", name:"Î›Î¹ÎºÎ­Ï", price:7.50},

  {cat:"cocktail", name:"Mojito", price:9.50},
  {cat:"cocktail", name:"Caipirinha", price:9.50},
  {cat:"cocktail", name:"Margarita", price:10.00},
  {cat:"cocktail", name:"Aperol Spritz", price:8.50},
  {cat:"cocktail", name:"Gin Tonic", price:9.00},
  {cat:"cocktail", name:"Negroni", price:10.50},
];

/* ===================== HELPERS ===================== */
const $ = (id)=>document.getElementById(id);
const fmt = (n)=> (n||0).toLocaleString("el-GR",{minimumFractionDigits:2,maximumFractionDigits:2})+" â‚¬";
const uid = ()=> Math.random().toString(36).slice(2)+Date.now().toString(36);
function load(key, fallback){ try{ const raw=localStorage.getItem(key); return raw?JSON.parse(raw):fallback; } catch{ return fallback; } }
function save(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
function toast(t,s){
  $("toastT").textContent=t; $("toastS").textContent=s;
  $("toast").classList.add("show");
  setTimeout(()=>$("toast").classList.remove("show"), 2200);
}
function vibrate(ms){ try{ if(navigator.vibrate) navigator.vibrate(ms);}catch{} }
async function sha256Hex(str){
  const enc=new TextEncoder().encode(str);
  const buf=await crypto.subtle.digest("SHA-256", enc);
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
}
function isPin(p){ return /^\d{4}$/.test(p||""); }

/* ===================== PIN MODAL (numeric keyboard) ===================== */
let pinResolve = null;

function pinOpen({title="PIN", sub="", cancelText="Î†ÎºÏ…ÏÎ¿", okText="ÎŸÎš"} = {}){
  $("pinTitle").textContent = title;
  $("pinSub").textContent = sub || "";
  $("pinCancel").textContent = cancelText;
  $("pinOk").textContent = okText;
  $("pinInput").value = "";
  $("pinOv").classList.add("show");

  // focus after showing
  setTimeout(()=>{ $("pinInput").focus(); }, 50);

  return new Promise((resolve)=>{
    pinResolve = resolve;
  });
}

function pinClose(result){
  $("pinOv").classList.remove("show");
  const r = pinResolve;
  pinResolve = null;
  if(r) r(result);
}

$("pinCancel").onclick = ()=> pinClose(null);
$("pinOk").onclick = ()=> pinClose(($("pinInput").value||"").trim());
$("pinInput").addEventListener("keydown",(e)=>{
  if(e.key==="Enter") pinClose(($("pinInput").value||"").trim());
});

/* ===================== SCREENSAVER ===================== */
function showScreensaver(){
  $("ssLogo").textContent = getShopName();
  $("ssUser").textContent = `Î•Î½ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±: ${getActiveUser().name}`;
  $("ss").classList.add("show");
}
function hideScreensaver(){
  $("ss").classList.remove("show");
}
$("ss").addEventListener("click", ()=>{
  hideScreensaver();
  resetIdleTimers();
});

/* ===================== IDLE -> HOME -> SCREENSAVER ===================== */
let idleTimerHome=null;
let idleTimerSS=null;

function closeAllOverlays(){
  ["settingsOv","summaryOv","userOv","payOv","qpayOv","pinOv"].forEach(id=>$(id).classList.remove("show"));
}
function goHome(){
  closeAllOverlays();
  showView("home");
  renderAll();
}
function resetIdleTimers(){
  hideScreensaver();
  if(idleTimerHome) clearTimeout(idleTimerHome);
  if(idleTimerSS) clearTimeout(idleTimerSS);

  idleTimerHome = setTimeout(()=>{ goHome(); }, IDLE_HOME_MS);
  idleTimerSS = setTimeout(()=>{ showScreensaver(); }, IDLE_HOME_MS + IDLE_SCREENSAVER_EXTRA);
}
["click","touchstart","scroll","keydown","input"].forEach(ev=>{
  document.addEventListener(ev, resetIdleTimers, {capture:true, passive:true});
});
resetIdleTimers();

/* ===================== USERS ===================== */
function ensureUsers(){
  let users=load(LS_USERS,null);
  if(!users || !Array.isArray(users) || users.length===0){
    users=[{id:uid(), name:"Î§ÏÎ®ÏƒÏ„Î·Ï‚ 1", pinHash:null}];
    save(LS_USERS, users);
    save(LS_ACTIVE, users[0].id);
  }
  return users;
}
function getActiveUserId(){
  const users=ensureUsers();
  const a=load(LS_ACTIVE,null);
  if(a && users.some(u=>u.id===a)) return a;
  save(LS_ACTIVE, users[0].id);
  return users[0].id;
}
function getActiveUser(){
  const users=ensureUsers();
  return users.find(u=>u.id===getActiveUserId()) || users[0];
}
async function requireUserPinIfExists(user, reason){
  if(!user.pinHash) return true;
  const pin = await pinOpen({
    title: "ğŸ”’ PIN",
    sub: `PIN Î±Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ (${reason}).\nÎ“ÏÎ¬ÏˆÎµ 4 ÏˆÎ·Ï†Î¯Î±.`,
    cancelText: "Î†ÎºÏ…ÏÎ¿",
    okText: "Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·"
  });
  if(!pin) return false;
  if(!isPin(pin)){ alert("Î†ÎºÏ…ÏÎ¿ PIN."); return false; }
  const h=await sha256Hex(pin);
  if(h!==user.pinHash){ alert("Î›Î¬Î¸Î¿Ï‚ PIN."); return false; }
  return true;
}
async function changeUser(newId){
  const users=ensureUsers();
  const u=users.find(x=>x.id===newId);
  if(!u) return;
  const ok=await requireUserPinIfExists(u, "Î‘Î»Î»Î±Î³Î® Ï‡ÏÎ®ÏƒÏ„Î·");
  if(!ok){ $("userSelect").value=getActiveUserId(); return; }
  save(LS_ACTIVE, u.id);
  renderAll();
}

/* ===================== SHOP (Admin PIN) ===================== */
function getShopName(){ return load(LS_SHOP,null)?.name || "Î¤Î¿ ÎœÎ±Î³Î±Î¶Î¯"; }
function setShopName(name){ save(LS_SHOP,{name}); }

async function ensureAdminPin(){
  let h = localStorage.getItem(LS_ADMIN_HASH);
  if(h) return h;

  alert("Î ÏÏÏ„Î· Ï†Î¿ÏÎ¬: ÎŒÏÎ¹ÏƒÎµ Admin PIN (4 ÏˆÎ·Ï†Î¯Î±).");
  const p1 = await pinOpen({title:"Admin PIN", sub:"Î“ÏÎ¬ÏˆÎµ 4 ÏˆÎ·Ï†Î¯Î± Î³Î¹Î± Admin PIN", cancelText:"Î†ÎºÏ…ÏÎ¿", okText:"Î£Ï…Î½Î­Ï‡ÎµÎ¹Î±"});
  if(!p1) return null;
  if(!isPin(p1)){ alert("Î†ÎºÏ…ÏÎ¿ PIN."); return null; }

  const p2 = await pinOpen({title:"Admin PIN", sub:"ÎÎ±Î½Î¬ Admin PIN (ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·)", cancelText:"Î†ÎºÏ…ÏÎ¿", okText:"Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·"});
  if(!p2) return null;
  if(p2!==p1){ alert("Î”ÎµÎ½ Ï„Î±Î¹ÏÎ¹Î¬Î¶Î¿Ï…Î½."); return null; }

  h = await sha256Hex(p1);
  localStorage.setItem(LS_ADMIN_HASH, h);
  return h;
}

async function verifyAdminPin(reason){
  const h = localStorage.getItem(LS_ADMIN_HASH) || await ensureAdminPin();
  if(!h) return false;

  const p = await pinOpen({title:"Admin PIN", sub:`Admin PIN Î±Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ (${reason}).`, cancelText:"Î†ÎºÏ…ÏÎ¿", okText:"ÎŸÎš"});
  if(!p) return false;
  if(!isPin(p)) return false;

  const ph = await sha256Hex(p);
  if(ph!==h){ alert("Î›Î¬Î¸Î¿Ï‚ Admin PIN."); return false; }
  return true;
}

/* ===================== DB ===================== */
function ensureDB(){
  const db=load(LS_DB, {days:{}});
  if(!db.days[TODAY]){
    db.days[TODAY]={
      meta:{ day:TODAY, activeTable:"T1", activeCat:"coffee", showOnlyOpen:true },
      tables:{},
      payments:[],
      undo:[]
    };
    for(const t of TABLES) db.days[TODAY].tables[t]={lines:[]};
    save(LS_DB, db);
  } else {
    for(const t of TABLES){
      if(!db.days[TODAY].tables[t]) db.days[TODAY].tables[t]={lines:[]};
      if(!Array.isArray(db.days[TODAY].tables[t].lines)) db.days[TODAY].tables[t].lines=[];
    }
    if(!Array.isArray(db.days[TODAY].payments)) db.days[TODAY].payments=[];
    if(!Array.isArray(db.days[TODAY].undo)) db.days[TODAY].undo=[];
    if(!db.days[TODAY].meta.activeCat) db.days[TODAY].meta.activeCat="coffee";
    if(typeof db.days[TODAY].meta.showOnlyOpen!=="boolean") db.days[TODAY].meta.showOnlyOpen=true;
  }
  return db;
}
function getLines(db, table){ return db.days[TODAY].tables[table].lines; }
function openLines(lines){ return lines.filter(x=>!x.paid); }
function sumOpen(db, t){ return openLines(getLines(db,t)).reduce((s,x)=>s+x.price,0); }
function cntOpen(db, t){ return openLines(getLines(db,t)).length; }
function dayStats(db){
  let openTables=0, openItems=0;
  for(const t of TABLES){
    const c=cntOpen(db,t);
    if(c>0) openTables++;
    openItems+=c;
  }
  const paidTotal=db.days[TODAY].payments.reduce((s,p)=>s+p.total,0);
  const cash=db.days[TODAY].payments.filter(p=>p.method==="cash").reduce((s,p)=>s+p.total,0);
  const card=db.days[TODAY].payments.filter(p=>p.method==="card").reduce((s,p)=>s+p.total,0);
  const free=db.days[TODAY].payments.filter(p=>p.method==="free").reduce((s,p)=>s+p.total,0);
  return {openTables, openItems, paidTotal, cash, card, free};
}

/* ===================== FAVORITES (Top8) ===================== */
function loadFavs(){ return load(LS_FAVS,{day:TODAY, counts:{}}); }
function saveFavs(f){ save(LS_FAVS,f); }
function bumpFav(name){
  let f=loadFavs();
  if(f.day!==TODAY) f={day:TODAY, counts:{}};
  f.counts[name]=(f.counts[name]||0)+1;
  saveFavs(f);
}
function top8(){
  const f=loadFavs();
  const counts = (f.day===TODAY)? f.counts : {};
  const names = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,8).map(x=>x[0]);
  const arr = names.map(n=>PRODUCTS.find(p=>p.name===n)).filter(Boolean);
  for(const p of PRODUCTS){
    if(arr.length>=8) break;
    if(!arr.some(x=>x.name===p.name) && p.cat!=="extras") arr.push(p);
  }
  return arr.slice(0,8);
}

/* ===================== GROUP OPEN BY PRODUCT ===================== */
function groupOpen(lines){
  const map=new Map();
  for(const l of lines){
    if(l.paid) continue;
    const k=l.name+"||"+l.price.toFixed(2);
    if(!map.has(k)) map.set(k,{name:l.name, price:l.price, ids:[], lastAt:0});
    const g=map.get(k);
    g.ids.push(l.id);
    g.lastAt=Math.max(g.lastAt, l.at||0);
  }
  return [...map.values()].sort((a,b)=>b.lastAt-a.lastAt);
}

/* ===================== ADD/REMOVE ===================== */
function addItem(name, price){
  const db=ensureDB();
  const t=db.days[TODAY].meta.activeTable;
  const line={id:uid(), name, price, at:Date.now(), by:getActiveUser().name, paid:null};
  db.days[TODAY].tables[t].lines.push(line);
  bumpFav(name);
  db.days[TODAY].undo.unshift({type:"add", table:t, line});
  db.days[TODAY].undo=db.days[TODAY].undo.slice(0,25);
  save(LS_DB, db);
}
function removeOne(name, price){
  const db=ensureDB();
  const t=db.days[TODAY].meta.activeTable;
  const lines=db.days[TODAY].tables[t].lines;
  const idx=lines.findIndex(x=>!x.paid && x.name===name && x.price===price);
  if(idx>=0){
    const removed=lines.splice(idx,1)[0];
    db.days[TODAY].undo.unshift({type:"remove", table:t, line:removed});
    db.days[TODAY].undo=db.days[TODAY].undo.slice(0,25);
    save(LS_DB, db);
  }
}
function undo(){
  const db=ensureDB();
  const a=db.days[TODAY].undo.shift();
  if(!a){ toast("Undo","Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎºÎ¬Ï„Î¹."); return; }
  if(a.type==="add"){
    const lines=db.days[TODAY].tables[a.table].lines;
    const i=lines.findIndex(x=>x.id===a.line.id);
    if(i>=0) lines.splice(i,1);
    toast("Undo","Î‘Ï†Î±Î¹ÏÎ­Î¸Î·ÎºÎµ item.");
  } else if(a.type==="remove"){
    db.days[TODAY].tables[a.table].lines.push(a.line);
    toast("Undo","Î•Ï€Î±Î½Î±Ï†Î­ÏÎ¸Î·ÎºÎµ item.");
  } else if(a.type==="pay"){
    const lines=db.days[TODAY].tables[a.table].lines;
    for(const l of lines) if(a.itemIds.includes(l.id)) l.paid=null;
    db.days[TODAY].payments=db.days[TODAY].payments.filter(p=>p.id!==a.paymentId);
    toast("Undo","Î‘Î½Î±Î¹ÏÎ­Î¸Î·ÎºÎµ Ï€Î»Î·ÏÏ‰Î¼Î®.");
  }
  save(LS_DB, db);
  renderAll();
}

/* ===================== PAY (Split + QuickPay) ===================== */
const payState={ ids:new Set() };

function openPay(){
  payState.ids=new Set();
  renderPayList();
  $("payOv").classList.add("show");
}
function closePay(){ $("payOv").classList.remove("show"); }

function renderPayList(){
  const db=ensureDB();
  const t=db.days[TODAY].meta.activeTable;
  const open=openLines(getLines(db,t));
  $("payTitle").textContent = `Î Î»Î·ÏÏ‰Î¼Î® â€” ${t} â€¢ Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ ${fmt(sumOpen(db,t))}`;
  const box=$("payList");
  box.innerHTML="";
  for(const l of open){
    const r=document.createElement("div");
    r.className="row";
    r.innerHTML=`
      <div class="leftcol">
        <div class="title">${l.name}</div>
        <div class="mini">${l.by} â€¢ ${new Date(l.at).toLocaleTimeString("el-GR",{hour:"2-digit",minute:"2-digit"})}</div>
      </div>
      <div class="ctrls">
        <span class="badge">${fmt(l.price)}</span>
        <input type="checkbox" style="width:22px;height:22px;accent-color:var(--accent)" />
      </div>
    `;
    const cb=r.querySelector("input");
    cb.checked=payState.ids.has(l.id);
    cb.onchange=()=>{ cb.checked ? payState.ids.add(l.id) : payState.ids.delete(l.id); updatePayTotal(); };
    r.onclick=(e)=>{ if(e.target.tagName.toLowerCase()==="input") return; cb.checked=!cb.checked; cb.dispatchEvent(new Event("change")); };
    box.appendChild(r);
  }
  updatePayTotal();
}
function updatePayTotal(){
  const db=ensureDB();
  const t=db.days[TODAY].meta.activeTable;
  const open=openLines(getLines(db,t));
  const sel=open.filter(x=>payState.ids.has(x.id));
  const total=sel.reduce((s,x)=>s+x.price,0);
  $("payTotal").textContent = `Î¤ÎµÎ»Î¹ÎºÏŒ: ${fmt(total)} (${sel.length} items)`;
}
function selectAllPay(){
  const db=ensureDB();
  const t=db.days[TODAY].meta.activeTable;
  const open=openLines(getLines(db,t));
  if(payState.ids.size===open.length){
    payState.ids=new Set();
  } else {
    payState.ids=new Set(open.map(x=>x.id));
  }
  renderPayList();
}

function confirmPaymentIfNeeded(method,total,count){
  if(method==="free") return confirm(`Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· ÎšÎ•Î¡Î‘Î£ÎœÎ•ÎÎ‘\nItems: ${count}\nÎ£ÏÎ½Î¿Î»Î¿: ${fmt(total)}\nÎÎ± ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ·Î¸ÎµÎ¯;`);
  if(total>=15 || count>=3) return confirm(`Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚\nItems: ${count}\nÎ£ÏÎ½Î¿Î»Î¿: ${fmt(total)}\nÎÎ± ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ·Î¸ÎµÎ¯;`);
  return true;
}

function payIds(table, ids, method, fromQuick=false){
  const db=ensureDB();
  const lines=getLines(db,table);
  const now=Date.now();
  const user=getActiveUser().name;

  let total=0;
  const realIds=[];
  for(const l of lines){
    if(ids.includes(l.id) && !l.paid){
      total+=l.price;
      realIds.push(l.id);
    }
  }
  if(realIds.length===0) return;

  if(!confirmPaymentIfNeeded(method,total,realIds.length)) return;

  for(const l of lines) if(realIds.includes(l.id)) l.paid={method, at:now, by:user};

  const pid=uid();
  db.days[TODAY].payments.push({id:pid, at:now, table, user, method, total, itemIds:realIds});
  db.days[TODAY].undo.unshift({type:"pay", paymentId:pid, table, itemIds:realIds});
  db.days[TODAY].undo=db.days[TODAY].undo.slice(0,25);

  save(LS_DB, db);

  if(!fromQuick){
    closePay();
    goHome(); // Î¼ÎµÏ„Î¬ Ï„Î·Î½ Ï€Î»Î·ÏÏ‰Î¼Î® -> Home
  } else {
    if(cntOpen(db, table)===0) goHome();
  }
}

function doPay(method){
  const db=ensureDB();
  const t=db.days[TODAY].meta.activeTable;
  const open=openLines(getLines(db,t));
  const sel=open.filter(x=>payState.ids.has(x.id));
  if(sel.length===0){ alert("Î”Î¹Î¬Î»ÎµÎ¾Îµ items."); return; }
  payIds(t, sel.map(x=>x.id), method, false);
  toast("âœ… Î Î»Î·ÏÏ‰Î¼Î®", `${t} â€” ${fmt(sel.reduce((s,x)=>s+x.price,0))}`);
  renderAll();
}

/* Quick pay */
function openQuickPay(table, g, method){
  const label = method==="cash"?"ğŸ’¶ ÎœÎµÏ„ÏÎ·Ï„Î¬":method==="card"?"ğŸ’³ ÎšÎ¬ÏÏ„Î±":"ğŸ ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±";
  $("qpayTitle").textContent = `${label} â€” ${g.name}`;
  $("qpaySub").textContent = `Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î±: ${g.ids.length} Ã— ${fmt(g.price)}. Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï€ÏŒÏƒÎ± Î½Î± ÎºÎ»ÎµÎ¯ÏƒÎ¿Ï…Î½ Ï„ÏÏÎ±.`;

  const box=$("qpayBtns");
  box.innerHTML="";
  const max=g.ids.length;
  const opts = max<=8 ? Array.from({length:max},(_,i)=>i+1) : [1,2,3,4,5,max];
  for(const n of opts){
    const b=document.createElement("button");
    b.className="sheetbtn";
    b.textContent = `${n}`;
    b.onclick=()=>{ payIds(table, g.ids.slice(0,n), method, true); $("qpayOv").classList.remove("show"); renderAll(); };
    box.appendChild(b);
  }
  $("qpayOv").classList.add("show");
}

/* ===================== SUMMARY ===================== */
function paymentsByUser(db){
  const users=ensureUsers();
  const map={};
  for(const u of users) map[u.name]={cash:0,card:0,free:0,count:0,total:0};
  for(const p of db.days[TODAY].payments){
    if(!map[p.user]) map[p.user]={cash:0,card:0,free:0,count:0,total:0};
    map[p.user][p.method]+=p.total;
    map[p.user].count+=1;
    map[p.user].total+=p.total;
  }
  return Object.entries(map).map(([name,v])=>({name,...v})).sort((a,b)=>b.total-a.total);
}
function topProductsToday(db, limit=5){
  const counts={};
  for(const t of TABLES){
    for(const l of getLines(db,t)){
      counts[l.name]=(counts[l.name]||0)+1;
    }
  }
  return Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,limit).map(([name,c])=>({name,count:c}));
}
function openSummary(){
  renderSummary();
  $("summaryOv").classList.add("show");
}
function closeSummary(){ $("summaryOv").classList.remove("show"); }

function openUserDetails(name){
  const db=ensureDB();
  const pay=db.days[TODAY].payments.filter(p=>p.user===name).sort((a,b)=>b.at-a.at);
  const sums={cash:0,card:0,free:0,total:0,count:pay.length};
  for(const p of pay){ sums[p.method]+=p.total; sums.total+=p.total; }
  $("userTitle").textContent = `ğŸ‘¤ ${name}`;
  $("userSub").textContent = `Î Î»Î·ÏÏ‰Î¼Î­Ï‚: ${sums.count} â€¢ ÎœÎµÏ„ÏÎ·Ï„Î¬: ${fmt(sums.cash)} â€¢ ÎšÎ¬ÏÏ„Î±: ${fmt(sums.card)} â€¢ ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±: ${fmt(sums.free)} â€¢ Î£ÏÎ½Î¿Î»Î¿: ${fmt(sums.total)}`;
  const body=$("userBody");
  body.innerHTML="";
  if(pay.length===0){
    const d=document.createElement("div");
    d.className="sub";
    d.textContent="â€” Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚.";
    body.appendChild(d);
  } else {
    for(const p of pay.slice(0,200)){
      const r=document.createElement("div");
      r.className="row";
      r.style.borderTop="1px solid var(--line2)";
      r.innerHTML=`
        <div class="leftcol">
          <div class="title">${fmt(p.total)} <span class="badge">${p.method}</span></div>
          <div class="mini">${new Date(p.at).toLocaleTimeString("el-GR",{hour:"2-digit",minute:"2-digit",second:"2-digit"})} â€¢ ${p.table}</div>
        </div>
        <span class="badge">${p.itemIds?.length||0} items</span>
      `;
      body.appendChild(r);
    }
  }
  $("userOv").classList.add("show");
}

/* ===================== CSV ===================== */
function exportCSV(){
  const db=ensureDB();
  const rows=[];
  rows.push(["date","time","table","user","method","total","items"].join(","));
  for(const p of db.days[TODAY].payments){
    rows.push([
      TODAY,
      new Date(p.at).toLocaleTimeString("el-GR",{hour:"2-digit",minute:"2-digit",second:"2-digit"}),
      p.table,
      p.user,
      p.method,
      (p.total||0).toFixed(2),
      (p.itemIds?.length||0)
    ].join(","));
  }
  const blob=new Blob([rows.join("\n")],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`daily-cashier-${TODAY}.csv`;
  a.click();
}

/* ===================== WIPE ===================== */
function wipeAll(){
  if(!confirm("Î˜Î± ÏƒÎ²Î·ÏƒÏ„Î¿ÏÎ½ ÏŒÎ»Î± Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î±. Î£Ï…Î½Î­Ï‡ÎµÎ¹Î±;")) return;
  const word=prompt('Î“ÏÎ¬ÏˆÎµ Î±ÎºÏÎ¹Î²ÏÏ‚: DELETE');
  if(word!=="DELETE"){ alert("Î‘ÎºÏ…ÏÏÎ¸Î·ÎºÎµ."); return; }
  localStorage.removeItem(LS_DB);
  localStorage.removeItem(LS_USERS);
  localStorage.removeItem(LS_ACTIVE);
  localStorage.removeItem(LS_SHOP);
  localStorage.removeItem(LS_ADMIN_HASH);
  localStorage.removeItem(LS_FAVS);
  location.reload();
}

/* ===================== SETTINGS ACTIONS ===================== */
async function addUser(){
  const name=prompt("ÎŒÎ½Î¿Î¼Î± Î½Î­Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·:");
  if(!name) return;
  const users=ensureUsers();
  users.push({id:uid(), name:name.trim(), pinHash:null});
  save(LS_USERS, users);
  save(LS_ACTIVE, users[users.length-1].id);
  renderAll();
}
async function renameUser(){
  const u=getActiveUser();
  const ok=await requireUserPinIfExists(u, "ÎœÎµÏ„Î¿Î½Î¿Î¼Î±ÏƒÎ¯Î±");
  if(!ok) return;
  const name=prompt("ÎÎ­Î¿ ÏŒÎ½Î¿Î¼Î±:", u.name);
  if(!name) return;
  const users=ensureUsers();
  const i=users.findIndex(x=>x.id===u.id);
  users[i].name=name.trim();
  save(LS_USERS, users);
  renderAll();
}
async function setUserPin(){
  const u=getActiveUser();
  const ok=await requireUserPinIfExists(u, "Î‘Î»Î»Î±Î³Î® PIN");
  if(!ok) return;

  const p1 = await pinOpen({title:"PIN Ï‡ÏÎ®ÏƒÏ„Î·", sub:"ÎÎ­Î¿ 4-ÏˆÎ®Ï†Î¹Î¿ PIN", cancelText:"Î†ÎºÏ…ÏÎ¿", okText:"Î£Ï…Î½Î­Ï‡ÎµÎ¹Î±"});
  if(!p1) return;
  if(!isPin(p1)){ alert("Î†ÎºÏ…ÏÎ¿ PIN."); return; }

  const p2 = await pinOpen({title:"PIN Ï‡ÏÎ®ÏƒÏ„Î·", sub:"ÎÎ±Î½Î¬ PIN (ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·)", cancelText:"Î†ÎºÏ…ÏÎ¿", okText:"Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·"});
  if(!p2) return;
  if(p2!==p1){ alert("Î”ÎµÎ½ Ï„Î±Î¹ÏÎ¹Î¬Î¶Î¿Ï…Î½."); return; }

  const users=ensureUsers();
  const i=users.findIndex(x=>x.id===u.id);
  users[i].pinHash=await sha256Hex(p1);
  save(LS_USERS, users);
  alert("PIN ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ.");
}
async function delUser(){
  const u=getActiveUser();
  const ok=await requireUserPinIfExists(u, "Î”Î¹Î±Î³ÏÎ±Ï†Î® Ï‡ÏÎ®ÏƒÏ„Î·");
  if(!ok) return;
  const users=ensureUsers();
  if(users.length<=1){ alert("Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 1 Ï‡ÏÎ®ÏƒÏ„Î·Ï‚."); return; }
  if(!confirm(`ÎÎ± Î´Î¹Î±Î³ÏÎ±Ï†ÎµÎ¯ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ "${u.name}";`)) return;
  const left=users.filter(x=>x.id!==u.id);
  save(LS_USERS, left);
  save(LS_ACTIVE, left[0].id);
  renderAll();
}
async function changeShop(){
  const ok=await verifyAdminPin("Î‘Î»Î»Î±Î³Î® Î¿Î½ÏŒÎ¼Î±Ï„Î¿Ï‚ Î¼Î±Î³Î±Î¶Î¹Î¿Ï");
  if(!ok) return;
  const cur=getShopName();
  const name=prompt("ÎÎ­Î¿ ÏŒÎ½Î¿Î¼Î± Î¼Î±Î³Î±Î¶Î¹Î¿Ï:", cur);
  if(!name) return;
  setShopName(name.trim());
  toast("ğŸ· ÎŒÎ½Î¿Î¼Î±","Î‘Î»Î»Î¬Ï‡Ï„Î·ÎºÎµ.");
  renderAll();
}

/* ===================== VIEWS ===================== */
let view="home";
function showView(v){
  view=v;
  $("viewHome").classList.toggle("show", v==="home");
  $("viewTables").classList.toggle("show", v==="tables");
  $("viewTicket").classList.toggle("show", v==="ticket");
}

/* ===================== RENDER ===================== */
function renderTop(){
  $("shopName").textContent=getShopName();
  const u=getActiveUser();
  const stats=dayStats(ensureDB());
  $("topSub").textContent = `Î£Î®Î¼ÎµÏÎ± ${TODAY.split("-").reverse().join("/")} â€¢ Î§ÏÎ®ÏƒÏ„Î·Ï‚: ${u.name} â€¢ Î‘Î½Î¿Î¹Ï‡Ï„Î¬: ${stats.openTables} / ${stats.openItems}`;

  const users=ensureUsers();
  $("userSelect").innerHTML = users.map(x=>`<option value="${x.id}">${x.name}</option>`).join("");
  $("userSelect").value = getActiveUserId();
}

function renderHome(){
  const db=ensureDB();
  const st=dayStats(db);
  $("openCountMeta").textContent = `${st.openTables} Ï„ÏÎ±Ï€Î­Î¶Î¹Î±`;
  $("homeStats").textContent =
    `Î‘Î½Î¿Î¹Ï‡Ï„Î¬ Ï„ÏÎ±Ï€Î­Î¶Î¹Î±: ${st.openTables} â€¢ Î‘Î½Î¿Î¹Ï‡Ï„Î¬ items: ${st.openItems}\n`+
    `Î£ÏÎ½Î¿Î»Î¿ ÎµÎ¹ÏƒÏ€ÏÎ¬Î¾ÎµÏ‰Î½: ${fmt(st.paidTotal)} (ğŸ’¶ ${fmt(st.cash)} â€¢ ğŸ’³ ${fmt(st.card)} â€¢ ğŸ ${fmt(st.free)})`;
}

function renderTables(){
  const db=ensureDB();
  const onlyOpen=db.days[TODAY].meta.showOnlyOpen;
  $("btnToggleTables").textContent = onlyOpen ? "ÎœÏŒÎ½Î¿ Î±Î½Î¿Î¹Ï‡Ï„Î¬" : "ÎŒÎ»Î±";
  $("tablesSub").textContent = onlyOpen ? "Î”ÎµÎ¯Ï‡Î½ÎµÎ¹ Î¼ÏŒÎ½Î¿ ÏŒÏƒÎ± Î­Ï‡Î¿Ï…Î½ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿." : "Î”ÎµÎ¯Ï‡Î½ÎµÎ¹ ÏŒÎ»Î± Ï„Î± Ï„ÏÎ±Ï€Î­Î¶Î¹Î±.";

  const box=$("tablesList");
  box.innerHTML="";
  let shown=0;
  for(const t of TABLES){
    const c=cntOpen(db,t);
    const total=sumOpen(db,t);
    if(onlyOpen && c===0) continue;
    shown++;
    const r=document.createElement("div");
    r.className="row";
    if(shown>1) r.style.borderTop="1px solid var(--line2)";
    r.innerHTML=`
      <div class="leftcol">
        <div class="title">${t}</div>
        <div class="mini">${c} items Î±Î½Î¿Î¹Ï‡Ï„Î¬</div>
      </div>
      <div class="ctrls">
        <span class="badge">${fmt(total)}</span>
        <span class="badge">${c}</span>
      </div>
    `;
    r.onclick=()=>{
      const db2=ensureDB();
      db2.days[TODAY].meta.activeTable=t;
      save(LS_DB, db2);
      showView("ticket");
      renderAll();
    };
    box.appendChild(r);
  }
  if(shown===0){
    const d=document.createElement("div");
    d.className="sub";
    d.textContent="â€” Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î½Î¿Î¹Ï‡Ï„Î¬ Ï„ÏÎ±Ï€Î­Î¶Î¹Î±.";
    box.appendChild(d);
  }
}

function renderTicket(){
  const db=ensureDB();
  const t=db.days[TODAY].meta.activeTable;
  $("ticketSub").textContent = `${t} â€¢ Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ ${fmt(sumOpen(db,t))}`;

  renderOpenItems();
  renderTop8();
  renderCats();
  renderProducts();
}

function renderOpenItems(){
  const db=ensureDB();
  const t=db.days[TODAY].meta.activeTable;
  const groups=groupOpen(getLines(db,t));
  const box=$("openItemsList");
  box.innerHTML="";

  if(groups.length===0){
    const d=document.createElement("div");
    d.className="sub";
    d.textContent="â€” Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î½Î¿Î¹Ï‡Ï„Î¬ items.";
    box.appendChild(d);
    return;
  }

  let first=true;
  for(const g of groups){
    const qty=g.ids.length;
    const total=qty*g.price;
    const r=document.createElement("div");
    r.className="row";
    if(!first) r.style.borderTop="1px solid var(--line2)";
    first=false;
    r.innerHTML=`
      <div class="leftcol">
        <div class="title">${g.name}</div>
        <div class="mini">${qty} Ã— ${fmt(g.price)} = <b>${fmt(total)}</b></div>
      </div>
      <div class="ctrls">
        <div class="qty">
          <button class="qbtn" data-a="minus">âˆ’</button>
          <div class="qval">${qty}</div>
          <button class="qbtn" data-a="plus">+</button>
        </div>
        <div class="payicons">
          <button class="pbtn cash" data-p="cash">ğŸ’¶</button>
          <button class="pbtn card" data-p="card">ğŸ’³</button>
          <button class="pbtn free" data-p="free">ğŸ</button>
        </div>
      </div>
    `;

    r.querySelector('[data-a="plus"]').onclick=(e)=>{ e.stopPropagation(); addItem(g.name,g.price); vibrate(18); renderAll(); };
    r.querySelector('[data-a="minus"]').onclick=(e)=>{ e.stopPropagation(); removeOne(g.name,g.price); vibrate([12,25,12]); renderAll(); };

    const quick=(method)=>{
      if(g.ids.length===1){
        payIds(t, g.ids.slice(), method, true);
        toast("âœ… Î Î»Î·ÏÏÎ¸Î·ÎºÎµ", g.name);
        renderAll();
        return;
      }
      openQuickPay(t, g, method);
    };
    r.querySelector('[data-p="cash"]').onclick=(e)=>{ e.stopPropagation(); quick("cash"); };
    r.querySelector('[data-p="card"]').onclick=(e)=>{ e.stopPropagation(); quick("card"); };
    r.querySelector('[data-p="free"]').onclick=(e)=>{ e.stopPropagation(); quick("free"); };

    box.appendChild(r);
  }
}

function renderTop8(){
  const box=$("top8Row");
  box.innerHTML="";
  for(const p of top8()){
    const b=document.createElement("button");
    b.className="tab";
    b.textContent = `${p.name} â€¢ ${fmt(p.price)}`;
    b.onclick=()=>{ addItem(p.name,p.price); vibrate(18); renderAll(); };
    box.appendChild(b);
  }
}

function renderCats(){
  const db=ensureDB();
  const active=db.days[TODAY].meta.activeCat;
  const box=$("catTabs");
  box.innerHTML="";
  for(const c of CATS){
    const b=document.createElement("button");
    b.className="tab"+(c.id===active?" active":"");
    b.textContent=c.label;
    b.onclick=()=>{
      const db2=ensureDB();
      db2.days[TODAY].meta.activeCat=c.id;
      save(LS_DB, db2);
      renderProducts();
      renderCats();
    };
    box.appendChild(b);
  }
}

function renderProducts(){
  const db=ensureDB();
  const t=db.days[TODAY].meta.activeTable;
  const lines=openLines(getLines(db,t));
  const qtyMap={};
  for(const l of lines) qtyMap[l.name]=(qtyMap[l.name]||0)+1;

  const active=db.days[TODAY].meta.activeCat;
  const allowed=CATS.find(x=>x.id===active)?.allowed||[];
  const q=($("prodSearch").value||"").trim().toLowerCase();

  const list=PRODUCTS.filter(p=>allowed.includes(p.cat)).filter(p=>p.name.toLowerCase().includes(q));

  const box=$("productsList");
  box.innerHTML="";
  let first=true;
  for(const p of list){
    const qty=qtyMap[p.name]||0;
    const r=document.createElement("div");
    r.className="row";
    if(!first) r.style.borderTop="1px solid var(--line2)";
    first=false;
    r.innerHTML=`
      <div class="leftcol">
        <div class="title">${p.name}</div>
        <div class="mini">${fmt(p.price)}</div>
      </div>
      <div class="ctrls">
        <div class="qty">
          <button class="qbtn" data-a="minus">âˆ’</button>
          <div class="qval">${qty}</div>
          <button class="qbtn" data-a="plus">+</button>
        </div>
      </div>
    `;
    r.querySelector('[data-a="plus"]').onclick=(e)=>{ e.stopPropagation(); addItem(p.name,p.price); vibrate(18); renderAll(); };
    r.querySelector('[data-a="minus"]').onclick=(e)=>{ e.stopPropagation(); removeOne(p.name,p.price); vibrate([12,25,12]); renderAll(); };
    r.onclick=()=>{ addItem(p.name,p.price); vibrate(12); renderAll(); };
    box.appendChild(r);
  }
  if(list.length===0){
    const d=document.createElement("div");
    d.className="sub";
    d.textContent="â€” Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±.";
    box.appendChild(d);
  }
}

function renderSummary(){
  const db=ensureDB();
  const st=dayStats(db);
  $("summaryText").textContent =
    `Î‘Î½Î¿Î¹Ï‡Ï„Î¬ Ï„ÏÎ±Ï€Î­Î¶Î¹Î±: ${st.openTables} â€¢ Î‘Î½Î¿Î¹Ï‡Ï„Î¬ items: ${st.openItems}\n`+
    `Î£ÏÎ½Î¿Î»Î¿ ÎµÎ¹ÏƒÏ€ÏÎ¬Î¾ÎµÏ‰Î½: ${fmt(st.paidTotal)} (ğŸ’¶ ${fmt(st.cash)} â€¢ ğŸ’³ ${fmt(st.card)} â€¢ ğŸ ${fmt(st.free)})`;

  const top=topProductsToday(db,5);
  const topBox=$("topList");
  topBox.innerHTML="";
  if(top.length===0){
    const d=document.createElement("div");
    d.className="sub";
    d.textContent="â€” Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®ÏƒÎµÎ¹Ï‚ Î±ÎºÏŒÎ¼Î±.";
    topBox.appendChild(d);
  } else {
    let first=true;
    for(const it of top){
      const r=document.createElement("div");
      r.className="row";
      if(!first) r.style.borderTop="1px solid var(--line2)";
      first=false;
      r.innerHTML=`
        <div class="leftcol">
          <div class="title">${it.name}</div>
          <div class="mini">Î¤ÎµÎ¼Î¬Ï‡Î¹Î±: ${it.count}</div>
        </div>
        <span class="badge">${it.count}</span>
      `;
      topBox.appendChild(r);
    }
  }

  const us=paymentsByUser(db);
  const userBox=$("userSumList");
  userBox.innerHTML="";
  if(us.length===0){
    const d=document.createElement("div");
    d.className="sub";
    d.textContent="â€” Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚.";
    userBox.appendChild(d);
  } else {
    let first=true;
    for(const u of us){
      const r=document.createElement("div");
      r.className="row";
      if(!first) r.style.borderTop="1px solid var(--line2)";
      first=false;
      r.innerHTML=`
        <div class="leftcol">
          <div class="title">${u.name}</div>
          <div class="mini">ğŸ’¶ ${fmt(u.cash)} â€¢ ğŸ’³ ${fmt(u.card)} â€¢ ğŸ ${fmt(u.free)} â€¢ Î Î»Î·ÏÏ‰Î¼Î­Ï‚: ${u.count}</div>
        </div>
        <span class="badge">${fmt(u.total)}</span>
      `;
      r.onclick=()=>{ closeSummary(); openUserDetails(u.name); };
      userBox.appendChild(r);
    }
  }
}

function renderSettings(){
  const u=getActiveUser();
  $("settingsSub").textContent = `Î—Î¼Î­ÏÎ±: ${TODAY.split("-").reverse().join("/")} â€¢ Î•Î½ÎµÏÎ³ÏŒÏ‚ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚: ${u.name} â€¢ Shop: ${getShopName()}`;
}

function renderAll(){
  renderTop();
  renderHome();
  renderTables();
  renderTicket();
  renderSummary();
  renderSettings();
}

/* ===================== EVENTS ===================== */
$("btnSettings").onclick=()=>{ renderSettings(); $("settingsOv").classList.add("show"); };
$("btnCloseSettings").onclick=()=>$("settingsOv").classList.remove("show");
$("settingsOv").onclick=(e)=>{ if(e.target.id==="settingsOv") $("settingsOv").classList.remove("show"); };

$("btnSummaryTop").onclick=()=>openSummary();
$("btnSummaryHome").onclick=()=>openSummary();
$("btnCloseSummary").onclick=()=>closeSummary();
$("summaryOv").onclick=(e)=>{ if(e.target.id==="summaryOv") closeSummary(); };

$("btnCloseUser").onclick=()=>$("userOv").classList.remove("show");
$("userOv").onclick=(e)=>{ if(e.target.id==="userOv") $("userOv").classList.remove("show"); };

$("btnClosePay").onclick=()=>closePay();
$("payOv").onclick=(e)=>{ if(e.target.id==="payOv") closePay(); };

$("btnCloseQPay").onclick=()=>$("qpayOv").classList.remove("show");
$("qpayOv").onclick=(e)=>{ if(e.target.id==="qpayOv") $("qpayOv").classList.remove("show"); };

$("btnNewOrder").onclick=()=>{ showView("tables"); const db=ensureDB(); db.days[TODAY].meta.showOnlyOpen=false; save(LS_DB,db); renderAll(); };
$("btnOpenOrders").onclick=()=>{ showView("tables"); const db=ensureDB(); db.days[TODAY].meta.showOnlyOpen=true; save(LS_DB,db); renderAll(); };
$("btnBackHome").onclick=()=>goHome();
$("btnBackTables").onclick=()=>{ showView("tables"); renderAll(); };

$("btnToggleTables").onclick=()=>{
  const db=ensureDB();
  db.days[TODAY].meta.showOnlyOpen=!db.days[TODAY].meta.showOnlyOpen;
  save(LS_DB, db);
  renderTables();
  renderTop();
};

$("btnPay").onclick=()=>openPay();
$("btnPayCash").onclick=()=>doPay("cash");
$("btnPayCard").onclick=()=>doPay("card");
$("btnPayFree").onclick=()=>doPay("free");
$("btnSelAll").onclick=()=>selectAllPay();

$("prodSearch").addEventListener("input", ()=>renderProducts());

$("btnUndo").onclick=()=>undo();
$("btnCSV").onclick=()=>exportCSV();
$("btnWipe").onclick=()=>wipeAll();

$("btnAddUser").onclick=()=>addUser();
$("btnRenameUser").onclick=()=>renameUser();
$("btnSetPin").onclick=()=>setUserPin();
$("btnDelUser").onclick=()=>delUser();
$("btnShopName").onclick=()=>changeShop();

$("userSelect").onchange=(e)=>changeUser(e.target.value);

/* ===================== INIT ===================== */
ensureUsers();
ensureDB();
showView("home");
renderAll();

</script>
</body>
</html>