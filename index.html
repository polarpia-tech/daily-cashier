<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Î—Î¼ÎµÏÎ®ÏƒÎ¹Î¿ Î¤Î±Î¼ÎµÎ¯Î¿</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0f1115" />

  <style>
    :root{
      --bg:#0f1115; --card:#151a22; --muted:#a9b1c3; --text:#eef2ff;
      --accent:#4cc2ff; --ok:#42d392; --warn:#ffcd3c; --bad:#ff6b6b;
      --stroke: rgba(255,255,255,.10);
      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.10);
    }
    *{ box-sizing:border-box; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    html,body{ height:100%; width:100%; }
    body{ margin:0; background:var(--bg); color:var(--text); overflow-x:hidden; -webkit-tap-highlight-color: transparent; }
    .wrap{ width:100%; max-width:1020px; margin:0 auto; padding:0 12px; }

    header{
      position: sticky; top: 0; z-index: 30;
      background: rgba(15,17,21,.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.10);
      padding: 10px 0;
    }
    .top{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .brand{ display:flex; flex-direction:column; gap:2px; }
    .brand b{ font-size:16px; }
    .brand span{ color:var(--muted); font-size:12px; }

    .statusBar{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }
    .pill{
      padding:10px 12px; background:var(--glass); border:1px solid var(--glass2);
      border-radius:16px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      min-height:44px; color:var(--muted); font-size:13px;
    }
    .pill b{ color:var(--text); }

    select, input{
      padding:10px 10px; border-radius:14px; border:1px solid var(--stroke);
      background:rgba(255,255,255,.05); color:var(--text);
      outline:none; min-height:44px; font-size:16px; max-width:100%;
    }

    .btn{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 12px;
      border-radius:16px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      min-height:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ border-color: rgba(76,194,255,.55); background: rgba(76,194,255,.14); }
    .btn.ok{ border-color: rgba(66,211,146,.55); background: rgba(66,211,146,.16); }
    .btn.warn{ border-color: rgba(255,205,60,.55); background: rgba(255,205,60,.16); }
    .btn.bad{ border-color: rgba(255,107,107,.55); background: rgba(255,107,107,.18); }
    .btn.ghost{ background: rgba(255,255,255,.04); }
    .btn.small{ min-height:40px; padding:10px 10px; border-radius:14px; font-size:14px; }

    main{ padding:12px 0; padding-bottom: calc(190px + env(safe-area-inset-bottom, 0px)); }
    .grid{ display:grid; gap:12px; }
    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      padding:12px;
      box-shadow:0 10px 28px rgba(0,0,0,.28);
    }
    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .title{ font-weight:900; font-size:15px; }
    .muted{ color:var(--muted); font-size:13px; }
    .divider{ height:1px; background: rgba(255,255,255,.08); margin:10px 0; }

    /* Tabs */
    .tabs{
      display:flex; gap:10px; align-items:center;
      padding:8px; border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .tab{ flex:1; }
    .tab.active{ outline:2px solid rgba(76,194,255,.55); }

    /* Tables grid (CSS + JS forces too) */
    #tablesGrid{
      display:grid;
      gap:10px;
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
    @media (min-width:420px){
      #tablesGrid{ grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }
    @media (min-width:520px){
      #tablesGrid{ grid-template-columns: repeat(6, minmax(0, 1fr)); }
    }
    @media (min-width:820px){
      #tablesGrid{ grid-template-columns: repeat(10, minmax(0, 1fr)); }
    }

    .tableBtn{
      min-height:54px;
      border-radius:16px;
      display:flex; flex-direction:column; justify-content:center; align-items:center;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      font-weight:900;
      user-select:none;
      min-width:0;
    }
    .tableBtn small{ font-weight:700; color:var(--muted); margin-top:2px; }
    .tableBtn.active{ outline: 2px solid rgba(76,194,255,.75); }
    .tableBtn.hasDue{ border-color: rgba(255,205,60,.45); }
    .tableBtn:active{ transform: translateY(1px); }

    /* Categories & products */
    .cats{ display:flex; gap:8px; overflow:auto; padding-bottom:6px; -webkit-overflow-scrolling: touch; }
    .cat.active{ outline:2px solid rgba(76,194,255,.55); }
    .products{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media (min-width:560px){ .products{ grid-template-columns:1fr 1fr; } }
    @media (min-width:920px){ .products{ grid-template-columns:1fr 1fr 1fr; } }
    .prod{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px; border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      min-width:0;
    }
    .prod > div:first-child{ min-width:0; }
    .prod .title{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .prod small{ color:var(--muted); display:block; margin-top:2px; }
    .price{ font-weight:900; white-space:nowrap; }

    /* Ticket detail lines */
    .lineList{ display:grid; gap:10px; }
    .line{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      border-radius:16px;
      padding:10px;
      display:grid;
      gap:10px;
    }
    .lineTop{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between; }
    .lineName{ font-weight:900; }
    .lineMeta{ color:var(--muted); font-size:12px; margin-top:2px; }

    .payRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    .payRow .btn{ width:100%; }
    .qtyNow{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 10px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      min-height:44px;
    }
    .qtyNow b{ min-width:18px; text-align:center; font-size:16px; }
    .qtyNow .btn{ min-height:40px; padding:10px 12px; border-radius:14px; }

    .dangerRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .dangerRow .btn{ flex:1; min-width:140px; }

    /* Modal */
    .modalWrap{
      position:fixed; inset:0;
      background: rgba(0,0,0,.56);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:12px;
      z-index:60;
    }
    .modal{
      width:min(860px, 100%);
      background:var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-radius:20px;
      padding:12px;
      box-shadow:0 18px 55px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal h2{ margin:0 0 6px; font-size:16px; }
    .qty{ display:flex; gap:10px; align-items:center; }
    .qty .n{ font-size:18px; font-weight:900; min-width:40px; text-align:center; }
    .toggle{ display:flex; gap:10px; flex-wrap:wrap; }
    label.cb{
      display:flex; gap:10px; align-items:center;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      min-height:44px;
    }
    input[type="checkbox"]{ width:18px; height:18px; }

    /* Footer */
    .footerBar{
      position:fixed; left:0; right:0; bottom:0;
      padding: 10px 0 calc(10px + env(safe-area-inset-bottom, 0px));
      z-index: 40;
      background: rgba(15,17,21,0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 -14px 40px rgba(0,0,0,.55);
    }
    .footerGrid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (min-width:760px){ .footerGrid{ grid-template-columns:1fr 1fr 1fr 1fr; } }

    /* IMPORTANT: make content readable behind footer */
    .footerBar::before{
      content:"";
      position:absolute;
      left:0; right:0;
      top:-22px;
      height:22px;
      background: linear-gradient(to bottom, rgba(15,17,21,0), rgba(15,17,21,.95));
      pointer-events:none;
    }

    .tiny{ font-size:12px; color:var(--muted); margin-top:8px; }

    .toast{
      position: fixed; left:50%; transform:translateX(-50%);
      bottom: calc(126px + env(safe-area-inset-bottom, 0px));
      background: rgba(20,24,32,.95);
      border:1px solid rgba(255,255,255,.10);
      padding:10px 12px;
      border-radius:16px;
      display:none;
      z-index:80;
      max-width:92vw;
      text-align:center;
    }
    /* =========================
   HOTFIX: Mobile layout fix
   (Î³Î¹Î± Î½Î± Î¼Î·Î½ "Ï†ÎµÏÎ³ÎµÎ¹" Î´ÎµÎ¾Î¹Î¬
   ÎºÎ±Î¹ Î½Î± Î¼Î·Î½ ÏƒÏ€Î¬ÎµÎ¹ Ï„Î¿ grid)
   ========================= */

html, body { width: 100% !important; max-width: 100% !important; overflow-x: hidden !important; }

.wrap { max-width: 100% !important; width: 100% !important; }

header, main, .footerBar { width: 100% !important; max-width: 100% !important; }

#tablesGrid{
  width: 100% !important;
  display: grid !important;
  gap: 10px !important;
  /* Î‘Ï…Ï„ÏŒ â€œÎºÎ»ÎµÎ¹Î´ÏÎ½ÎµÎ¹â€ ÏƒÏ‰ÏƒÏ„Î¬ Ï„Î¹Ï‚ ÏƒÏ„Î®Î»ÎµÏ‚ ÏƒÎµ ÎŸÎ›Î‘ Ï„Î± ÎºÎ¹Î½Î·Ï„Î¬ */
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)) !important;
}

.tableBtn{
  min-width: 0 !important;
  width: 100% !important;
}

/* Î±Î½ Ï„Î¿ ÎºÎµÎ¯Î¼ÎµÎ½Î¿/ÎºÎ¿Ï…Î¼Ï€Î¹Î¬ Î¼ÎµÎ³Î±Î»ÏÎ½Î¿Ï…Î½ Ï…Ï€ÎµÏÎ²Î¿Î»Î¹ÎºÎ¬ ÏƒÎµ ÎºÎ¬Ï€Î¿Î¹Î± ÎºÎ¹Î½Î·Ï„Î¬ */
.tableBtn div { font-size: 16px !important; }
.tableBtn small { font-size: 12px !important; }
  </style>
</head>

<body>

<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <b>Î—Î¼ÎµÏÎ®ÏƒÎ¹Î¿ Î¤Î±Î¼ÎµÎ¯Î¿</b>
        <span id="todayPill">Î£Î®Î¼ÎµÏÎ±: â€”</span>
      </div>

      <div class="statusBar">
        <select id="userSel"></select>
        <div class="pill">
          Î¤ÏÎ±Ï€Î­Î¶Î¹: <b id="activeTable">â€”</b> â€¢ Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: <b id="activeDue">0,00 â‚¬</b>
        </div>
        <button class="btn ghost" id="btnSettings">âš™</button>
      </div>
    </div>

    <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <div class="tabs" style="flex:1; min-width:260px;">
        <button class="btn tab active" id="tabOrder">Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±</button>
        <button class="btn tab" id="tabTickets">Tickets</button>
      </div>
      <button class="btn ghost" id="btnNewTicket">+ Ticket</button>
      <button class="btn ghost" id="btnCloseTicket" style="display:none;">ÎšÎ»ÎµÎ¯ÏƒÎµ Ticket</button>
    </div>
  </div>
</header>

<!-- Settings -->
<div class="modalWrap" id="settingsWrap">
  <div class="modal">
    <div class="row" style="align-items:flex-start;">
      <div>
        <h2>Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</h2>
        <div class="muted">Î—Î¼Î­ÏÎ±: <b id="dayKey">â€”</b> â€” Î§ÏÎ®ÏƒÏ„Î·Ï‚: <b id="userNameLabel">â€”</b></div>
      </div>
      <button class="btn" id="btnSettingsClose">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
    <div class="divider"></div>
    <div class="row" style="gap:10px;">
      <button class="btn ghost" style="flex:1" id="userAdd">+ Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Ï‡ÏÎ®ÏƒÏ„Î·</button>
      <button class="btn ghost" style="flex:1" id="userRename">âœ ÎœÎµÏ„Î¿Î½Î¿Î¼Î±ÏƒÎ¯Î±</button>
      <button class="btn bad" style="flex:1" id="userDelete">ğŸ—‘ Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
    </div>
  </div>
</div>

<main>
  <div class="wrap">
    <div class="grid">

      <!-- Tables picker -->
      <section class="card">
        <div class="row">
          <div>
            <div class="title">Î“ÏÎ®Î³Î¿ÏÎ· ÎµÏ€Î¹Î»Î¿Î³Î® Ï„ÏÎ±Ï€ÎµÎ¶Î¹Î¿Ï</div>
            <div class="muted">Î Î¬Ï„Î± Ï„ÏÎ±Ï€Î­Î¶Î¹ â†’ ÎºÎ±Î¹ Î¼ÎµÏ„Î¬ Î³ÏÎ¬Ï†ÎµÎ¹Ï‚ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±.</div>
          </div>
          <div class="pill" style="min-height:auto;">Tip: ÎŒÏƒÎ± Î­Ï‡Î¿Ï…Î½ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ Ï†Î±Î¯Î½Î¿Î½Ï„Î±Î¹ Î¼Îµ Ï‡ÏÏÎ¼Î±.</div>
        </div>
        <div class="divider"></div>
        <div id="tablesGrid"></div>
      </section>

      <!-- ORDER TAB -->
      <section class="card" id="orderView">
        <div class="row">
          <div>
            <div class="title">Î ÏÎ¿ÏŠÏŒÎ½Ï„Î±</div>
            <div class="muted">ÎŒ,Ï„Î¹ Ï€Î±Ï„Î¬Ï‚ Î¼Ï€Î±Î¯Î½ÎµÎ¹ ÏƒÏ„Î¿ ÎµÎ½ÎµÏÎ³ÏŒ Ï„ÏÎ±Ï€Î­Î¶Î¹.</div>
          </div>
          <input id="search" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·â€¦">
        </div>

        <div class="divider"></div>
        <div class="cats" id="cats"></div>

        <div class="divider"></div>
        <div class="products" id="products"></div>
      </section>

      <!-- TICKETS TAB -->
      <section class="card" id="ticketsView" style="display:none;">
        <div class="row">
          <div>
            <div class="title">Ticket: <span id="detailName">â€”</span></div>
            <div class="muted">Î Î»Î·ÏÏÎ½ÎµÎ¹Ï‚ Î±Î½Î¬ Ï€ÏÎ¿ÏŠÏŒÎ½ (ÎºÎ±Î¹ Î¼ÎµÏÎ¹ÎºÎ¬ Ï„ÎµÎ¼Î¬Ï‡Î¹Î± Î±Î½ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹).</div>
          </div>
          <button class="btn ghost" id="btnResetDay">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î·Î¼Î­ÏÎ±Ï‚</button>
        </div>
        <div class="divider"></div>
        <div id="lineList" class="lineList"></div>

        <div class="divider"></div>
        <div class="row">
          <div class="pill">ÎœÎµÏ„ÏÎ·Ï„Î¬: <b id="sumCash">0,00 â‚¬</b> â€¢ ÎšÎ¬ÏÏ„Î±: <b id="sumCard">0,00 â‚¬</b> â€¢ ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±: <b id="sumGift">0,00 â‚¬</b></div>
          <button class="btn primary" id="btnClose">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Î·Î¼Î­ÏÎ±Ï‚</button>
        </div>
        <div class="tiny" id="lastList"></div>
      </section>

    </div>
  </div>
</main>

<div class="footerBar">
  <div class="wrap">
    <div class="footerGrid">
      <button class="btn ok" id="btnUndo">Î‘Î½Î±Î¯ÏÎµÏƒÎ· Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î±Ï‚ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚</button>
      <button class="btn primary" id="btnRepeat">Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± Ï€Î»Î·ÏÏ‰Î¼Î® Î¾Î±Î½Î¬</button>
      <button class="btn" id="btnCSV">Î•Î¾Î±Î³Ï‰Î³Î® CSV</button>
      <button class="btn bad" id="btnWipeAll">Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏŒÎ»Ï‰Î½</button>
    </div>
    <div class="tiny">Chrome â‹® â†’ <b>Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î·Î½ Î±ÏÏ‡Î¹ÎºÎ® Î¿Î¸ÏŒÎ½Î·</b>.</div>
  </div>
</div>

<!-- Product modal -->
<div class="modalWrap" id="modalWrap">
  <div class="modal">
    <div class="row" style="align-items:flex-start;">
      <div>
        <h2 id="mTitle">â€”</h2>
        <div class="muted" id="mPrice">â€”</div>
      </div>
      <button class="btn" id="mClose">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div class="qty">
        <button class="btn" id="qtyMinus">â€“</button>
        <div class="n" id="qtyVal">1</div>
        <button class="btn" id="qtyPlus">+</button>
      </div>

      <div class="muted">Î¤ÎµÎ»Î¹ÎºÏŒ:</div>
      <div class="title" id="mFinal">0,00 â‚¬</div>
    </div>

    <div class="divider"></div>

    <div class="toggle">
      <label class="cb"><input type="checkbox" id="xDecaf"> Decaf (+0,30â‚¬)</label>
      <label class="cb"><input type="checkbox" id="xPlant"> Î¦Ï…Ï„Î¹ÎºÏŒ Î³Î¬Î»Î± (+0,50â‚¬)</label>
    </div>

    <div class="divider"></div>

    <button class="btn primary" style="width:100%;" id="addToTicket">â• Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—</button>
    <div class="tiny">Î˜Î± Î¼Ï€ÎµÎ¹ ÏƒÏ„Î¿ ÎµÎ½ÎµÏÎ³ÏŒ Ï„ÏÎ±Ï€Î­Î¶Î¹.</div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
  // Register SW
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function(){
      navigator.serviceWorker.register('./sw.js').catch(function(){});
    });
  }

  function euro(n){ return n.toFixed(2).replace(".", ",") + " â‚¬"; }
  function dayKey(d){
    var y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), da=String(d.getDate()).padStart(2,"0");
    return y+"-"+m+"-"+da;
  }
  function nowHM(){ return (new Date()).toTimeString().slice(0,5); }
  function escapeCSV(s){
    s=String(s==null?"":s);
    if(/[,"\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  }
  function normalizeId(name){
    var s=name.trim().toLowerCase().replace(/\s+/g,"_");
    s=s.replace(/[^a-z0-9\u0370-\u03ff_-]/g,"");
    return s;
  }

  var toastEl=document.getElementById("toast");
  function toast(msg){
    toastEl.textContent=msg;
    toastEl.style.display="block";
    clearTimeout(toastEl._t);
    toastEl._t=setTimeout(function(){ toastEl.style.display="none"; }, 1600);
  }

  // MENU
  var MENU=[
    { cat:"â˜• ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ Î–Î•Î£Î¤ÎŸÎ™", items:[
      ["Espresso Î¼Î¿Î½ÏŒÏ‚",2.60],["Espresso Î´Î¹Ï€Î»ÏŒÏ‚",3.20],["Espresso macchiato",2.90],
      ["Americano",3.20],["Cappuccino",3.60],["Cappuccino Î´Î¹Ï€Î»ÏŒÏ‚",4.20],
      ["Latte macchiato",4.20],["Flat white",4.40],["Mocha",4.50],["ÎšÎ±Ï†Î­Ï‚ Ï†Î¯Î»Ï„ÏÎ¿Ï…",3.00]
    ]},
    { cat:"â„ï¸ ÎšÎ‘Î¦Î•Î”Î•Î£ â€“ ÎšÎ¡Î¥ÎŸÎ™", items:[
      ["Freddo espresso",3.80],["Freddo cappuccino",4.20],["Iced latte",4.50],["Cold brew",4.80],["Frappe",3.50]
    ]},
    { cat:"ğŸ«– Î¤Î£Î‘Îª â€“ Î–Î•Î£Î¤Î‘ Î¡ÎŸÎ¦Î—ÎœÎ‘Î¤Î‘", items:[
      ["Î¤ÏƒÎ¬Î¹ (Î¼Î±ÏÏÎ¿, Ï€ÏÎ¬ÏƒÎ¹Î½Î¿, Î²ÏŒÏ„Î±Î½Î±)",3.20],["Î¤ÏƒÎ¬Î¹ Ï†ÏÎ¿ÏÏ„Ï‰Î½",3.50],["Chai latte",4.30]
    ]},
    { cat:"ğŸ« Î£ÎŸÎšÎŸÎ›Î‘Î¤Î•Î£ â€“ Î“Î‘Î›Î‘ÎšÎ¤Î•Î¡Î‘", items:[
      ["Î–ÎµÏƒÏ„Î® ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±",4.20],["ÎšÏÏÎ± ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±",4.50],["Î›ÎµÏ…ÎºÎ® ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±",4.50],["ÎšÎ±ÎºÎ¬Î¿",4.00]
    ]},
    { cat:"ğŸ¥¤ Î‘ÎÎ‘Î¨Î¥ÎšÎ¤Î™ÎšÎ‘ â€“ ÎÎ•Î¡Î‘", items:[
      ["Coca-Cola / Zero / Fanta (0,33l)",3.40],["Ice Tea",3.60],["Î£ÏŒÎ´Î± / Î¤ÏŒÎ½Î¹Îº",3.20],
      ["ÎœÎµÏ„Î±Î»Î»Î¹ÎºÏŒ Î½ÎµÏÏŒ (0,33l)",2.80],["ÎœÎµÏ„Î±Î»Î»Î¹ÎºÏŒ Î½ÎµÏÏŒ (0,75l)",5.50]
    ]},
    { cat:"ğŸŠ Î§Î¥ÎœÎŸÎ™ â€“ SMOOTHIES", items:[
      ["Î¦Ï…ÏƒÎ¹ÎºÏŒÏ‚ Ï‡Ï…Î¼ÏŒÏ‚ Ï€Î¿ÏÏ„Î¿ÎºÎ¬Î»Î¹",4.50],["Î§Ï…Î¼ÏŒÏ‚ Î±Î½Î¬Î¼ÎµÎ¹ÎºÏ„Î¿Ï‚",4.80],["Smoothie Ï†ÏÎ¿ÏÏ„Ï‰Î½",5.80],["Milkshake",5.50]
    ]},
    { cat:"ğŸ¥ Î£ÎÎ‘Îš â€“ Î“Î›Î¥ÎšÎ‘", items:[
      ["ÎšÏÎ¿Ï…Î±ÏƒÎ¬Î½ ÏƒÎºÎ­Ï„Î¿",2.80],["ÎšÏÎ¿Ï…Î±ÏƒÎ¬Î½ ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±",3.20],["ÎœÎ¬Ï†Î¹Î½",3.50],["ÎšÎ­Î¹Îº (ÎºÎ¿Î¼Î¼Î¬Ï„Î¹)",4.20],
      ["Cheesecake",4.80],["ÎœÏ€Î¹ÏƒÎºÏŒÏ„Î±",2.50],["Î¤Î¿ÏƒÏ„ Î¶Î±Î¼Ï€ÏŒÎ½-Ï„Ï…ÏÎ¯",4.50],["Î¤Î¿ÏƒÏ„ vegetarian",4.80]
    ]},
    { cat:"ğŸº ÎœÎ Î¥Î¡Î•Î£", items:[
      ["ÎœÏ€ÏÏÎ± Î²Î±ÏÎµÎ»Î¯ÏƒÎ¹Î± (0,5l)",5.20],["ÎœÏ€ÏÏÎ± ÎµÎ¼Ï†Î¹Î±Î»Ï‰Î¼Î­Î½Î· (0,33l)",4.20],["Weissbier (0,5l)",5.50],["ÎœÏ€ÏÏÎ± Ï‡Ï‰ÏÎ¯Ï‚ Î±Î»ÎºÎ¿ÏŒÎ»",4.20]
    ]},
    { cat:"ğŸ· ÎšÎ¡Î‘Î£Î™Î‘", items:[
      ["ÎšÏÎ±ÏƒÎ¯ Ï€Î¿Ï„Î®ÏÎ¹",5.50],["ÎšÏÎ±ÏƒÎ¯ ÎºÎ±ÏÎ¬Ï†Î± (0,5l)",12.00],["Î¦Î¹Î¬Î»Î· ÎºÏÎ±ÏƒÎ¯ (22â‚¬)",22.00],["Î¦Î¹Î¬Î»Î· ÎºÏÎ±ÏƒÎ¯ (28â‚¬)",28.00],["Prosecco Ï€Î¿Ï„Î®ÏÎ¹",6.50]
    ]},
    { cat:"ğŸ¥ƒ Î ÎŸÎ¤Î‘ (4cl)", items:[
      ["ÎŸÏ…Î¯ÏƒÎºÎ¹ standard",8.50],["Premium Î¿Ï…Î¯ÏƒÎºÎ¹",10.50],["Î’ÏŒÏ„ÎºÎ±",8.00],["Î¡Î¿ÏÎ¼Î¹",8.50],
      ["Î¤Î¶Î¹Î½",8.50],["ÎŸÏÎ¶Î¿ / Î¤ÏƒÎ¯Ï€Î¿Ï…ÏÎ¿",7.50],["Î›Î¹ÎºÎ­Ï",7.50]
    ]},
    { cat:"ğŸ¸ ÎšÎŸÎšÎ¤Î•ÎªÎ›", items:[
      ["Mojito",9.50],["Caipirinha",9.50],["Margarita",10.00],["Aperol Spritz",8.50],["Gin Tonic",9.00],["Negroni",10.50]
    ]}
  ];

  var EXTRAS={ decaf:{name:"Decaf",price:0.30}, plant:{name:"Î¦Ï…Ï„Î¹ÎºÏŒ Î³Î¬Î»Î±",price:0.50} };

  // Storage keys
  var LS_KEY="mini_cashier_db_tickets_v1";
  var LS_USERS="mini_cashier_users_v1";
  var LS_USER="mini_cashier_user_v1";
  var LS_ACTIVE_TICKET="mini_cashier_active_ticket_v1";

  function loadDB(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)) || {days:{},lastId:0}; }catch(e){ return {days:{},lastId:0}; } }
  function saveDB(db){ localStorage.setItem(LS_KEY, JSON.stringify(db)); }
  function loadUsers(){
    var fallback=[{id:"user1",name:"Î§ÏÎ®ÏƒÏ„Î·Ï‚ 1"},{id:"tablet",name:"Tablet (Î­ÎºÏ„Î±ÎºÏ„Î·)"}];
    try{
      var raw=localStorage.getItem(LS_USERS);
      if(!raw) return fallback;
      var arr=JSON.parse(raw);
      if(!Array.isArray(arr)||!arr.length) return fallback;
      return arr;
    }catch(e){ return fallback; }
  }
  function saveUsers(arr){ localStorage.setItem(LS_USERS, JSON.stringify(arr)); }

  var db=loadDB();
  var USERS=loadUsers();
  var BASE_TODAY=dayKey(new Date());
  var TODAY="";

  // UI refs
  var userSel=document.getElementById("userSel");
  var todayPill=document.getElementById("todayPill");
  var activeTable=document.getElementById("activeTable");
  var activeDueEl=document.getElementById("activeDue");
  var btnNewTicket=document.getElementById("btnNewTicket");
  var btnCloseTicket=document.getElementById("btnCloseTicket");

  var tabOrder=document.getElementById("tabOrder");
  var tabTickets=document.getElementById("tabTickets");
  var orderView=document.getElementById("orderView");
  var ticketsView=document.getElementById("ticketsView");

  var tablesGrid=document.getElementById("tablesGrid");
  var detailName=document.getElementById("detailName");
  var lineListEl=document.getElementById("lineList");

  // Settings
  var settingsWrap=document.getElementById("settingsWrap");
  var btnSettings=document.getElementById("btnSettings");
  var btnSettingsClose=document.getElementById("btnSettingsClose");
  var userAdd=document.getElementById("userAdd");
  var userRename=document.getElementById("userRename");
  var userDelete=document.getElementById("userDelete");
  var dayKeyEl=document.getElementById("dayKey");
  var userNameLabel=document.getElementById("userNameLabel");

  btnSettings.onclick=function(){
    dayKeyEl.textContent=BASE_TODAY;
    userNameLabel.textContent=currentUser().name;
    settingsWrap.style.display="flex";
  };
  btnSettingsClose.onclick=function(){ settingsWrap.style.display="none"; };
  settingsWrap.addEventListener("click", function(e){ if(e.target===settingsWrap) settingsWrap.style.display="none"; });

  function currentUser(){
    var id=userSel.value;
    return USERS.find(u=>u.id===id) || USERS[0];
  }
  function dayUserKey(){ return BASE_TODAY + "__" + currentUser().id; }
  function ensureDay(){
    TODAY=dayUserKey();
    if(!db.days[TODAY]) db.days[TODAY]={tickets:[], paid:[]};
    if(!db.days[TODAY].tickets) db.days[TODAY].tickets=[];
    if(!db.days[TODAY].paid) db.days[TODAY].paid=[];

    if(!db.days[TODAY].tickets.length){
      var defaults=[];
      for(var i=1;i<=20;i++) defaults.push({name:"T"+i});
      defaults.push({name:"BAR"});
      defaults.push({name:"Î•ÎÎ©"});
      defaults.forEach(function(d){
        db.days[TODAY].tickets.push({id: ++db.lastId, name:d.name, createdAt: nowHM(), lines:[]});
      });
      saveDB(db);
    }
    saveDB(db);
    todayPill.textContent="Î£Î®Î¼ÎµÏÎ±: " + BASE_TODAY.split("-").reverse().join("/");
  }

  function tickets(){ ensureDay(); return db.days[TODAY].tickets; }

  function setActiveTicketId(id){
    localStorage.setItem(LS_ACTIVE_TICKET+"__"+TODAY, String(id));
  }
  function getActiveTicketId(){
    var key=LS_ACTIVE_TICKET+"__"+TODAY;
    var id=parseInt(localStorage.getItem(key)||"",10);
    if(!id || !tickets().some(t=>t.id===id)) return tickets()[0].id;
    return id;
  }
  function activeTicket(){
    var id=getActiveTicketId();
    return tickets().find(t=>t.id===id) || tickets()[0];
  }
  function ticketDue(t){
    var s=0; (t.lines||[]).forEach(l=> s += l.qty_open*l.unit); return s;
  }

  function renderUserSelect(){
    var selected=localStorage.getItem(LS_USER) || (USERS[0] && USERS[0].id);
    userSel.innerHTML="";
    USERS.forEach(function(u){
      var opt=document.createElement("option");
      opt.value=u.id; opt.textContent=u.name;
      userSel.appendChild(opt);
    });
    if(!USERS.some(u=>u.id===selected)) selected=USERS[0].id;
    userSel.value=selected;
    localStorage.setItem(LS_USER, selected);
  }
  userSel.addEventListener("change", function(){
    localStorage.setItem(LS_USER, userSel.value);
    ensureDay();
    renderAll();
  });

  userAdd.onclick=function(){
    var name=prompt("ÎŒÎ½Î¿Î¼Î± Ï…Ï€Î±Î»Î»Î®Î»Î¿Ï…/Ï‡ÏÎ®ÏƒÏ„Î·:");
    if(!name||!name.trim()) return;
    var id=normalizeId(name);
    if(!id){ alert("Î”ÏÏƒÎµ Î­Î³ÎºÏ…ÏÎ¿ ÏŒÎ½Î¿Î¼Î±."); return; }
    var base=id,n=2;
    while(USERS.some(u=>u.id===id)) id=base+"_"+(n++);
    USERS.push({id:id,name:name.trim()});
    saveUsers(USERS);
    renderUserSelect();
    ensureDay();
    renderAll();
  };
  userRename.onclick=function(){
    var cur=currentUser();
    var name=prompt("ÎÎ­Î¿ ÏŒÎ½Î¿Î¼Î±:", cur.name);
    if(!name||!name.trim()) return;
    var idx=USERS.findIndex(u=>u.id===cur.id);
    USERS[idx].name=name.trim();
    saveUsers(USERS);
    renderUserSelect();
    renderAll();
  };
  userDelete.onclick=function(){
    var cur=currentUser();
    if(USERS.length<=1){ alert("Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î­Î½Î±Ï‚ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚."); return; }
    if(!confirm('ÎÎ± Î´Î¹Î±Î³ÏÎ¬ÏˆÏ‰ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· "'+cur.name+'"; (Î”ÎµÎ½ ÏƒÎ²Î®Î½ÎµÎ¹ Ï€Î±Î»Î¹Î­Ï‚ ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚)')) return;
    USERS=USERS.filter(u=>u.id!==cur.id);
    saveUsers(USERS);
    renderUserSelect();
    ensureDay();
    renderAll();
  };

  // Tabs
  function setTab(which){
    var isOrder = which==="order";
    tabOrder.classList.toggle("active", isOrder);
    tabTickets.classList.toggle("active", !isOrder);
    orderView.style.display = isOrder ? "block" : "none";
    ticketsView.style.display = isOrder ? "none" : "block";
    if(!isOrder){
      renderTicketLines();
      ticketsView.scrollIntoView({behavior:"smooth", block:"start"});
    }
  }
  tabOrder.onclick=function(){ setTab("order"); };
  tabTickets.onclick=function(){ setTab("tickets"); };

  // Ticket create/close
  btnNewTicket.onclick=function(){
    ensureDay();
    var name=prompt("ÎŒÎ½Î¿Î¼Î± Ticket (Ï€.Ï‡. T21, Î•ÎÎ©3):");
    if(!name||!name.trim()) return;
    db.days[TODAY].tickets.push({id: ++db.lastId, name:name.trim(), createdAt: nowHM(), lines:[]});
    saveDB(db);
    setActiveTicketId(db.lastId);
    toast("ÎÎ­Î¿ ticket: "+name.trim());
    renderAll();
  };

  btnCloseTicket.onclick=function(){
    ensureDay();
    var t=activeTicket();
    if(ticketDue(t)>0){ toast("ÎˆÏ‡ÎµÎ¹ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿, Î´ÎµÎ½ ÎºÎ»ÎµÎ¯Î½ÎµÎ¹"); return; }
    if(!confirm('ÎÎ± ÎºÎ»ÎµÎ¯ÏƒÏ‰ Ï„Î¿ ticket "'+t.name+'";')) return;
    db.days[TODAY].tickets = db.days[TODAY].tickets.filter(x=>x.id!==t.id);
    if(!db.days[TODAY].tickets.length){
      db.days[TODAY].tickets.push({id: ++db.lastId, name:"BAR", createdAt: nowHM(), lines:[]});
    }
    saveDB(db);
    setActiveTicketId(db.days[TODAY].tickets[0].id);
    toast("ÎˆÎºÎ»ÎµÎ¹ÏƒÎµ ticket");
    renderAll();
  };

  // âœ… FORCE GRID via JS (cannot break)
  function applyTablesGridLayout(){
    var w = tablesGrid.clientWidth || window.innerWidth || 360;
    var cols = 3;
    if (w >= 420) cols = 4;
    if (w >= 520) cols = 6;
    if (w >= 820) cols = 10;
    tablesGrid.style.display = "grid";
    tablesGrid.style.gap = "10px";
    tablesGrid.style.gridTemplateColumns = "repeat(" + cols + ", minmax(0, 1fr))";
  }

  // Tables render
  function renderTablesGrid(){
    var ts=tickets();
    var activeId=getActiveTicketId();
    tablesGrid.innerHTML="";

    applyTablesGridLayout();
    setTimeout(applyTablesGridLayout, 60);
    setTimeout(applyTablesGridLayout, 260);

    ts.forEach(function(t){
      var due=ticketDue(t);
      var btn=document.createElement("div");
      btn.className="tableBtn"+(t.id===activeId?" active":"")+(due>0?" hasDue":"");
      btn.innerHTML = '<div>'+t.name+'</div><small>'+ (due>0? euro(due) : "â€”") +'</small>';
      btn.onclick=function(){
        setActiveTicketId(t.id);
        toast("Î•Î½ÎµÏÎ³ÏŒ: "+t.name);
        renderAll();
        setTab("order");
      };
      tablesGrid.appendChild(btn);
    });

    var a=activeTicket();
    activeTable.textContent=a.name;
    activeDueEl.textContent=euro(ticketDue(a));
    btnCloseTicket.style.display = ticketDue(a)===0 ? "inline-flex" : "none";
    detailName.textContent=a.name;
  }

  if(!window.__tablesGridResizeHooked){
    window.__tablesGridResizeHooked=true;
    window.addEventListener("resize", function(){
      try{ applyTablesGridLayout(); }catch(e){}
    });
  }

  // Ticket lines logic
  function mergeLine(t, item, unit, extras){
    var exKey=(extras||[]).join("|");
    return (t.lines||[]).find(function(l){
      return l.item===item && Math.abs(l.unit-unit)<0.0001 && (l.extras||[]).join("|")===exKey;
    });
  }
  function findLine(lineId){
    var t=activeTicket();
    var idx=t.lines.findIndex(x=>x.id===lineId);
    return {t:t, idx:idx, line: idx>=0?t.lines[idx]:null};
  }
  function adjustPayNow(lineId, delta){
    var f=findLine(lineId); if(!f.line) return;
    var l=f.line;
    var cur=l.pay_now||1;
    cur+=delta;
    cur=Math.max(1, Math.min(cur, l.qty_open));
    l.pay_now=cur;
    saveDB(db);
    renderAll();
    setTab("tickets");
  }
  function cancelQty(lineId, qty){
    var f=findLine(lineId); if(!f.line) return;
    var l=f.line;
    var q=Math.min(qty, l.qty_open);
    l.qty_open -= q;
    l.pay_now = Math.max(1, Math.min(l.pay_now||1, l.qty_open||1));
    if(l.qty_open<=0){
      f.t.lines.splice(f.idx,1);
    }
    saveDB(db);
    toast(qty>=9999 ? "Î‘ÎºÏ…ÏÏÎ¸Î·ÎºÎµ Î³ÏÎ±Î¼Î¼Î®" : ("Î‘ÎºÏ…ÏÏÎ¸Î·ÎºÎ±Î½ "+q+" Ï„ÎµÎ¼."));
    renderAll();
    setTab("tickets");
  }
  function payPartial(lineId, method){
    var f=findLine(lineId); if(!f.line) return;
    var t=f.t, l=f.line;
    var q=Math.min(l.pay_now||1, l.qty_open);
    if(q<=0) return;

    l.qty_open -= q;
    l.pay_now = Math.max(1, Math.min(l.pay_now||1, l.qty_open||1));

    var paidEntry={
      id: ++db.lastId,
      ticketId: t.id,
      ticketName: t.name,
      date: BASE_TODAY,
      openTime: l.time,
      paidTime: nowHM(),
      category: l.category,
      item: l.item,
      qty_paid: q,
      extras: l.extras,
      unit: l.unit,
      total: q*l.unit,
      method: method
    };
    db.days[TODAY].paid.push(paidEntry);

    if(l.qty_open<=0){
      t.lines.splice(f.idx,1);
    }
    saveDB(db);
    toast("Î Î»Î·ÏÏÎ¸Î·ÎºÎ±Î½ "+q);
    renderAll();
    setTab("tickets");
  }

  function renderTicketLines(){
    var t=activeTicket();
    lineListEl.innerHTML="";

    if(!t.lines || !t.lines.length){
      lineListEl.innerHTML='<div class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± ÏƒÎµ Î±Ï…Ï„ÏŒ Ï„Î¿ ticket.</div>';
      return;
    }

    t.lines.slice().reverse().forEach(function(l){
      var ex=(l.extras && l.extras.length) ? (" +"+l.extras.join(", ")) : "";
      var payNow=Math.min(l.pay_now||1, l.qty_open);

      var div=document.createElement("div");
      div.className="line";
      div.innerHTML =
        '<div class="lineTop">' +
          '<div>' +
            '<div class="lineName">'+l.qty_open+'x '+l.item+ex+'</div>' +
            '<div class="lineMeta">â± '+l.time+' â€¢ ÎœÎ¿Î½Î¬Î´Î± '+euro(l.unit)+' â€¢ Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ '+euro(l.qty_open*l.unit)+'</div>' +
          '</div>' +
          '<div class="pill" style="min-height:auto;">Î¤ÏÏÎ±: <b>'+payNow+'</b></div>' +
        '</div>' +

        '<div class="qtyNow">' +
          '<button class="btn small" data-act="minus" data-id="'+l.id+'">â€“</button>' +
          '<span class="muted">Î ÏŒÏƒÎ± Ï€Î»Î·ÏÏÎ½ÎµÎ¹ Ï„ÏÏÎ±;</span>' +
          '<b>'+payNow+'</b>' +
          '<button class="btn small" data-act="plus" data-id="'+l.id+'">+</button>' +
        '</div>' +

        '<div class="payRow">' +
          '<button class="btn ok" data-act="cash" data-id="'+l.id+'">ğŸ’¶ CASH</button>' +
          '<button class="btn primary" data-act="card" data-id="'+l.id+'">ğŸ’³ CARD</button>' +
          '<button class="btn warn" data-act="gift" data-id="'+l.id+'">ğŸ GIFT</button>' +
        '</div>' +

        '<div class="dangerRow">' +
          '<button class="btn bad" data-act="cancel1" data-id="'+l.id+'">ğŸ—‘ Î‘ÎºÏÏÏ‰ÏƒÎ· 1</button>' +
          '<button class="btn bad" data-act="cancelAll" data-id="'+l.id+'">ğŸ—‘ Î‘ÎºÏÏÏ‰ÏƒÎ· ÏŒÎ»Î±</button>' +
        '</div>';

      div.querySelectorAll("button").forEach(function(b){
        b.onclick=function(){
          var act=b.getAttribute("data-act");
          var id=parseInt(b.getAttribute("data-id"),10);
          if(act==="minus") return adjustPayNow(id, -1);
          if(act==="plus") return adjustPayNow(id, +1);
          if(act==="cancel1") return cancelQty(id, 1);
          if(act==="cancelAll") return cancelQty(id, 9999);
          payPartial(id, act);
        };
      });

      lineListEl.appendChild(div);
    });
  }

  // Categories & products
  var catsEl=document.getElementById("cats");
  var productsEl=document.getElementById("products");
  var searchEl=document.getElementById("search");
  var activeCat=MENU[0].cat;

  function buildCats(){
    catsEl.innerHTML="";
    MENU.forEach(function(section){
      var b=document.createElement("button");
      b.className="btn small cat"+(section.cat===activeCat?" active":"");
      b.textContent=section.cat;
      b.onclick=function(){ activeCat=section.cat; buildCats(); buildProducts(); };
      catsEl.appendChild(b);
    });
  }

  function buildProducts(){
    var q=(searchEl.value||"").trim().toLowerCase();
    productsEl.innerHTML="";
    var section=MENU.find(s=>s.cat===activeCat);

    var items=section.items.map(it=>({name:it[0],price:it[1],cat:section.cat}));
    if(q) items=items.filter(x=>x.name.toLowerCase().indexOf(q)>=0);

    items.forEach(function(item){
      var div=document.createElement("div");
      div.className="prod";
      div.innerHTML=
        '<div><div class="title">'+item.name+'</div><small>'+item.cat+'</small></div>'+
        '<div class="price">'+euro(item.price)+'</div>';
      div.onclick=function(){ openModal(item); };
      productsEl.appendChild(div);
    });
  }
  searchEl.addEventListener("input", buildProducts);

  // Product modal
  var modalWrap=document.getElementById("modalWrap");
  var mTitle=document.getElementById("mTitle");
  var mPrice=document.getElementById("mPrice");
  var mFinal=document.getElementById("mFinal");
  var qtyValEl=document.getElementById("qtyVal");
  var xDecaf=document.getElementById("xDecaf");
  var xPlant=document.getElementById("xPlant");
  var addToTicketBtn=document.getElementById("addToTicket");
  var currentItem=null;
  var qty=1;

  function calcFinal(base){
    var extra=0;
    if(xDecaf.checked) extra+=EXTRAS.decaf.price;
    if(xPlant.checked) extra+=EXTRAS.plant.price;
    return (base+extra)*qty;
  }

  function openModal(item){
    currentItem=item;
    qty=1;
    xDecaf.checked=false;
    xPlant.checked=false;
    mTitle.textContent=item.name;
    mPrice.textContent="Î¤Î¹Î¼Î®: "+euro(item.price)+" (Î²Î¬ÏƒÎ·)";
    qtyValEl.textContent=String(qty);
    mFinal.textContent=euro(calcFinal(item.price));
    modalWrap.style.display="flex";
  }
  function closeModal(){ modalWrap.style.display="none"; currentItem=null; }
  document.getElementById("mClose").onclick=closeModal;
  modalWrap.addEventListener("click", function(e){ if(e.target===modalWrap) closeModal(); });

  document.getElementById("qtyMinus").onclick=function(){
    qty=Math.max(1, qty-1);
    qtyValEl.textContent=String(qty);
    mFinal.textContent=euro(calcFinal(currentItem.price));
  };
  document.getElementById("qtyPlus").onclick=function(){
    qty=qty+1;
    qtyValEl.textContent=String(qty);
    mFinal.textContent=euro(calcFinal(currentItem.price));
  };
  xDecaf.onchange=function(){ if(currentItem) mFinal.textContent=euro(calcFinal(currentItem.price)); };
  xPlant.onchange=function(){ if(currentItem) mFinal.textContent=euro(calcFinal(currentItem.price)); };

  addToTicketBtn.onclick=function(){
    ensureDay();
    var t=activeTicket();
    var extras=[], extraTotal=0;
    if(xDecaf.checked){ extras.push(EXTRAS.decaf.name); extraTotal+=EXTRAS.decaf.price; }
    if(xPlant.checked){ extras.push(EXTRAS.plant.name); extraTotal+=EXTRAS.plant.price; }
    var unit=currentItem.price + extraTotal;

    var existing = mergeLine(t, currentItem.name, unit, extras);
    if(existing){
      existing.qty_open += qty;
      existing.pay_now = Math.max(1, Math.min(existing.pay_now||1, existing.qty_open));
    }else{
      t.lines.push({
        id: ++db.lastId,
        category: currentItem.cat,
        item: currentItem.name,
        extras: extras,
        unit: unit,
        qty_open: qty,
        pay_now: 1,
        time: nowHM()
      });
    }
    saveDB(db);
    toast("Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ "+t.name);
    closeModal();
    renderAll();
  };

  // Paid summary + last
  var sumCash=document.getElementById("sumCash");
  var sumCard=document.getElementById("sumCard");
  var sumGift=document.getElementById("sumGift");
  var lastList=document.getElementById("lastList");

  function computePaid(){
    ensureDay();
    var paid=db.days[TODAY].paid || [];
    var cash=0, card=0, gift=0;
    paid.forEach(function(e){
      if(e.method==="cash") cash+=e.total;
      else if(e.method==="card") card+=e.total;
      else if(e.method==="gift") gift+=e.total;
    });
    return {paid:paid, cash:cash, card:card, gift:gift};
  }
  function renderPaid(){
    var c=computePaid();
    sumCash.textContent=euro(c.cash);
    sumCard.textContent=euro(c.card);
    sumGift.textContent=euro(c.gift);

    var last=c.paid.slice(-6).reverse();
    if(!last.length){ lastList.innerHTML='<div class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï€Î»Î·ÏÏ‰Î¼Î® Î±ÎºÏŒÎ¼Î±.</div>'; return; }

    lastList.innerHTML = last.map(function(e){
      var m=e.method==="cash"?"ğŸ’¶":(e.method==="card"?"ğŸ’³":"ğŸ");
      return '<div>'+m+' '+e.paidTime+' â€” '+e.ticketName+' â€” '+e.qty_paid+'x '+e.item+' = '+euro(e.total)+'</div>';
    }).join("");
  }

  // Footer buttons
  document.getElementById("btnUndo").onclick=function(){
    ensureDay();
    var paid=db.days[TODAY].paid;
    if(!paid.length){ toast("Î¤Î¯Ï€Î¿Ï„Î± Î³Î¹Î± Î±Î½Î±Î¯ÏÎµÏƒÎ·"); return; }
    var last=paid.pop();

    var t=tickets().find(x=>x.id===last.ticketId);
    if(!t){
      db.days[TODAY].tickets.push({id:last.ticketId, name:last.ticketName||("T"+last.ticketId), createdAt: nowHM(), lines:[]});
      t=tickets().find(x=>x.id===last.ticketId);
    }
    var existing = mergeLine(t, last.item, last.unit, last.extras||[]);
    if(existing){
      existing.qty_open += last.qty_paid;
      existing.pay_now = Math.max(1, Math.min(existing.pay_now||1, existing.qty_open));
    }else{
      t.lines.push({
        id: ++db.lastId, category:last.category, item:last.item, extras:last.extras||[],
        unit:last.unit, qty_open:last.qty_paid, pay_now:1, time: nowHM()
      });
    }
    saveDB(db);
    toast("Î‘Î½Î±Î¹ÏÎ­Î¸Î·ÎºÎµ");
    renderAll();
    setTab("tickets");
  };

  document.getElementById("btnRepeat").onclick=function(){
    ensureDay();
    var paid=db.days[TODAY].paid;
    if(!paid.length){ toast("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± Ï€Î»Î·ÏÏ‰Î¼Î®"); return; }
    var last=paid[paid.length-1];
    var t=activeTicket();
    var existing = mergeLine(t, last.item, last.unit, last.extras||[]);
    if(existing){
      existing.qty_open += last.qty_paid;
      existing.pay_now = Math.max(1, Math.min(existing.pay_now||1, existing.qty_open));
    }else{
      t.lines.push({
        id: ++db.lastId, category:last.category, item:last.item, extras:last.extras||[],
        unit:last.unit, qty_open:last.qty_paid, pay_now:1, time: nowHM()
      });
    }
    saveDB(db);
    toast("Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ "+t.name);
    renderAll();
  };

  document.getElementById("btnCSV").onclick=function(){
    ensureDay();
    var rows=[];
    tickets().forEach(function(t){
      (t.lines||[]).forEach(function(l){
        rows.push({
          status:"open", ticketId:t.id, ticketName:t.name, date: BASE_TODAY, openTime:l.time, paidTime:"",
          category:l.category, item:l.item, qty:l.qty_open, extras:(l.extras||[]).join(" | "),
          unit:l.unit.toFixed(2), total:(l.qty_open*l.unit).toFixed(2), method:""
        });
      });
    });
    (db.days[TODAY].paid||[]).forEach(function(p){
      rows.push({
        status:"paid", ticketId:p.ticketId, ticketName:p.ticketName, date:p.date, openTime:p.openTime, paidTime:p.paidTime,
        category:p.category, item:p.item, qty:p.qty_paid, extras:(p.extras||[]).join(" | "),
        unit:p.unit.toFixed(2), total:p.total.toFixed(2), method:p.method
      });
    });
    if(!rows.length){ toast("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚"); return; }

    var header=["user","date","status","ticketId","ticketName","openTime","paidTime","category","item","qty","extras","unit","total","method"];
    var lines=[header.join(",")];
    rows.forEach(function(r){
      lines.push([
        currentUser().name, r.date, r.status, r.ticketId, r.ticketName, r.openTime, r.paidTime,
        r.category, r.item, r.qty, r.extras, r.unit, r.total, r.method
      ].map(escapeCSV).join(","));
    });

    var blob=new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    var a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="taMeio_"+BASE_TODAY+"_"+normalizeId(currentUser().name)+".csv";
    a.click();
    URL.revokeObjectURL(a.href);
    toast("ÎšÎ±Ï„Î­Î²Î·ÎºÎµ CSV");
  };

  document.getElementById("btnResetDay").onclick=function(){
    ensureDay();
    if(!confirm("ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î·Î¼Î­ÏÎ±Ï‚ Î³Î¹Î± Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î·;")) return;
    db.days[TODAY]={tickets:[], paid:[]};
    saveDB(db);
    ensureDay();
    setActiveTicketId(tickets()[0].id);
    toast("ÎšÎ±Î¸Î±ÏÎ¯ÏƒÏ„Î·ÎºÎµ");
    renderAll();
  };

  document.getElementById("btnWipeAll").onclick=function(){
    if(!confirm("Î Î¡ÎŸÎ£ÎŸÎ§Î—: Î”Î¹Î±Î³ÏÎ¬Ï†ÎµÎ¹ ÎŸÎ›Î‘ Î±Ï€ÏŒ Ï„Î· ÏƒÏ…ÏƒÎºÎµÏ…Î®. Î£Ï…Î½Î­Ï‡ÎµÎ¹Î±;")) return;
    localStorage.removeItem(LS_KEY);
    localStorage.removeItem(LS_USERS);
    localStorage.removeItem(LS_USER);
    location.reload();
  };

  document.getElementById("btnClose").onclick=function(){
    ensureDay();
    var c=computePaid();
    var openCount=0, openSum=0;
    tickets().forEach(function(t){ (t.lines||[]).forEach(function(l){ openCount+=l.qty_open; openSum += l.qty_open*l.unit; }); });

    alert(
      "ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Î·Î¼Î­ÏÎ±Ï‚ ("+BASE_TODAY.split("-").reverse().join("/")+")\n\n"+
      "ÎœÎµÏ„ÏÎ·Ï„Î¬: "+euro(c.cash)+"\n"+
      "ÎšÎ¬ÏÏ„Î±: "+euro(c.card)+"\n"+
      "ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±: "+euro(c.gift)+"\n\n"+
      "Î‘Î½Î¿Î¹Ï‡Ï„Î¬ Ï„ÎµÎ¼Î¬Ï‡Î¹Î±: "+openCount+"\n"+
      "Î‘Î½Î¿Î¹Ï‡Ï„Î¬ Î±Î¾Î¯Î±: "+euro(openSum)
    );
  };

  // INIT
  renderUserSelect();
  ensureDay();
  setActiveTicketId(getActiveTicketId());
  buildCats();
  buildProducts();
  renderAll();

  function renderAll(){
    ensureDay();
    renderTablesGrid();
    renderTicketLines();
    renderPaid();
  }

})();
</script>

</body>
</html>
