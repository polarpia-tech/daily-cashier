<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Daily Cashier</title>
  <link rel="manifest" href="./manifest.webmanifest" />

  <style>
    :root{
      --bg0:#070a0f; --bg1:#0b0f14;
      --line:rgba(255,255,255,.10);
      --text:#eaf1ff;
      --muted:rgba(234,241,255,.72);
      --muted2:rgba(234,241,255,.55);
      --accent:#4aa3ff;
      --good:#2fe39f;
      --bad:#ff5566;
      --r:18px;

      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
      --safeLeft: env(safe-area-inset-left, 0px);
      --safeRight: env(safe-area-inset-right, 0px);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; margin:0; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 70% -10%, rgba(74,163,255,.18), transparent 55%),
        radial-gradient(900px 700px at -10% 30%, rgba(47,227,159,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }
    .app{
      height: 100dvh;
      display:flex;
      flex-direction:column;
      padding: calc(var(--safeTop) + 10px) calc(var(--safeRight) + 10px) calc(var(--safeBottom) + 10px) calc(var(--safeLeft) + 10px);
      gap:10px;
    }
    .topbar{
      display:flex;
      align-items:center;
      gap:10px;
      background: rgba(17,24,36,.55);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 10px 12px;
      backdrop-filter: blur(10px);
    }
    .brand{ flex:1; min-width:0; display:flex; flex-direction:column; gap:2px; }
    .shopName{ font-weight:1000; font-size:16px; line-height:1.1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .subline{ font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    select, button, input{ font: inherit; color:var(--text); }
    select{
      border:1px solid var(--line);
      background: rgba(17,24,36,.70);
      border-radius: 14px;
      height: 40px;
      padding: 0 36px 0 12px;
      appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, var(--muted) 50%),
        linear-gradient(135deg, var(--muted) 50%, transparent 50%);
      background-position: calc(100% - 18px) 50%, calc(100% - 12px) 50%;
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      max-width: 220px;
    }
    .iconbtn{
      border:1px solid var(--line);
      background: rgba(17,24,36,.70);
      border-radius:14px;
      height: 40px;
      width: 40px;
      display:flex;
      align-items:center;
      justify-content:center;
      position: relative;
      overflow:hidden;
    }

    .content{ flex:1; min-height:0; display:flex; flex-direction:column; }
    .view{
      flex:1; min-height:0;
      overflow:auto; -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      touch-action: pan-y;
      padding-bottom: calc(94px + var(--safeBottom));
    }
    .view::-webkit-scrollbar{ width:0; height:0; }

    .card{
      background: rgba(17,24,36,.55);
      border:1px solid var(--line);
      border-radius: var(--r);
      padding: 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      margin-bottom:10px;
    }
    .h{ font-weight:1000; margin:0 0 8px 0; font-size:16px; }
    .muted{ color:var(--muted); }
    .muted2{ color:var(--muted2); }
    .row{ display:flex; align-items:center; gap:10px; }
    .row.space{ justify-content:space-between; }

    /* PRESS ONLY (no ripple) */
    .pressable{
      position:relative; overflow:hidden;
      transition: transform .06s ease, filter .06s ease, background-color .12s ease, box-shadow .12s ease, border-color .12s ease;
      touch-action: manipulation; user-select:none; isolation:isolate;
      will-change: transform, filter;
    }
    .pressable:active{
      transform: translateY(1px) scale(.975);
      filter: brightness(1.18) saturate(1.05);
    }
    .pressable.is-pressed{
      background-color: rgba(47,227,159,.30) !important;
      border-color: rgba(47,227,159,.60) !important;
      box-shadow:
        0 0 0 4px rgba(47,227,159,.14) inset,
        0 10px 26px rgba(0,0,0,.22);
    }

    .tables{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px; }
    @media (min-width: 520px){ .tables{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    .tbtn{
      text-align:left; padding: 14px 14px;
      border-radius: var(--r);
      border:1px solid var(--line);
      background: rgba(17,24,36,.45);
      min-height: 74px;
      display:flex; flex-direction:column; justify-content:center; gap:4px;
      position:relative;
    }
    .tbtn .title{ font-weight:1000; font-size:18px; display:flex; align-items:center; gap:8px; }
    .tbtn .sub{ color:var(--muted); font-size:13px; }

    .led{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.16);
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.15);
      flex:0 0 auto;
    }
    .led.open{
      background: rgba(47,227,159,.85);
      border-color: rgba(47,227,159,.55);
      box-shadow: 0 0 10px rgba(47,227,159,.35);
    }
    .badge{
      position:absolute; right:10px; top:10px;
      min-width: 28px; height: 22px; padding:0 8px;
      border-radius: 999px;
      border:1px solid var(--line);
      display:flex; align-items:center; justify-content:center;
      font-size:12px; background: rgba(74,163,255,.10);
    }

    .chips{
      display:flex; gap:8px; overflow:auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      padding: 2px 2px 8px 2px;
      touch-action: pan-x;
    }
    .chips::-webkit-scrollbar{ height:0; }
    .chip{
      flex:0 0 auto;
      border:1px solid var(--line);
      background: rgba(17,24,36,.45);
      border-radius:999px;
      height: 38px;
      padding: 0 12px;
      display:flex; align-items:center; gap:8px;
      font-weight:900; color: var(--muted);
      white-space:nowrap;
    }
    .chip.active{
      color: var(--text);
      border-color: rgba(74,163,255,.35);
      box-shadow: 0 0 0 3px rgba(74,163,255,.08) inset;
    }

    .list{
      display:flex; flex-direction:column;
      border:1px solid var(--line);
      border-radius: var(--r);
      overflow:hidden;
      background: rgba(17,24,36,.35);
    }
    .li{
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 12px;
      border-top:1px solid rgba(255,255,255,.07);
      gap:12px;
    }
    .li:first-child{ border-top:none; }
    .li .left{ min-width:0; flex:1; }
    .li .name{ font-weight:1000; font-size:15px; line-height:1.15; margin:0; }
    .li .meta{ font-size:12px; color:var(--muted2); margin-top:3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .price{ font-weight:1000; font-size:15px; white-space:nowrap; }

    .qty{ display:flex; align-items:center; gap:6px; flex:0 0 auto; }
    .qbtn{
      height: 34px; min-width: 34px; padding: 0 10px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(17,24,36,.55);
      display:flex; align-items:center; justify-content:center;
      font-weight:1000; position:relative; overflow:hidden;
    }
    .qnum{ min-width: 22px; text-align:center; font-weight:1000; }

    .bottom{
      position:fixed; left:0; right:0; bottom:0;
      padding: 10px calc(var(--safeRight) + 10px) calc(var(--safeBottom) + 10px) calc(var(--safeLeft) + 10px);
      background: linear-gradient(180deg, transparent, rgba(7,10,15,.72) 30%, rgba(7,10,15,.92));
      backdrop-filter: blur(10px);
      pointer-events:none;
    }
    .bottom .bar{
      pointer-events:auto;
      display:grid; grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (min-width:520px){ .bottom .bar{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    .btn{
      border:1px solid var(--line);
      background: rgba(17,24,36,.62);
      border-radius: 16px;
      height: 48px;
      display:flex; align-items:center; justify-content:center;
      font-weight:1000;
      position:relative; overflow:hidden;
    }
    .btn.good{ border-color: rgba(47,227,159,.35); box-shadow:0 0 0 3px rgba(47,227,159,.06) inset; }
    .btn.bad{ border-color: rgba(255,85,102,.35); box-shadow:0 0 0 3px rgba(255,85,102,.06) inset; }
    .btn.accent{ border-color: rgba(74,163,255,.35); box-shadow:0 0 0 3px rgba(74,163,255,.06) inset; }
    .btn:disabled{ opacity:.45; }

    .bar.full .btn.full{ grid-column: 1 / -1; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(17,24,36,.40);
      margin: 6px 6px 0 0;
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 10px;
      padding-bottom: calc(10px + var(--safeBottom));
      z-index:999;
    }
    .modal{
      width:min(560px, 100%);
      border-radius: 22px;
      border:1px solid var(--line);
      background: rgba(17,24,36,.90);
      backdrop-filter: blur(14px);
      box-shadow: 0 30px 80px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .modal .head{
      padding: 14px 14px 10px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-weight:1000;
    }
    .modal .body{ padding: 14px; color:var(--muted); line-height:1.4; }
    .modal .foot{
      padding: 12px 14px 14px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    .input{
      width:100%;
      height:46px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(17,24,36,.55);
      padding: 0 12px;
      color: var(--text);
      outline:none;
    }
    .hint{ font-size:12px; color:var(--muted2); margin-top:8px; }
    .dangerBox{
      border:1px solid rgba(255,85,102,.35);
      background: rgba(255,85,102,.06);
      border-radius: 16px;
      padding: 12px;
    }

    /* Screen Saver overlay */
    .saver{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:10px;
      background: radial-gradient(900px 600px at 50% 0%, rgba(74,163,255,.10), transparent 55%),
                  rgba(0,0,0,.92);
      z-index: 998;
      padding: calc(var(--safeTop) + 20px) 20px calc(var(--safeBottom) + 20px) 20px;
      text-align:center;
    }
    .saver .big{ font-size:22px; font-weight:1000; letter-spacing:.2px; }
    .saver .mid{ font-size:14px; color:var(--muted); }
    .saver .time{ font-size:42px; font-weight:1000; margin-top:6px; }
    .saver .tap{ font-size:12px; color:var(--muted2); margin-top:14px; }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="shopName" id="shopNameTop">â€”</div>
        <div class="subline" id="topSub">â€”</div>
      </div>

      <select id="userSelect" title="Î§ÏÎ®ÏƒÏ„Î·Ï‚"></select>
      <button class="iconbtn pressable" id="btnGear" title="Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚" aria-label="Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚">âš™ï¸</button>
    </div>

    <div class="content">
      <div class="view" id="view"></div>
    </div>
  </div>

  <div class="bottom" id="bottom">
    <div class="bar" id="bottomBar"></div>
  </div>

  <div class="modalBack" id="modalBack">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="head" id="modalTitle">â€”</div>
      <div class="body" id="modalBody">â€”</div>
      <div class="foot" id="modalFoot"></div>
    </div>
  </div>

  <div class="saver" id="saver">
    <div class="big" id="saverShop">â€”</div>
    <div class="mid" id="saverUser">â€”</div>
    <div class="time" id="saverTime">â€”</div>
    <div class="tap">Î‘Î³Î³Î¯Î¾Ï„Îµ Î³Î¹Î± ÎµÏ€Î¹ÏƒÏ„ÏÎ¿Ï†Î®</div>
  </div>

  <script>
    const LS_KEY = "daily_cashier_db_v6";
    const TODAY = new Date().toISOString().slice(0,10);

    // Idle behavior
    const IDLE_HOME_MS  = 30_000;  // 30s no touch -> go Home
    const IDLE_SAVER_MS = 75_000;  // idle on Home -> saver
    let lastActivityTs = Date.now();
    let saverShown = false;

    const el = (id) => document.getElementById(id);
    const view = el("view");
    const bottom = el("bottom");
    const bottomBar = el("bottomBar");

    const modalBack = el("modalBack");
    const modalTitle = el("modalTitle");
    const modalBody  = el("modalBody");
    const modalFoot  = el("modalFoot");

    const saver = el("saver");
    const saverShop = el("saverShop");
    const saverUser = el("saverUser");
    const saverTime = el("saverTime");

    function hapticStrong(){
      try{ if(navigator.vibrate) navigator.vibrate([35, 12, 35]); }catch{}
    }
    function hapticSmall(){
      try{ if(navigator.vibrate) navigator.vibrate(12); }catch{}
    }

    function pressFlash(elem){
      elem.classList.add("is-pressed");
      setTimeout(()=> elem.classList.remove("is-pressed"), 190);
    }

    function makePressable(elem, strong=false){
      if(!elem) return;
      elem.classList.add("pressable");
      const down = ()=>{ pressFlash(elem); strong ? hapticStrong() : hapticSmall(); };
      elem.addEventListener("pointerdown", down, {passive:true});
    }

    // Activity tracking
    function markActivity(){
      lastActivityTs = Date.now();
      if(saverShown) hideSaver();
    }
    ["pointerdown","touchstart","mousedown","keydown","wheel"].forEach(evt=>{
      window.addEventListener(evt, markActivity, {passive:true});
    });

    function euro(x){
      const n = Number(x || 0);
      return n.toLocaleString("el-GR",{minimumFractionDigits:2, maximumFractionDigits:2}) + " â‚¬";
    }
    function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }

    function loadDB(){
      try{ const raw = localStorage.getItem(LS_KEY); if(raw) return JSON.parse(raw); }catch(e){}
      return null;
    }

    function defaultDB(){
      return {
        shopName: "Î¤Î¿ ÎœÎ±Î³Î±Î¶Î¯ Î¼Î¿Ï…",
        ownerPin: "9999",
        ownerEmail: "",
        ownerWhatsApp: "", // âœ… Ï€.Ï‡. 491761234567 (Ï‡Ï‰ÏÎ¯Ï‚ +)

        users: [
          { id:"u1", name:"Î¥Ï€Î¬Î»Î»Î·Î»Î¿Ï‚ 1", pin:"1111" }
        ],
        currentUserId: "u1",

        tables: [
          { id:"T1",  label:"T1" }, { id:"T2",  label:"T2" }, { id:"T3",  label:"T3" }, { id:"T4",  label:"T4" },
          { id:"T5",  label:"T5" }, { id:"T6",  label:"T6" }, { id:"BAR", label:"BAR" }, { id:"OUT", label:"Î•ÎÎ©" }
        ],

        menu: null,
        days: {}
      };
    }

    function buildMenuIfMissing(){
      const categories = [
        { id:"coffee_hot",  name:"ÎšÎ±Ï†Î­Î´ÎµÏ‚ â€“ Î–ÎµÏƒÏ„Î¿Î¯", emoji:"â˜•" },
        { id:"coffee_cold", name:"ÎšÎ±Ï†Î­Î´ÎµÏ‚ â€“ ÎšÏÏÎ¿Î¹",  emoji:"ğŸ§Š" },
        { id:"tea",         name:"Î¤ÏƒÎ¬Î¹ â€“ Î–ÎµÏƒÏ„Î¬",     emoji:"ğŸ«–" },
        { id:"choco",       name:"Î£Î¿ÎºÎ¿Î»Î¬Ï„ÎµÏ‚ / Î“Î±Î»Î±ÎºÏ„ÎµÏÎ¬", emoji:"ğŸ«" },
        { id:"soft",        name:"Î‘Î½Î±ÏˆÏ…ÎºÏ„Î¹ÎºÎ¬ â€“ ÎÎµÏÎ¬", emoji:"ğŸ¥¤" },
        { id:"juice",       name:"Î§Ï…Î¼Î¿Î¯ â€“ Smoothies", emoji:"ğŸŠ" },
        { id:"snack",       name:"Î£Î½Î±Îº â€“ Î“Î»Ï…ÎºÎ¬",      emoji:"ğŸ¥" },
        { id:"beer",        name:"ÎœÏ€ÏÏÎµÏ‚",            emoji:"ğŸº" },
        { id:"wine",        name:"ÎšÏÎ±ÏƒÎ¹Î¬",            emoji:"ğŸ·" },
        { id:"spirit",      name:"Î Î¿Ï„Î¬",              emoji:"ğŸ¥ƒ" },
        { id:"cocktail",    name:"ÎšÎ¿ÎºÏ„Î­Î¹Î»",           emoji:"ğŸ¸" },
        { id:"extras",      name:"Extras",            emoji:"â•" }
      ];
      return { categories, products: [] };
    }

    let db = loadDB() || defaultDB();
    if(!db.menu || !db.menu.categories){ db.menu = buildMenuIfMissing(); }

    if(!db.menu.products || db.menu.products.length===0){
      db.menu.products = [
        { id:"p_espresso_single", cat:"coffee_hot", name:"Espresso Î¼Î¿Î½ÏŒÏ‚", price:2.60 },
        { id:"p_espresso_double", cat:"coffee_hot", name:"Espresso Î´Î¹Ï€Î»ÏŒÏ‚", price:3.20 },
        { id:"p_espresso_macchiato", cat:"coffee_hot", name:"Espresso macchiato", price:2.90 },
        { id:"p_americano", cat:"coffee_hot", name:"Americano", price:3.20 },
        { id:"p_cappuccino", cat:"coffee_hot", name:"Cappuccino", price:3.60 },
        { id:"p_cappuccino_double", cat:"coffee_hot", name:"Cappuccino Î´Î¹Ï€Î»ÏŒÏ‚", price:4.20 },
        { id:"p_latte_macchiato", cat:"coffee_hot", name:"Latte macchiato", price:4.20 },
        { id:"p_flat_white", cat:"coffee_hot", name:"Flat white", price:4.40 },
        { id:"p_mocha", cat:"coffee_hot", name:"Mocha", price:4.50 },
        { id:"p_filter", cat:"coffee_hot", name:"ÎšÎ±Ï†Î­Ï‚ Ï†Î¯Î»Ï„ÏÎ¿Ï…", price:3.00 },
        { id:"p_freddo_espresso", cat:"coffee_cold", name:"Freddo espresso", price:3.80 },
        { id:"p_freddo_cappuccino", cat:"coffee_cold", name:"Freddo cappuccino", price:4.20 },
        { id:"p_iced_latte", cat:"coffee_cold", name:"Iced latte", price:4.50 },
        { id:"p_cold_brew", cat:"coffee_cold", name:"Cold brew", price:4.80 },
        { id:"p_frappe", cat:"coffee_cold", name:"Frappe", price:3.50 },
        { id:"p_tea_basic", cat:"tea", name:"Î¤ÏƒÎ¬Î¹ (Î¼Î±ÏÏÎ¿/Ï€ÏÎ¬ÏƒÎ¹Î½Î¿/Î²ÏŒÏ„Î±Î½Î±)", price:3.20 },
        { id:"p_tea_fruit", cat:"tea", name:"Î¤ÏƒÎ¬Î¹ Ï†ÏÎ¿ÏÏ„Ï‰Î½", price:3.50 },
        { id:"p_chai_latte", cat:"tea", name:"Chai latte", price:4.30 },
        { id:"p_hot_chocolate", cat:"choco", name:"Î–ÎµÏƒÏ„Î® ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:4.20 },
        { id:"p_cold_chocolate", cat:"choco", name:"ÎšÏÏÎ± ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:4.50 },
        { id:"p_white_chocolate", cat:"choco", name:"Î›ÎµÏ…ÎºÎ® ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:4.50 },
        { id:"p_cocoa", cat:"choco", name:"ÎšÎ±ÎºÎ¬Î¿", price:4.00 },
        { id:"p_cola", cat:"soft", name:"Coca-Cola / Zero / Fanta (0,33l)", price:3.40 },
        { id:"p_ice_tea", cat:"soft", name:"Ice Tea", price:3.60 },
        { id:"p_soda_tonic", cat:"soft", name:"Î£ÏŒÎ´Î± / Î¤ÏŒÎ½Î¹Îº", price:3.20 },
        { id:"p_water_033", cat:"soft", name:"ÎœÎµÏ„Î±Î»Î»Î¹ÎºÏŒ Î½ÎµÏÏŒ (0,33l)", price:2.80 },
        { id:"p_water_075", cat:"soft", name:"ÎœÎµÏ„Î±Î»Î»Î¹ÎºÏŒ Î½ÎµÏÏŒ (0,75l)", price:5.50 },
        { id:"p_orange_juice", cat:"juice", name:"Î¦Ï…ÏƒÎ¹ÎºÏŒÏ‚ Ï‡Ï…Î¼ÏŒÏ‚ Ï€Î¿ÏÏ„Î¿ÎºÎ¬Î»Î¹", price:4.50 },
        { id:"p_mix_juice", cat:"juice", name:"Î§Ï…Î¼ÏŒÏ‚ Î±Î½Î¬Î¼ÎµÎ¹ÎºÏ„Î¿Ï‚", price:4.80 },
        { id:"p_fruit_smoothie", cat:"juice", name:"Smoothie Ï†ÏÎ¿ÏÏ„Ï‰Î½", price:5.80 },
        { id:"p_milkshake", cat:"juice", name:"Milkshake", price:5.50 },
        { id:"p_croissant_plain", cat:"snack", name:"ÎšÏÎ¿Ï…Î±ÏƒÎ¬Î½ ÏƒÎºÎ­Ï„Î¿", price:2.80 },
        { id:"p_croissant_choco", cat:"snack", name:"ÎšÏÎ¿Ï…Î±ÏƒÎ¬Î½ ÏƒÎ¿ÎºÎ¿Î»Î¬Ï„Î±", price:3.20 },
        { id:"p_muffin", cat:"snack", name:"ÎœÎ¬Ï†Î¹Î½", price:3.50 },
        { id:"p_cake_piece", cat:"snack", name:"ÎšÎ­Î¹Îº (ÎºÎ¿Î¼Î¼Î¬Ï„Î¹)", price:4.20 },
        { id:"p_cheesecake", cat:"snack", name:"Cheesecake", price:4.80 },
        { id:"p_cookies", cat:"snack", name:"ÎœÏ€Î¹ÏƒÎºÏŒÏ„Î±", price:2.50 },
        { id:"p_toast_ham", cat:"snack", name:"Î¤Î¿ÏƒÏ„ Î¶Î±Î¼Ï€ÏŒÎ½-Ï„Ï…ÏÎ¯", price:4.50 },
        { id:"p_toast_veg", cat:"snack", name:"Î¤Î¿ÏƒÏ„ vegetarian", price:4.80 },
        { id:"p_beer_draft", cat:"beer", name:"ÎœÏ€ÏÏÎ± Î²Î±ÏÎµÎ»Î¯ÏƒÎ¹Î± (0,5l)", price:5.20 },
        { id:"p_beer_bottle", cat:"beer", name:"ÎœÏ€ÏÏÎ± ÎµÎ¼Ï†Î¹Î±Î»Ï‰Î¼Î­Î½Î· (0,33l)", price:4.20 },
        { id:"p_weissbier", cat:"beer", name:"Weissbier (0,5l)", price:5.50 },
        { id:"p_beer_zero", cat:"beer", name:"ÎœÏ€ÏÏÎ± Ï‡Ï‰ÏÎ¯Ï‚ Î±Î»ÎºÎ¿ÏŒÎ»", price:4.20 },
        { id:"p_wine_glass", cat:"wine", name:"ÎšÏÎ±ÏƒÎ¯ Ï€Î¿Ï„Î®ÏÎ¹", price:5.50 },
        { id:"p_wine_carafe", cat:"wine", name:"ÎšÏÎ±ÏƒÎ¯ ÎºÎ±ÏÎ¬Ï†Î± (0,5l)", price:12.00 },
        { id:"p_wine_bottle_22", cat:"wine", name:"Î¦Î¹Î¬Î»Î· ÎºÏÎ±ÏƒÎ¯ (22â‚¬)", price:22.00 },
        { id:"p_wine_bottle_28", cat:"wine", name:"Î¦Î¹Î¬Î»Î· ÎºÏÎ±ÏƒÎ¯ (28â‚¬)", price:28.00 },
        { id:"p_prosecco_glass", cat:"wine", name:"Prosecco Ï€Î¿Ï„Î®ÏÎ¹", price:6.50 },
        { id:"p_whisky_std", cat:"spirit", name:"ÎŸÏ…Î¯ÏƒÎºÎ¹ standard (4cl)", price:8.50 },
        { id:"p_whisky_premium", cat:"spirit", name:"Premium Î¿Ï…Î¯ÏƒÎºÎ¹ (4cl)", price:10.50 },
        { id:"p_vodka", cat:"spirit", name:"Î’ÏŒÏ„ÎºÎ± (4cl)", price:8.00 },
        { id:"p_rum", cat:"spirit", name:"Î¡Î¿ÏÎ¼Î¹ (4cl)", price:8.50 },
        { id:"p_gin", cat:"spirit", name:"Î¤Î¶Î¹Î½ (4cl)", price:8.50 },
        { id:"p_ouzo_tsipouro", cat:"spirit", name:"ÎŸÏÎ¶Î¿ / Î¤ÏƒÎ¯Ï€Î¿Ï…ÏÎ¿ (4cl)", price:7.50 },
        { id:"p_liqueur", cat:"spirit", name:"Î›Î¹ÎºÎ­Ï (4cl)", price:7.50 },
        { id:"p_mojito", cat:"cocktail", name:"Mojito", price:9.50 },
        { id:"p_caipirinha", cat:"cocktail", name:"Caipirinha", price:9.50 },
        { id:"p_margarita", cat:"cocktail", name:"Margarita", price:10.00 },
        { id:"p_aperol", cat:"cocktail", name:"Aperol Spritz", price:8.50 },
        { id:"p_gin_tonic", cat:"cocktail", name:"Gin Tonic", price:9.00 },
        { id:"p_negroni", cat:"cocktail", name:"Negroni", price:10.50 },
        { id:"p_extra_decaf", cat:"extras", name:"Decaf (+)", price:0.30 },
        { id:"p_extra_plant_milk", cat:"extras", name:"Î¦Ï…Ï„Î¹ÎºÏŒ Î³Î¬Î»Î± (+)", price:0.50 }
      ];
    }

    function saveDB(){ localStorage.setItem(LS_KEY, JSON.stringify(db)); }

    // Ensure day + shift
    function ensureDay(){
      if(!db.days[TODAY]) db.days[TODAY] = { shiftId: uid(), shifts:[], tables:{}, payments:[] };

      for(const t of db.tables){
        if(!db.days[TODAY].tables[t.id]) db.days[TODAY].tables[t.id] = { items:[] };
        if(!Array.isArray(db.days[TODAY].tables[t.id].items)) db.days[TODAY].tables[t.id].items = [];
      }
      if(!db.days[TODAY].shiftId) db.days[TODAY].shiftId = uid();
      if(!Array.isArray(db.days[TODAY].shifts)) db.days[TODAY].shifts = [];
      if(!Array.isArray(db.days[TODAY].payments)) db.days[TODAY].payments = [];
    }
    ensureDay(); saveDB();

    // lastUserId prevents broken select revert
    let lastUserId = db.currentUserId;

    function getUser(){ return db.users.find(u=>u.id===db.currentUserId) || db.users[0]; }

    function setTop(){
      el("shopNameTop").textContent = db.shopName || "â€”";
      const u = getUser();
      el("topSub").textContent = `${TODAY} â€¢ Î•Î½ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±: ${u?.name || "â€”"}`;
      document.title = db.shopName || "Daily Cashier";
      updateSaverText();
    }

    function fillUsers(){
      const sel = el("userSelect");
      sel.innerHTML = "";
      for(const u of db.users){
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = u.name;
        if(u.id===db.currentUserId) opt.selected = true;
        sel.appendChild(opt);
      }
      sel.value = db.currentUserId;
      lastUserId = db.currentUserId;
    }

    // modal helpers
    function closeModal(){
      modalBack.style.display = "none";
      modalTitle.textContent = "";
      modalBody.innerHTML = "";
      modalFoot.innerHTML = "";
    }
    modalBack.addEventListener("click", (e)=>{ if(e.target===modalBack) closeModal(); });

    function modalConfirm(title, text, okText="ÎÎ±Î¹", cancelText="Î†ÎºÏ…ÏÎ¿"){
      return new Promise((resolve)=>{
        modalTitle.textContent = title;
        modalBody.textContent = text;
        modalFoot.innerHTML = "";

        const b1 = document.createElement("button");
        b1.className = "btn pressable";
        b1.textContent = cancelText;
        makePressable(b1, true);
        b1.addEventListener("click", ()=>{ closeModal(); resolve(false); });

        const b2 = document.createElement("button");
        b2.className = "btn pressable good";
        b2.textContent = okText;
        makePressable(b2, true);
        b2.addEventListener("click", ()=>{ closeModal(); resolve(true); });

        modalFoot.appendChild(b1);
        modalFoot.appendChild(b2);

        modalBack.style.display = "flex";
      });
    }

    function modalAlert(title, text, okText="ÎŸÎš"){
      return new Promise((resolve)=>{
        modalTitle.textContent = title;
        modalBody.textContent = text;
        modalFoot.innerHTML = "";

        const b = document.createElement("button");
        b.className = "btn pressable good";
        b.textContent = okText;
        makePressable(b, true);
        b.addEventListener("click", ()=>{ closeModal(); resolve(true); });

        const dummy = document.createElement("div");
        dummy.style.display = "none";
        modalFoot.appendChild(dummy);
        modalFoot.appendChild(b);

        modalBack.style.display = "flex";
      });
    }

    function modalPromptPin(title, label, hint){
      return new Promise((resolve)=>{
        modalTitle.textContent = title;
        modalBody.innerHTML = `
          <div>${label}</div>
          <div style="margin-top:10px;">
            <input class="input" id="pinInput"
              type="password"
              inputmode="numeric"
              pattern="[0-9]*"
              autocomplete="one-time-code"
              placeholder="â€¢â€¢â€¢â€¢" />
          </div>
          <div class="hint">${hint || ""}</div>
        `;
        modalFoot.innerHTML = "";

        const cancel = document.createElement("button");
        cancel.className = "btn pressable";
        cancel.textContent = "Î†ÎºÏ…ÏÎ¿";
        makePressable(cancel, true);
        cancel.addEventListener("click", ()=>{ closeModal(); resolve(null); });

        const ok = document.createElement("button");
        ok.className = "btn pressable good";
        ok.textContent = "ÎŸÎš";
        makePressable(ok, true);
        ok.addEventListener("click", ()=>{
          const v = (document.getElementById("pinInput").value || "").trim();
          closeModal();
          resolve(v);
        });

        modalFoot.appendChild(cancel);
        modalFoot.appendChild(ok);
        modalBack.style.display = "flex";
        setTimeout(()=> document.getElementById("pinInput")?.focus(), 50);
      });
    }

    function escHtml(s){
      return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#39;");
    }
    function modalPromptText(title, label, initialValue="", hint=""){
      return new Promise((resolve)=>{
        modalTitle.textContent = title;
        modalBody.innerHTML = `
          <div>${escHtml(label)}</div>
          <div style="margin-top:10px;">
            <input class="input" id="textInput"
              type="text"
              autocomplete="off"
              value="${escHtml(initialValue)}" />
          </div>
          <div class="hint">${escHtml(hint || "")}</div>
        `;
        modalFoot.innerHTML = "";

        const cancel = document.createElement("button");
        cancel.className = "btn pressable";
        cancel.textContent = "Î†ÎºÏ…ÏÎ¿";
        makePressable(cancel, true);
        cancel.addEventListener("click", ()=>{ closeModal(); resolve(null); });

        const ok = document.createElement("button");
        ok.className = "btn pressable good";
        ok.textContent = "ÎŸÎš";
        makePressable(ok, true);
        ok.addEventListener("click", ()=>{
          const v = (document.getElementById("textInput").value || "").trim();
          closeModal();
          resolve(v);
        });

        modalFoot.appendChild(cancel);
        modalFoot.appendChild(ok);
        modalBack.style.display = "flex";
        setTimeout(()=> document.getElementById("textInput")?.focus(), 50);
      });
    }

    // state
    let state = { screen:"home", tableId:null, categoryId:null };
    function gotoHome(){ state.screen="home"; state.tableId=null; render(); }
    function gotoTable(tid){ state.screen="table"; state.tableId=tid; render(); }
    function gotoAdd(tid){ state.screen="add"; state.tableId=tid; state.categoryId = state.categoryId || db.menu.categories[0]?.id; render(); }
    function gotoPay(tid){ state.screen="pay"; state.tableId=tid; render(); }
    function gotoSummary(){ state.screen="summary"; state.tableId=null; render(); }
    function gotoSettings(){ state.screen="settings"; state.tableId=null; render(); }

    function dayTable(tid){ ensureDay(); return db.days[TODAY].tables[tid]; }
    function unpaidItems(tid){ return dayTable(tid).items.filter(it => !it.paid && !it.voided && it.shiftId === db.days[TODAY].shiftId); }
    function tableTotal(tid){ return unpaidItems(tid).reduce((s,it)=>s+it.price,0); }

    function groupUnpaid(tid){
      const map = new Map();
      for(const it of unpaidItems(tid)){
        const k = it.prodId + "|" + it.price + "|" + (it.tag||""); // âœ… BAR: split by tag
        if(!map.has(k)) map.set(k, { prodId: it.prodId, name: it.name, price: it.price, qty:0, tag:(it.tag||"") });
        map.get(k).qty += 1;
      }
      return [...map.values()];
    }

    function addProductToTable(prodId){
      const tid = state.tableId;
      const p = db.menu.products.find(x=>x.id===prodId);
      if(!tid || !p) return;
      dayTable(tid).items.push({
        id: uid(), prodId:p.id, name:p.name, cat:p.cat, price:Number(p.price),
        ts: Date.now(), by: getUser()?.name || "", paid:null, voided:false,
        shiftId: db.days[TODAY].shiftId,
        tag: "" // âœ… who is it for (BAR)
      });
      saveDB(); render();
    }

    function removeOneUnit(tid, prodId, tag=""){
      const items = dayTable(tid).items;
      const idx = items.findIndex(it =>
        it.prodId===prodId && (it.tag||"")===(tag||"") &&
        !it.paid && !it.voided && it.shiftId === db.days[TODAY].shiftId
      );
      if(idx>=0){ items.splice(idx,1); saveDB(); render(); }
    }

    function findOneUnpaid(tid, prodId, tag=""){
      return dayTable(tid).items.find(it =>
        it.prodId===prodId && (it.tag||"")===(tag||"") &&
        !it.paid && !it.voided && it.shiftId === db.days[TODAY].shiftId
      ) || null;
    }

    function setBottomButtons(btns, fullMode=false){
      bottomBar.className = "bar" + (fullMode ? " full" : "");
      bottomBar.innerHTML = "";
      if(!btns || btns.length===0){ bottom.style.display="none"; return; }
      bottom.style.display="block";

      for(const b of btns){
        const btn = document.createElement("button");
        btn.className = "btn pressable " + (b.kind||"") + (b.full ? " full" : "");
        btn.textContent = b.text;
        if(b.disabled){
          btn.disabled = true;
        }
        makePressable(btn, true);
        btn.addEventListener("click", ()=>{
          if(btn.disabled) return;
          pressFlash(btn);
          hapticStrong();
          b.onClick();
        });
        bottomBar.appendChild(btn);
      }
    }

    async function markTreatOne(tid, prodId, tag=""){
      const it = findOneUnpaid(tid, prodId, tag);
      if(!it) return;
      const ok = await modalConfirm("ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î¿", `ÎÎ± Î³Î¯Î½ÎµÎ¹ ÎºÎµÏÎ±ÏƒÎ¼Î­Î½Î¿ 1 Ï„ÎµÎ¼. â€œ${it.name}â€;`, "ÎÎ±Î¹", "Î†ÎºÏ…ÏÎ¿");
      if(!ok) return;
      const u = getUser()?.name || "";
      const ts = Date.now();
      it.paid = { method:"treat", ts, by:u };
      db.days[TODAY].payments.push({
        id:uid(), shiftId: db.days[TODAY].shiftId,
        tableId:tid, prodId:it.prodId, name:it.name, price:it.price, method:"treat", ts, by:u,
        tag: it.tag || ""
      });
      saveDB(); render();
    }

    function payAll(tid, method){
      const items = unpaidItems(tid);
      if(items.length===0){ gotoHome(); return; }
      const u = getUser()?.name || "";
      const ts = Date.now();
      for(const it of items){
        it.paid = { method, ts, by:u };
        db.days[TODAY].payments.push({
          id:uid(), shiftId: db.days[TODAY].shiftId,
          tableId:tid, prodId:it.prodId, name:it.name, price:it.price, method, ts, by:u,
          tag: it.tag || ""
        });
      }
      saveDB();
      gotoHome();
    }

    // owner gate (for settings only)
    async function requireOwner(){
      const pin = await modalPromptPin("Owner Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·", "Î’Î¬Î»Îµ Owner PIN", "ÎœÏŒÎ½Î¿ Î¿ Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·Ï‚ Î±Î»Î»Î¬Î¶ÎµÎ¹ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚.");
      if(pin===null) return false;
      return String(pin) === String(db.ownerPin || "9999");
    }

    // Screen saver
    function updateSaverText(){
      const u = getUser();
      saverShop.textContent = db.shopName || "â€”";
      saverUser.textContent = `Î•Î½ Ï…Ï€Î·ÏÎµÏƒÎ¯Î±: ${u?.name || "â€”"} â€¢ ${TODAY}`;
      const now = new Date();
      saverTime.textContent = now.toLocaleTimeString("el-GR",{hour:"2-digit",minute:"2-digit"});
    }
    setInterval(()=>{ if(saverShown) updateSaverText(); }, 10_000);

    function showSaver(){
      saverShown = true;
      updateSaverText();
      saver.style.display = "flex";
    }
    function hideSaver(){
      saverShown = false;
      saver.style.display = "none";
      render();
    }
    saver.addEventListener("pointerdown", ()=>{
      markActivity();
      hideSaver();
    });

    // Shift logic
    function shiftPayments(){
      const pay = db.days[TODAY].payments || [];
      return pay.filter(p => p.shiftId === db.days[TODAY].shiftId);
    }
    function computeShiftTotals(){
      const pay = shiftPayments();
      const totals = { cash:0, card:0, treat:0, all:0, count: pay.length };
      for(const p of pay){
        totals.all += p.price;
        if(p.method==="cash") totals.cash += p.price;
        if(p.method==="card") totals.card += p.price;
        if(p.method==="treat") totals.treat += p.price;
      }
      return totals;
    }

    function shiftReportText(totals){
      const u = getUser();
      return [
        `ÎœÎ±Î³Î±Î¶Î¯: ${db.shopName || "â€”"}`,
        `Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±: ${TODAY}`,
        `Î’Î¬ÏÎ´Î¹Î± (Shift ID): ${db.days[TODAY].shiftId}`,
        `Î§ÏÎ®ÏƒÏ„Î·Ï‚: ${u?.name || "â€”"}`,
        `Î£ÏÎ½Î¿Î»Î¿: ${euro(totals.all)}`,
        `ÎœÎµÏ„ÏÎ·Ï„Î¬: ${euro(totals.cash)}`,
        `ÎšÎ¬ÏÏ„Î±: ${euro(totals.card)}`,
        `ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±: ${euro(totals.treat)}`,
        `Î Î»Î·ÏÏ‰Î¼Î­Ï‚: ${totals.count}`
      ].join("\n");
    }

    function csvForShift(){
      const pay = shiftPayments();
      const rows = [["date","time","shiftId","table","product","tag","price","method","user"].join(",")];
      for(const p of pay){
        const d = new Date(p.ts);
        rows.push([
          TODAY,
          d.toLocaleTimeString("el-GR",{hour:"2-digit",minute:"2-digit"}),
          p.shiftId,
          p.tableId,
          `"${String(p.name).replaceAll('"','""')}"`,
          `"${String(p.tag||"").replaceAll('"','""')}"`,
          Number(p.price).toFixed(2),
          p.method,
          `"${String(p.by||"").replaceAll('"','""')}"`
        ].join(","));
      }
      return rows.join("\n");
    }

    async function sendShiftToOwner(){
      const totals = computeShiftTotals();
      if(totals.all <= 0.00001) return;

      const text = shiftReportText(totals);
      const csv = csvForShift();

      // 1) Web Share (choose WhatsApp/Email)
      try{
        const file = new File([csv], `shift_${TODAY}_${db.days[TODAY].shiftId}.csv`, {type:"text/csv"});
        if(navigator.share){
          const payload = { title:`Î¤Î±Î¼ÎµÎ¯Î¿ Î²Î¬ÏÎ´Î¹Î±Ï‚ â€¢ ${db.shopName || ""}`, text };
          if(navigator.canShare && navigator.canShare({files:[file]})){
            payload.files = [file];
          }
          await navigator.share(payload);
          return;
        }
      }catch(e){}

      // 2) WhatsApp direct
      const wa = (db.ownerWhatsApp || "").trim();
      if(wa){
        const waText = encodeURIComponent(text + "\n\n" + csv);
        window.location.href = `https://wa.me/${encodeURIComponent(wa)}?text=${waText}`;
        return;
      }

      // 3) Email fallback
      const to = (db.ownerEmail || "").trim();
      const subj = encodeURIComponent(`Î¤Î±Î¼ÎµÎ¯Î¿ Î²Î¬ÏÎ´Î¹Î±Ï‚ â€¢ ${db.shopName || ""} â€¢ ${TODAY}`);
      const body = encodeURIComponent(text + "\n\nCSV:\n" + csv);
      window.location.href = `mailto:${encodeURIComponent(to)}?subject=${subj}&body=${body}`;
    }

    async function closeShift(){
      const totals = computeShiftTotals();

      const ok = await modalConfirm(
        "ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Î²Î¬ÏÎ´Î¹Î±Ï‚",
        `ÎÎ± ÎºÎ»ÎµÎ¯ÏƒÎµÎ¹ Î· Î²Î¬ÏÎ´Î¹Î±;\n\nÎ£ÏÎ½Î¿Î»Î¿: ${euro(totals.all)}\nÎœÎµÏ„ÏÎ·Ï„Î¬: ${euro(totals.cash)}\nÎšÎ¬ÏÏ„Î±: ${euro(totals.card)}\nÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±: ${euro(totals.treat)}`,
        "ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿",
        "Î†ÎºÏ…ÏÎ¿"
      );
      if(!ok) return;

      // Store shift record in history
      db.days[TODAY].shifts.push({
        id: db.days[TODAY].shiftId,
        closedAt: Date.now(),
        user: getUser()?.name || "",
        totals
      });

      // Reset for next shift
      db.days[TODAY].shiftId = uid();
      db.days[TODAY].payments = []; // reset payments for next shift

      // Clear tables for new shift
      for(const t of db.tables){
        db.days[TODAY].tables[t.id].items = [];
      }

      saveDB();
      gotoHome();
      await modalAlert("ÎˆÎ³Î¹Î½Îµ âœ…", "Î— Î²Î¬ÏÎ´Î¹Î± Î­ÎºÎ»ÎµÎ¹ÏƒÎµ ÎºÎ±Î¹ Î¾ÎµÎºÎ¯Î½Î·ÏƒÎµ Î½Î­Î± Î²Î¬ÏÎ´Î¹Î± (ÎºÎ±Î¸Î±ÏÏŒ Ï„Î±Î¼ÎµÎ¯Î¿).");
    }

    // screens
    function renderHome(){
      view.innerHTML = `
        <div style="
          text-align:center;
          font-weight:1000;
          letter-spacing:.2px;
          margin: 6px 0 10px 0;
          color: rgba(234,241,255,.92);
          font-size: 16px;
        ">Î¤ÏÎ±Ï€Î­Î¶Î¹Î± - Bar</div>

        <div class="tables">
          ${db.tables.map(t=>{
            const total = tableTotal(t.id);
            const count = unpaidItems(t.id).length;
            const open = total>0;
            return `
              <button class="tbtn pressable" data-tid="${t.id}">
                <div class="title">
                  <span class="led ${open ? "open" : ""}"></span>
                  ${escHtml(t.label)}
                </div>
                <div class="sub">${open ? ("Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: " + euro(total)) : "â€”"}</div>
                <div class="badge">${count}</div>
              </button>
            `;
          }).join("")}
        </div>
      `;

      view.querySelectorAll("[data-tid]").forEach(b=>{
        makePressable(b, true);
        b.addEventListener("click", ()=> gotoTable(b.getAttribute("data-tid")));
      });

      setBottomButtons([
        { text:"Î£ÏÎ½Î¿ÏˆÎ·", kind:"accent", onClick: ()=> gotoSummary() },
        { text:"CSV", kind:"", onClick: ()=> exportCSV() },
        { text:"Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚", kind:"", onClick: ()=> gotoSettings() }
      ]);
    }

    function renderTable(){
      const tid = state.tableId;
      const t = db.tables.find(x=>x.id===tid);
      const groups = groupUnpaid(tid);
      const total = tableTotal(tid);

      view.innerHTML = `
        <div class="card">
          <div class="h">Î¤ÏÎ±Ï€Î­Î¶Î¹: ${escHtml(t?.label || tid)}</div>
          <div class="muted">Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: <b>${euro(total)}</b></div>
          ${tid==="BAR" ? `<div class="hint">Î£Ï„Î¿ BAR, ÎºÎ¬Î¸Îµ Ï€ÏÎ¿ÏŠÏŒÎ½ Ï€Î±Î¯ÏÎ½ÎµÎ¹ â€œÏƒÎµ Ï€Î¿Î¹Î¿Î½â€ (Ï€.Ï‡. Ï†Î±Î»Î±ÎºÏÏŒÏ‚/Ï‡Î¿Î½Ï„ÏÏŒÏ‚).</div>` : ``}
        </div>

        <div class="card">
          <div class="h">Î‘Î½Î¿Î¹Ï‡Ï„Î¬ items</div>
          ${groups.length===0 ? `<div class="muted">ÎšÎ±Î¸Î±ÏÏŒ âœ…</div>` : `
            <div class="list">
              ${groups.map(g=>`
                <div class="li">
                  <div class="left">
                    <div class="name">${escHtml(g.name)}${g.tag ? ` <span class="muted2">(${escHtml(g.tag)})</span>` : ``}</div>
                    <div class="meta">${euro(g.price)} â€¢ ${g.qty} Ï„ÎµÎ¼.</div>
                  </div>
                  <div class="qty">
                    <button class="qbtn pressable" data-minus="${g.prodId}" data-tag="${escHtml(g.tag||"")}">âˆ’</button>
                    <div class="qnum">${g.qty}</div>
                    <button class="qbtn pressable" data-plus="${g.prodId}" data-tag="${escHtml(g.tag||"")}">+</button>
                  </div>
                </div>
              `).join("")}
            </div>
          `}
        </div>
      `;

      view.querySelectorAll("[data-minus]").forEach(b=>{
        makePressable(b, true);
        b.addEventListener("click", ()=>{
          const tag = b.getAttribute("data-tag") || "";
          removeOneUnit(tid, b.getAttribute("data-minus"), tag);
        });
      });

      view.querySelectorAll("[data-plus]").forEach(b=>{
        makePressable(b, true);
        b.addEventListener("click", async ()=>{
          const pid = b.getAttribute("data-plus");
          const tag = b.getAttribute("data-tag") || "";
          // + Î¼Î­ÏƒÎ± Î±Ï€ÏŒ table screen: Ï€ÏÎ¿ÏƒÎ¸Î­Ï„ÎµÎ¹ Î¯Î´Î¹Î¿ tag group
          addProductToTable(pid);
          const items = dayTable(tid).items;
          const last = items[items.length - 1];
          if(last && last.prodId===pid && last.shiftId===db.days[TODAY].shiftId && !last.paid && !last.voided){
            last.tag = String(tag||"").trim();
            saveDB(); render();
          }
        });
      });

      setBottomButtons([
        { text:"â† Î Î¯ÏƒÏ‰", kind:"", onClick: ()=> gotoHome() },
        { text:"+ Î ÏÎ¿ÏŠÏŒÎ½", kind:"accent", onClick: ()=> gotoAdd(tid) },
        { text:"Î Î›Î—Î¡Î©ÎœÎ—", kind:"good", full:true, onClick: ()=> gotoPay(tid) }
      ], true);
    }

    function renderAdd(){
      const tid = state.tableId;
      const t = db.tables.find(x=>x.id===tid);
      const cats = db.menu.categories;
      const activeCat = state.categoryId || cats[0]?.id;
      const products = db.menu.products.filter(p=>p.cat===activeCat);

      view.innerHTML = `
        <div class="card">
          <div class="h">+ Î ÏÎ¿ÏŠÏŒÎ½ â€¢ ${escHtml(t?.label || tid)}</div>
          <div class="muted">Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: <b>${euro(tableTotal(tid))}</b></div>
          ${tid==="BAR" ? `<div class="hint">Î£Ï„Î¿ BAR Î¸Î± ÏƒÎµ ÏÏ‰Ï„Î®ÏƒÎµÎ¹ â€œÏƒÎµ Ï€Î¿Î¹Î¿Î½â€ ÎºÎ¬Î¸Îµ Ï†Î¿ÏÎ¬.</div>` : ``}
        </div>

        <div class="card">
          <div class="h">ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚</div>
          <div class="chips">
            ${cats.map(c=>`
              <button class="chip pressable ${c.id===activeCat?"active":""}" data-cat="${c.id}">
                ${c.emoji} ${escHtml(c.name)}
              </button>
            `).join("")}
          </div>
        </div>

        <div class="card">
          <div class="h">Î ÏÎ¿ÏŠÏŒÎ½Ï„Î±</div>
          <div class="list">
            ${products.map(p=>`
              <div class="li pressable" data-add="${p.id}">
                <div class="left">
                  <div class="name">${escHtml(p.name)}</div>
                  <div class="meta">${euro(p.price)}</div>
                </div>
                <div class="price">${euro(p.price)}</div>
              </div>
            `).join("")}
          </div>
        </div>
      `;

      view.querySelectorAll("[data-cat]").forEach(b=>{
        makePressable(b, true);
        b.addEventListener("click", ()=>{ state.categoryId=b.getAttribute("data-cat"); render(); });
      });

      view.querySelectorAll("[data-add]").forEach(li=>{
        makePressable(li, true);
        li.addEventListener("click", async ()=>{
          const pid = li.getAttribute("data-add");

          if(state.tableId === "BAR"){
            const tag = await modalPromptText(
              "BAR â€¢ Î£Îµ Ï€Î¿Î¹Î¿Î½;",
              "Î“ÏÎ¬ÏˆÎµ Î±Î½Î±Ï†Î¿ÏÎ¬ (Ï€.Ï‡. Ï‡Î¿Î½Ï„ÏÏŒÏ‚ / Ï†Î±Î»Î±ÎºÏÏŒÏ‚ / ÎºÏŒÎºÎºÎ¹Î½Î· Î¼Ï€Î»Î¿ÏÎ¶Î±):",
              "",
              "Î†Ï†Î·ÏƒÎµ ÎºÎµÎ½ÏŒ Î±Î½ Î´ÎµÎ½ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹."
            );
            if(tag === null) return; // cancel
            addProductToTable(pid);
            const items = dayTable("BAR").items;
            const last = items[items.length - 1];
            if(last && last.prodId===pid && last.shiftId===db.days[TODAY].shiftId && !last.paid && !last.voided){
              last.tag = String(tag||"").trim();
              saveDB(); render();
            }
          }else{
            addProductToTable(pid);
          }
        });
      });

      // âœ… No PAYMENT button in categories/products screen
      setBottomButtons([
        { text:"â† Î Î¯ÏƒÏ‰", kind:"", onClick: ()=> gotoTable(tid) }
      ]);
    }

    function renderPay(){
      const tid = state.tableId;
      const t = db.tables.find(x=>x.id===tid);
      const total = tableTotal(tid);
      const groups = groupUnpaid(tid);

      view.innerHTML = `
        <div class="card">
          <div class="h">Î Î»Î·ÏÏ‰Î¼Î® â€¢ ${escHtml(t?.label || tid)}</div>
          <div class="muted">Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: <b>${euro(total)}</b></div>
          <div class="row" style="margin-top:10px;">
            <button class="btn pressable good" style="flex:1;" id="payCash">ÎœÎµÏ„ÏÎ·Ï„Î¬</button>
            <button class="btn pressable accent" style="flex:1;" id="payCard">ÎšÎ¬ÏÏ„Î±</button>
          </div>
          <div class="muted2" style="margin-top:8px;">ğŸ = ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î¿ (Î±Ï†Î±Î¹ÏÎµÎ¯ 1 Ï„ÎµÎ¼. Î±Ï€ÏŒ Ï„Î¿ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿)</div>
        </div>

        <div class="card">
          <div class="h">Î‘Î½Î¿Î¹Ï‡Ï„Î¬ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±</div>
          ${groups.length===0 ? `<div class="muted">ÎšÎ±Î¸Î±ÏÏŒ âœ…</div>` : `
            <div class="list">
              ${groups.map(g=>`
                <div class="li">
                  <div class="left">
                    <div class="name">${escHtml(g.name)}${g.tag ? ` <span class="muted2">(${escHtml(g.tag)})</span>` : ``}</div>
                    <div class="meta">${euro(g.price)} â€¢ ${g.qty} Ï„ÎµÎ¼.</div>
                  </div>
                  <div class="qty">
                    <button class="qbtn pressable" title="ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î¿ 1 Ï„ÎµÎ¼." data-treat="${g.prodId}" data-tag="${escHtml(g.tag||"")}">ğŸ</button>
                  </div>
                </div>
              `).join("")}
            </div>
          `}
        </div>
      `;

      const cash = document.getElementById("payCash");
      const card = document.getElementById("payCard");
      makePressable(cash, true);
      makePressable(card, true);
      cash.addEventListener("click", ()=> payAll(tid,"cash"));
      card.addEventListener("click", ()=> payAll(tid,"card"));

      view.querySelectorAll("[data-treat]").forEach(b=>{
        makePressable(b, true);
        b.addEventListener("click", ()=>{
          const tag = b.getAttribute("data-tag") || "";
          markTreatOne(tid, b.getAttribute("data-treat"), tag);
        });
      });

      setBottomButtons([
        { text:"â† Î Î¯ÏƒÏ‰", kind:"", onClick: ()=> gotoTable(tid) }
      ]);
    }

    function renderSummary(){
      const totals = computeShiftTotals();
      const pay = shiftPayments();
      const canSend = totals.all > 0.00001;

      view.innerHTML = `
        <div class="card">
          <div class="h">Î£ÏÎ½Î¿ÏˆÎ· â€¢ ${TODAY}</div>
          <div class="muted2">Shift: <b>${escHtml(db.days[TODAY].shiftId)}</b></div>
          <div>
            <span class="pill">Î£ÏÎ½Î¿Î»Î¿: <b>${euro(totals.all)}</b></span>
            <span class="pill">ÎœÎµÏ„ÏÎ·Ï„Î¬: <b>${euro(totals.cash)}</b></span>
            <span class="pill">ÎšÎ¬ÏÏ„Î±: <b>${euro(totals.card)}</b></span>
            <span class="pill">ÎšÎµÏÎ±ÏƒÎ¼Î­Î½Î±: <b>${euro(totals.treat)}</b></span>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn pressable" style="flex:1;" id="btnSendOwner" ${canSend ? "" : "disabled"}>Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·</button>
            <button class="btn pressable bad" style="flex:1;" id="btnCloseShift">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Î²Î¬ÏÎ´Î¹Î±Ï‚</button>
          </div>
          <div class="hint">Î¤Î¿ â€œÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Î²Î¬ÏÎ´Î¹Î±Ï‚â€ Î¼Î·Î´ÎµÎ½Î¯Î¶ÎµÎ¹ Ï„Î± Ï€Î¬Î½Ï„Î± ÎºÎ±Î¹ Î±Î½Î¿Î¯Î³ÎµÎ¹ Î½Î­Î± Î²Î¬ÏÎ´Î¹Î±.</div>
        </div>

        <div class="card">
          <div class="h">Î Î»Î·ÏÏ‰Î¼Î­Ï‚ (${pay.length})</div>
          <div class="list">
            ${pay.slice().reverse().map(p=>`
              <div class="li">
                <div class="left">
                  <div class="name">${escHtml(p.name)}${p.tag ? ` <span class="muted2">(${escHtml(p.tag)})</span>` : ``}</div>
                  <div class="meta">${escHtml(p.tableId)} â€¢ ${String(p.method).toUpperCase()} â€¢ ${new Date(p.ts).toLocaleTimeString("el-GR",{hour:"2-digit",minute:"2-digit"})} â€¢ ${escHtml(p.by)}</div>
                </div>
                <div class="price">${euro(p.price)}</div>
              </div>
            `).join("") || `<div class="li"><div class="muted2">â€”</div></div>`}
          </div>
        </div>
      `;

      const btnSendOwner = document.getElementById("btnSendOwner");
      const btnCloseShift = document.getElementById("btnCloseShift");
      makePressable(btnSendOwner, true);
      makePressable(btnCloseShift, true);

      btnSendOwner.addEventListener("click", async ()=>{
        if(!canSend) return;
        await sendShiftToOwner();
      });

      btnCloseShift.addEventListener("click", async ()=>{
        // âœ… server/waiter PIN required (not owner)
        const u = getUser();
        const pin = await modalPromptPin("ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Î²Î¬ÏÎ´Î¹Î±Ï‚", `PIN Î³Î¹Î±: ${u?.name || ""}`, "Î’Î¬Î»Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ ÏƒÎ¿Ï… Î³Î¹Î± ÎºÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Î²Î¬ÏÎ´Î¹Î±Ï‚.");
        if(pin === null) return;
        if(String(pin).trim() !== String(u?.pin || "").trim()){
          await modalAlert("Î›Î¬Î¸Î¿Ï‚ PIN", "Î”ÎµÎ½ ÎµÎ¯Î½Î±Î¹ ÏƒÏ‰ÏƒÏ„ÏŒÏ‚ Î¿ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚.", "ÎŸÎš");
          return;
        }
        await closeShift();
      });

      setBottomButtons([
        { text:"â† Home", kind:"", onClick: ()=> gotoHome() },
        { text:"CSV", kind:"", onClick: ()=> exportCSV() }
      ]);
    }

    function renderSettings(){
      const u = getUser();
      view.innerHTML = `
        <div class="card">
          <div class="h">Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</div>
          <div class="muted">Î§ÏÎ®ÏƒÏ„Î·Ï‚: <b>${escHtml(u?.name || "â€”")}</b></div>
          <div class="muted2" style="margin-top:6px;">Î“Î¹Î± Î±Î»Î»Î±Î³Î­Ï‚ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Owner PIN.</div>
        </div>

        <div class="card">
          <div class="h">ÎœÎ±Î³Î±Î¶Î¯</div>
          <div class="row space">
            <div class="muted">ÎŒÎ½Î¿Î¼Î± Î¼Î±Î³Î±Î¶Î¹Î¿Ï</div>
            <div><b>${escHtml(db.shopName || "â€”")}</b></div>
          </div>
          <div style="margin-top:10px;">
            <button class="btn pressable accent" id="btnChangeShop">Î‘Î»Î»Î±Î³Î® Î¿Î½ÏŒÎ¼Î±Ï„Î¿Ï‚ (Owner)</button>
          </div>
        </div>

        <div class="card">
          <div class="h">Î™Î´Î¹Î¿ÎºÏ„Î®Ï„Î·Ï‚</div>

          <div class="row space">
            <div class="muted">Email Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·</div>
            <div><b>${escHtml(db.ownerEmail || "â€”")}</b></div>
          </div>
          <div style="margin-top:10px;">
            <button class="btn pressable accent" id="btnOwnerEmail">Î‘Î»Î»Î±Î³Î® email (Owner)</button>
          </div>

          <div class="row space" style="margin-top:12px;">
            <div class="muted">WhatsApp (Î½Î¿ÏÎ¼ÎµÏÎ¿)</div>
            <div><b>${escHtml(db.ownerWhatsApp || "â€”")}</b></div>
          </div>
          <div style="margin-top:10px;">
            <button class="btn pressable accent" id="btnOwnerWA">Î‘Î»Î»Î±Î³Î® WhatsApp (Owner)</button>
          </div>

          <div class="hint">WhatsApp: Î²Î¬Î»Îµ Ï€.Ï‡. 49176xxxxxxx (Ï‡Ï‰ÏÎ¯Ï‚ +).</div>
        </div>

        <div class="card">
          <div class="h">Î§ÏÎ®ÏƒÏ„ÎµÏ‚</div>
          <div class="list" id="usersList"></div>

          <div style="margin-top:10px;">
            <button class="btn pressable accent" id="btnAddUser">+ ÎÎ­Î¿Ï‚ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ (Owner)</button>
          </div>
        </div>

        <div class="card dangerBox">
          <div class="h">Î‘ÏƒÏ†Î¬Î»ÎµÎ¹Î±</div>
          <div class="muted2">Owner PIN: Î¼ÏŒÎ½Î¿ Î¿ Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î±Î»Î»Î¬Î¾ÎµÎ¹ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚.</div>
          <div style="margin-top:10px;">
            <button class="btn pressable bad" id="btnChangeOwner">Î‘Î»Î»Î±Î³Î® Owner PIN</button>
          </div>
        </div>
      `;

      const ul = document.getElementById("usersList");
      ul.innerHTML = db.users.map(us=>`
        <div class="li">
          <div class="left">
            <div class="name">${escHtml(us.name)}</div>
            <div class="meta">PIN: â€¢â€¢â€¢â€¢</div>
          </div>
          <div class="qty">
            <button class="qbtn pressable" data-epin="${us.id}" title="Î‘Î»Î»Î±Î³Î® PIN">ğŸ”‘</button>
            <button class="qbtn pressable" data-del="${us.id}" title="Î”Î¹Î±Î³ÏÎ±Ï†Î®">ğŸ—‘ï¸</button>
          </div>
        </div>
      `).join("");

      const btnChangeShop = document.getElementById("btnChangeShop");
      const btnOwnerEmail = document.getElementById("btnOwnerEmail");
      const btnOwnerWA = document.getElementById("btnOwnerWA");
      const btnAddUser = document.getElementById("btnAddUser");
      const btnChangeOwner = document.getElementById("btnChangeOwner");

      [btnChangeShop, btnOwnerEmail, btnOwnerWA, btnAddUser, btnChangeOwner].forEach(b=> makePressable(b, true));

      btnChangeShop.addEventListener("click", async ()=>{
        if(!(await requireOwner())) return;
        const name = await modalPromptText("ÎŒÎ½Î¿Î¼Î± Î¼Î±Î³Î±Î¶Î¹Î¿Ï", "Î“ÏÎ¬ÏˆÎµ Î½Î­Î¿ ÏŒÎ½Î¿Î¼Î±:", db.shopName || "", "Î˜Î± ÎµÎ¼Ï†Î±Î½Î¯Î¶ÎµÏ„Î±Î¹ ÎµÏ€Î¬Î½Ï‰.");
        if(name === null || !name) return;
        db.shopName = String(name).trim();
        saveDB();
        setTop();
        render();
      });

      btnOwnerEmail.addEventListener("click", async ()=>{
        if(!(await requireOwner())) return;
        const em = await modalPromptText("Email Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·", "Î’Î¬Î»Îµ email (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ):", db.ownerEmail || "", "Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ ÏƒÏ„Î¿ mailto fallback.");
        if(em === null) return;
        db.ownerEmail = String(em).trim();
        saveDB();
        render();
      });

      btnOwnerWA.addEventListener("click", async ()=>{
        if(!(await requireOwner())) return;
        const wa = await modalPromptText("WhatsApp Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·", "Î’Î¬Î»Îµ Î±ÏÎ¹Î¸Î¼ÏŒ (Ï‡Ï‰ÏÎ¯Ï‚ +):", db.ownerWhatsApp || "", "Î .Ï‡. 491761234567");
        if(wa === null) return;
        db.ownerWhatsApp = String(wa).replaceAll(/\s+/g,"").replaceAll("+","").trim();
        saveDB();
        render();
      });

      btnAddUser.addEventListener("click", async ()=>{
        if(!(await requireOwner())) return;
        const name = await modalPromptText("ÎÎ­Î¿Ï‚ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚", "ÎŒÎ½Î¿Î¼Î± Ï‡ÏÎ®ÏƒÏ„Î·:", "ÎÎ­Î¿Ï‚ Î¥Ï€Î¬Î»Î»Î·Î»Î¿Ï‚", "");
        if(!name) return;
        const pin = await modalPromptPin("PIN Ï‡ÏÎ®ÏƒÏ„Î·", "Î’Î¬Î»Îµ PIN (4+ ÏˆÎ·Ï†Î¯Î±)", "Î˜Î± ÎµÎ¼Ï†Î±Î½Î¯Î¶ÎµÏ„Î±Î¹ numeric keypad.");
        if(!pin) return;
        const id = "u" + uid();
        db.users.push({ id, name: String(name).trim(), pin: String(pin).trim() });
        db.currentUserId = id;
        saveDB();
        fillUsers();
        setTop();
        render();
      });

      btnChangeOwner.addEventListener("click", async ()=>{
        if(!(await requireOwner())) return;
        const newPin = await modalPromptPin("Owner PIN", "Î’Î¬Î»Îµ Î½Î­Î¿ Owner PIN", "ÎšÏÎ¬Ï„Î± Ï„Î¿ Î¼Ï…ÏƒÏ„Î¹ÎºÏŒ.");
        if(!newPin) return;
        db.ownerPin = String(newPin).trim();
        saveDB();
        render();
      });

      ul.querySelectorAll("[data-epin]").forEach(b=>{
        makePressable(b, true);
        b.addEventListener("click", async ()=>{
          if(!(await requireOwner())) return;
          const uid2 = b.getAttribute("data-epin");
          const user = db.users.find(x=>x.id===uid2);
          if(!user) return;
          const pin = await modalPromptPin("Î‘Î»Î»Î±Î³Î® PIN", `ÎÎ­Î¿ PIN Î³Î¹Î± ${user.name}`, "Numeric keypad.");
          if(!pin) return;
          user.pin = String(pin).trim();
          saveDB();
          render();
        });
      });

      ul.querySelectorAll("[data-del]").forEach(b=>{
        makePressable(b, true);
        b.addEventListener("click", async ()=>{
          if(!(await requireOwner())) return;
          const uid2 = b.getAttribute("data-del");
          const user = db.users.find(x=>x.id===uid2);
          if(!user) return;
          const ok = await modalConfirm("Î”Î¹Î±Î³ÏÎ±Ï†Î® Ï‡ÏÎ®ÏƒÏ„Î·", `ÎÎ± Î´Î¹Î±Î³ÏÎ±Ï†ÎµÎ¯ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ â€œ${user.name}â€;`, "Î”Î¹Î±Î³ÏÎ±Ï†Î®", "Î†ÎºÏ…ÏÎ¿");
          if(!ok) return;

          db.users = db.users.filter(x=>x.id!==uid2);
          if(!db.users.length){
            db.users = [{ id:"u1", name:"Î¥Ï€Î¬Î»Î»Î·Î»Î¿Ï‚ 1", pin:"1111" }];
            db.currentUserId = "u1";
          }else if(db.currentUserId===uid2){
            db.currentUserId = db.users[0].id;
          }
          saveDB();
          fillUsers();
          setTop();
          render();
        });
      });

      setBottomButtons([
        { text:"â† Home", kind:"", onClick: ()=> gotoHome() }
      ]);
    }

    function exportCSV(){
      const totals = computeShiftTotals();
      if(totals.all <= 0.00001){
        modalAlert("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï„Î±Î¼ÎµÎ¯Î¿", "Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€Î¿ÏƒÎ¬ Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î· Î²Î¬ÏÎ´Î¹Î±.", "ÎŸÎš");
        return;
      }
      const csv = csvForShift();
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `shift_${TODAY}_${db.days[TODAY].shiftId}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function render(){
      setTop();
      if(state.screen==="home") renderHome();
      else if(state.screen==="table") renderTable();
      else if(state.screen==="add") renderAdd();
      else if(state.screen==="pay") renderPay();
      else if(state.screen==="summary") renderSummary();
      else if(state.screen==="settings") renderSettings();
    }

    // User select requires USER PIN, safe revert
    el("userSelect").addEventListener("change", async ()=>{
      const sel = el("userSelect");
      const requestedId = sel.value;

      sel.value = lastUserId;
      if(requestedId === lastUserId) return;

      const targetUser = db.users.find(u=>u.id===requestedId);
      if(!targetUser){
        sel.value = lastUserId;
        return;
      }

      const pin = await modalPromptPin(
        "Î‘Î»Î»Î±Î³Î® Ï‡ÏÎ®ÏƒÏ„Î·",
        `PIN Î³Î¹Î±: ${targetUser.name}`,
        "Î’Î¬Î»Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ Î³Î¹Î± Î½Î± Î±Î»Î»Î¬Î¾ÎµÎ¹ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚."
      );

      if(pin === null){
        sel.value = lastUserId;
        return;
      }

      if(String(pin).trim() !== String(targetUser.pin).trim()){
        await modalAlert("Î›Î¬Î¸Î¿Ï‚ PIN", "ÎŸ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ ÏƒÏ‰ÏƒÏ„ÏŒÏ‚.", "ÎŸÎš");
        sel.value = lastUserId;
        return;
      }

      db.currentUserId = requestedId;
      lastUserId = requestedId;
      sel.value = requestedId;
      saveDB();
      setTop();
      render();
    });

    const btnGear = el("btnGear");
    makePressable(btnGear, true);
    btnGear.addEventListener("click", ()=> gotoSettings());

    // Idle loop: go home & show saver
    setInterval(()=>{
      const idle = Date.now() - lastActivityTs;
      if(saverShown) return;

      if(state.screen !== "home" && idle > IDLE_HOME_MS){
        gotoHome();
        return;
      }
      if(state.screen === "home" && idle > IDLE_SAVER_MS){
        showSaver();
      }
    }, 500);

    async function registerSW(){
      if(!("serviceWorker" in navigator)) return;
      try{
        const reg = await navigator.serviceWorker.register("./sw.js", { scope:"./" });
        if(reg.update) reg.update();
      }catch(e){}
    }

    fillUsers();
    render();
    registerSW();
  </script>
</body>
</html>
